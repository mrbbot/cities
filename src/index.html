<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Code Highlighter</title>

    <style>
        /*! minireset.css v0.0.3 | MIT License | github.com/jgthms/minireset.css */html,body,p,ol,ul,li,dl,dt,dd,blockquote,figure,fieldset,legend,textarea,pre,iframe,hr,h1,h2,h3,h4,h5,h6{margin:0;padding:0}h1,h2,h3,h4,h5,h6{font-size:100%;font-weight:normal}ul{list-style:none}button,input,select,textarea{margin:0}html{box-sizing:border-box}*,*:before,*:after{box-sizing:inherit}img,embed,iframe,object,audio,video{height:auto;max-width:100%}iframe{border:0}table{border-collapse:collapse;border-spacing:0}td,th{padding:0;text-align:left}
    </style>

    <style>
        /* PrismJS 1.15.0
https://prismjs.com/download.html#themes=prism&languages=markup+css+clike+javascript+abap+actionscript+ada+apacheconf+apl+applescript+c+arff+asciidoc+asm6502+csharp+autohotkey+autoit+bash+basic+batch+bison+brainfuck+bro+cpp+aspnet+arduino+coffeescript+clojure+ruby+csp+css-extras+d+dart+diff+django+docker+eiffel+elixir+elm+markup-templating+erlang+fsharp+flow+fortran+gedcom+gherkin+git+glsl+go+graphql+groovy+haml+handlebars+haskell+haxe+http+hpkp+hsts+ichigojam+icon+inform7+ini+io+j+java+jolie+json+julia+keyman+kotlin+latex+less+liquid+lisp+livescript+lolcode+lua+makefile+markdown+erb+matlab+mel+mizar+monkey+n4js+nasm+nginx+nim+nix+nsis+objectivec+ocaml+opencl+oz+parigp+parser+pascal+perl+php+php-extras+sql+powershell+processing+prolog+properties+protobuf+pug+puppet+pure+python+q+qore+r+jsx+typescript+renpy+reason+rest+rip+roboconf+crystal+rust+sas+sass+scss+scala+scheme+smalltalk+smarty+plsql+soy+stylus+swift+yaml+tcl+textile+tt2+twig+tsx+vbnet+velocity+verilog+vhdl+vim+visual-basic+wasm+wiki+xeora+xojo+xquery+tap */
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
  color: black;
  background: none;
  text-shadow: 0 1px white;
  font-family: Consolas, Monaco, "Andale Mono", "Ubuntu Mono", monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

pre[class*="language-"]::-moz-selection,
pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection,
code[class*="language-"] ::-moz-selection {
  text-shadow: none;
  background: #b3d4fc;
}

pre[class*="language-"]::selection,
pre[class*="language-"] ::selection,
code[class*="language-"]::selection,
code[class*="language-"] ::selection {
  text-shadow: none;
  background: #b3d4fc;
}

@media print {
  code[class*="language-"],
  pre[class*="language-"] {
    text-shadow: none;
  }
}

/* Code blocks */
pre[class*="language-"] {
  /*padding: 1em;*/
  /*margin: 0.5em 0;*/
  margin: 0.25em 0;
  overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
  /*background: #f5f2f0;*/
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: 0.1em;
  border-radius: 0.3em;
  white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
  color: slategray;
}

.token.punctuation {
  color: #999;
}

.namespace {
  opacity: 0.7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
  color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
  color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
  color: #9a6e3a;
}

.token.atrule,
.token.attr-value,
.token.keyword {
  color: #07a;
}

.token.function,
.token.class-name {
  color: #dd4a68;
}

.token.regex,
.token.important,
.token.variable {
  color: #e90;
}

.token.important,
.token.bold {
  font-weight: bold;
}
.token.italic {
  font-style: italic;
}

.token.entity {
  cursor: help;
}

    </style>

    <style>
        body {
            font-family: "Segoe UI", sans-serif;
        }

        #wrapper {
            max-width: 210mm;
            margin: 0 auto;
        }

        h1 {
            font-size: 12pt;
            text-decoration: underline;
        }

        pre:not(:last-child) {
            margin-bottom: 1em;
        }

        /*pre {
            width: 210mm !important;
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
        }*/

        pre code {
            max-width: 210mm; !important;
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
        }
    </style>
</head>
<body>
<div id="wrapper">
    <h1>com/mrbbot/civilisation/Civilisation.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>Game<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>MapSize<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>CivilisationServer<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>connect<span class="token punctuation">.</span>ClientCreator<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>connect<span class="token punctuation">.</span>ScreenConnect<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>connect<span class="token punctuation">.</span>ServerCreator<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>game<span class="token punctuation">.</span>ScreenGame<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>Client<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>Server<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>application<span class="token punctuation">.</span>Application<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>application<span class="token punctuation">.</span>Platform<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Rectangle2D<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>stage<span class="token punctuation">.</span>Screen<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>stage<span class="token punctuation">.</span>Stage<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>

<span class="token comment">/**
 * Class containing the main entry point for the program.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Civilisation</span> <span class="token keyword">extends</span> <span class="token class-name">Application</span>
  <span class="token keyword">implements</span> <span class="token class-name">ClientCreator</span><span class="token punctuation">,</span> ServerCreator <span class="token punctuation">{</span>
  <span class="token comment">/**
   * The game client. Exposed so that any component of the game can send
   * packets to the server.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Client<span class="token generics function"><span class="token punctuation">&lt;</span>Packet<span class="token punctuation">></span></span> CLIENT<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The internal game server. There should only be one instance of this per
   * instance of the program.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> CivilisationServer SERVER<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Primary stage of the application. This is where the scenes for the
   * different screens go.
   */</span>
  <span class="token keyword">private</span> Stage primaryStage<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Width of the application window.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> width<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Height of the application window.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> height<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The game screen for this client. Contains the 3D map render and the UI
   * information overlays.
   */</span>
  <span class="token keyword">private</span> ScreenGame screenGame<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span>Stage primaryStage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Store the primary stage so the screen can be changed later.</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>primaryStage <span class="token operator">=</span> primaryStage<span class="token punctuation">;</span>

    <span class="token comment">// Make the game occupy all of the screen</span>
    Rectangle2D screenBounds <span class="token operator">=</span> Screen<span class="token punctuation">.</span><span class="token function">getPrimary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    width <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> screenBounds<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    height <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> screenBounds<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    width <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">//1000 //1600</span>
    height <span class="token operator">=</span> <span class="token number">600</span><span class="token punctuation">;</span> <span class="token comment">//600 //900</span>

    <span class="token comment">// Create the initial connection screen, registering this as the client</span>
    <span class="token comment">// and server creator</span>
    ScreenConnect screenConnect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScreenConnect</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Show the connection screen by default</span>
    primaryStage<span class="token punctuation">.</span><span class="token function">setScene</span><span class="token punctuation">(</span>
      screenConnect<span class="token punctuation">.</span><span class="token function">makeScene</span><span class="token punctuation">(</span>primaryStage<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Set window details</span>
    primaryStage<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">"Civilisation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    primaryStage<span class="token punctuation">.</span><span class="token function">setResizable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//primaryStage.setFullScreen(true);</span>

    <span class="token comment">// Terminate the client and server when the user requests the game exit by</span>
    <span class="token comment">// clicking the window's close button</span>
    primaryStage<span class="token punctuation">.</span><span class="token function">setOnCloseRequest</span><span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>CLIENT <span class="token operator">!=</span> null<span class="token punctuation">)</span> CLIENT<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>SERVER <span class="token operator">!=</span> null<span class="token punctuation">)</span> SERVER<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">}</span>
      System<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Show the game window</span>
    primaryStage<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Function to create a new game client. Creates and shows the game screen
   * when the first packet is received.
   *
   * @param host server host IP/URL
   * @param port server port number
   * @param id   desired id of the player
   * @throws IOException if there was a networking error
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createClient</span><span class="token punctuation">(</span>
    String host<span class="token punctuation">,</span>
    <span class="token keyword">int</span> port<span class="token punctuation">,</span>
    String id
  <span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token comment">// Store the client so that all components of the game can send packets to</span>
    <span class="token comment">// the server</span>
    CLIENT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>
      host<span class="token punctuation">,</span>
      port<span class="token punctuation">,</span>
      id<span class="token punctuation">,</span>
      <span class="token comment">// Run the packet handler on the UI thread so that UI components can be</span>
      <span class="token comment">// updated without throwing errors</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Platform<span class="token punctuation">.</span><span class="token function">runLater</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">PacketGame</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// If the packet contains game state information (1st packet), create</span>
          <span class="token comment">// the game screen with the existing state and show it to the user</span>
          Game game <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Game</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PacketGame<span class="token punctuation">)</span> data<span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
          screenGame <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScreenGame</span><span class="token punctuation">(</span>game<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
          primaryStage<span class="token punctuation">.</span><span class="token function">setScene</span><span class="token punctuation">(</span>
            screenGame<span class="token punctuation">.</span><span class="token function">makeScene</span><span class="token punctuation">(</span>primaryStage<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">PacketChat</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// If this was a chat packet, send it to the chat panel</span>
          screenGame<span class="token punctuation">.</span><span class="token function">handlePacketChat</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PacketChat<span class="token punctuation">)</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// Otherwise, if it was anything else...</span>

          <span class="token comment">// If this was a ready packet, make the "Next Turn" button clickable</span>
          <span class="token comment">// again</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">PacketReady</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            screenGame<span class="token punctuation">.</span><span class="token function">handlePacketReady</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PacketReady<span class="token punctuation">)</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// Get the game to handle it (likely a game state sync [unit moving,</span>
          <span class="token comment">// city creation, etc])</span>
          screenGame<span class="token punctuation">.</span>renderCivilisation<span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">handlePacket</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Send a request for the current game state</span>
    CLIENT<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PacketInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Function to create a new internal game server.
   *
   * @param gameFilePath file path of the game save file (may or may not exist)
   * @param gameName     name of the game (if this is null, we're loading an
   *                     existing game from a file)
   * @param mapSize      desired map size of the new game (ignored if loading
   *                     from a file)
   * @param port         port number to run the server on
   * @throws IOException if there was a networking error
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createServer</span><span class="token punctuation">(</span>
    String gameFilePath<span class="token punctuation">,</span>
    String gameName<span class="token punctuation">,</span>
    MapSize mapSize<span class="token punctuation">,</span>
    <span class="token keyword">int</span> port
  <span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>gameName <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If the game name is null, we're loading an existing game from a file</span>
      <span class="token comment">// so don't pass the additional parameters</span>
      SERVER <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CivilisationServer</span><span class="token punctuation">(</span>gameFilePath<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Otherwise, create an entirely new game</span>
      SERVER <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CivilisationServer</span><span class="token punctuation">(</span>gameFilePath<span class="token punctuation">,</span> gameName<span class="token punctuation">,</span> mapSize<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Main entry point for the client program. Launches the JavaFX application.
   * @param args command line arguments
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">launch</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><h1>com/mrbbot/civilisation/geometry/Hexagon.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>geometry<span class="token punctuation">;</span>

<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Point2D<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>shape<span class="token punctuation">.</span>Cylinder<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>shape<span class="token punctuation">.</span>Shape3D<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>Rotate<span class="token punctuation">;</span>

<span class="token comment">/**
 * Class that represents a Hexagon in 2D space
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hexagon</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * The square root of 3, used in calculations of distances to edges
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> SQRT_3 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * The center of the hexagon
   */</span>
  <span class="token keyword">private</span> Point2D c<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The radius from the center of the hexagon
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">double</span> r<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The points that join the edges of the hexagon. All of these points are a
   * {@link #r radius} from the {@link #c center}.
   */</span>
  <span class="token keyword">private</span> Point2D<span class="token punctuation">[</span><span class="token punctuation">]</span> vertices<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Creates a new hexagon using the specific parameters
   *
   * @param center center coordinate of the new hexagon
   * @param radius radius from the center of the new hexagon
   */</span>
  <span class="token function">Hexagon</span><span class="token punctuation">(</span>Point2D center<span class="token punctuation">,</span> <span class="token keyword">double</span> radius<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>c <span class="token operator">=</span> center<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>r <span class="token operator">=</span> radius <span class="token comment">/*- 0.1*/</span><span class="token punctuation">;</span> <span class="token comment">// - 0.1 puts a gap in between hexes</span>
    <span class="token function">calculateVertices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Calculates the vertices of the hexagon. This is only called when any of
   * the data required to calculate them changes.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">calculateVertices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">double</span> cx <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// alias for c.getX()</span>
    <span class="token keyword">double</span> cy <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// alias for c.getY()</span>
    <span class="token keyword">double</span> hr <span class="token operator">=</span> r <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>          <span class="token comment">// half radius</span>
    <span class="token keyword">double</span> hw <span class="token operator">=</span> SQRT_3 <span class="token operator">*</span> hr<span class="token punctuation">;</span>    <span class="token comment">// half width</span>

    <span class="token comment">// Calculate the vertices and store them in a new array (the old one will</span>
    <span class="token comment">// be garbage collected)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point2D</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
      <span class="token keyword">new</span> <span class="token class-name">Point2D</span><span class="token punctuation">(</span>cx<span class="token punctuation">,</span> cy <span class="token operator">-</span> r<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Point2D</span><span class="token punctuation">(</span>cx <span class="token operator">-</span> hw<span class="token punctuation">,</span> cy <span class="token operator">-</span> hr<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Point2D</span><span class="token punctuation">(</span>cx <span class="token operator">-</span> hw<span class="token punctuation">,</span> cy <span class="token operator">+</span> hr<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Point2D</span><span class="token punctuation">(</span>cx<span class="token punctuation">,</span> cy <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Point2D</span><span class="token punctuation">(</span>cx <span class="token operator">+</span> hw<span class="token punctuation">,</span> cy <span class="token operator">+</span> hr<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Point2D</span><span class="token punctuation">(</span>cx <span class="token operator">+</span> hw<span class="token punctuation">,</span> cy <span class="token operator">-</span> hr<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the vertices of this hexagon
   *
   * @return vertices of this hexagon
   */</span>
  <span class="token keyword">public</span> Point2D<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getVertices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> vertices<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets a hexagonal prism created by extruding the cross section
   *
   * @param height the height of the new prism
   * @return a 3D hexagonal prism
   */</span>
  <span class="token keyword">public</span> Shape3D <span class="token function">getPrism</span><span class="token punctuation">(</span><span class="token keyword">double</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Cylinder cylinder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cylinder</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> height<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cylinder<span class="token punctuation">.</span><span class="token function">getTransforms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">Rotate</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">,</span> Rotate<span class="token punctuation">.</span>X_AXIS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cylinder<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the center of this hexagon
   *
   * @return center of this hexagon
   */</span>
  <span class="token keyword">public</span> Point2D <span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> c<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the center of this hexagon and then recalculates the vertices
   *
   * @param center new center of the hexagon
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCenter</span><span class="token punctuation">(</span>Point2D center<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>c <span class="token operator">=</span> center<span class="token punctuation">;</span>
    <span class="token function">calculateVertices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the radius of this hexagon
   *
   * @return radius of this hexagon
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getRadius</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> r<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the radius of this hexagon and then recalculates the vertices
   *
   * @param radius new radius of the hexagon
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRadius</span><span class="token punctuation">(</span><span class="token keyword">double</span> radius<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>r <span class="token operator">=</span> radius<span class="token punctuation">;</span>
    <span class="token function">calculateVertices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"Hexagon[cx = "</span> <span class="token operator">+</span> c<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">+</span> <span class="token string">", cy = "</span> <span class="token operator">+</span> c<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", r = "</span> <span class="token operator">+</span> r <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/geometry/HexagonConsumer.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>geometry<span class="token punctuation">;</span>

<span class="token comment">/**
 * Represents an operation that accepts part of a hexagon grid and then performs an action with it.
 * @param &lt;T> type of the hexagon grid
 */</span>
<span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">HexagonConsumer</span><span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token punctuation">{</span>
   <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span>T t<span class="token punctuation">,</span> Hexagon hex<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/geometry/Path.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>geometry<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>

<span class="token comment">/**
 * Class representing a path between two points
 * @param &lt;E> the type of the data within the path
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Path</span><span class="token operator">&lt;</span>E <span class="token keyword">extends</span> <span class="token class-name">Traversable</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Ordered list of the tiles in the path
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>E<span class="token punctuation">></span></span> path<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The cost of travelling to the end through this path
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> totalCost<span class="token punctuation">;</span>

  <span class="token function">Path</span><span class="token punctuation">(</span>List<span class="token generics function"><span class="token punctuation">&lt;</span>E<span class="token punctuation">></span></span> path<span class="token punctuation">,</span> <span class="token keyword">int</span> totalCost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>totalCost <span class="token operator">=</span> totalCost<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/geometry/HexagonGrid.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>geometry<span class="token punctuation">;</span>

<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Point2D<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token comment">/**
 * Represents a 2D grid a hexagons and handles the maths for positioning hexagons relative to each other
 *
 * @param &lt;E> the type of the data associated with each hexagon (should implement {@link Traversable} for pathfinding)
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HexagonGrid</span><span class="token operator">&lt;</span>E <span class="token keyword">extends</span> <span class="token class-name">Traversable</span><span class="token operator">></span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Grid width of the hexagon grid (how many tiles the grid spans)
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> width<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Grid height of the hexagon grid (how many tiles the grid spans)
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> height<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Radius of each hexagon within the hexagon grid
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">double</span> radius<span class="token punctuation">;</span>

  <span class="token comment">/**
   * 2D array for storing the data associated with each tile. Objects within this array should be of type E. Every
   * other tile has +-1 element than the previous row.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> grid<span class="token punctuation">;</span>
  <span class="token comment">/**
   * 2D array for storing the hexagons which contain the data about tile positioning for this grid. Every other tile
   * has +-1 element than the previous row.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Hexagon<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hexagonGrid<span class="token punctuation">;</span>

  <span class="token comment">/**
   * The distance from the midpoint of one edge to another midpoint of a hexagon
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">double</span> cw<span class="token punctuation">;</span>    <span class="token comment">// cell width</span>
  <span class="token comment">/**
   * The distance from the center of a hexagon to the midpoint of an edge of the hexagon
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">double</span> hcw<span class="token punctuation">;</span>   <span class="token comment">// half cell width</span>
  <span class="token comment">/**
   * The vertical distance between the center of hexagons on adjacent rows
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">double</span> ch<span class="token punctuation">;</span>    <span class="token comment">// cell height</span>
  <span class="token comment">/**
   * The x-coordinate of where the grid starts relative to the origin
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">double</span> sx<span class="token punctuation">;</span>    <span class="token comment">// start x</span>
  <span class="token comment">/**
   * The y-coordinate of where the grid starts relative to the origin
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">double</span> sy<span class="token punctuation">;</span>    <span class="token comment">// start y</span>

  <span class="token comment">/**
   * Creates a new Hexagon Grid using the default radius of 1
   *
   * @param width  grid width of the grid
   * @param height grid height of the grid
   */</span>
  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unused"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token function">HexagonGrid</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Call the other constructor with the default</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Creates a new Hexagon Grid
   *
   * @param width  grid width of the grid
   * @param height grid height of the grid
   * @param radius radius of each hexagon within the hexagon grid
   */</span>
  <span class="token keyword">public</span> <span class="token function">HexagonGrid</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">double</span> radius<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Initialise class fields</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>radius <span class="token operator">=</span> radius<span class="token punctuation">;</span>

    <span class="token comment">// Construct the grid arrays taking into account the extra element on alternating rows</span>
    grid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>height<span class="token punctuation">]</span><span class="token punctuation">[</span>width <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    hexagonGrid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hexagon</span><span class="token punctuation">[</span>height<span class="token punctuation">]</span><span class="token punctuation">[</span>width <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Calculate constants for the grid that are used when laying out the hexagons</span>
    cw <span class="token operator">=</span> Hexagon<span class="token punctuation">.</span>SQRT_3 <span class="token operator">*</span> radius<span class="token punctuation">;</span>    <span class="token comment">// cell width</span>
    hcw <span class="token operator">=</span> cw <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>                    <span class="token comment">// half cell width</span>
    ch <span class="token operator">=</span> <span class="token number">3.0</span> <span class="token operator">/</span> <span class="token number">2.0</span> <span class="token operator">*</span> radius<span class="token punctuation">;</span>         <span class="token comment">// cell height</span>
    <span class="token keyword">double</span> gw <span class="token operator">=</span> <span class="token punctuation">(</span>width <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> cw<span class="token punctuation">;</span>  <span class="token comment">// grid width</span>
    <span class="token keyword">double</span> gh <span class="token operator">=</span> <span class="token punctuation">(</span>height <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> ch<span class="token punctuation">;</span> <span class="token comment">// grid height</span>
    sx <span class="token operator">=</span> <span class="token operator">-</span>gw <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>                    <span class="token comment">// start x</span>
    sy <span class="token operator">=</span> gh <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>                     <span class="token comment">// start y</span>

    <span class="token comment">// Calculate the positions of the hexagons on the grid</span>
    <span class="token function">calculateHexagonGrid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Iterates through every position for a hexagon and creates a new {@link Hexagon} for that position.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">calculateHexagonGrid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> hex<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> hexagonGrid<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hexagon</span><span class="token punctuation">(</span>
      <span class="token comment">// Center of the hexagon</span>
      <span class="token keyword">new</span> <span class="token class-name">Point2D</span><span class="token punctuation">(</span>
        <span class="token comment">// From the start coordinates, add the extra for this position</span>
        sx <span class="token operator">+</span> <span class="token punctuation">(</span>cw <span class="token operator">*</span> x<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> hcw<span class="token punctuation">)</span><span class="token punctuation">,</span>
        sy <span class="token operator">-</span> <span class="token punctuation">(</span>ch <span class="token operator">*</span> y<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// Use the specified radius for hexagons</span>
      radius
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Determines whether a cell actually exists in the hexagon grid, taking into account alternating numbers of
   * elements on each row
   *
   * @param x x-coordinate of cell to check
   * @param y y-coordinate of cell to check
   * @return whether the cell exists
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">cellExists</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> x <span class="token operator">&amp;&amp;</span> x <span class="token operator">&lt;</span> grid<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> y <span class="token operator">&amp;&amp;</span> y <span class="token operator">&lt;</span> grid<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>y <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> x <span class="token operator">></span> grid<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Checks whether the specified neighbouring cell exists, sometimes taking into account the traversability of the
   * cell.
   *
   * @param x             x-coordinate of neighbouring cell to check
   * @param y             y-coordinate of neighbouring cell to check
   * @param checkTraverse whether to check if the cell is traversable or not (used for pathfinding)
   * @return whether the neighbouring cell exists
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">checkNeighbour</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkTraverse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">cellExists</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>checkTraverse <span class="token operator">||</span> <span class="token function">get</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">canTraverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the data associated with the cell at the coordinate
   *
   * @param x x-coordinate of cell
   * @param y y-coordinate of cell
   * @return data associated with the cell
   */</span>
  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> E <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Ensure the cell actually exists in the grid</span>
    <span class="token keyword">assert</span> <span class="token function">cellExists</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Return the data, casting it to the data type</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>E<span class="token punctuation">)</span> grid<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the data associated with a cell called in the context of an adjacency check
   *
   * @param x             x-coordinate of cell
   * @param y             y-coordinate of cell
   * @param checkTraverse whether to check if the cell is traversable or not (used for pathfinding)
   * @param dx            offset added to the x-coordinate of the cell
   * @return the data associated with the cell or null if the cell doesn't exist
   */</span>
  <span class="token keyword">private</span> E <span class="token function">getAdjacent</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkTraverse<span class="token punctuation">,</span> <span class="token keyword">int</span> dx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Check if the cell exists, if it does return it, otherwise return null</span>
    <span class="token keyword">return</span> <span class="token function">checkNeighbour</span><span class="token punctuation">(</span>x <span class="token operator">+</span> dx<span class="token punctuation">,</span> y<span class="token punctuation">,</span> checkTraverse<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">get</span><span class="token punctuation">(</span>x <span class="token operator">+</span> dx<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the cell to the top-left of the specified coordinate
   *
   * @param x             x-coordinate to check to the top-left of
   * @param y             y-coordinate to check to the top-left of
   * @param checkTraverse whether to check if the cell is traversable or not (used for pathfinding)
   * @return the data associated with the top-left or null if the cell doesn't exist
   */</span>
  <span class="token keyword">public</span> E <span class="token function">getTopLeft</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkTraverse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getAdjacent</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> checkTraverse<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">(</span>y <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the cell to the top-right of the specified coordinate
   *
   * @param x             x-coordinate to check to the top-right of
   * @param y             y-coordinate to check to the top-right of
   * @param checkTraverse whether to check if the cell is traversable or not (used for pathfinding)
   * @return the data associated with the top-right or null if the cell doesn't exist
   */</span>
  <span class="token keyword">public</span> E <span class="token function">getTopRight</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkTraverse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getAdjacent</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> checkTraverse<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">(</span>y <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the cell to the left of the specified coordinate
   *
   * @param x             x-coordinate to check to the left of
   * @param y             y-coordinate to check to the left of
   * @param checkTraverse whether to check if the cell is traversable or not (used for pathfinding)
   * @return the data associated with the left or null if the cell doesn't exist
   */</span>
  <span class="token keyword">public</span> E <span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkTraverse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getAdjacent</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> y<span class="token punctuation">,</span> checkTraverse<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the cell to the right of the specified coordinate
   *
   * @param x             x-coordinate to check to the right of
   * @param y             y-coordinate to check to the right of
   * @param checkTraverse whether to check if the cell is traversable or not (used for pathfinding)
   * @return the data associated with the right or null if the cell doesn't exist
   */</span>
  <span class="token keyword">public</span> E <span class="token function">getRight</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkTraverse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getAdjacent</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> y<span class="token punctuation">,</span> checkTraverse<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the cell to the bottom-left of the specified coordinate
   *
   * @param x             x-coordinate to check to the bottom-left of
   * @param y             y-coordinate to check to the bottom-left of
   * @param checkTraverse whether to check if the cell is traversable or not (used for pathfinding)
   * @return the data associated with the bottom-left or null if the cell doesn't exist
   */</span>
  <span class="token keyword">public</span> E <span class="token function">getBottomLeft</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkTraverse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getAdjacent</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> checkTraverse<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">(</span>y <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the cell to the bottom-right of the specified coordinate
   *
   * @param x             x-coordinate to check to the bottom-right of
   * @param y             y-coordinate to check to the bottom-right of
   * @param checkTraverse whether to check if the cell is traversable or not (used for pathfinding)
   * @return the data associated with the bottom-right or null if the cell doesn't exist
   */</span>
  <span class="token keyword">public</span> E <span class="token function">getBottomRight</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkTraverse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getAdjacent</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> checkTraverse<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">(</span>y <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets a list of the neighbouring cells to the specified coordinate
   *
   * @param x             x-coordinate to get neighbours of
   * @param y             y-coordinate to get neighbours of
   * @param checkTraverse whether to check if the cells are traversable or not (used for pathfinding)
   * @return ArrayList of the neighbours' data
   */</span>
  <span class="token keyword">public</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>E<span class="token punctuation">></span></span> <span class="token function">getNeighbours</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkTraverse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create an empty list to add to</span>
    ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>E<span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get the adjacent cells</span>
    E topLeft <span class="token operator">=</span> <span class="token function">getTopLeft</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> checkTraverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    E topRight <span class="token operator">=</span> <span class="token function">getTopRight</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> checkTraverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    E left <span class="token operator">=</span> <span class="token function">getLeft</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> checkTraverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    E right <span class="token operator">=</span> <span class="token function">getRight</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> checkTraverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    E bottomLeft <span class="token operator">=</span> <span class="token function">getBottomLeft</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> checkTraverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    E bottomRight <span class="token operator">=</span> <span class="token function">getBottomRight</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> checkTraverse<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add the cells to the list if they aren't null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>topLeft <span class="token operator">!=</span> null<span class="token punctuation">)</span> list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>topLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>topRight <span class="token operator">!=</span> null<span class="token punctuation">)</span> list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>topRight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">!=</span> null<span class="token punctuation">)</span> list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>right <span class="token operator">!=</span> null<span class="token punctuation">)</span> list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bottomLeft <span class="token operator">!=</span> null<span class="token punctuation">)</span> list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bottomLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bottomRight <span class="token operator">!=</span> null<span class="token punctuation">)</span> list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bottomRight<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Return the list</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Finds the shortest path between (x1, y1) and (x2, y2) that does not exceed maxCost using Dijkstra's algorithm. If
   * maxCost is exceeded, the function returns the path up until the cost is exceeded.
   *
   * @param x1      start x-coordinate
   * @param y1      start y-coordinate
   * @param x2      end x-coordinate
   * @param y2      end y-coordinate
   * @param maxCost max cost of the path
   * @return a path object containing information of the tiles in the path and the total cost of the path
   */</span>
  <span class="token keyword">public</span> Path<span class="token generics function"><span class="token punctuation">&lt;</span>E<span class="token punctuation">></span></span> <span class="token function">findPath</span><span class="token punctuation">(</span><span class="token keyword">int</span> x1<span class="token punctuation">,</span> <span class="token keyword">int</span> y1<span class="token punctuation">,</span> <span class="token keyword">int</span> x2<span class="token punctuation">,</span> <span class="token keyword">int</span> y2<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create a map for storing the cost of certain tiles for sorting the queue</span>
    Map<span class="token generics function"><span class="token punctuation">&lt;</span>E<span class="token punctuation">,</span> Integer<span class="token punctuation">></span></span> costs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Create the queue for the frontier, sorting elements by their cost so the cheapest elements are at the front</span>
    PriorityQueue<span class="token generics function"><span class="token punctuation">&lt;</span>E<span class="token punctuation">></span></span> frontier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriorityQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>Comparator<span class="token punctuation">.</span><span class="token function">comparingInt</span><span class="token punctuation">(</span>costs<span class="token operator">:</span><span class="token operator">:</span>get<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create a map for storing the path back to the beginning</span>
    Map<span class="token generics function"><span class="token punctuation">&lt;</span>E<span class="token punctuation">,</span> E<span class="token punctuation">></span></span> cameFrom <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Create a map for storing the costs of the path to a cell so far</span>
    Map<span class="token generics function"><span class="token punctuation">&lt;</span>E<span class="token punctuation">,</span> Integer<span class="token punctuation">></span></span> costSoFar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get the start/end of the path</span>
    E start <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    E goal <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span>x2<span class="token punctuation">,</span> y2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Set the cost of the start to 0 and add it to the queue</span>
    costs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    frontier<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cameFrom<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    costSoFar<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// While there are still tiles to explore...</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>frontier<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Get the cheapest tile</span>
      E current <span class="token operator">=</span> frontier<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Check if this is the goal or doesn't exist</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> null <span class="token operator">||</span> current <span class="token operator">==</span> goal<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token comment">// For every neighbour of the current tile... (making sure that the neighbour is traversable)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>E next <span class="token operator">:</span> <span class="token function">getNeighbours</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> current<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Calculate the cost of getting to this tile</span>
        <span class="token keyword">int</span> newCost <span class="token operator">=</span> costSoFar<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token operator">+</span> next<span class="token punctuation">.</span><span class="token function">getCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// If this is a new tile or the cost of using this route is cheaper</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cameFrom<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">||</span> newCost <span class="token operator">&lt;</span> costSoFar<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Store the more efficient path</span>
          costSoFar<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> newCost<span class="token punctuation">)</span><span class="token punctuation">;</span>
          costs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> newCost<span class="token punctuation">)</span><span class="token punctuation">;</span>
          frontier<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
          cameFrom<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Build the path list of tiles travelled</span>
    List<span class="token generics function"><span class="token punctuation">&lt;</span>E<span class="token punctuation">></span></span> path <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    E current <span class="token operator">=</span> goal<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>current <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      path<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
      current <span class="token operator">=</span> cameFrom<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Reverse the order of this path so the start is at the beginning and the end is at the end</span>
    Collections<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Make sure the path doesn't exceed the max cost</span>
    <span class="token keyword">int</span> travelledCost <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> lastListIndex <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>travelledCost <span class="token operator">&lt;</span> maxCost <span class="token operator">&amp;&amp;</span> lastListIndex <span class="token operator">&lt;</span> path<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      travelledCost <span class="token operator">+=</span> path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>lastListIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      lastListIndex<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Get the path up to the point where the max cost is exceeded</span>
    path <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> lastListIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Return a path object with details on the path</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> travelledCost<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the data associated with the cell at the coordinate
   *
   * @param x    x-coordinate of cell
   * @param y    y-coordinate of cell
   * @param cell data associated with the cell
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> E cell<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span> <span class="token function">cellExists</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    grid<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> cell<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the hexagon (with position data) associated with the cell at the coordinate
   *
   * @param x x-coordinate of cell
   * @param y y-coordinate of cell
   * @return {@link Hexagon} associated with the cell
   */</span>
  <span class="token keyword">public</span> Hexagon <span class="token function">getHexagon</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span> <span class="token function">cellExists</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> hexagonGrid<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Iterates through all possible hexes in the hexagon grid and calls the consumer with data for each cell
   *
   * @param consumer function to be called with details about the cell
   */</span>
  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">forEach</span><span class="token punctuation">(</span>HexagonConsumer<span class="token generics function"><span class="token punctuation">&lt;</span>E<span class="token punctuation">></span></span> consumer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// For every row...</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> grid<span class="token punctuation">.</span>length<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// For every column... (taking into account the alternating numbers of columns in rows)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> grid<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Send the details on the cell</span>
        consumer<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">(</span>E<span class="token punctuation">)</span> grid<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">,</span> hexagonGrid<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Implementation of {@link Iterator} for iterating over the cells in a hexagon grid
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">HexagonGridIterator</span> <span class="token keyword">implements</span> <span class="token class-name">Iterator</span><span class="token generics function"><span class="token punctuation">&lt;</span>E<span class="token punctuation">></span></span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * Current x-coordinate state of the iterator
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Current y-coordinate state of the iterator
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> y<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Constructor for iterator. Initialises the state to (0, 0).
     */</span>
    <span class="token keyword">private</span> <span class="token function">HexagonGridIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Checks if the iterator has another cell to give
     *
     * @return whether the current state of the iterator is valid
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">cellExists</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Gets the next cell and increments the iterator state
     *
     * @return cell currently pointed to by the iterator
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> E <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      E next <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> grid<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        x<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        y<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Creates a new {@link HexagonGridIterator} for this hexagon grid
   *
   * @return the created iterator
   */</span>
  <span class="token keyword">public</span> Iterator<span class="token generics function"><span class="token punctuation">&lt;</span>E<span class="token punctuation">></span></span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HexagonGridIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Builder for the output</span>
    StringBuilder builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// For every row...</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> grid<span class="token punctuation">.</span>length<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Padding the row if needed to make a hexagon grid shape in the string</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// For every column...</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> grid<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Set the output depending on whether the tile exists</span>
        builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">get</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token string">"-"</span> <span class="token operator">:</span> <span class="token string">"#"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the grid width of this hexagon grid (how many tiles the grid spans)
   *
   * @return grid width of this hexagon grid
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> width<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the grid height of this hexagon grid (how many tiles the grid spans)
   *
   * @return grid height this hexagon grid
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> height<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/geometry/NoiseGenerator.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>geometry<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Random<span class="token punctuation">;</span>

<span class="token comment">/**
 * Class containing static methods for generating random noise to be used by
 * the terrain generator. Code used is from this YouTube video:
 * https://youtu.be/qChQrNWU9Xw
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NoiseGenerator</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Random number generator used internally
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Random RANDOM <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Random seed to be used by the generator
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SEED <span class="token operator">=</span> RANDOM<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Gets some random noise for the specified coordinate. This function will
   * always return the same value for the same coordinate in the same program
   * execution.
   *
   * @param x x-coordinate of noise to get
   * @param y y-coordinate of noise to get
   * @return random noise in the range (-1, 1)
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">double</span> <span class="token function">getNoise</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Set the seed of the random generator as a constant plus some multiple of</span>
    <span class="token comment">// the x and y coordinates. This ensures the same coordinates generate the</span>
    <span class="token comment">// same noise.</span>
    RANDOM<span class="token punctuation">.</span><span class="token function">setSeed</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token number">49632</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y <span class="token operator">*</span> <span class="token number">325176</span><span class="token punctuation">)</span> <span class="token operator">+</span> SEED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Return random number in the desired range</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>RANDOM<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets a smoothed version of the random noise for the specified coordinates.
   * Corners, edges, and the center are all taken into account with different
   * proportions.
   *
   * @param x x-coordinate of noise to get
   * @param y y-coordinate of noise to get
   * @return random noise in the range (-1, 1)
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">double</span> <span class="token function">getSmoothNoise</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">double</span> topLeft <span class="token operator">=</span> <span class="token function">getNoise</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> topRight <span class="token operator">=</span> <span class="token function">getNoise</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> bottomRight <span class="token operator">=</span> <span class="token function">getNoise</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> bottomLeft <span class="token operator">=</span> <span class="token function">getNoise</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">double</span> left <span class="token operator">=</span> <span class="token function">getNoise</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> top <span class="token operator">=</span> <span class="token function">getNoise</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> right <span class="token operator">=</span> <span class="token function">getNoise</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> bottom <span class="token operator">=</span> <span class="token function">getNoise</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">double</span> center <span class="token operator">=</span> <span class="token function">getNoise</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>topLeft <span class="token operator">+</span> topRight <span class="token operator">+</span> bottomRight <span class="token operator">+</span> bottomLeft<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">16.0</span><span class="token punctuation">)</span>
      <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>left <span class="token operator">+</span> top <span class="token operator">+</span> right <span class="token operator">+</span> bottom<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">8.0</span><span class="token punctuation">)</span>
      <span class="token operator">+</span> <span class="token punctuation">(</span>center <span class="token operator">/</span> <span class="token number">4.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Interpolates between two values using a cos function
   *
   * @param a first value
   * @param b second value
   * @param t amount to interpolate in the interval [0, 1]
   * @return a value between in the range [a, b]
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">double</span> <span class="token function">cosInterpolate</span><span class="token punctuation">(</span><span class="token keyword">double</span> a<span class="token punctuation">,</span> <span class="token keyword">double</span> b<span class="token punctuation">,</span> <span class="token keyword">double</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span>PI <span class="token operator">*</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>a <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>b <span class="token operator">*</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets an interpolated version of the random noise. This function unlike the
   * others in this class takes doubles for the coordinates allowing for
   * decimal positions to be used.
   *
   * @param x x-coordinate of noise to get
   * @param y y-coordinate of noise to get
   * @return random noise in the range (-1, 1)
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">double</span> <span class="token function">getInterpolatedNoise</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">,</span> <span class="token keyword">double</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Gets the fractional components of the x and y coordinates</span>
    <span class="token keyword">double</span> xf <span class="token operator">=</span> x <span class="token operator">-</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> yf <span class="token operator">=</span> y <span class="token operator">-</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Gets the floors and ceilings of the x and y coordinates. These are the</span>
    <span class="token comment">// vertices of the quadrant to get the noise from.</span>
    <span class="token keyword">int</span> xMin <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> yMin <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> xMax <span class="token operator">=</span> xMin <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> yMax <span class="token operator">=</span> yMin <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// Get noise for the top of the quadrant</span>
    <span class="token keyword">double</span> top <span class="token operator">=</span> <span class="token function">cosInterpolate</span><span class="token punctuation">(</span>
      <span class="token function">getSmoothNoise</span><span class="token punctuation">(</span>xMin<span class="token punctuation">,</span> yMin<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">getSmoothNoise</span><span class="token punctuation">(</span>xMax<span class="token punctuation">,</span> yMin<span class="token punctuation">)</span><span class="token punctuation">,</span>
      xf
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Get noise for the bottom of the quadrant</span>
    <span class="token keyword">double</span> bottom <span class="token operator">=</span> <span class="token function">cosInterpolate</span><span class="token punctuation">(</span>
      <span class="token function">getSmoothNoise</span><span class="token punctuation">(</span>xMin<span class="token punctuation">,</span> yMax<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">getSmoothNoise</span><span class="token punctuation">(</span>xMax<span class="token punctuation">,</span> yMax<span class="token punctuation">)</span><span class="token punctuation">,</span>
      xf
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Get noise for the position in the quadrant proportional to the</span>
    <span class="token comment">// fractional coordinate components</span>
    <span class="token keyword">return</span> <span class="token function">cosInterpolate</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> yf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/geometry/Positionable.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>geometry<span class="token punctuation">;</span>

<span class="token comment">/**
 * Interface representing a positionable 2D element with a x and y coordinate
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Positionable</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Gets the x-coordinate of the element
   *
   * @return x-coordinate of the element
   */</span>
  <span class="token keyword">int</span> <span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Gets the y-coordinate of the element
   *
   * @return y-coordinate of the element
   */</span>
  <span class="token keyword">int</span> <span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/geometry/Traversable.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>geometry<span class="token punctuation">;</span>

<span class="token comment">/**
 * Interface representing a traversable element
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Traversable</span> <span class="token keyword">extends</span> <span class="token class-name">Positionable</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Gets the cost of traversing this element
   *
   * @return cost of traversing this element
   */</span>
  <span class="token keyword">int</span> <span class="token function">getCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Checks whether this tile can be traversed
   *
   * @return whether this tile can be traversed
   */</span>
  <span class="token keyword">boolean</span> <span class="token function">canTraverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/logic/CityBuildable.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>techs<span class="token punctuation">.</span>Unlockable<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>Game<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Building<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>City<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Tile<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>UnitType<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>game<span class="token punctuation">.</span>BadgeType<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Objects<span class="token punctuation">;</span>

<span class="token comment">/**
 * Abstract class representing an item that can be built within a city by the
 * city instead of a worker
 */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">CityBuildable</span> <span class="token keyword">implements</span> <span class="token class-name">Unlockable</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Gets a city buildable from just its name
   *
   * @param name name of the city buildable to get
   * @return the city buildable with the specified name or null if it doesn't
   * exist
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> CityBuildable <span class="token function">fromName</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Try get it as a unit type</span>
    UnitType unitType <span class="token operator">=</span> UnitType<span class="token punctuation">.</span><span class="token function">fromName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>unitType <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span> unitType<span class="token punctuation">;</span>
    <span class="token comment">// Otherwise, try get it as a building (this will return null if it doesn't</span>
    <span class="token comment">// exist)</span>
    <span class="token keyword">return</span> Building<span class="token punctuation">.</span><span class="token function">fromName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Class representing a detail in the city production list. This could be the
   * production cost, the amount of movement points, or something like the
   * gold per turn increase.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Detail</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * Type of badge that should be used to represent this detail
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> BadgeType badge<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Text contents of this detail
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> String text<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Creates a new detail
     *
     * @param badge badge type of the detail
     * @param text  text to be shown next to the badge
     */</span>
    <span class="token keyword">public</span> <span class="token function">Detail</span><span class="token punctuation">(</span>BadgeType badge<span class="token punctuation">,</span> String text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>badge <span class="token operator">=</span> badge<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>text <span class="token operator">=</span> text<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Creates a new detail with a number that is automatically converted to a
     * string
     *
     * @param badge  badge type of the detail
     * @param number number to be shown next to the badge
     */</span>
    <span class="token keyword">public</span> <span class="token function">Detail</span><span class="token punctuation">(</span>BadgeType badge<span class="token punctuation">,</span> <span class="token keyword">int</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">(</span>badge<span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Name of this buildable (i.e. what is displayed in the city production
   * list)
   */</span>
  <span class="token keyword">protected</span> <span class="token keyword">final</span> String name<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Description of this buildable (i.e. what is displayed in the city
   * production list)
   */</span>
  <span class="token keyword">protected</span> <span class="token keyword">final</span> String description<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Amount of production points required to build this thing. Also determines
   * the gold cost (1.5x this value).
   */</span>
  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"WeakerAccess"</span><span class="token punctuation">)</span>
  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> productionCost<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Unlock ID of this buildable. Used to track what things are unlocked by a
   * technology.
   */</span>
  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> unlockId<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">CityBuildable</span><span class="token punctuation">(</span>
    String name<span class="token punctuation">,</span>
    String description<span class="token punctuation">,</span>
    <span class="token keyword">int</span> productionCost<span class="token punctuation">,</span>
    <span class="token keyword">int</span> unlockId
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>description <span class="token operator">=</span> description<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>productionCost <span class="token operator">=</span> productionCost<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>unlockId <span class="token operator">=</span> unlockId<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Name should be unique</span>
    <span class="token keyword">return</span> name<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">CityBuildable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Name should be unique</span>
      <span class="token keyword">return</span> Objects<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>CityBuildable<span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the name of the buildable to be displayed in the production list
   *
   * @return name of the buildable
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the unlock ID of the buildable
   *
   * @return unlock ID of the buildable
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getUnlockId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> unlockId<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the description of the buildable to be displayed in the production
   * list
   *
   * @return description of the buildable
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> String <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> description<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the required production total for this buildable
   *
   * @return production cost of this buildable
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getProductionCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> productionCost<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Calculates the gold cost of this item from the production cost
   *
   * @return productionCost * 1.5
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getGoldCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>productionCost <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Checks if this buildable can be built with the player's current production
   * total
   *
   * @param productionTotal player's current production total to check against
   * @return whether the buildable can be built
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">canBuildWithProduction</span><span class="token punctuation">(</span><span class="token keyword">int</span> productionTotal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> productionTotal <span class="token operator">>=</span> productionCost<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Checks if this buildable can be built with the player's current gold total
   *
   * @param goldTotal player's current gold total to check against
   * @return whether the buildable can be built
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">canBuildWithGold</span><span class="token punctuation">(</span><span class="token keyword">int</span> goldTotal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> goldTotal <span class="token operator">>=</span> <span class="token function">getGoldCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the details to be displayed in the city production list for this
   * building. This should be overridden in subclasses to add more specific
   * details.
   *
   * @return details to be displayed
   */</span>
  <span class="token keyword">public</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Detail<span class="token punctuation">></span></span> <span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Detail<span class="token punctuation">></span></span> details <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Add cost details (common for all buildables)</span>
    details<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Detail</span><span class="token punctuation">(</span>BadgeType<span class="token punctuation">.</span>PRODUCTION<span class="token punctuation">,</span> productionCost<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    details<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Detail</span><span class="token punctuation">(</span>BadgeType<span class="token punctuation">.</span>GOLD<span class="token punctuation">,</span> <span class="token function">getGoldCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> details<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Function that builds the buildable in the city. Must be overridden in
   * subclasses for actual implementation.
   *
   * @param city city to build the buildable in
   * @param game game containing the city
   * @return tile updated during the build process
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">abstract</span> Tile <span class="token function">build</span><span class="token punctuation">(</span>City city<span class="token punctuation">,</span> Game game<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Determine if a buildable can be built in a city given the player's other
   * cities. Designed to be overridden in subclasses.
   *
   * @param city   target city to build in
   * @param cities player's other cities
   * @return reason why the buildable cannot be built, or an empty string if it
   * can
   */</span>
  <span class="token keyword">public</span> String <span class="token function">canBuildGivenCities</span><span class="token punctuation">(</span>City city<span class="token punctuation">,</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>City<span class="token punctuation">></span></span> cities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/logic/Living.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Positionable<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>Unit<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Point2D<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token comment">/**
 * Abstract base living class. Describes something that has health and does
 * something every turn. Implements positionable, mappable, and turn handler
 * interfaces, but doesn't provide any implementations meaning this must be
 * done by subclasses.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Living</span> <span class="token keyword">implements</span> <span class="token class-name">Positionable</span><span class="token punctuation">,</span> Mappable<span class="token punctuation">,</span> TurnHandler <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Maximum health of the living object. Should naturally heal towards this
   * value each turn.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> baseHealth<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Current health of the living object. If this value reaches 0, the living
   * object should be considered dead.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> health<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Constructor for a new living object. Automatically sets the current health
   * to the maximum.
   *
   * @param baseHealth maximum health of this living object
   */</span>
  <span class="token keyword">public</span> <span class="token function">Living</span><span class="token punctuation">(</span><span class="token keyword">int</span> baseHealth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>baseHealth<span class="token punctuation">,</span> baseHealth<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Constructor for a new living object that doesn't necessarily have maximum
   * health.
   *
   * @param baseHealth maximum health of this living object
   * @param health     current health of this living object
   */</span>
  <span class="token keyword">public</span> <span class="token function">Living</span><span class="token punctuation">(</span><span class="token keyword">int</span> baseHealth<span class="token punctuation">,</span> <span class="token keyword">int</span> health<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>baseHealth <span class="token operator">=</span> baseHealth<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>health <span class="token operator">=</span> health<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Increases a living's health by the specified amount up to the maximum
   * health
   *
   * @param healing amount to increase the health by
   */</span>
  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"WeakerAccess"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">heal</span><span class="token punctuation">(</span><span class="token keyword">int</span> healing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setHealth</span><span class="token punctuation">(</span>health <span class="token operator">+</span> healing<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Checks if the living's health is below its maximum and heals it up to 5
   * health if it is.
   *
   * @return true if the living needed healing
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">naturalHeal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Check if healing is needed and heal up to 5 health if it is</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>health <span class="token operator">&lt;</span> baseHealth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">heal</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Mark as healed</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Decreases a living's health by the specified amount
   *
   * @param damage amount to decrease the health by
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">damage</span><span class="token punctuation">(</span><span class="token keyword">int</span> damage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>health <span class="token operator">-=</span> damage<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Checks if the living is dead (i.e. the health is less than or equal to 0)
   *
   * @return whether the living is dead
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">isDead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>health <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the units maximum health. This will also set the health so that it's
   * the same proportion of health as it was before.
   *
   * @param baseHealth new maximum health
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setBaseHealth</span><span class="token punctuation">(</span><span class="token keyword">int</span> baseHealth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get the old proportion</span>
    <span class="token keyword">double</span> percentOfBase <span class="token operator">=</span> <span class="token function">getHealthPercent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>baseHealth <span class="token operator">=</span> baseHealth<span class="token punctuation">;</span>
    <span class="token comment">// Ensure the proportion remains the same</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>health <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>percentOfBase <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseHealth<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the current health of the living
   *
   * @return current health
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> health<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the current health of the living, making sure it doesn't exceed the
   * maximum
   *
   * @param health new current health
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setHealth</span><span class="token punctuation">(</span><span class="token keyword">int</span> health<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>health <span class="token operator">=</span> health<span class="token punctuation">;</span>
    <span class="token comment">// Check if the health exceeds the maximum and set it to the maximum if it</span>
    <span class="token comment">// does</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>health <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseHealth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>health <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseHealth<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the maximum health of the living object
   *
   * @return maximum health of the living object
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getBaseHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> baseHealth<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the percent health filled of the living
   *
   * @return percent health filled
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getHealthPercent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> health <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> baseHealth<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Stores health information in a map so it can be saved/sent over the
   * network. This should be overridden by subclasses to add their additional
   * information.
   *
   * @return map containing health information
   */</span>
  <span class="token keyword">public</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> <span class="token function">toMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store health information</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"baseHealth"</span><span class="token punctuation">,</span> baseHealth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"health"</span><span class="token punctuation">,</span> health<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> map<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Handle a unit attacking this living object. Should be overridden in
   * subclasses to describe how attacking units should be affected.
   *
   * @param attacker the unit attacking this living object
   * @param ranged   whether this was a ranged attack
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">onAttacked</span><span class="token punctuation">(</span>Unit attacker<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ranged<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Gets the living's owner. Should be overridden in subclasses.
   *
   * @return the living's owner
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">abstract</span> Player <span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Gets the living's position in the map. Should be overridden in subclasses.
   *
   * @return the living's position in the map
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">abstract</span> Point2D <span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/logic/Mappable.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token comment">/**
 * Interface describing something that stores the state of itself in a map so
 * that it can be restored later. Used for sending the state over a network or
 * for storing it in a file.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Mappable</span> <span class="token punctuation">{</span>
  Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> <span class="token function">toMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/logic/Player.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">;</span>

<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable<span class="token punctuation">;</span>

<span class="token comment">/**
 * Player object containing the player's ID and a function for calculation
 * their colour. Also implements serializable so it can be sent over the
 * network.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Player</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * ID of this player. Chosen by the user when they launch the game.
   */</span>
  <span class="token keyword">public</span> String id<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">Player</span><span class="token punctuation">(</span>String id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the colour of this player. This is calculated from the hash code of
   * the player's id, so the same ID will always have the same colour. There's
   * also no need to send the colour over the network as it can be easily
   * recalculated.
   *
   * @return the colour representing this player to be used for unit rendering
   * and UI panels
   */</span>
  <span class="token keyword">public</span> Color <span class="token function">getColour</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Calculate the hue from the hash code, hues can be a number from 0 to</span>
    <span class="token comment">// 360.</span>
    <span class="token keyword">return</span> Color<span class="token punctuation">.</span><span class="token function">hsb</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">360</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Player</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// The id of the player should be unique</span>
      <span class="token keyword">return</span> id<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Player<span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/logic/PlayerStats.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">;</span>

<span class="token comment">/**
 * Data class containing information about a player's statistics (their
 * science and gold) so that they can be displayed in the UI
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PlayerStats</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * The player's total science per turn from all their cities
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> sciencePerTurn<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The player's total gold amount
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> gold<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The player's total gold per turn from all their cities
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> goldPerTurn<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">PlayerStats</span><span class="token punctuation">(</span><span class="token keyword">int</span> sciencePerTurn<span class="token punctuation">,</span> <span class="token keyword">int</span> gold<span class="token punctuation">,</span> <span class="token keyword">int</span> goldPerTurn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sciencePerTurn <span class="token operator">=</span> sciencePerTurn<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gold <span class="token operator">=</span> gold<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>goldPerTurn <span class="token operator">=</span> goldPerTurn<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/logic/TurnHandler.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>Game<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Tile<span class="token punctuation">;</span>

<span class="token comment">/**
 * Interface describing an object that contains logic that should be executed
 * at the beginning of every turn. This might be healing a unit, growing a
 * city, etc
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TurnHandler</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Turn handler function definition
   *
   * @param game game the turn is taking place in
   * @return an array of tiles to rerender, if empty, should rerender all
   * tiles, if null, should rerender no tiles
   */</span>
  Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handleTurn</span><span class="token punctuation">(</span>Game game<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/render/RenderCivilisation.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>map<span class="token punctuation">.</span>RenderGame<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">.</span>RenderRoot<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>application<span class="token punctuation">.</span>Platform<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>event<span class="token punctuation">.</span>EventHandler<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>AmbientLight<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>PointLight<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>Scene<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>input<span class="token punctuation">.</span>KeyEvent<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>input<span class="token punctuation">.</span>MouseButton<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>Rotate<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>Translate<span class="token punctuation">;</span>

<span class="token comment">/**
 * Render object containing the game render that handles zooming, panning and
 * lighting. This is the root render object, so extends {@link RenderRoot} in
 * order to access methods that create a sub-scene that can be included in the
 * JavaFX application.
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RenderCivilisation</span> <span class="token keyword">extends</span> <span class="token class-name">RenderRoot</span><span class="token generics function"><span class="token punctuation">&lt;</span>RenderGame<span class="token punctuation">></span></span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Most zoomed in scale.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">double</span> MAX_ZOOM <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Most zoomed out scale.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">double</span> MIN_ZOOM <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Easy way to enable/disable lighting. Used for development as lighting can
   * be quite annoying.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> ENABLE_LIGHTING <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Last x-coordinate of drag. Used for calculating how much the screen was
   * dragged.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">double</span> oldMouseX <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Last y-coordinate of drag. Used for calculating how much the screen was
   * dragged.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">double</span> oldMouseY <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Point light source representing the sun. Rotated round the map to simulate
   * day/night.
   */</span>
  <span class="token keyword">private</span> PointLight sun<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Point light source representing the moon. Rotated round the map to
   * simulate day/night.
   */</span>
  <span class="token keyword">private</span> PointLight moon<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Rotate transform applied to both the sun and moon to simulate day/night.
   */</span>
  <span class="token keyword">private</span> Rotate sunMoonRotate<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Creates a new instance of the root render object.
   *
   * @param root   root game render to show
   * @param width  width of the screen
   * @param height height of the screen
   */</span>
  <span class="token keyword">public</span> <span class="token function">RenderCivilisation</span><span class="token punctuation">(</span>RenderGame root<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Pass width/height to super constructor so an appropriately sized sub-</span>
    <span class="token comment">// scene can be created.</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Setup lighting if required</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ENABLE_LIGHTING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Create new lights for the sun/moon</span>
      sun <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PointLight</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      moon <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PointLight</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>BLACK<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Create and add transforms for the sun and the moon. Notice the moon</span>
      <span class="token comment">// has a negative x-transform so it will always be on the opposite side</span>
      <span class="token comment">// to the sun.</span>
      sunMoonRotate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rotate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Rotate<span class="token punctuation">.</span>Y_AXIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      sun<span class="token punctuation">.</span><span class="token function">getTransforms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>
        sunMoonRotate<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Translate</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      moon<span class="token punctuation">.</span><span class="token function">getTransforms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>
        sunMoonRotate<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Translate</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Create an ambient light so that you can still see the map at night</span>
      AmbientLight ambientLight <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AmbientLight</span><span class="token punctuation">(</span>
        Color<span class="token punctuation">.</span><span class="token function">color</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>sun<span class="token punctuation">,</span> moon<span class="token punctuation">,</span> ambientLight<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Set the time to sunset just to update the lights to something sensible</span>
      <span class="token function">setTime</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Start a thread to update the game time on a regular interval</span>
      <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span><span class="token operator">:</span>runDayNightCycle<span class="token punctuation">,</span> <span class="token string">"DayNightCycle"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Zooming</span>
    subScene<span class="token punctuation">.</span><span class="token function">setOnScroll</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token comment">// Calculate a new zoom value from the current zoom and the scroll amount</span>
      <span class="token keyword">double</span> newValue <span class="token operator">=</span> camera<span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">getZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getDeltaY</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Clamp the value to the min/max values</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">></span> <span class="token operator">-</span>MAX_ZOOM<span class="token punctuation">)</span> newValue <span class="token operator">=</span> <span class="token operator">-</span>MAX_ZOOM<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">&lt;</span> <span class="token operator">-</span>MIN_ZOOM<span class="token punctuation">)</span> newValue <span class="token operator">=</span> <span class="token operator">-</span>MIN_ZOOM<span class="token punctuation">;</span>
      <span class="token comment">// Set the new zoom value</span>
      camera<span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">setZ</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Panning</span>
    subScene<span class="token punctuation">.</span><span class="token function">setOnMouseDragged</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token comment">// Only drag the map if the left mouse button is pressed</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> MouseButton<span class="token punctuation">.</span>PRIMARY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Get mouse position</span>
        <span class="token keyword">double</span> x <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> y <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Check if this is the first coordinate of the drag</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldMouseX <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> oldMouseY <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          oldMouseX <span class="token operator">=</span> x<span class="token punctuation">;</span>
          oldMouseY <span class="token operator">=</span> y<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// If it's not, work out how far we've dragged</span>
          <span class="token keyword">double</span> dX <span class="token operator">=</span> x <span class="token operator">-</span> oldMouseX<span class="token punctuation">;</span>
          <span class="token keyword">double</span> dY <span class="token operator">=</span> y <span class="token operator">-</span> oldMouseY<span class="token punctuation">;</span>
          <span class="token comment">// ...and store the now old values</span>
          oldMouseX <span class="token operator">=</span> x<span class="token punctuation">;</span>
          oldMouseY <span class="token operator">=</span> y<span class="token punctuation">;</span>

          <span class="token comment">// Multiply this movement by a value proportional to the zoom amount</span>
          <span class="token keyword">double</span> multiplier <span class="token operator">=</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">getZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>

          dX <span class="token operator">*=</span> multiplier<span class="token punctuation">;</span>
          dY <span class="token operator">*=</span> multiplier<span class="token punctuation">;</span>

          <span class="token comment">// Translate the camera by the dragged amount</span>
          camera<span class="token punctuation">.</span><span class="token function">translateBy</span><span class="token punctuation">(</span><span class="token operator">-</span>dX <span class="token operator">/</span> <span class="token number">250</span><span class="token punctuation">,</span> <span class="token operator">-</span>dY <span class="token operator">/</span> <span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    subScene<span class="token punctuation">.</span><span class="token function">setOnMouseReleased</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If the left mouse button was released, reset the old drag</span>
        <span class="token comment">// coordinates</span>
        <span class="token keyword">case</span> PRIMARY<span class="token operator">:</span>
          oldMouseX <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
          oldMouseY <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token comment">// If the right mouse button was released, reset pathfinding and move</span>
        <span class="token comment">// units if they were selected</span>
        <span class="token keyword">case</span> SECONDARY<span class="token operator">:</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">resetPathfinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Called by the client to register key handlers. These don't work with the
   * sub-scene.
   *
   * @param scene        scene to add key handlers to
   * @param eventHandler extra event handler for key events
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setScene</span><span class="token punctuation">(</span>
    Scene scene<span class="token punctuation">,</span>
    EventHandler<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> KeyEvent<span class="token operator">></span> eventHandler
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Debug keyboard shortcuts</span>
    scene<span class="token punctuation">.</span><span class="token function">setOnKeyPressed</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Camera rotation for looking around the map</span>
        <span class="token keyword">case</span> W<span class="token operator">:</span>
          camera<span class="token punctuation">.</span><span class="token function">rotateBy</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> S<span class="token operator">:</span>
          camera<span class="token punctuation">.</span><span class="token function">rotateBy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token comment">// Shortcut key to force rerender of all tiles</span>
        <span class="token keyword">case</span> R<span class="token operator">:</span>
          root<span class="token punctuation">.</span><span class="token function">updateTileRenders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Updated tile renders"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Handle extra shortcuts</span>
      eventHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Function called in a separate thread to run the day/night cycle.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">runDayNightCycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Work out the second of the current minute including fractional</span>
        <span class="token comment">// component</span>
        <span class="token keyword">double</span> second <span class="token operator">=</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000.0</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">60.0</span><span class="token punctuation">;</span>

        <span class="token comment">// Set the time on the UI thread as non-UI threads can't update UI</span>
        <span class="token comment">// components</span>
        Platform<span class="token punctuation">.</span><span class="token function">runLater</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">setTime</span><span class="token punctuation">(</span>second <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Try to update the time 30 times-per-second.</span>
        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">/</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the time of day represented by the angle of the sun.
   *
   * @param angle angle of the sun: sunrise(0) - midday (90) - sunset(180)
   *              - midnight (270) - sunrise (360)
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setTime</span><span class="token punctuation">(</span><span class="token keyword">double</span> angle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Update the angle of the sun/moon</span>
    sunMoonRotate<span class="token punctuation">.</span><span class="token function">setAngle</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Calculate the intensity of the sun/moon</span>
    <span class="token keyword">double</span> sunValue <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">toRadians</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> moonValue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> sunValue<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">;</span>

    <span class="token comment">// Calculate/update  the colours of the sun/moon lights</span>
    Color sunColour <span class="token operator">=</span> Color<span class="token punctuation">.</span><span class="token function">color</span><span class="token punctuation">(</span>sunValue<span class="token punctuation">,</span> sunValue<span class="token punctuation">,</span> sunValue <span class="token operator">*</span> <span class="token number">0.95</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Color moonColour <span class="token operator">=</span> Color<span class="token punctuation">.</span><span class="token function">color</span><span class="token punctuation">(</span>moonValue<span class="token punctuation">,</span> moonValue<span class="token punctuation">,</span> moonValue <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    sun<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>sunColour<span class="token punctuation">)</span><span class="token punctuation">;</span>
    moon<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>moonColour<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Update the background colour of the game window</span>
    subScene<span class="token punctuation">.</span><span class="token function">setFill</span><span class="token punctuation">(</span>sunColour<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/ui/Screen.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">;</span>

<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>Scene<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>stage<span class="token punctuation">.</span>Stage<span class="token punctuation">;</span>

<span class="token comment">/**
 * Abstract class representing a screen that can be displayed. Currently there
 * are only two screens, the connection screen and the game screen. The screen
 * should be able to create a JavaFX scene containing the required UI
 * components.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Screen</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Creates a scene representing this screen
   *
   * @param stage  stage the scene would be placed in
   * @param width  width of the screen
   * @param height height of the screen
   * @return scene representing this screen
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">abstract</span> Scene <span class="token function">makeScene</span><span class="token punctuation">(</span>Stage stage<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/ui/UIHelpers.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">;</span>

<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>Node<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>control<span class="token punctuation">.</span>Alert<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>Background<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>BackgroundFill<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>

<span class="token comment">/**
 * Utility class containing common functions used by the UI package.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UIHelpers</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Creates a solid background of a single colour
   *
   * @param colour colour to make the background
   * @return background object filled with the specified colour
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Background <span class="token function">colouredBackground</span><span class="token punctuation">(</span>Color colour<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Background</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BackgroundFill</span><span class="token punctuation">(</span>colour<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Forces the specified CSS class to either be enabled or disabled
   *
   * @param node      node to toggle the class of
   * @param className CSS class to be toggled
   * @param active    whether to enable the class
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">toggleClass</span><span class="token punctuation">(</span>Node node<span class="token punctuation">,</span> String className<span class="token punctuation">,</span> <span class="token keyword">boolean</span> active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Add the class if it's not already there</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">.</span><span class="token function">getStyleClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span><span class="token function">getStyleClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Otherwise remove it</span>
      node<span class="token punctuation">.</span><span class="token function">getStyleClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Show a modal dialog to the user
   *
   * @param message message to show
   * @param isError whether to show an error or information icon
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">showDialog</span><span class="token punctuation">(</span>String message<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create the dialog</span>
    Alert dialog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Alert</span><span class="token punctuation">(</span>
      isError
        <span class="token operator">?</span> Alert<span class="token punctuation">.</span>AlertType<span class="token punctuation">.</span>ERROR
        <span class="token operator">:</span> Alert<span class="token punctuation">.</span>AlertType<span class="token punctuation">.</span>INFORMATION
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    dialog<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>isError <span class="token operator">?</span> <span class="token string">"Error"</span> <span class="token operator">:</span> <span class="token string">"Message"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dialog<span class="token punctuation">.</span><span class="token function">setContentText</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Show the dialog</span>
    dialog<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/CivilisationServer.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>Game<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>MapSize<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Tile<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>Connection<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>Handler<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>Server<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>yaml<span class="token punctuation">.</span>snakeyaml<span class="token punctuation">.</span>Yaml<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>File<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileReader<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileWriter<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token comment">/**
 * Class containing the implementation of the game server.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CivilisationServer</span> <span class="token keyword">implements</span> <span class="token class-name">Handler</span><span class="token generics function"><span class="token punctuation">&lt;</span>Packet<span class="token punctuation">></span></span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Instance of the external library used for saving/parsing YAML game saves.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Yaml YAML <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Yaml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * File for the current game save the server is using
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> File gameFile<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The server instance of the game. Contains all state details but no render
   * references.
   */</span>
  <span class="token keyword">private</span> Game game<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The instance of the generic server for sending/receiving {@link Packet}s.
   */</span>
  <span class="token keyword">private</span> Server<span class="token generics function"><span class="token punctuation">&lt;</span>Packet<span class="token punctuation">></span></span> server<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Creates a completely new game server with the specified details
   *
   * @param gameFileName path for the game save file
   * @param gameName     name of the new game
   * @param mapSize      map size of the new game
   * @param port         port number to run the server on
   * @throws IOException if there are any server networking errors
   */</span>
  <span class="token keyword">public</span> <span class="token function">CivilisationServer</span><span class="token punctuation">(</span>
    String gameFileName<span class="token punctuation">,</span>
    String gameName<span class="token punctuation">,</span>
    MapSize mapSize<span class="token punctuation">,</span>
    <span class="token keyword">int</span> port
  <span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token comment">// Create the reference to the game file</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gameFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>gameFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Create the new game</span>
    game <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Game</span><span class="token punctuation">(</span>gameName<span class="token punctuation">,</span> mapSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Save and then immediately load the game so it's in the same state as if</span>
    <span class="token comment">// it were just loaded (see the 2nd constructor)</span>
    <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Start the server using this instance as the packet handler (See</span>
    <span class="token comment">// accept(Connection&lt;Packet> Packet)).</span>
    server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Server</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Creates a new game server loaded from an existing game save
   *
   * @param gameFileName path of the game save file
   * @param port         port number to run the server on
   * @throws IOException if there are any server networking errors
   */</span>
  <span class="token keyword">public</span> <span class="token function">CivilisationServer</span><span class="token punctuation">(</span>String gameFileName<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token comment">// Create the reference to the game file</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gameFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>gameFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Check the save exists</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>gameFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"game file doesn't exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Load the game</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Start the server using this instance as the packet handler (See</span>
    <span class="token comment">// accept(Connection&lt;Packet> Packet)).</span>
    server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Server</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Closes the server's socket disconnecting all clients
   *
   * @throws IOException if there are any networking errors
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    server<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Saves the game state to the game file
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Try and create a file writer, closing it when the game state has been</span>
    <span class="token comment">// written</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span>FileWriter writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWriter</span><span class="token punctuation">(</span>gameFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Dump the game state as YAML</span>
      YAML<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>game<span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> writer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Loads and overwrites the game state from the game file
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Try and create a file reader, closing it when the game state has been</span>
    <span class="token comment">// read</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span>FileReader reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span>gameFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Read the game state as YAML</span>
      <span class="token comment">//noinspection unchecked</span>
      game <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Game</span><span class="token punctuation">(</span>YAML<span class="token punctuation">.</span><span class="token function">loadAs</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> Map<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Main packet handler for the server
   *
   * @param connection connection object for a client
   * @param data       packet the client has just sent, may be null if the
   *                   client has disconnected
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span>Connection<span class="token generics function"><span class="token punctuation">&lt;</span>Packet<span class="token punctuation">></span></span> connection<span class="token punctuation">,</span> Packet data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Alias the connection id</span>
    String id <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If the player disconnects, mark them as not ready so the game waits</span>
      <span class="token comment">// for them to reconnect</span>
      game<span class="token punctuation">.</span>readyPlayers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Otherwise depending on the type of packet...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">PacketInit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Check if this is the first time the player has joined this game</span>
      <span class="token keyword">boolean</span> shouldCreateStartingPackets <span class="token operator">=</span> <span class="token operator">!</span>game<span class="token punctuation">.</span><span class="token function">containsPlayerWithId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Broadcast the player change to every other client</span>
      PacketPlayerChange packetPlayerChange <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PacketPlayerChange</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      game<span class="token punctuation">.</span><span class="token function">handlePacket</span><span class="token punctuation">(</span>packetPlayerChange<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Send the current game state to the new player</span>
      connection<span class="token punctuation">.</span><span class="token function">broadcastTo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PacketGame</span><span class="token punctuation">(</span>game<span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      connection<span class="token punctuation">.</span><span class="token function">broadcastExcluding</span><span class="token punctuation">(</span>packetPlayerChange<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Create the starting units (initial settler and warrior) if this is the</span>
      <span class="token comment">// first time the player has joined this game.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldCreateStartingPackets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>PacketUnitCreate packet <span class="token operator">:</span> game<span class="token punctuation">.</span><span class="token function">createStartingUnits</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Broadcast them to every client, not just the new player</span>
          connection<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">PacketReady</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Set the players ready state</span>
      game<span class="token punctuation">.</span>readyPlayers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>PacketReady<span class="token punctuation">)</span> data<span class="token punctuation">)</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Check if all players have marked themselves as ready</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>game<span class="token punctuation">.</span><span class="token function">allPlayersReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Handle the turn and request all clients do the same</span>
        PacketReady packetReady <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PacketReady</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        game<span class="token punctuation">.</span><span class="token function">handlePacket</span><span class="token punctuation">(</span>packetReady<span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>packetReady<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">PacketUpdate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If this was a game state update, update the local state</span>
      Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> tilesToUpdate <span class="token operator">=</span> game<span class="token punctuation">.</span><span class="token function">handlePacket</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Check if any units have died and remove them from the game</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tilesToUpdate <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> tilesToUpdate<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Tile tile <span class="token operator">:</span> tilesToUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>tile<span class="token punctuation">.</span>unit <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> tile<span class="token punctuation">.</span>unit<span class="token punctuation">.</span><span class="token function">isDead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            game<span class="token punctuation">.</span>units<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>tile<span class="token punctuation">.</span>unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tile<span class="token punctuation">.</span>unit <span class="token operator">=</span> null<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Send the update to all connected clients but the sender</span>
      connection<span class="token punctuation">.</span><span class="token function">broadcastExcluding</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Save the game state to the file after handling the packet so the game</span>
    <span class="token comment">// can be easily restored</span>
    <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Entry point for a dedicated server (one without a UI/client)
   *
   * @param args command line arguments
   * @throws IOException if there are any server networking errors
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">CivilisationServer</span><span class="token punctuation">(</span>
      <span class="token string">"saves"</span> <span class="token operator">+</span> File<span class="token punctuation">.</span>separator <span class="token operator">+</span> <span class="token string">"game.yml"</span><span class="token punctuation">,</span>
      <span class="token string">"Game"</span><span class="token punctuation">,</span>
      MapSize<span class="token punctuation">.</span>STANDARD<span class="token punctuation">,</span>
      <span class="token number">1234</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/generic/net/Broadcaster.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span>Predicate<span class="token punctuation">;</span>

<span class="token comment">/**
 * Interface describing an object that can send packets to another place.
 *
 * @param &lt;T> type of data to be exchanged over the network
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Broadcaster</span><span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Broadcasts data to all connections
   *
   * @param data data to be sent
   */</span>
  <span class="token keyword">void</span> <span class="token function">broadcast</span><span class="token punctuation">(</span>T data<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Broadcasts data to connections that return true from the predicate
   *
   * @param data data to be sent
   * @param test function to test each connection ID against, if it returns
   *             true, the data is sent to that connection ID
   */</span>
  <span class="token keyword">void</span> <span class="token function">broadcastWhere</span><span class="token punctuation">(</span>T data<span class="token punctuation">,</span> Predicate<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> test<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Broadcasts data to all but the specified ID
   *
   * @param data data to be sent
   * @param id   connection ID to exclude from sending
   */</span>
  <span class="token keyword">void</span> <span class="token function">broadcastExcluding</span><span class="token punctuation">(</span>T data<span class="token punctuation">,</span> String id<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Broadcasts data to only the specified ID
   *
   * @param data data to be sent
   * @param id   connection ID to send to
   */</span>
  <span class="token keyword">void</span> <span class="token function">broadcastTo</span><span class="token punctuation">(</span>T data<span class="token punctuation">,</span> String id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/generic/net/BaseBroadcaster.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">;</span>

<span class="token comment">/**
 * Base class for a broadcaster containing implementations of some of the
 * functions that are the same for every broadcaster.
 *
 * @param &lt;T> type of data to be exchanged over the network
 */</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BaseBroadcaster</span><span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">Broadcaster</span><span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Broadcasts data to all but the specified ID
   * @param data data to be sent
   * @param id connection ID to exclude from sending
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">broadcastExcluding</span><span class="token punctuation">(</span>T data<span class="token punctuation">,</span> String id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">broadcastWhere</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span>testId<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">!</span>testId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Broadcasts data to only the specified ID
   * @param data data to be sent
   * @param id connection ID to send to
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">broadcastTo</span><span class="token punctuation">(</span>T data<span class="token punctuation">,</span> String id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">broadcastWhere</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span>testId<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> testId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/generic/net/Client.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>Socket<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span>Predicate<span class="token punctuation">;</span>

<span class="token comment">/**
 * Generic client class for connecting to a generic server and exchanging data
 *
 * @param &lt;T> type of data to be exchanged over the network
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span><span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">BaseBroadcaster</span><span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Connection object for the client representing the connection to the server
   */</span>
  <span class="token keyword">private</span> Connection<span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> connection<span class="token punctuation">;</span>
  <span class="token comment">/**
   * TCP socket for transferring data to and from the server
   */</span>
  <span class="token keyword">private</span> Socket socket<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Creates a new client and connects to the specified server
   *
   * @param host    host name of the server
   * @param port    port number the server is listening on
   * @param id      id for this connection
   * @param handler data handler for when data is received from the server
   * @throws IOException if there was a connection error
   */</span>
  <span class="token keyword">public</span> <span class="token function">Client</span><span class="token punctuation">(</span>
    String host<span class="token punctuation">,</span>
    <span class="token keyword">int</span> port<span class="token punctuation">,</span>
    String id<span class="token punctuation">,</span>
    Handler<span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> handler
  <span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token comment">// Create the TCP socket</span>
    socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Create a connection object that waits for data from the socket and</span>
    <span class="token comment">// facilitates sending data to the server</span>
    connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Connection</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>
      socket<span class="token punctuation">,</span>
      <span class="token comment">// Set the ID of the connection when one is received</span>
      Connection<span class="token operator">:</span><span class="token operator">:</span>setId<span class="token punctuation">,</span>
      <span class="token punctuation">(</span>connection<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Pass data to the handler if it isn't null</span>
          handler<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Send the desired ID as the first packet</span>
    connection<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Broadcasts data to the server
   *
   * @param data data to be sent
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">broadcast</span><span class="token punctuation">(</span>T data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      connection<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Broadcasts data to to the server if the connection ID matches the
   * predicate
   *
   * @param data data to be sent
   * @param test function to test each connection ID against, if it returns
   *             true, the data is sent to that connection ID
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">broadcastWhere</span><span class="token punctuation">(</span>T data<span class="token punctuation">,</span> Predicate<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> test<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Send the data if the connection ID matches</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        connection<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Closes the client's socket, disconnecting from the server
   *
   * @throws IOException if there was a networking error
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/generic/net/ClientOnly.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">;</span>

<span class="token comment">/**
 * Annotation for marking something as only usable on the client side. Whilst
 * this doesn't actually enforce anything, it serves as an effective marker
 * during development.
 */</span>
<span class="token keyword">public</span> @<span class="token keyword">interface</span> <span class="token class-name">ClientOnly</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/generic/net/Connection.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>ObjectInputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>ObjectOutputStream<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>Socket<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Date<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span>Predicate<span class="token punctuation">;</span>

<span class="token comment">/**
 * Class representing a connection between a client and server or vice-versa
 *
 * @param &lt;T> type of data to be exchanged over the network
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Connection</span><span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">,</span> Broadcaster<span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Stream for sending data to the other side
   */</span>
  <span class="token keyword">private</span> ObjectOutputStream outputStream<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Stream for receiving data from the other side
   */</span>
  <span class="token keyword">private</span> ObjectInputStream inputStream<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Function to be called when an ID is received from the other side
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> IdHandler<span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> idHandler<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Function to be called when data is received from the other side.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Handler<span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> inputHandler<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Whether the connection is open and data is being sent.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> open<span class="token punctuation">;</span>
  <span class="token comment">/**
   * ID of this connection. Used for broadcast targeting.
   */</span>
  <span class="token keyword">private</span> String id<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Thread that checks for data being sent and interprets it.
   */</span>
  <span class="token keyword">private</span> Thread thread<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Broadcaster that actually handles sending data (the client or server)
   */</span>
  <span class="token keyword">private</span> Broadcaster<span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> broadcaster<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Constructor for creating a new connection
   *
   * @param socket       TCP socket for sending/receiving data to/from
   * @param idHandler    function to be called when the connection gets an ID
   * @param inputHandler function to be called when generic data is received
   * @param broadcaster  broadcaster for sending data to other connections
   * @throws IOException if there was an error creating in/output streams
   */</span>
  <span class="token function">Connection</span><span class="token punctuation">(</span>
    Socket socket<span class="token punctuation">,</span>
    IdHandler<span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> idHandler<span class="token punctuation">,</span>
    Handler<span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> inputHandler<span class="token punctuation">,</span>
    Broadcaster<span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> broadcaster
  <span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token comment">// Create streams for the socket</span>
    outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    inputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store handlers</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>idHandler <span class="token operator">=</span> idHandler<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>inputHandler <span class="token operator">=</span> inputHandler<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>broadcaster <span class="token operator">=</span> broadcaster<span class="token punctuation">;</span>

    open <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// Create a new thread that constantly attempts to read data</span>
    thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Connection"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sends the specified data to the receiving end of this connection
   *
   * @param object data to be sent
   * @throws IOException if the data cannot be sent
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span>Object object<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token comment">// Log the send request</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
      <span class="token string">"[%s] %s -> %s"</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      object<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      id
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Send the data and flush the stream so that it's sent immediately</span>
    outputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
    outputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Runner for the input checking thread.
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Keep checking until the socket is closed</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>open<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Read the data, this will block the thread until data is received</span>
        Object object <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Log the incoming data</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
          <span class="token string">"[%s] %s &lt;- %s"</span><span class="token punctuation">,</span>
          <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          object<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          id
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// If an ID hasn't been set yet, assume this is an ID</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          idHandler<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// Otherwise, this is generic data, so handle it accordingly</span>
          <span class="token comment">//noinspection unchecked</span>
          inputHandler<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If there was an error close the connection</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
          <span class="token string">"[%s] Connection with \"%s\" closed: %s"</span><span class="token punctuation">,</span>
          <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          id<span class="token punctuation">,</span>
          e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Send null to the handler to signal the connection closing</span>
        inputHandler<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        open <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets this connection's ID or null if the ID hasn't been set yet
   *
   * @return this connection's ID
   */</span>
  <span class="token keyword">public</span> String <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> id<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets this connection's ID
   *
   * @param id new ID for this connection
   */</span>
  <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span>String id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Connection:"</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Broadcasts data to all connections
   *
   * @param data data to be sent
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">broadcast</span><span class="token punctuation">(</span>T data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    broadcaster<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Broadcasts data to connections that return true from the predicate
   *
   * @param data data to be sent
   * @param test function to test each connection ID against, if it returns
   *             true, the data is sent to that connection ID
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">broadcastWhere</span><span class="token punctuation">(</span>T data<span class="token punctuation">,</span> Predicate<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> test<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    broadcaster<span class="token punctuation">.</span><span class="token function">broadcastWhere</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> test<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Broadcasts data to all but this connection
   *
   * @param data data to be sent
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">broadcastExcluding</span><span class="token punctuation">(</span>T data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    broadcaster<span class="token punctuation">.</span><span class="token function">broadcastExcluding</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Broadcasts data to all but the specified ID
   *
   * @param data data to be sent
   * @param id   connection ID to exclude from sending
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">broadcastExcluding</span><span class="token punctuation">(</span>T data<span class="token punctuation">,</span> String id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    broadcaster<span class="token punctuation">.</span><span class="token function">broadcastExcluding</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Broadcasts data to only this connection
   *
   * @param data data to be sent
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">broadcastTo</span><span class="token punctuation">(</span>T data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    broadcaster<span class="token punctuation">.</span><span class="token function">broadcastTo</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Broadcasts data to only the specified ID
   *
   * @param data data to be sent
   * @param id   connection ID to send to
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">broadcastTo</span><span class="token punctuation">(</span>T data<span class="token punctuation">,</span> String id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    broadcaster<span class="token punctuation">.</span><span class="token function">broadcastTo</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/generic/net/Handler.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">;</span>

<span class="token comment">/**
 * Function to be called when incoming data is received.
 *
 * @param &lt;T> type of data being exchanged over the network
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Handler</span><span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Function called when incoming data is received
   *
   * @param connection the connection this data comes from
   * @param data       the data itself, or null if the connection has closed
   */</span>
  <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span>Connection<span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> connection<span class="token punctuation">,</span> T data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/generic/net/Server.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ServerSocket<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>Socket<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span>Predicate<span class="token punctuation">;</span>

<span class="token comment">/**
 * Generic server class for listening for clients' connections and data
 *
 * @param &lt;T> type of data to be exchanged over the network
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Server</span><span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">BaseBroadcaster</span><span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * TCP server socket to listen for incoming connections on
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> ServerSocket serverSocket<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Handler function for incoming data coming from clients
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Handler<span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> handler<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Map mapping connection IDs to their connection objects
   */</span>
  <span class="token keyword">private</span> HashMap<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Connection<span class="token punctuation">></span></span> connections<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Creates a new server
   *
   * @param port    port number to listen for connections on
   * @param handler function to be called when data is received from a client
   * @throws IOException if the server socket cannot be created (likely
   *                     because the port has already be bound)
   */</span>
  <span class="token keyword">public</span> <span class="token function">Server</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">,</span> Handler<span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token comment">// Create the TCP server socket</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>serverSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Store the handler so it can be called later</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
    <span class="token comment">// Initialise the connections map</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>connections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create a new thread for handling incoming connections from clients</span>
    Thread thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"Server"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Broadcasts data to all connections
   *
   * @param data data to be sent
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">broadcast</span><span class="token punctuation">(</span>T data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">broadcastWhere</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Broadcasts data to connections that return true from the predicate
   *
   * @param data data to be sent
   * @param test function to test each connection ID against, if it returns
   *             true, the data is sent to that connection ID
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">broadcastWhere</span><span class="token punctuation">(</span>T data<span class="token punctuation">,</span> Predicate<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> test<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Connection<span class="token punctuation">></span></span> connection <span class="token operator">:</span> connections<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          connection<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Function that runs the server. Called in a separate thread.
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> open <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// Whilst the socket is open...</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>open<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Listen for new connections, this blocks until a new connection</span>
        <span class="token comment">// request is received or the socket is closed</span>
        Socket socket <span class="token operator">=</span> serverSocket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Create a connection object that waits for data from the socket and</span>
        <span class="token comment">// facilitates sending data to the client</span>
        <span class="token keyword">new</span> <span class="token class-name">Connection</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>
          socket<span class="token punctuation">,</span>
          <span class="token punctuation">(</span>connection<span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token comment">// Set the connection ID when it is sent</span>
            connection<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Store the connection in the map</span>
            connections<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token comment">// Send the server's ID</span>
              connection<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"Server"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>connection<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token comment">// If the connection's been closed (data is null)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// Remove the connection from the map</span>
              connections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Forward the incoming data onto the incoming data handler</span>
            handler<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token keyword">this</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Ignore the error if it was just the socket closing</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"socket closed"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        open <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Closes the servers's socket, disconnecting all connected clients
   *
   * @throws IOException if there was a networking error
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    serverSocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/generic/net/IdHandler.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">;</span>

<span class="token comment">/**
 * Function to be called when a connection receives an ID
 *
 * @param &lt;T> type of data being exchanged over the network
 */</span>
<span class="token keyword">interface</span> <span class="token class-name">IdHandler</span><span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Function called when a connection receives an ID
   *
   * @param connection the connection this ID is for
   * @param data       the request ID for this connection
   */</span>
  <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span>Connection<span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> connection<span class="token punctuation">,</span> String data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/generic/net/ServerOnly.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">;</span>

<span class="token comment">/**
 * Annotation for marking something as only usable on the server side. Whilst
 * this doesn't actually enforce anything, it serves as an effective marker
 * during development.
 */</span>
<span class="token keyword">public</span> @<span class="token keyword">interface</span> <span class="token class-name">ServerOnly</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/generic/render/Render.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">;</span>

<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>Group<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>Node<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>Rotate<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>Scale<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>Translate<span class="token punctuation">;</span>

<span class="token comment">/**
 * Base render object class with default transformations that can be adjusted
 * as required. Extends group so more nodes can be added as children.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Render</span>
  <span class="token keyword">extends</span> <span class="token class-name">Group</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Scale transform for this render object.
   */</span>
  <span class="token keyword">public</span> Scale scale <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Transform for rotations in the X-axis
   */</span>
  <span class="token keyword">public</span> Rotate rotateX <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rotate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Rotate<span class="token punctuation">.</span>X_AXIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Transform for rotations in the Y-axis
   */</span>
  <span class="token keyword">public</span> Rotate rotateY <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rotate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Rotate<span class="token punctuation">.</span>Y_AXIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Transform for rotations in the Z-axis
   */</span>
  <span class="token keyword">public</span> Rotate rotateZ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rotate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Rotate<span class="token punctuation">.</span>Z_AXIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Transform for translations
   */</span>
  <span class="token keyword">public</span> Translate translate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Translate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">Render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Add the transforms so that translations are applied last (means they</span>
    <span class="token comment">// won't affect scaling and rotation)</span>
    <span class="token function">getTransforms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>scale<span class="token punctuation">,</span> rotateX<span class="token punctuation">,</span> rotateY<span class="token punctuation">,</span> rotateZ<span class="token punctuation">,</span> translate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Adds child nodes to this render object
   *
   * @param elements nodes to add
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span>Node<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> elements<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Removes child nodes from this render object
   *
   * @param elements nodes to remove
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span>Node<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> elements<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Resets all the transformations of this render object to their default
   * state.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">translateTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rotateTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scaleTo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Translates this render object to the specified coordinates.
   *
   * @param x new x-coordinate for this render object
   * @param y new y-coordinate for this render object
   * @param z new z-coordinate for this render object
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">translateTo</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">,</span> <span class="token keyword">double</span> y<span class="token punctuation">,</span> <span class="token keyword">double</span> z<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    translate<span class="token punctuation">.</span><span class="token function">setX</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    translate<span class="token punctuation">.</span><span class="token function">setY</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    translate<span class="token punctuation">.</span><span class="token function">setZ</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Rotates this render object to the specified angles in each axis
   *
   * @param xDegrees new x rotation in degrees for this render object
   * @param yDegrees new y rotation in degrees for this render object
   * @param zDegrees new z rotation in degrees for this render object
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">rotateTo</span><span class="token punctuation">(</span>
    <span class="token keyword">double</span> xDegrees<span class="token punctuation">,</span>
    <span class="token keyword">double</span> yDegrees<span class="token punctuation">,</span>
    <span class="token keyword">double</span> zDegrees
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rotateX<span class="token punctuation">.</span><span class="token function">setAngle</span><span class="token punctuation">(</span>xDegrees<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rotateY<span class="token punctuation">.</span><span class="token function">setAngle</span><span class="token punctuation">(</span>yDegrees<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rotateZ<span class="token punctuation">.</span><span class="token function">setAngle</span><span class="token punctuation">(</span>zDegrees<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Scales all axis of this render object to the same factor
   *
   * @param v new scale factor for all axis of this render object
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">scaleTo</span><span class="token punctuation">(</span><span class="token keyword">double</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">scaleTo</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> v<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Scales the render object to the specified scale factors for each axis
   *
   * @param x new scale factor for the x-axis
   * @param y new scale factor for the y-axis
   * @param z new scale factor for the z-axis
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">scaleTo</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">,</span> <span class="token keyword">double</span> y<span class="token punctuation">,</span> <span class="token keyword">double</span> z<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    scale<span class="token punctuation">.</span><span class="token function">setX</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    scale<span class="token punctuation">.</span><span class="token function">setY</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    scale<span class="token punctuation">.</span><span class="token function">setZ</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Translates the render object by the specified amount, adding to the
   * existing values for translation.
   *
   * @param x increase in the x-axis translation amount
   * @param y increase in the y-axis translation amount
   * @param z increase in the z-axis translation amount
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">translateBy</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">,</span> <span class="token keyword">double</span> y<span class="token punctuation">,</span> <span class="token keyword">double</span> z<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Add to the existing values</span>
    translate<span class="token punctuation">.</span><span class="token function">setX</span><span class="token punctuation">(</span>translate<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    translate<span class="token punctuation">.</span><span class="token function">setY</span><span class="token punctuation">(</span>translate<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    translate<span class="token punctuation">.</span><span class="token function">setZ</span><span class="token punctuation">(</span>translate<span class="token punctuation">.</span><span class="token function">getZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Rotates the render object by the specified number of degrees in each axis,
   * adding to the existing values for rotation.
   *
   * @param xDegrees degrees increase in the x-rotation of this object
   * @param yDegrees degrees increase in the y-rotation of this object
   * @param zDegrees degrees increase in the z-rotation of this object
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">rotateBy</span><span class="token punctuation">(</span>
    <span class="token keyword">double</span> xDegrees<span class="token punctuation">,</span>
    <span class="token keyword">double</span> yDegrees<span class="token punctuation">,</span>
    <span class="token keyword">double</span> zDegrees
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Add to the existing values</span>
    rotateX<span class="token punctuation">.</span><span class="token function">setAngle</span><span class="token punctuation">(</span>rotateX<span class="token punctuation">.</span><span class="token function">getAngle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> xDegrees<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rotateY<span class="token punctuation">.</span><span class="token function">setAngle</span><span class="token punctuation">(</span>rotateY<span class="token punctuation">.</span><span class="token function">getAngle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> yDegrees<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rotateZ<span class="token punctuation">.</span><span class="token function">setAngle</span><span class="token punctuation">(</span>rotateZ<span class="token punctuation">.</span><span class="token function">getAngle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> zDegrees<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><h1>com/mrbbot/generic/render/RenderCamera.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">;</span>

<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>PerspectiveCamera<span class="token punctuation">;</span>

<span class="token comment">/**
 * Render object that just contains a camera that handles displaying the
 * rest of the scene.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RenderCamera</span>
  <span class="token keyword">extends</span> <span class="token class-name">Render</span> <span class="token punctuation">{</span>

  <span class="token comment">/**
   * Camera that displays the scene. Can be positioned as if it were on a
   * tripod so that different perspectives of the same scene can be seen.
   */</span>
  PerspectiveCamera camera<span class="token punctuation">;</span>

  <span class="token function">RenderCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the camera</span>
    camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerspectiveCamera</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Give it an initial transformation looking down slightly leant back</span>
    rotateX<span class="token punctuation">.</span><span class="token function">setAngle</span><span class="token punctuation">(</span><span class="token number">220</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    translate<span class="token punctuation">.</span><span class="token function">setZ</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">add</span><span class="token punctuation">(</span>camera<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><h1>com/mrbbot/generic/render/RenderData.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">;</span>

<span class="token comment">/**
 * Render object for that stores some additional data required for rendering.
 * Used by the game's render itself and also for individual tile renders.
 *
 * @param &lt;T> type of the data to be stored along with the render
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RenderData</span><span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span>
  <span class="token keyword">extends</span> <span class="token class-name">Render</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Data that is required for this object to be rendered containing
   * information about how the render should look.
   */</span>
  <span class="token keyword">public</span> T data<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">RenderData</span><span class="token punctuation">(</span>T data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><h1>com/mrbbot/generic/render/RenderRoot.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">;</span>

<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>SceneAntialiasing<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>SubScene<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>

<span class="token comment">/**
 * Root render object that handles creating a sub scene so that other objects
 * added to this can be scene. Also creates the camera for the scene.
 *
 * @param &lt;T> render type that should be the root of the scene where all other
 *            children are added
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RenderRoot</span><span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">Render</span><span class="token operator">></span>
  <span class="token keyword">extends</span> <span class="token class-name">Render</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Root render object of the scene where other children that make up the
   * scene should be added.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> T root<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The camera used for rendering the scene. Can be transformed to see
   * different perspectives.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> RenderCamera camera<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The sub scene that allows the root render object to be visible within a
   * JavaFX applications's scene.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> SubScene subScene<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Creates a new root render object with camera and sub scene
   *
   * @param root   root render object to be rendered by the camera
   * @param width  width of the sub scene
   * @param height height of the sub scene
   */</span>
  <span class="token keyword">public</span> <span class="token function">RenderRoot</span><span class="token punctuation">(</span>T root<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>root <span class="token operator">=</span> root<span class="token punctuation">;</span>

    <span class="token comment">// Creates and adds the camera</span>
    camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RenderCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> camera<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Creates the new sub scene pointing to this as the root</span>
    subScene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SubScene</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">,</span>
      width<span class="token punctuation">,</span>
      height<span class="token punctuation">,</span>
      <span class="token comment">// Enable the depth buffer for 3D support</span>
      <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token comment">// Enable antialiasing for smoother edges on 3D objects</span>
      SceneAntialiasing<span class="token punctuation">.</span>BALANCED
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Set the default background of the scene</span>
    subScene<span class="token punctuation">.</span><span class="token function">setFill</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Set the camera responsible for rendering the scene</span>
    subScene<span class="token punctuation">.</span><span class="token function">setCamera</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>camera<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><h1>com/mrbbot/civilisation/logic/map/Game.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Hexagon<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>HexagonGrid<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>CityBuildable<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>Living<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>Player<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>PlayerStats<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>Mappable<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>TurnHandler<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>techs<span class="token punctuation">.</span>Unlockable<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Building<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>City<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Terrain<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Tile<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>techs<span class="token punctuation">.</span>PlayerTechDetails<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>techs<span class="token punctuation">.</span>Tech<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>Unit<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>UnitAbility<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>UnitType<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ServerOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Point2D<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span>BiConsumer<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span>Consumer<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>Collectors<span class="token punctuation">;</span>

<span class="token comment">/**
 * Main game logic class. Connects other parts of game logic together.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Game</span> <span class="token keyword">implements</span> <span class="token class-name">Mappable</span><span class="token punctuation">,</span> TurnHandler <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Message shown to user if someone wins by putting their cities on every
   * single tile
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String VICTORY_REASON_DOMINATION
    <span class="token operator">=</span> <span class="token string">"conquering every single tile"</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Message shown to user if someone wins by researching, building and
   * launching a rocket unit
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String VICTORY_REASON_SCIENCE
    <span class="token operator">=</span> <span class="token string">"blasting off into space"</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Name of the game, chosen by the user on initial create
   */</span>
  <span class="token keyword">private</span> String name<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Hexagon grid of the game, used for positioning tiles
   */</span>
  <span class="token keyword">public</span> HexagonGrid<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> hexagonGrid<span class="token punctuation">;</span>
  <span class="token comment">/**
   * List of all the cities in the game (regardless of player)
   */</span>
  <span class="token keyword">public</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>City<span class="token punctuation">></span></span> cities<span class="token punctuation">;</span>
  <span class="token comment">/**
   * List of all the units in the game (regardless of player)
   */</span>
  <span class="token keyword">public</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Unit<span class="token punctuation">></span></span> units<span class="token punctuation">;</span>
  <span class="token comment">/**
   * List of all the players in the game
   */</span>
  <span class="token keyword">public</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Player<span class="token punctuation">></span></span> players<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Total amount of science each player has. Maps players' ids to science
   * counts.
   */</span>
  <span class="token keyword">private</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token punctuation">></span></span> playerScienceCounts<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Total amount of gold each player has. Maps players' ids to gold counts.
   */</span>
  <span class="token keyword">private</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token punctuation">></span></span> playerGoldCounts<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Techs unlocked by each player. Map players' ids to sets of unlocked techs.
   * Sets are used as each technology can only be unlocked once by each player.
   */</span>
  <span class="token keyword">private</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Set<span class="token generics function"><span class="token punctuation">&lt;</span>Tech<span class="token punctuation">></span></span><span class="token operator">></span> playerUnlockedTechs<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Techs currently being unlocked by each player. Maps players' ids to techs
   * currently being unlocked.
   */</span>
  <span class="token keyword">private</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Tech<span class="token punctuation">></span></span> playerUnlockingTechs<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Players that have marked themselves as ready. Maps players' ids to their
   * ready state (true = ready).
   */</span>
  <span class="token annotation punctuation">@ServerOnly</span>
  <span class="token keyword">public</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Boolean<span class="token punctuation">></span></span> readyPlayers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * The currently selected unit. Units can be selected by clicking on them.
   */</span>
  <span class="token annotation punctuation">@ClientOnly</span>
  <span class="token keyword">public</span> Unit selectedUnit <span class="token operator">=</span> null<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Whether the game is waiting for other players to click the ready button.
   * This is set to true when the user clicks the "Next Turn" button.
   */</span>
  <span class="token annotation punctuation">@ClientOnly</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> waitingForPlayers <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * The ID of the current player.
   */</span>
  <span class="token annotation punctuation">@ClientOnly</span>
  <span class="token keyword">private</span> String currentPlayerId<span class="token punctuation">;</span>
  <span class="token comment">/**
   * A function to be called whenever the current player's stats (gold/science
   * counts) change.
   */</span>
  <span class="token annotation punctuation">@ClientOnly</span>
  <span class="token keyword">private</span> Consumer<span class="token generics function"><span class="token punctuation">&lt;</span>PlayerStats<span class="token punctuation">></span></span> playerStatsListener<span class="token punctuation">;</span>
  <span class="token comment">/**
   * A function to be called whenever the current player's tech state changes.
   * This may be progress in researching a
   * technology or the actual unlocking of a technology.
   */</span>
  <span class="token annotation punctuation">@ClientOnly</span>
  <span class="token keyword">private</span> Consumer<span class="token generics function"><span class="token punctuation">&lt;</span>PlayerTechDetails<span class="token punctuation">></span></span> techDetailsListener<span class="token punctuation">;</span>
  <span class="token comment">/**
   * A function to be called whenever a message is to be sent to the user. On
   * the client, this is handled by displaying a message box.
   * &lt;p>
   * The first parameter is the message to be displayed, and the second is
   * whether the message is an error or not (true = error).
   */</span>
  <span class="token annotation punctuation">@ClientOnly</span>
  <span class="token keyword">private</span> BiConsumer<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Boolean<span class="token punctuation">></span></span> messageListener<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Constructor for a new game (not loaded from a file)
   *
   * @param name    name of the game
   * @param mapSize size of the game (contains information on width/height)
   */</span>
  <span class="token keyword">public</span> <span class="token function">Game</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> MapSize mapSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Store the name</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>

    <span class="token comment">// Create the hexagon grid</span>
    hexagonGrid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HexagonGrid</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>mapSize<span class="token punctuation">.</span>width<span class="token punctuation">,</span> mapSize<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Create a tile object for every tile in the grid</span>
    hexagonGrid<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_tile<span class="token punctuation">,</span> hex<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
      hexagonGrid<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Tile</span><span class="token punctuation">(</span>hex<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create empty lists</span>
    cities <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    units <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    players <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create empty maps</span>
    playerScienceCounts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    playerGoldCounts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    playerUnlockedTechs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    playerUnlockingTechs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Constructor for a game (loaded from a file/over the network)
   *
   * @param map map containing details of game
   */</span>
  <span class="token keyword">public</span> <span class="token function">Game</span><span class="token punctuation">(</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Load the name of the game</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Load the player list</span>
    <span class="token comment">//noinspection unchecked</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>players <span class="token operator">=</span> <span class="token punctuation">(</span>ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Player<span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>List<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"players"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// Create a new player for each player id</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Player<span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Load the terrain</span>
    <span class="token comment">//noinspection unchecked</span>
    List<span class="token operator">&lt;</span>List<span class="token generics function"><span class="token punctuation">&lt;</span>Double<span class="token punctuation">></span></span><span class="token operator">></span> terrainList <span class="token operator">=</span> <span class="token punctuation">(</span>List<span class="token operator">&lt;</span>List<span class="token generics function"><span class="token punctuation">&lt;</span>Double<span class="token punctuation">></span></span><span class="token operator">></span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"terrain"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//noinspection unchecked</span>
    List<span class="token operator">&lt;</span>List<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">></span></span><span class="token operator">></span> treeList <span class="token operator">=</span> <span class="token punctuation">(</span>List<span class="token operator">&lt;</span>List<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">></span></span><span class="token operator">></span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"trees"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> height <span class="token operator">=</span> terrainList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      List<span class="token generics function"><span class="token punctuation">&lt;</span>Double<span class="token punctuation">></span></span> terrainRow <span class="token operator">=</span> terrainList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
      List<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">></span></span> treeRow <span class="token operator">=</span> treeList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> width <span class="token operator">=</span> terrainRow<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// If the hexagon grid hasn't been initialised yet, we now have all the</span>
      <span class="token comment">// information required to make one</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hexagonGrid <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hexagonGrid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HexagonGrid</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> terrainHeight <span class="token operator">=</span> terrainRow<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> tree <span class="token operator">=</span> treeRow<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token comment">// Put the tile into the grid with the loaded height and tree state</span>
        hexagonGrid<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Tile</span><span class="token punctuation">(</span>
          hexagonGrid<span class="token punctuation">.</span><span class="token function">getHexagon</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span>
          x<span class="token punctuation">,</span> y<span class="token punctuation">,</span>
          terrainHeight<span class="token punctuation">,</span> tree
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Make sure the hexagon grid has been set</span>
    <span class="token keyword">assert</span> hexagonGrid <span class="token operator">!=</span> null<span class="token punctuation">;</span>

    <span class="token comment">// Load the cities</span>
    <span class="token comment">//noinspection unchecked</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cities <span class="token operator">=</span> <span class="token punctuation">(</span>ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>City<span class="token punctuation">></span></span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span><span class="token operator">></span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"cities"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>m <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">City</span><span class="token punctuation">(</span>hexagonGrid<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Load the units</span>
    <span class="token comment">//noinspection unchecked</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>units <span class="token operator">=</span> <span class="token punctuation">(</span>ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Unit<span class="token punctuation">></span></span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span><span class="token operator">></span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"units"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>m <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">Unit</span><span class="token punctuation">(</span>hexagonGrid<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Load player resource counts</span>
    <span class="token comment">//noinspection unchecked</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>playerScienceCounts <span class="token operator">=</span> <span class="token punctuation">(</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token punctuation">></span></span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"science"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//noinspection unchecked</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>playerGoldCounts <span class="token operator">=</span> <span class="token punctuation">(</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token punctuation">></span></span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"gold"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Load player unlocked techs. These are stored as strings by default not</span>
    <span class="token comment">// tech names so have to be converted.</span>
    <span class="token comment">//noinspection unchecked</span>
    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span><span class="token operator">></span> unlockedTechs <span class="token operator">=</span>
      <span class="token punctuation">(</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span><span class="token operator">></span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"unlockedTechs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>playerUnlockedTechs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span><span class="token operator">></span> e <span class="token operator">:</span> unlockedTechs<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Convert the list of strings to a list of techs</span>
      ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tech<span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token punctuation">(</span>ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tech<span class="token punctuation">></span></span><span class="token punctuation">)</span> e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Tech<span class="token operator">:</span><span class="token operator">:</span>fromName<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Store these techs in a set to ensure uniqueness</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>playerUnlockedTechs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>
        e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Load player unlocking techs. Again techs are stored as strings so have</span>
    <span class="token comment">// to be converted.</span>
    <span class="token comment">//noinspection unchecked</span>
    Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">></span></span> unlockingTechs <span class="token operator">=</span>
      <span class="token punctuation">(</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">></span></span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"unlockingTechs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>playerUnlockingTechs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">></span></span> e <span class="token operator">:</span> unlockingTechs<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Store the tech, converting the name to a recognised tech object</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>playerUnlockingTechs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tech<span class="token punctuation">.</span><span class="token function">fromName</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the current player of the game. Also registers the player stats
   * listener so the interface can be updated.
   *
   * @param currentPlayerId     id of the current player
   * @param playerStatsListener function to be called when player stats change
   */</span>
  <span class="token annotation punctuation">@ClientOnly</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCurrentPlayer</span><span class="token punctuation">(</span>
    String currentPlayerId<span class="token punctuation">,</span>
    Consumer<span class="token generics function"><span class="token punctuation">&lt;</span>PlayerStats<span class="token punctuation">></span></span> playerStatsListener
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentPlayerId <span class="token operator">=</span> currentPlayerId<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>playerStatsListener <span class="token operator">=</span> playerStatsListener<span class="token punctuation">;</span>
    <span class="token comment">// Send the initial player stats straight away</span>
    <span class="token function">sendPlayerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Registers the tech details listener.
   *
   * @param techDetailsListener function to be called when tech progress
   *                            changes
   */</span>
  <span class="token annotation punctuation">@ClientOnly</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTechDetailsListener</span><span class="token punctuation">(</span>
    Consumer<span class="token generics function"><span class="token punctuation">&lt;</span>PlayerTechDetails<span class="token punctuation">></span></span> techDetailsListener
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>techDetailsListener <span class="token operator">=</span> techDetailsListener<span class="token punctuation">;</span>
    <span class="token comment">// Send the initial tech details straight away</span>
    <span class="token function">sendTechDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Registers the listener for messages
   *
   * @param messageListener function to be called when a message is sent
   *                        (1st parameter: message, 2nd parameter: isError)
   */</span>
  <span class="token annotation punctuation">@ClientOnly</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMessageListener</span><span class="token punctuation">(</span>BiConsumer<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Boolean<span class="token punctuation">></span></span> messageListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>messageListener <span class="token operator">=</span> messageListener<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sends a message to the client if there is one
   *
   * @param message message to be sent
   * @param isError whether this message represents an error
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span>String message<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Only sends the message if the message listener is defined</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageListener <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>messageListener<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> isError<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sends a message to the client if there is one for a specific user
   *
   * @param forPlayerId id of player to send the message to
   * @param message     message to be sent
   * @param isError     whether this message represents an error
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendMessageTo</span><span class="token punctuation">(</span>
    String forPlayerId<span class="token punctuation">,</span>
    String message<span class="token punctuation">,</span>
    <span class="token keyword">boolean</span> isError
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Only sends the message if the message listener is defined and if the</span>
    <span class="token comment">// current player matches the message recipient</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageListener <span class="token operator">!=</span> null
      <span class="token operator">&amp;&amp;</span> Objects<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>forPlayerId<span class="token punctuation">,</span> currentPlayerId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>messageListener<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> isError<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Stores the game state in a map so that it can be restored later. Used for
   * sending the game state over a network or for storing it in a file.
   *
   * @return map representing the game state
   */</span>
  <span class="token keyword">public</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> <span class="token function">toMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store the game name</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store the list of player ids</span>
    List<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> playerList <span class="token operator">=</span> players<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>player <span class="token operator">-</span><span class="token operator">></span> player<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"players"</span><span class="token punctuation">,</span> playerList<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store the terrain</span>
    ArrayList<span class="token operator">&lt;</span>ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Double<span class="token punctuation">></span></span><span class="token operator">></span> terrainList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ArrayList<span class="token operator">&lt;</span>ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">></span></span><span class="token operator">></span> treeList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> gridWidth <span class="token operator">=</span> hexagonGrid<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> gridHeight <span class="token operator">=</span> hexagonGrid<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> gridHeight<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Double<span class="token punctuation">></span></span> terrainRow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Trees are stored as integers to reduce file size</span>
      ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">></span></span> treeRow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> gridWidth <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Terrain terrain <span class="token operator">=</span> hexagonGrid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTerrain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        terrainRow<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>terrain<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        treeRow<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>terrain<span class="token punctuation">.</span>hasTree <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      terrainList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>terrainRow<span class="token punctuation">)</span><span class="token punctuation">;</span>
      treeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>treeRow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"terrain"</span><span class="token punctuation">,</span> terrainList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"trees"</span><span class="token punctuation">,</span> treeList<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store the cities</span>
    List<span class="token operator">&lt;</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span><span class="token operator">></span> cityList <span class="token operator">=</span> cities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// Delegate to the the city's toMap function to store it</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>City<span class="token operator">:</span><span class="token operator">:</span>toMap<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"cities"</span><span class="token punctuation">,</span> cityList<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store the units</span>
    List<span class="token operator">&lt;</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span><span class="token operator">></span> unitList <span class="token operator">=</span> units<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// Delegate to the the units's toMap function to store it</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Unit<span class="token operator">:</span><span class="token operator">:</span>toMap<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"units"</span><span class="token punctuation">,</span> unitList<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store player science/gold counts</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"science"</span><span class="token punctuation">,</span> playerScienceCounts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"gold"</span><span class="token punctuation">,</span> playerGoldCounts<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store player unlocked techs. As raw techs cannot be stored, these must</span>
    <span class="token comment">// be converted to tech names first.</span>
    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span><span class="token operator">></span> unlockedTechsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Set<span class="token generics function"><span class="token punctuation">&lt;</span>Tech<span class="token punctuation">></span></span><span class="token operator">></span> e <span class="token operator">:</span> playerUnlockedTechs<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      unlockedTechsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>
        e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span><span class="token punctuation">)</span> e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token comment">// Convert the techs to just their names</span>
          <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Tech<span class="token operator">:</span><span class="token operator">:</span>getName<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"unlockedTechs"</span><span class="token punctuation">,</span> unlockedTechsMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store player unlocking techs. Again, raw techs cannot be stored so must</span>
    <span class="token comment">// be converted.</span>
    Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">></span></span> unlockingTechsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Tech<span class="token punctuation">></span></span> e <span class="token operator">:</span> playerUnlockingTechs<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Only store the tech if the player is currently unlocking something</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        unlockingTechsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>
          e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token comment">// Convert the tech to just its name</span>
          e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"unlockingTechs"</span><span class="token punctuation">,</span> unlockingTechsMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> map<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Send a message indicating a player has won the game
   *
   * @param playerId id of the winning player
   * @param reason   reason the player has won the game (one of
   *                 {@link #VICTORY_REASON_DOMINATION} or
   *                 {@link #VICTORY_REASON_SCIENCE})
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">win</span><span class="token punctuation">(</span>String playerId<span class="token punctuation">,</span> String reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Determine whether it's the current player that has won the game</span>
    <span class="token keyword">boolean</span> victory <span class="token operator">=</span> currentPlayerId <span class="token operator">==</span> null
      <span class="token operator">||</span> playerId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>currentPlayerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    String messageStart <span class="token operator">=</span> victory <span class="token operator">?</span> <span class="token string">"Victory!"</span> <span class="token operator">:</span> <span class="token string">"Defeat!"</span><span class="token punctuation">;</span>
    String playerPart <span class="token operator">=</span> playerId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>currentPlayerId<span class="token punctuation">)</span>
      <span class="token operator">?</span> <span class="token string">"You've"</span>
      <span class="token operator">:</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s has"</span><span class="token punctuation">,</span> playerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Send the formatted message</span>
    <span class="token function">sendMessage</span><span class="token punctuation">(</span>
      String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
        <span class="token string">"%s %s won the game by %s!"</span><span class="token punctuation">,</span>
        messageStart<span class="token punctuation">,</span> playerPart<span class="token punctuation">,</span> reason
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token operator">!</span>victory
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Checks if a player has won by covering the map with their cities and sends
   * a victory message if they have.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkDominationVictory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Player id of potential winner</span>
    String playerId <span class="token operator">=</span> null<span class="token punctuation">;</span>

    <span class="token comment">// Create a new iterator to iterate over the hexagon grid</span>
    Iterator<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> tileIterator <span class="token operator">=</span> hexagonGrid<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>tileIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Get the next tile to check</span>
      Tile tile <span class="token operator">=</span> tileIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// If the tile doesn't have a city, then there are tiles that aren't</span>
      <span class="token comment">// covered. In that case, not all tiles are covered by cities.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tile<span class="token punctuation">.</span>city <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token comment">// Set the potential winner to the first tile with a city</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>playerId <span class="token operator">==</span> null<span class="token punctuation">)</span> playerId <span class="token operator">=</span> tile<span class="token punctuation">.</span>city<span class="token punctuation">.</span>player<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
      <span class="token comment">// Check that each subsequent tile with a city is owned by the same</span>
      <span class="token comment">// player</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>playerId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>tile<span class="token punctuation">.</span>city<span class="token punctuation">.</span>player<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// If there was a winning player, send the victory message</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>playerId <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">win</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> VICTORY_REASON_DOMINATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Checks if the player already contains a player with the specified ID
   *
   * @param id id to check
   * @return whether a player with that ID already exists
   */</span>
  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"BooleanMethodIsAlwaysInverted"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">containsPlayerWithId</span><span class="token punctuation">(</span>String id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Player player <span class="token operator">:</span> players<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>player<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * START PACKET HANDLING
   */</span>

  <span class="token comment">/**
   * Creates the unit described by the packet in the tile closest to the
   * desired location
   *
   * @param packet packet containing unit details
   * @return array containing tile the unit was placed on, or null if a tile
   * couldn't be found
   */</span>
  <span class="token keyword">private</span> Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handleUnitCreatePacket</span><span class="token punctuation">(</span>PacketUnitCreate packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// List of already checked tiles</span>
    ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> checkedTiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Queue of tiles to check for placement</span>
    Queue<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> placementTilesToCheck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Add the desired location as the first tile to check</span>
    placementTilesToCheck<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>hexagonGrid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>x<span class="token punctuation">,</span> packet<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// While there are still tiles to check...</span>
    Tile tileToCheck<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tileToCheck <span class="token operator">=</span> placementTilesToCheck<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Determine if the tile is a capital of a city (we don't want to place</span>
      <span class="token comment">// the unit there if it is)</span>
      <span class="token keyword">boolean</span> tileIsCapital <span class="token operator">=</span> tileToCheck<span class="token punctuation">.</span>city <span class="token operator">!=</span> null
        <span class="token operator">&amp;&amp;</span> tileToCheck<span class="token punctuation">.</span>city<span class="token punctuation">.</span><span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">samePositionAs</span><span class="token punctuation">(</span>tileToCheck<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// If it's not a capital, there isn't a unit there, and we can traverse</span>
      <span class="token comment">// it, it's a suitable tile, so break out of the search loop</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tileIsCapital
        <span class="token operator">&amp;&amp;</span> tileToCheck<span class="token punctuation">.</span>unit <span class="token operator">==</span> null
        <span class="token operator">&amp;&amp;</span> tileToCheck<span class="token punctuation">.</span><span class="token function">canTraverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Otherwise mark the tile as checked</span>
      checkedTiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tileToCheck<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Add all of the tiles neighbours that haven't already been checked to</span>
      <span class="token comment">// the queue for checking</span>
      placementTilesToCheck<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>
        hexagonGrid<span class="token punctuation">.</span><span class="token function">getNeighbours</span><span class="token punctuation">(</span>
          tileToCheck<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
          tileToCheck<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
          <span class="token boolean">false</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>tile <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">!</span>checkedTiles<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>tile<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// If a suitable tile was found...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tileToCheck <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Create the unit on that tile</span>
      Player player <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Player</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      Unit unit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Unit</span><span class="token punctuation">(</span>player<span class="token punctuation">,</span> tileToCheck<span class="token punctuation">,</span> packet<span class="token punctuation">.</span><span class="token function">getUnitType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      units<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>unit<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// And update that tile's render</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tile</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>tileToCheck<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Otherwise return null</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Moves a unit described in the packet to a new location, subtracting the
   * amount of movement points required for the operation.
   *
   * @param packet packet containing movement details
   * @return start and end tile of the movement for updating
   */</span>
  <span class="token keyword">private</span> Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handleUnitMovePacket</span><span class="token punctuation">(</span>PacketUnitMove packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get the start/end tiles of the movement</span>
    Tile startTile <span class="token operator">=</span> hexagonGrid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>startX<span class="token punctuation">,</span> packet<span class="token punctuation">.</span>startY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Tile endTile <span class="token operator">=</span> hexagonGrid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>endX<span class="token punctuation">,</span> packet<span class="token punctuation">.</span>endY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Subtract the movement points from the unit's remaining this turn</span>
    startTile<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>remainingMovementPointsThisTurn <span class="token operator">-=</span> packet<span class="token punctuation">.</span>usedMovementPoints<span class="token punctuation">;</span>
    <span class="token comment">// Check the the remaining points aren't negative (should never happen)</span>
    <span class="token keyword">assert</span> startTile<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>remainingMovementPointsThisTurn <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// Move the unit to a new tile, marking the old tile as empty</span>
    startTile<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>tile <span class="token operator">=</span> endTile<span class="token punctuation">;</span>
    endTile<span class="token punctuation">.</span>unit <span class="token operator">=</span> startTile<span class="token punctuation">.</span>unit<span class="token punctuation">;</span>
    startTile<span class="token punctuation">.</span>unit <span class="token operator">=</span> null<span class="token punctuation">;</span>

    <span class="token comment">// Update the start/end tiles</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tile</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>startTile<span class="token punctuation">,</span> endTile<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Deletes the unit described in the packet, removing it from the game.
   *
   * @param packet packet containing deletion details
   * @return tile the unit was previously occupying
   */</span>
  <span class="token keyword">private</span> Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handleUnitDeletePacket</span><span class="token punctuation">(</span>PacketUnitDelete packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get the tile the unit is currently occupying</span>
    Tile tile <span class="token operator">=</span> hexagonGrid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>x<span class="token punctuation">,</span> packet<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get the unit on the tile and check it exists</span>
    Unit unit <span class="token operator">=</span> tile<span class="token punctuation">.</span>unit<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>unit <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If it does, remove it from the tile and the game</span>
      tile<span class="token punctuation">.</span>unit <span class="token operator">=</span> null<span class="token punctuation">;</span>
      units<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tile</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>tile<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Attacks a living object (city/unit) as described by the packet. This may
   * cause the living object and/or the attacker to loose health. If a city was
   * attacked, and it runs out of health, it is given to the player who last
   * attacked it.
   *
   * @param packet packet containing attack details
   * @return tiles the attacker and target are occupying
   */</span>
  <span class="token keyword">private</span> Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handleUnitDamagePacket</span><span class="token punctuation">(</span>PacketDamage packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get the attacker/target tiles</span>
    Tile attackerTile <span class="token operator">=</span> hexagonGrid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>attackerX<span class="token punctuation">,</span> packet<span class="token punctuation">.</span>attackerY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Tile targetTile <span class="token operator">=</span> hexagonGrid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>targetX<span class="token punctuation">,</span> packet<span class="token punctuation">.</span>targetY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Determine if the target is a city</span>
    <span class="token keyword">boolean</span> targetIsCity <span class="token operator">=</span> targetTile<span class="token punctuation">.</span>city <span class="token operator">!=</span> null
      <span class="token operator">&amp;&amp;</span> targetTile<span class="token punctuation">.</span>city<span class="token punctuation">.</span><span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">samePositionAs</span><span class="token punctuation">(</span>targetTile<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get the attacker</span>
    Unit attacker <span class="token operator">=</span> attackerTile<span class="token punctuation">.</span>unit<span class="token punctuation">;</span>
    <span class="token comment">// Get the target, prioritising units over cities if a unit is occupying a</span>
    <span class="token comment">// city (i.e. defending it)</span>
    Living target <span class="token operator">=</span> targetTile<span class="token punctuation">.</span>unit <span class="token operator">==</span> null
      <span class="token operator">?</span> <span class="token punctuation">(</span>targetIsCity <span class="token operator">?</span> targetTile<span class="token punctuation">.</span>city <span class="token operator">:</span> null<span class="token punctuation">)</span>
      <span class="token operator">:</span> targetTile<span class="token punctuation">.</span>unit<span class="token punctuation">;</span>

    <span class="token comment">// Check if the attacker exists and can attack</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>attacker <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>attacker<span class="token punctuation">.</span><span class="token function">canAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token comment">// If the target doesn't exist, send a message stating such</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">sendMessageTo</span><span class="token punctuation">(</span>
        attacker<span class="token punctuation">.</span>player<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        <span class="token string">"You can't attack nothing!"</span><span class="token punctuation">,</span>
        <span class="token boolean">true</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// If the target and attacker are owned by the same player, send a message</span>
    <span class="token comment">// stating such</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>attacker<span class="token punctuation">.</span><span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">sendMessageTo</span><span class="token punctuation">(</span>
        attacker<span class="token punctuation">.</span>player<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        <span class="token string">"You can't attack yourself!"</span><span class="token punctuation">,</span>
        <span class="token boolean">true</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// If the attacker has already attacked this turn, send a message stating</span>
    <span class="token comment">// such</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>attacker<span class="token punctuation">.</span>hasAttackedThisTurn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">sendMessageTo</span><span class="token punctuation">(</span>
        attacker<span class="token punctuation">.</span>player<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        <span class="token string">"You've already attacked this turn!"</span><span class="token punctuation">,</span>
        <span class="token boolean">true</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Get the number of tiles between the attacker and target</span>
    Point2D targetPos <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Point2D attackerPos <span class="token operator">=</span> attacker<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> distanceBetween <span class="token operator">=</span> targetPos<span class="token punctuation">.</span><span class="token function">distance</span><span class="token punctuation">(</span>attackerPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> tilesBetween <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>distanceBetween <span class="token operator">/</span> Hexagon<span class="token punctuation">.</span>SQRT_3<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Check if a melee attack could take place, if so, perform it</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      attacker<span class="token punctuation">.</span><span class="token function">hasAbility</span><span class="token punctuation">(</span>UnitAbility<span class="token punctuation">.</span>ABILITY_ATTACK<span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> tilesBetween <span class="token operator">&lt;=</span> <span class="token number">1</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      target<span class="token punctuation">.</span><span class="token function">onAttacked</span><span class="token punctuation">(</span>attacker<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      attacker<span class="token punctuation">.</span>hasAttackedThisTurn <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Check if a ranged attack could take place, if so, perform it</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      attacker<span class="token punctuation">.</span><span class="token function">hasAbility</span><span class="token punctuation">(</span>UnitAbility<span class="token punctuation">.</span>ABILITY_RANGED_ATTACK<span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> tilesBetween <span class="token operator">&lt;=</span> <span class="token number">2</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      target<span class="token punctuation">.</span><span class="token function">onAttacked</span><span class="token punctuation">(</span>attacker<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      attacker<span class="token punctuation">.</span>hasAttackedThisTurn <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Check if the target is a city, if it is and is now dead, give the city</span>
    <span class="token comment">// to the player that attacked it last</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token keyword">instanceof</span> <span class="token class-name">City</span> <span class="token operator">&amp;&amp;</span> target<span class="token punctuation">.</span><span class="token function">isDead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      City targetCity <span class="token operator">=</span> <span class="token punctuation">(</span>City<span class="token punctuation">)</span> target<span class="token punctuation">;</span>
      <span class="token comment">// Increase the cities health</span>
      targetCity<span class="token punctuation">.</span><span class="token function">setHealth</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Set the city's owner</span>
      targetCity<span class="token punctuation">.</span><span class="token function">setOwner</span><span class="token punctuation">(</span>targetCity<span class="token punctuation">.</span>lastAttacker<span class="token punctuation">.</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Check for a domination victory</span>
      <span class="token function">checkDominationVictory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Mark every tile for update (re-rendering city walls)</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tile</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Mark the attacker and target tile for update</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tile</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>attackerTile<span class="token punctuation">,</span> targetTile<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Creates a city at the location described by the packet.
   *
   * @param packet packet containing city creation information
   * @return an empty array of tiles signalling that all tiles should be
   * updated
   */</span>
  <span class="token keyword">private</span> Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handleCityCreatePacket</span><span class="token punctuation">(</span>PacketCityCreate packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Player player <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Player</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Create the new city</span>
    cities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">City</span><span class="token punctuation">(</span>hexagonGrid<span class="token punctuation">,</span> packet<span class="token punctuation">.</span>x<span class="token punctuation">,</span> packet<span class="token punctuation">.</span>y<span class="token punctuation">,</span> player<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Recalculate player stats with this new city in place</span>
    <span class="token function">sendPlayerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Signal an update of every tile</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tile</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Grows a city to a specific set of points
   *
   * @param packet packet containing locations of points to grow to
   * @return an empty array of tiles signalling that all tiles should be
   * updated
   */</span>
  <span class="token keyword">private</span> Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handleCityGrowPacket</span><span class="token punctuation">(</span>PacketCityGrow packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get tile with city</span>
    Tile t <span class="token operator">=</span> hexagonGrid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>x<span class="token punctuation">,</span> packet<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>city <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      t<span class="token punctuation">.</span>city<span class="token punctuation">.</span><span class="token function">growTo</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span><span class="token function">getGrownTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Recalculate player stats with new tiles</span>
    <span class="token function">sendPlayerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Signal an update of every tile</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tile</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Renames a city described by the packet
   *
   * @param packet packet containing rename information
   * @return null signalling no tiles need to be updated
   */</span>
  <span class="token keyword">private</span> Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handleCityRenamePacket</span><span class="token punctuation">(</span>PacketCityRename packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get tile with city</span>
    Tile t <span class="token operator">=</span> hexagonGrid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>x<span class="token punctuation">,</span> packet<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>city <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Rename the city</span>
      t<span class="token punctuation">.</span>city<span class="token punctuation">.</span>name <span class="token operator">=</span> packet<span class="token punctuation">.</span>newName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// No need to update any tiles</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Requests that a city start building something or purchase an item with
   * gold.
   *
   * @param packet packet containing build information
   * @return an array of tiles to be updated, or null if no tiles are to be
   * updated
   */</span>
  <span class="token keyword">private</span> Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handleCityBuildRequestPacket</span><span class="token punctuation">(</span>PacketCityBuildRequest packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get tile with city</span>
    Tile t <span class="token operator">=</span> hexagonGrid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>x<span class="token punctuation">,</span> packet<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>city <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Get thing to be built by the city</span>
      CityBuildable buildable <span class="token operator">=</span> packet<span class="token punctuation">.</span><span class="token function">getBuildable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// If the city is going to build this with production...</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>packet<span class="token punctuation">.</span>withProduction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Mark it as the current build</span>
        t<span class="token punctuation">.</span>city<span class="token punctuation">.</span>currentlyBuilding <span class="token operator">=</span> buildable<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token comment">// Otherwise if they can afford to buy it with gold</span>
        buildable<span class="token punctuation">.</span><span class="token function">canBuildWithGold</span><span class="token punctuation">(</span><span class="token function">getPlayerGoldTotal</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>city<span class="token punctuation">.</span>player<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Subtract that amount from the player's gold balance</span>
        <span class="token function">increasePlayerGoldBy</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>city<span class="token punctuation">.</span>player<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token operator">-</span>buildable<span class="token punctuation">.</span><span class="token function">getGoldCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Build the thing, getting the tile that was updated</span>
        Tile placed <span class="token operator">=</span> buildable<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>city<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// If there was an update, return it</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>placed <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tile</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>placed<span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// No need to update any tiles</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Requests that a worker build an improvement on a tile
   *
   * @param packet packet describing the improvement request
   * @return tiles updated by the improvement or null if no tiles are to be
   * updated
   */</span>
  <span class="token keyword">private</span> Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handleWorkerImproveRequestPacket</span><span class="token punctuation">(</span>
    PacketWorkerImproveRequest packet
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get the tile containing the worker</span>
    Tile t <span class="token operator">=</span> hexagonGrid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>x<span class="token punctuation">,</span> packet<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>unit <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Request that the worker start building the improvement</span>
      t<span class="token punctuation">.</span>unit<span class="token punctuation">.</span><span class="token function">startWorkerBuilding</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span><span class="token function">getImprovement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Return the updated tile</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tile</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>t<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Otherwise, no need to update any tiles</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Requests that a player start researching a new technology
   *
   * @param packet packet describing the research request
   * @return null as no tiles need to be updated
   */</span>
  <span class="token keyword">private</span> Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handlePlayerResearchRequestPacket</span><span class="token punctuation">(</span>
    PacketPlayerResearchRequest packet
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Set the unlocking tech to the one described in the packet</span>
    playerUnlockingTechs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>playerId<span class="token punctuation">,</span> packet<span class="token punctuation">.</span><span class="token function">getTech</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Update the UI to reflect this change</span>
    <span class="token function">sendTechDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Upgrades a unit to a more advanced type with better abilities.
   *
   * @param packet packet describing the upgrade request
   * @return array of tiles to be updated or null if no tiles need to be
   */</span>
  <span class="token keyword">private</span> Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handleUnitUpgradePacket</span><span class="token punctuation">(</span>PacketUnitUpgrade packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get te tile containing the unit to be upgraded</span>
    Tile t <span class="token operator">=</span> hexagonGrid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>x<span class="token punctuation">,</span> packet<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Check the unit can be upgraded</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>unit <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> t<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>unitType<span class="token punctuation">.</span><span class="token function">getUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Upgrade the unit</span>
      t<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>unitType <span class="token operator">=</span> t<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>unitType<span class="token punctuation">.</span><span class="token function">getUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Set the new health proportional to its current health</span>
      t<span class="token punctuation">.</span>unit<span class="token punctuation">.</span><span class="token function">setBaseHealth</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>unitType<span class="token punctuation">.</span><span class="token function">getBaseHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tile</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>t<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Brings a tile adjacent a city into that city's territory using gold.
   *
   * @param packet packet describing the purchase request
   * @return empty array signalling all tiles should be updated or null if the
   * tile couldn't be bought
   */</span>
  <span class="token keyword">private</span> Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handlePurchaseTileRequestPacket</span><span class="token punctuation">(</span>
    PacketPurchaseTileRequest packet
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get the capital tile for the target city</span>
    Tile t <span class="token operator">=</span> hexagonGrid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>cityX<span class="token punctuation">,</span> packet<span class="token punctuation">.</span>cityY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>city <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Get the id of the city owner</span>
      String playerId <span class="token operator">=</span> t<span class="token punctuation">.</span>city<span class="token punctuation">.</span>player<span class="token punctuation">.</span>id<span class="token punctuation">;</span>

      <span class="token comment">// Get the tile requested to be purchased</span>
      Tile purchaseTile <span class="token operator">=</span> hexagonGrid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>purchaseX<span class="token punctuation">,</span> packet<span class="token punctuation">.</span>purchaseY<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Check if the tile is already part of a city, if it is, send a message</span>
      <span class="token comment">// stating such</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>purchaseTile<span class="token punctuation">.</span>city <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sendMessageTo</span><span class="token punctuation">(</span>
          playerId<span class="token punctuation">,</span>
          <span class="token string">"This tile is already part of a city!"</span><span class="token punctuation">,</span>
          <span class="token boolean">true</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Check the tile is adjacent to the cities borders</span>
      ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> neighbours <span class="token operator">=</span> hexagonGrid<span class="token punctuation">.</span><span class="token function">getNeighbours</span><span class="token punctuation">(</span>
        packet<span class="token punctuation">.</span>purchaseX<span class="token punctuation">,</span>
        packet<span class="token punctuation">.</span>purchaseY<span class="token punctuation">,</span>
        <span class="token boolean">false</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">boolean</span> isNeighbour <span class="token operator">=</span> neighbours<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>tile <span class="token operator">-</span><span class="token operator">></span> tile<span class="token punctuation">.</span>city <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> tile<span class="token punctuation">.</span>city<span class="token punctuation">.</span><span class="token function">sameCenterAs</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>city<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// If it's not, send a message stating such</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isNeighbour<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sendMessageTo</span><span class="token punctuation">(</span>
          playerId<span class="token punctuation">,</span>
          <span class="token string">"This tile isn't adjacent to this city!"</span><span class="token punctuation">,</span>
          <span class="token boolean">true</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Calculate the gold cost of purchasing the tile based on the tile</span>
      <span class="token comment">// distance between it and the city center</span>
      <span class="token keyword">double</span> distanceBetween <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">getHexagon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">distance</span><span class="token punctuation">(</span>purchaseTile<span class="token punctuation">.</span><span class="token function">getHexagon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> tilesBetween <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>distanceBetween <span class="token operator">/</span> Hexagon<span class="token punctuation">.</span>SQRT_3<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">double</span> cost <span class="token operator">=</span> <span class="token number">50.0</span> <span class="token operator">*</span> tilesBetween<span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>Building building <span class="token operator">:</span> t<span class="token punctuation">.</span>city<span class="token punctuation">.</span>buildings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cost <span class="token operator">*=</span> building<span class="token punctuation">.</span>expansionCostMultiplier<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">int</span> goldTotal <span class="token operator">=</span> <span class="token function">getPlayerGoldTotal</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>city<span class="token punctuation">.</span>player<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> roundCost <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>cost<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// If the player doesn't have enough money to buy the tile, send them a</span>
      <span class="token comment">// message stating such</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>goldTotal <span class="token operator">&lt;</span> roundCost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sendMessageTo</span><span class="token punctuation">(</span>
          playerId<span class="token punctuation">,</span>
          String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
            <span class="token string">"This tile costs %d gold to purchase, you only have %d!"</span><span class="token punctuation">,</span>
            roundCost<span class="token punctuation">,</span>
            goldTotal
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token boolean">true</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Otherwise, decrease the players gold count by that amount</span>
      <span class="token function">increasePlayerGoldBy</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> <span class="token operator">-</span>roundCost<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ...and grow the city to encompass that tile</span>
      ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Point2D<span class="token punctuation">></span></span> grownTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      grownTo<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Point2D</span><span class="token punctuation">(</span>purchaseTile<span class="token punctuation">.</span>x<span class="token punctuation">,</span> purchaseTile<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      t<span class="token punctuation">.</span>city<span class="token punctuation">.</span><span class="token function">growTo</span><span class="token punctuation">(</span>grownTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Update all tiles to regenerate city walls</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tile</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Main turn handler for the game. Updates units (health, attack state,
   * remaining movement), cities (health, build progress) and players
   * (research).
   *
   * @param game game to update (redundant but required by the
   *             {@link TurnHandler} interface)
   * @return an array of tiles to be updated
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handleTurn</span><span class="token punctuation">(</span>Game game<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> updatedTiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Update units</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Unit unit <span class="token operator">:</span> units<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> unitUpdatedTiles <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">handleTurn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Add updated tiles to the list</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>unitUpdatedTiles <span class="token operator">!=</span> null<span class="token punctuation">)</span>
        Collections<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>updatedTiles<span class="token punctuation">,</span> unitUpdatedTiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Update cities</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>City city <span class="token operator">:</span> cities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Add updated tiles to the list</span>
      Collections<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>updatedTiles<span class="token punctuation">,</span> city<span class="token punctuation">.</span><span class="token function">handleTurn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// If the city was low on health, and was healed, add the center to the</span>
      <span class="token comment">// update list (for health bar re-render)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>city<span class="token punctuation">.</span><span class="token function">naturalHeal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        updatedTiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>city<span class="token punctuation">.</span><span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Reset ready states</span>
    waitingForPlayers <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    readyPlayers<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Check to see if a player has won from a city growing</span>
    <span class="token function">checkDominationVictory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Send player stats and tech details</span>
    <span class="token function">sendPlayerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sendTechDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Update required tiles</span>
    <span class="token keyword">return</span> updatedTiles<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Tile</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Packet handler. Delegates handling to one of the methods in this class
   * depending on the packet type.
   *
   * @param packet packet to process
   * @return an array of tiles to rerender, if empty, should rerender all
   * tiles, if null, should rerender no tiles
   */</span>
  <span class="token keyword">public</span> Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handlePacket</span><span class="token punctuation">(</span>Packet packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Checks the type of the packet and handles it accordingly</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>packet <span class="token keyword">instanceof</span> <span class="token class-name">PacketPlayerChange</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      String newId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>PacketPlayerChange<span class="token punctuation">)</span> packet<span class="token punctuation">)</span><span class="token punctuation">.</span>id<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">containsPlayerWithId</span><span class="token punctuation">(</span>newId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        players<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Player</span><span class="token punctuation">(</span>newId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>packet <span class="token keyword">instanceof</span> <span class="token class-name">PacketCityCreate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">handleCityCreatePacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PacketCityCreate<span class="token punctuation">)</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>packet <span class="token keyword">instanceof</span> <span class="token class-name">PacketCityGrow</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">handleCityGrowPacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PacketCityGrow<span class="token punctuation">)</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>packet <span class="token keyword">instanceof</span> <span class="token class-name">PacketUnitCreate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">handleUnitCreatePacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PacketUnitCreate<span class="token punctuation">)</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>packet <span class="token keyword">instanceof</span> <span class="token class-name">PacketUnitMove</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">handleUnitMovePacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PacketUnitMove<span class="token punctuation">)</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>packet <span class="token keyword">instanceof</span> <span class="token class-name">PacketUnitDelete</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">handleUnitDeletePacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PacketUnitDelete<span class="token punctuation">)</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>packet <span class="token keyword">instanceof</span> <span class="token class-name">PacketDamage</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">handleUnitDamagePacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PacketDamage<span class="token punctuation">)</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>packet <span class="token keyword">instanceof</span> <span class="token class-name">PacketCityRename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">handleCityRenamePacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PacketCityRename<span class="token punctuation">)</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>packet <span class="token keyword">instanceof</span> <span class="token class-name">PacketCityBuildRequest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">handleCityBuildRequestPacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PacketCityBuildRequest<span class="token punctuation">)</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>packet <span class="token keyword">instanceof</span> <span class="token class-name">PacketWorkerImproveRequest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">handleWorkerImproveRequestPacket</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>PacketWorkerImproveRequest<span class="token punctuation">)</span> packet
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>packet <span class="token keyword">instanceof</span> <span class="token class-name">PacketPlayerResearchRequest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">handlePlayerResearchRequestPacket</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>PacketPlayerResearchRequest<span class="token punctuation">)</span> packet
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>packet <span class="token keyword">instanceof</span> <span class="token class-name">PacketUnitUpgrade</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">handleUnitUpgradePacket</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PacketUnitUpgrade<span class="token punctuation">)</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>packet <span class="token keyword">instanceof</span> <span class="token class-name">PacketPurchaseTileRequest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">handlePurchaseTileRequestPacket</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>PacketPurchaseTileRequest<span class="token punctuation">)</span> packet
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>packet <span class="token keyword">instanceof</span> <span class="token class-name">PacketBlastOff</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">win</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PacketBlastOff<span class="token punctuation">)</span> packet<span class="token punctuation">)</span><span class="token punctuation">.</span>playerId<span class="token punctuation">,</span> VICTORY_REASON_SCIENCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>packet <span class="token keyword">instanceof</span> <span class="token class-name">PacketReady</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">handleTurn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/*
   * END PACKET HANDLING
   */</span>

  <span class="token comment">/**
   * Calculates the player's gold/science per turn and sends them along with
   * the gold total.
   */</span>
  <span class="token annotation punctuation">@ClientOnly</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendPlayerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPlayerId <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> playerStatsListener <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">int</span> totalSciencePerTurn <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> totalGoldPerTurn <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>City city <span class="token operator">:</span> cities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>city<span class="token punctuation">.</span>player<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>currentPlayerId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          totalSciencePerTurn <span class="token operator">+=</span> city<span class="token punctuation">.</span><span class="token function">getSciencePerTurn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          totalGoldPerTurn <span class="token operator">+=</span> city<span class="token punctuation">.</span><span class="token function">getGoldPerTurn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      playerStatsListener<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PlayerStats</span><span class="token punctuation">(</span>
        totalSciencePerTurn<span class="token punctuation">,</span>
        <span class="token function">getPlayerGoldTotal</span><span class="token punctuation">(</span>currentPlayerId<span class="token punctuation">)</span><span class="token punctuation">,</span>
        totalGoldPerTurn
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sends the current players unlocked techs, and the currently researching
   * tech with its progress.
   */</span>
  <span class="token annotation punctuation">@ClientOnly</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendTechDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPlayerId <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> techDetailsListener <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      techDetailsListener<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PlayerTechDetails</span><span class="token punctuation">(</span>
        <span class="token function">getPlayerUnlockedTechs</span><span class="token punctuation">(</span>currentPlayerId<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">getPlayerUnlockingTech</span><span class="token punctuation">(</span>currentPlayerId<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">getPlayerUnlockingProgress</span><span class="token punctuation">(</span>currentPlayerId<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Creates the packets for creating a player's starting units
   *
   * @param playerId player id to create units for
   * @return packets that create the starting units
   */</span>
  <span class="token annotation punctuation">@ServerOnly</span>
  <span class="token keyword">public</span> PacketUnitCreate<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">createStartingUnits</span><span class="token punctuation">(</span>String playerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Calculate the coordinate of the starting location based on the number</span>
    <span class="token comment">// of players already in the game</span>
    <span class="token keyword">int</span> numPlayers <span class="token operator">=</span> players<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> gridWidth <span class="token operator">=</span> hexagonGrid<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> gridHeight <span class="token operator">=</span> hexagonGrid<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> x <span class="token operator">=</span> gridWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> y <span class="token operator">=</span> gridHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>numPlayers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
        x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        y <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
        x <span class="token operator">=</span> gridWidth <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>
        y <span class="token operator">=</span> gridHeight <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
        x <span class="token operator">=</span> gridWidth <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>
        y <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
        x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        y <span class="token operator">=</span> gridHeight <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Create the packets</span>
    PacketUnitCreate<span class="token punctuation">[</span><span class="token punctuation">]</span> packetUnitCreates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PacketUnitCreate</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
      <span class="token keyword">new</span> <span class="token class-name">PacketUnitCreate</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> UnitType<span class="token punctuation">.</span>SETTLER<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">PacketUnitCreate</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> UnitType<span class="token punctuation">.</span>WARRIOR<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// Handle them (server side only)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>PacketUnitCreate packetUnitCreate <span class="token operator">:</span> packetUnitCreates<span class="token punctuation">)</span>
      <span class="token function">handlePacket</span><span class="token punctuation">(</span>packetUnitCreate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Return them so they can be sent to the clients</span>
    <span class="token keyword">return</span> packetUnitCreates<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Checks whether all players have marked themselves as ready
   *
   * @return whether all players have clicked the "Next Turn" button
   */</span>
  <span class="token annotation punctuation">@ServerOnly</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">allPlayersReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Player player <span class="token operator">:</span> players<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>readyPlayers<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>player<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the techs researched by the specified player
   *
   * @param playerId id of the player to check the techs of
   * @return researched techs by that player
   */</span>
  <span class="token keyword">public</span> Set<span class="token generics function"><span class="token punctuation">&lt;</span>Tech<span class="token punctuation">></span></span> <span class="token function">getPlayerUnlockedTechs</span><span class="token punctuation">(</span>String playerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> playerUnlockedTechs<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the tech currently being researched by the specified player
   *
   * @param playerId id of the player to check the tech of
   * @return currently researching tech of that player, or null if they're not
   * researching anything
   */</span>
  <span class="token keyword">public</span> Tech <span class="token function">getPlayerUnlockingTech</span><span class="token punctuation">(</span>String playerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> playerUnlockingTechs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>playerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the progress through the research stage the specified player is
   *
   * @param playerId id of the player to check the progress of
   * @return progress of the currently researching tech, or 0 if not currently
   * researching
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getPlayerUnlockingProgress</span><span class="token punctuation">(</span>String playerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get the current tech, and check it exists</span>
    Tech unlockingTech <span class="token operator">=</span> <span class="token function">getPlayerUnlockingTech</span><span class="token punctuation">(</span>playerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>unlockingTech <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> scienceTotal <span class="token operator">=</span> <span class="token function">getPlayerScienceTotal</span><span class="token punctuation">(</span>playerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> scienceCost <span class="token operator">=</span> unlockingTech<span class="token punctuation">.</span><span class="token function">getScienceCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>scienceCost <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// Calculate the percent unlock, clamping the value to 1</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> scienceTotal <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> scienceCost<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Check whether a player has unlocked the specified item
   *
   * @param playerId   id of the player to check
   * @param unlockable unlockable item to check if unlocked
   * @return whether the item has been unlocked
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">playerHasUnlocked</span><span class="token punctuation">(</span>String playerId<span class="token punctuation">,</span> Unlockable unlockable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get the unlock id of the item, and check it's not unlocked by default</span>
    <span class="token keyword">int</span> unlockId <span class="token operator">=</span> unlockable<span class="token punctuation">.</span><span class="token function">getUnlockId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>unlockId <span class="token operator">==</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// Get the player's unlocked techs</span>
    Set<span class="token generics function"><span class="token punctuation">&lt;</span>Tech<span class="token punctuation">></span></span> unlockedTechs <span class="token operator">=</span> <span class="token function">getPlayerUnlockedTechs</span><span class="token punctuation">(</span>playerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Tech unlockedTech <span class="token operator">:</span> unlockedTechs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Check if the tech includes the specified unlockable</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>Unlockable unlock <span class="token operator">:</span> unlockedTech<span class="token punctuation">.</span><span class="token function">getUnlocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>unlock<span class="token punctuation">.</span><span class="token function">getUnlockId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> unlockId<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets a player resource count with a default value of 0
   *
   * @param counts   map containing player resource information
   * @param playerId id of the player to get the value of
   * @return player's count of that resource
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">getPlayerResource</span><span class="token punctuation">(</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token punctuation">></span></span> counts<span class="token punctuation">,</span> String playerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> counts<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets a players gold total with a default value of 0
   *
   * @param playerId id of the player to get the value of
   * @return player's gold total
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPlayerGoldTotal</span><span class="token punctuation">(</span>String playerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getPlayerResource</span><span class="token punctuation">(</span>playerGoldCounts<span class="token punctuation">,</span> playerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets a players science total with a default value of 0
   *
   * @param playerId id of the player to get the value of
   * @return player's science total
   */</span>
  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"WeakerAccess"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPlayerScienceTotal</span><span class="token punctuation">(</span>String playerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getPlayerResource</span><span class="token punctuation">(</span>playerScienceCounts<span class="token punctuation">,</span> playerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Increases a player's resource count by the specified amount
   *
   * @param counts   map containing player resource information
   * @param playerId id of the player to increase
   * @param amount   amount to increase by (can be negative)
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">increasePlayerResourceBy</span><span class="token punctuation">(</span>
    Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token punctuation">></span></span> counts<span class="token punctuation">,</span>
    String playerId<span class="token punctuation">,</span>
    <span class="token keyword">int</span> amount
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>counts<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>playerId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      counts<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> counts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>playerId<span class="token punctuation">)</span> <span class="token operator">+</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      counts<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">sendPlayerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Increases a player's gold total by the specified amount
   *
   * @param playerId id of the player to increase
   * @param gold     amount to increase by (can be negative)
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increasePlayerGoldBy</span><span class="token punctuation">(</span>String playerId<span class="token punctuation">,</span> <span class="token keyword">int</span> gold<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">increasePlayerResourceBy</span><span class="token punctuation">(</span>playerGoldCounts<span class="token punctuation">,</span> playerId<span class="token punctuation">,</span> gold<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Increases a player's science total by the specified amount
   *
   * @param playerId id of the player to increase
   * @param science  amount to increase by (can be negative)
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increasePlayerScienceBy</span><span class="token punctuation">(</span>String playerId<span class="token punctuation">,</span> <span class="token keyword">int</span> science<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">increasePlayerResourceBy</span><span class="token punctuation">(</span>playerScienceCounts<span class="token punctuation">,</span> playerId<span class="token punctuation">,</span> science<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get player's technology details</span>
    Set<span class="token generics function"><span class="token punctuation">&lt;</span>Tech<span class="token punctuation">></span></span> unlockedTechs <span class="token operator">=</span> <span class="token function">getPlayerUnlockedTechs</span><span class="token punctuation">(</span>playerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Tech unlockingTech <span class="token operator">=</span> <span class="token function">getPlayerUnlockingTech</span><span class="token punctuation">(</span>playerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> progress <span class="token operator">=</span> <span class="token function">getPlayerUnlockingProgress</span><span class="token punctuation">(</span>playerId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Check if a tech has now been unlocked</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>unlockingTech <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> progress <span class="token operator">>=</span> <span class="token number">1</span>
      <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>unlockedTechs<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>unlockingTech<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Unlock the tech if it has</span>
      playerUnlockedTechs<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      playerUnlockedTechs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>playerId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>unlockingTech<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Reset the current research</span>
      playerUnlockingTechs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Reduce science by the cost of the tech</span>
      <span class="token function">increasePlayerResourceBy</span><span class="token punctuation">(</span>
        playerScienceCounts<span class="token punctuation">,</span>
        playerId<span class="token punctuation">,</span>
        <span class="token operator">-</span>unlockingTech<span class="token punctuation">.</span><span class="token function">getScienceCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Send a message to the player</span>
      <span class="token function">sendMessageTo</span><span class="token punctuation">(</span>
        playerId<span class="token punctuation">,</span>
        String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s has been unlocked!"</span><span class="token punctuation">,</span> unlockingTech<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token boolean">false</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets a player's cities
   *
   * @param id id of the player to get cities of
   * @return list of cities belonging to the player
   */</span>
  <span class="token keyword">public</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>City<span class="token punctuation">></span></span> <span class="token function">getPlayersCitiesById</span><span class="token punctuation">(</span>String id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>City<span class="token punctuation">></span></span><span class="token punctuation">)</span> cities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>city <span class="token operator">-</span><span class="token operator">></span> city<span class="token punctuation">.</span>player<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/logic/map/MapSize.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">;</span>

<span class="token comment">/**
 * Enum for the different sizes a a map can be, used by the host/join screen to
 * list available sizes.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> MapSize <span class="token punctuation">{</span>
  <span class="token function">TINY</span><span class="token punctuation">(</span><span class="token string">"Tiny"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">SMALL</span><span class="token punctuation">(</span><span class="token string">"Small"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">STANDARD</span><span class="token punctuation">(</span><span class="token string">"Standard"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">LARGE</span><span class="token punctuation">(</span><span class="token string">"Large"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * User facing name of the map size
   */</span>
  <span class="token keyword">public</span> String name<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Width of the hexagon grid for this size
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> width<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Height of the hexagon grid for this size
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> height<span class="token punctuation">;</span>

  <span class="token function">MapSize</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/logic/techs/PlayerTechDetails.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>techs<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Set<span class="token punctuation">;</span>

<span class="token comment">/**
 * Class containing details about a player's tech status. Includes their
 * unlocked techs, the tech they're currently unlocking, and the percent
 * unlocked of the current tech.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PlayerTechDetails</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Techs that have been unlocked by the player. This is a Set because each
   * player can only unlock each tech once, so there should be no duplicate
   * entries.
   */</span>
  <span class="token keyword">public</span> Set<span class="token generics function"><span class="token punctuation">&lt;</span>Tech<span class="token punctuation">></span></span> unlockedTechs<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Tech that the player is currently unlocking. May be null if the player is
   * not researching anything at the moment.
   */</span>
  <span class="token keyword">public</span> Tech currentlyUnlocking<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The progress of the current research project. This is a value in the range
   * [0, 1]. If the player isn't researching anything at the
   * moment, this value will be 0.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">double</span> percentUnlocked<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">PlayerTechDetails</span><span class="token punctuation">(</span>
    Set<span class="token generics function"><span class="token punctuation">&lt;</span>Tech<span class="token punctuation">></span></span> unlockedTechs<span class="token punctuation">,</span>
    Tech currentlyUnlocking<span class="token punctuation">,</span>
    <span class="token keyword">double</span> percentUnlocked
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>unlockedTechs <span class="token operator">=</span> unlockedTechs<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentlyUnlocking <span class="token operator">=</span> currentlyUnlocking<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>percentUnlocked <span class="token operator">=</span> percentUnlocked<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/logic/techs/Tech.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>techs<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Building<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Improvement<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>UnitType<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Set<span class="token punctuation">;</span>

<span class="token comment">/**
 * Class representing a technology that can be unlocked by a player. This class
 * also contains the static tech registry that contains a list of all the
 * available techs. These are all initialised in this class too.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Tech</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * List of the techs that have been created. The first item added to this
   * list should be the root of the tech tree.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tech<span class="token punctuation">></span></span> REGISTRY <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * The maximum x-coordinate of a tech on the tech tree. This is used to work
   * out the width of the tech tree, so the scroll pane knows how long to
   * scroll for. See {@link com.mrbbot.civilisation.ui.game.UITechTree}.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> MAX_X <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/*
   * START TECH DEFINITIONS
   */</span>
  <span class="token keyword">static</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create the initial definitions for each tech, these include the name,</span>
    <span class="token comment">// position of the tech tree, and their colour.</span>

    <span class="token comment">// Level 0 (unlocked by default)</span>
    Tech civilisation <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">Tech</span><span class="token punctuation">(</span><span class="token string">"Civilisation"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>GOLDENROD<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 1</span>
    Tech agriculture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tech</span><span class="token punctuation">(</span><span class="token string">"Agriculture"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>GREEN<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 2</span>
    Tech forestry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tech</span><span class="token punctuation">(</span><span class="token string">"Forestry"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>DARKGREEN<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 3</span>
    Tech pottery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tech</span><span class="token punctuation">(</span><span class="token string">"Pottery"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>FIREBRICK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Tech husbandry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tech</span><span class="token punctuation">(</span><span class="token string">"Husbandry"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>PINK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Tech theWheel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tech</span><span class="token punctuation">(</span><span class="token string">"The Wheel"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>GOLDENROD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Tech archery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tech</span><span class="token punctuation">(</span><span class="token string">"Archery"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>RED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Tech mining <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tech</span><span class="token punctuation">(</span><span class="token string">"Mining"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>GREY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 4</span>
    Tech currency <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tech</span><span class="token punctuation">(</span><span class="token string">"Currency"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>GOLD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Tech dramaAndPoetry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tech</span><span class="token punctuation">(</span><span class="token string">"Drama"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>PURPLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Tech ironWorking <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tech</span><span class="token punctuation">(</span><span class="token string">"Iron Working"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>GREY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 5</span>
    Tech education <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tech</span><span class="token punctuation">(</span><span class="token string">"Education"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>LIGHTBLUE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 6</span>
    Tech industrialisation <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">Tech</span><span class="token punctuation">(</span><span class="token string">"Industrialisation"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>BLACK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Tech steel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tech</span><span class="token punctuation">(</span><span class="token string">"Steel"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>GREY<span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 7</span>
    Tech electricity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tech</span><span class="token punctuation">(</span><span class="token string">"Electricity"</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>GOLD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Tech plastics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tech</span><span class="token punctuation">(</span><span class="token string">"Plastics"</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>PINK<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 8</span>
    Tech rocketry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tech</span><span class="token punctuation">(</span><span class="token string">"Rocketry"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Color<span class="token punctuation">.</span>DARKBLUE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Specify the Unlockables that each tech unlocks. These could be</span>
    <span class="token comment">// improvements, buildings, or unit types.</span>

    <span class="token comment">// Level 0 (unlocked by default)</span>
    civilisation<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>UnitType<span class="token punctuation">.</span>SETTLER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    civilisation<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>UnitType<span class="token punctuation">.</span>SCOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    civilisation<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>UnitType<span class="token punctuation">.</span>WARRIOR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 1</span>
    agriculture<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>Improvement<span class="token punctuation">.</span>FARM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    agriculture<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>UnitType<span class="token punctuation">.</span>WORKER<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 2</span>
    forestry<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>Improvement<span class="token punctuation">.</span>CHOP_FOREST<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 3</span>
    pottery<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>Building<span class="token punctuation">.</span>MONUMENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    husbandry<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>Improvement<span class="token punctuation">.</span>PASTURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    theWheel<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>Improvement<span class="token punctuation">.</span>ROAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    archery<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>UnitType<span class="token punctuation">.</span>ARCHER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mining<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>Improvement<span class="token punctuation">.</span>MINE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mining<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>Building<span class="token punctuation">.</span>WALL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 4</span>
    currency<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>Building<span class="token punctuation">.</span>BANK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dramaAndPoetry<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>Building<span class="token punctuation">.</span>AMPHITHEATRE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ironWorking<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>UnitType<span class="token punctuation">.</span>SWORDSMAN<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 5</span>
    education<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>Building<span class="token punctuation">.</span>SCHOOL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    education<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>Building<span class="token punctuation">.</span>UNIVERSITY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 6</span>
    industrialisation<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>Building<span class="token punctuation">.</span>FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    steel<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>UnitType<span class="token punctuation">.</span>KNIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 7</span>
    electricity<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>Building<span class="token punctuation">.</span>POWER_STATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
    plastics<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>Building<span class="token punctuation">.</span>SUPERMARKET<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 8</span>
    rocketry<span class="token punctuation">.</span><span class="token function">unlocks</span><span class="token punctuation">(</span>UnitType<span class="token punctuation">.</span>ROCKET<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Specify the requirements for each of the techs. Techs can require</span>
    <span class="token comment">// multiple techs, but these must all be on a previous level.</span>

    <span class="token comment">// Level 0 techs have no requirements as they are unlocked by default.</span>

    <span class="token comment">// Level 1</span>
    agriculture<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>civilisation<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 2</span>
    forestry<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>agriculture<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 3</span>
    pottery<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>agriculture<span class="token punctuation">)</span><span class="token punctuation">;</span>
    husbandry<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>forestry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    theWheel<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>forestry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    archery<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>forestry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mining<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>agriculture<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 4</span>
    currency<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>pottery<span class="token punctuation">)</span><span class="token punctuation">;</span>
    currency<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>husbandry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dramaAndPoetry<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>pottery<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dramaAndPoetry<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>husbandry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ironWorking<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>archery<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ironWorking<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>mining<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 5</span>
    education<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>dramaAndPoetry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    education<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>theWheel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 6</span>
    industrialisation<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>currency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    industrialisation<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>education<span class="token punctuation">)</span><span class="token punctuation">;</span>
    steel<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>education<span class="token punctuation">)</span><span class="token punctuation">;</span>
    steel<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>ironWorking<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 7</span>
    electricity<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>industrialisation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    electricity<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>steel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    plastics<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>industrialisation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    plastics<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>steel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Level 8</span>
    rocketry<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>electricity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rocketry<span class="token punctuation">.</span><span class="token function">requires</span><span class="token punctuation">(</span>plastics<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Calculate tech science costs</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Tech tech <span class="token operator">:</span> Tech<span class="token punctuation">.</span>REGISTRY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Even though the costs are only printed, and not used for anything</span>
      <span class="token comment">// else, this function must be called in level order as the value is</span>
      <span class="token comment">// cached and previous requirements' tech costs are used in the</span>
      <span class="token comment">// calculations of later techs.</span>
      <span class="token keyword">int</span> cost <span class="token operator">=</span> tech<span class="token punctuation">.</span><span class="token function">getScienceCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s: %d"</span><span class="token punctuation">,</span> tech<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cost<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tech<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> MAX_X<span class="token punctuation">)</span> MAX_X <span class="token operator">=</span> tech<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/*
   * END TECH DEFINITIONS
   */</span>

  <span class="token comment">/**
   * Gets the root of the tech tree. This is the first item that was added to
   * the registry.
   *
   * @return root of the tech tree
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Tech <span class="token function">getRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> REGISTRY<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets a tech from just its name. Used to load techs from a map (network/
   * file)
   *
   * @param name name of the tech to load
   * @return Tech object for the tech or null if the tech doesn't exist
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Tech <span class="token function">fromName</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Tech tech <span class="token operator">:</span> REGISTRY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tech<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> tech<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * The user facing name of the tech. Used by
   * {@link com.mrbbot.civilisation.ui.game.UITechTree} when displaying a tech.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> String name<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The x-coordinate of the tech. Used by
   * {@link com.mrbbot.civilisation.ui.game.UITechTree} to position a tech in
   * the tree.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The y-coordinate of the tech. Used by
   * {@link com.mrbbot.civilisation.ui.game.UITechTree} to position a tech in
   * the tree.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> y<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The colour of the tech. Used by
   * {@link com.mrbbot.civilisation.ui.game.UITechTree} when displaying a tech.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Color colour<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The techs that this tech requires to be unlocked before it itself can be
   * unlocked.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tech<span class="token punctuation">></span></span> requirements<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The techs that require this tech before they can be unlocked. Used by
   * {@link com.mrbbot.civilisation.ui.game.UITechTree} to traverse and render
   * the tech tree.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tech<span class="token punctuation">></span></span> requiredBy<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The unlockable items that this tech unlocks. These could be improvements,
   * buildings, or unit types.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Unlockable<span class="token punctuation">></span></span> unlocks<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The total science cost of unlocking this technology. The default value of
   * -1 indicates that the cost has not yet been calculated. Upon calling
   * {@link Tech#getScienceCost()} for the first time it will be calculated
   * and stored.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> scienceCost <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Constructor to create a new tech object. Should only be called from within
   * this class.
   *
   * @param name   user facing name of the tech
   * @param x      x-coordinate of the tech in the tree
   * @param y      y-coordinate of the tech in the tree
   * @param colour colour of the tech in the tree
   */</span>
  <span class="token keyword">private</span> <span class="token function">Tech</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> Color colour<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>colour <span class="token operator">=</span> colour<span class="token punctuation">;</span>

    <span class="token comment">// Initialise these as empty lists</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>requirements <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>requiredBy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>unlocks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add this tech to the registry automatically</span>
    REGISTRY<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Marks this tech as requiring another before it can be unlocked. Allows the
   * caller to write tech.requires(other) meaning a tree can be constructed
   * with an English like language.
   *
   * @param tech the required tech
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">requires</span><span class="token punctuation">(</span>Tech tech<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    requirements<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tech<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tech<span class="token punctuation">.</span>requiredBy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Marks this tech as unlocking the specified unlockable. Allows the caller
   * to write tech.unlocks(something).
   *
   * @param unlockable an item this tech unlocks
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unlocks</span><span class="token punctuation">(</span>Unlockable unlockable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unlocks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>unlockable<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the user facing name of this technology
   *
   * @return user facing name to be displayed in the tech tree
   */</span>
  <span class="token keyword">public</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the x-coordinate of this technology
   *
   * @return x-coordinate for positioning this tech in the tech tree
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> x<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the y-coordinate of this technology
   *
   * @return y-coordinate for positioning this tech in the tech tree
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> y<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the colour of this technology
   *
   * @return colour used for rendering this tech in the tech tree
   */</span>
  <span class="token keyword">public</span> Color <span class="token function">getColour</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> colour<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets a list of the techs required by this tech before it can be unlocked
   *
   * @return list of requirements
   */</span>
  <span class="token keyword">public</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tech<span class="token punctuation">></span></span> <span class="token function">getRequirements</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> requirements<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets a list of the techs that require this tech before they can be
   * unlocked.
   *
   * @return list of techs that require this tech
   */</span>
  <span class="token keyword">public</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tech<span class="token punctuation">></span></span> <span class="token function">getRequiredBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> requiredBy<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets a list of the unlockables that this tech unlocks and allows the
   * player to use. These could be improvements, buildings, or unit types.
   *
   * @return list of things this tech unlocks
   */</span>
  <span class="token keyword">public</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Unlockable<span class="token punctuation">></span></span> <span class="token function">getUnlocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> unlocks<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Calculates and stores the science cost of unlocking this tech. This
   * function should be called in order of tech level as the cost depends on
   * the techs previous requirements (and their requirements, and so fourth)
   *
   * @return the total science cost of unlocking this tech
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getScienceCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// We only want to calculate this once as it's recursive and could</span>
    <span class="token comment">// potentially take a long time</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>scienceCost <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>requirements<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If there aren't any requirements, the cost is 0 (i.e. it's already</span>
        <span class="token comment">// unlocked)</span>
        scienceCost <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Otherwise the cost is the sum of the requirements' costs + 25</span>
        scienceCost <span class="token operator">=</span> requirements<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span>Tech<span class="token operator">:</span><span class="token operator">:</span>getScienceCost<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">+</span> <span class="token number">25</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> scienceCost<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Checks if a player can unlock this tech given their previously unlocked
   * techs. In other words, this function checks all the tech's requirements
   * are fulfilled.
   *
   * @param unlockedTechs all the techs a player has unlocked
   * @return whether or not the player has met all the requirements
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canUnlockGivenUnlocked</span><span class="token punctuation">(</span>Set<span class="token generics function"><span class="token punctuation">&lt;</span>Tech<span class="token punctuation">></span></span> unlockedTechs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> unlockedTechs<span class="token punctuation">.</span><span class="token function">containsAll</span><span class="token punctuation">(</span>requirements<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span>requirements<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>
        <span class="token operator">&amp;&amp;</span> requirements<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>requirements<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Name of the tech should be unique</span>
    <span class="token keyword">return</span> name<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Tech</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Name of the tech should be unique</span>
      <span class="token keyword">return</span> name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Tech<span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/logic/techs/Unlockable.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>techs<span class="token punctuation">;</span>

<span class="token comment">/**
 * Interface describing an unlockable item. In the context of this game, this
 * would be an improvement, building, or unit type.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Unlockable</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Gets the user facing name for this unlock. Displayed in the tech tree by
   * {@link com.mrbbot.civilisation.ui.game.UITechTree}.
   *
   * @return user facing name for this unlock
   */</span>
  String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Gets a ID representing this unlock. This should be 0 (if the item is
   * unlocked by default) or a unique ID for the item
   *
   * @return ID representing this unlock
   */</span>
  <span class="token keyword">int</span> <span class="token function">getUnlockId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/logic/unit/Unit.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>HexagonGrid<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>Living<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>Player<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Positionable<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>Game<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Improvement<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Tile<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Point2D<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>UnitAbility<span class="token punctuation">.</span>ABILITY_ATTACK<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>UnitAbility<span class="token punctuation">.</span>ABILITY_RANGED_ATTACK<span class="token punctuation">;</span>

<span class="token comment">/**
 * Class representing an instance of a unit in the game.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Unit</span> <span class="token keyword">extends</span> <span class="token class-name">Living</span> <span class="token keyword">implements</span> <span class="token class-name">Positionable</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Random number generator for generating improvement metadata
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Random RANDOM <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * The owner of this unit. Only the owner can move the unit, or perform an
   * action with it.
   */</span>
  <span class="token keyword">public</span> Player player<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The tile this unit is currently occupying
   */</span>
  <span class="token keyword">public</span> Tile tile<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The type of this unit. Contains information on the units abilities.
   */</span>
  <span class="token keyword">public</span> UnitType unitType<span class="token punctuation">;</span>

  <span class="token comment">/**
   * The number of movement points this unit has remaining this turn. When a
   * unit moves, the cost of the movement is taken away from this number. The
   * unit can't move if this value is 0.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> remainingMovementPointsThisTurn<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Whether or not the unit has attacked a living object this turn. Each
   * attacking unit can only attack one unit per turn, so this ensures that
   * when it's set to true no more attacking can take place.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> hasAttackedThisTurn<span class="token punctuation">;</span>
  <span class="token comment">/**
   * What the unit is currently trying to build on the tile. Although this is
   * part of the Unit class, this is only relevant for units that have
   * {@link UnitAbility#ABILITY_IMPROVE}.
   */</span>
  <span class="token keyword">public</span> Improvement workerBuilding <span class="token operator">=</span> Improvement<span class="token punctuation">.</span>NONE<span class="token punctuation">;</span>
  <span class="token comment">/**
   * How many turns the current unit has left on its build project. Again, this
   * is only relevant for units that have {@link UnitAbility#ABILITY_IMPROVE}.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> workerBuildTurnsRemaining <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Creates a new unit object with the specified data
   *
   * @param player   owner of the unit
   * @param tile     tile the unit is occupying
   * @param unitType type of the unit
   */</span>
  <span class="token keyword">public</span> <span class="token function">Unit</span><span class="token punctuation">(</span>Player player<span class="token punctuation">,</span> Tile tile<span class="token punctuation">,</span> UnitType unitType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Set required living parameters</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>unitType<span class="token punctuation">.</span><span class="token function">getBaseHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>player <span class="token operator">=</span> player<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tile <span class="token operator">=</span> tile<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>unitType <span class="token operator">=</span> unitType<span class="token punctuation">;</span>

    <span class="token comment">// Reset movement and attack state</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>remainingMovementPointsThisTurn <span class="token operator">=</span> unitType<span class="token punctuation">.</span><span class="token function">getMovementPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hasAttackedThisTurn <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// Check the tile doesn't already have a unit</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tile<span class="token punctuation">.</span>unit <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
        <span class="token string">"Unit created on tile with another unit"</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    tile<span class="token punctuation">.</span>unit <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Loads a unit from a map containing information about it
   *
   * @param grid hexagon grid containing the unit
   * @param map  map containing information on the unit
   */</span>
  <span class="token keyword">public</span> <span class="token function">Unit</span><span class="token punctuation">(</span>HexagonGrid<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> grid<span class="token punctuation">,</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Load base health and health for living</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"baseHealth"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"health"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Load player</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>player <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Player</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"owner"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Load tile from the hexagon grid</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tile <span class="token operator">=</span> grid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"y"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Load the unit type and check it exists</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>unitType <span class="token operator">=</span> UnitType<span class="token punctuation">.</span><span class="token function">fromName</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span> <span class="token keyword">this</span><span class="token punctuation">.</span>unitType <span class="token operator">!=</span> null<span class="token punctuation">;</span>

    <span class="token comment">// Load movement and attack state</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>remainingMovementPointsThisTurn <span class="token operator">=</span>
      <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"remainingMovementPoints"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hasAttackedThisTurn <span class="token operator">=</span> <span class="token function">canAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">boolean</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"hasAttacked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Load specific worker information</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"workerBuilding"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      workerBuilding <span class="token operator">=</span>
        Improvement<span class="token punctuation">.</span><span class="token function">fromName</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"workerBuilding"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"workerBuildTurnsRemaining"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      workerBuildTurnsRemaining <span class="token operator">=</span>
        <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"workerBuildTurnsRemaining"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Check the tile doesn't already have a unit</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tile<span class="token punctuation">.</span>unit <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
        <span class="token string">"Unit created on tile with another unit"</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    tile<span class="token punctuation">.</span>unit <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the x-coordinate of this unit
   *
   * @return x-coordinate of this unit
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> tile<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the y-coordinate of this unit
   *
   * @return y-coordinate of this unit
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> tile<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Stores all the information required to recreate this unit in map
   *
   * @return map containing unit information
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> <span class="token function">toMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Store health data from living base class</span>
    Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store the owner</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"owner"</span><span class="token punctuation">,</span> player<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store the location</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">,</span> tile<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"y"</span><span class="token punctuation">,</span> tile<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store the unit type</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> unitType<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store unit specific information</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"remainingMovementPoints"</span><span class="token punctuation">,</span> remainingMovementPointsThisTurn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"hasAttacked"</span><span class="token punctuation">,</span> hasAttackedThisTurn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>workerBuilding <span class="token operator">!=</span> Improvement<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span>
      map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"workerBuilding"</span><span class="token punctuation">,</span> workerBuilding<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>workerBuildTurnsRemaining <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
      map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"workerBuildTurnsRemaining"</span><span class="token punctuation">,</span> workerBuildTurnsRemaining<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> map<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Requests that the unit (if it can) begin working on constructing the
   * specified improvement on it's current tile
   *
   * @param improvement improvement to build
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startWorkerBuilding</span><span class="token punctuation">(</span>Improvement improvement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Check the unit can build and isn't already building something</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasAbility</span><span class="token punctuation">(</span>UnitAbility<span class="token punctuation">.</span>ABILITY_IMPROVE<span class="token punctuation">)</span>
      <span class="token operator">&amp;&amp;</span> workerBuilding <span class="token operator">==</span> Improvement<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Update the building improvement and turns remaining</span>
      workerBuilding <span class="token operator">=</span> improvement<span class="token punctuation">;</span>
      workerBuildTurnsRemaining <span class="token operator">=</span> improvement<span class="token punctuation">.</span>turnCost<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets a units abilities. Normally, this should be the same of the unit
   * type's abilities. However, when a worker is building something, it
   * shouldn't be able to move.
   *
   * @return number representing a workers abilities
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">getAbilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> abilities <span class="token operator">=</span> unitType<span class="token punctuation">.</span><span class="token function">getAbilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Check if the worker is building something, and prevent it from moving</span>
    <span class="token comment">// if it is</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>workerBuilding <span class="token operator">!=</span> Improvement<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      abilities <span class="token operator">-=</span> UnitAbility<span class="token punctuation">.</span>ABILITY_MOVEMENT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> abilities<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Check if a unit has the specified ability. This should be one of the
   * constants in the {@link UnitAbility} class. See {@link UnitAbility} for
   * more details on how this works.
   *
   * @param ability ability to check if the unit has
   * @return whether or not the unit has the ability
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasAbility</span><span class="token punctuation">(</span><span class="token keyword">int</span> ability<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">getAbilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> ability<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Check if the unit can attack a living object
   *
   * @return whether the unit can perform a melee or a ranged attack
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">hasAbility</span><span class="token punctuation">(</span>ABILITY_ATTACK<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">hasAbility</span><span class="token punctuation">(</span>ABILITY_RANGED_ATTACK<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Handle a turn of the game. This resets a unit's movement counter and
   * attack state, whilst also progressing any improvement that's being built.
   *
   * @param game game to handle the turn of
   * @return an array of tiles to be updated containing the unit's tile, an
   * empty array if all tiles should be updated, or null if no tiles should be
   * updated.
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handleTurn</span><span class="token punctuation">(</span>Game game<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Naturally heal the unit and see if the tile now needs to be updated</span>
    <span class="token keyword">boolean</span> tileUpdated <span class="token operator">=</span> <span class="token function">naturalHeal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> allTilesNeedReRendering <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// Reset movement and attack state</span>
    remainingMovementPointsThisTurn <span class="token operator">=</span> unitType<span class="token punctuation">.</span><span class="token function">getMovementPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hasAttackedThisTurn <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// Check if the unit is building something</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>workerBuilding <span class="token operator">!=</span> Improvement<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Increase build progress</span>
      workerBuildTurnsRemaining<span class="token operator">--</span><span class="token punctuation">;</span>
      <span class="token comment">// Check if the improvement has now been built</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>workerBuildTurnsRemaining <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Create a new map for metadata</span>
        HashMap<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> meta <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Check if the improvement used to be a road. If it did, all tiles</span>
        <span class="token comment">// will need re-rendering to recalculate road adjacencies.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tile<span class="token punctuation">.</span>improvement <span class="token operator">==</span> Improvement<span class="token punctuation">.</span>ROAD<span class="token punctuation">)</span>
          allTilesNeedReRendering <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>workerBuilding <span class="token operator">==</span> Improvement<span class="token punctuation">.</span>CHOP_FOREST<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// If the working was chopping a forest, add the production bonus to</span>
          <span class="token comment">// the cities total.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>tile<span class="token punctuation">.</span>city <span class="token operator">!=</span> null<span class="token punctuation">)</span> tile<span class="token punctuation">.</span>city<span class="token punctuation">.</span>productionTotal <span class="token operator">+=</span> <span class="token number">30</span><span class="token punctuation">;</span>
          tile<span class="token punctuation">.</span>improvement <span class="token operator">=</span> Improvement<span class="token punctuation">.</span>NONE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// Otherwise just set the tiles improvement to what was being built</span>
          tile<span class="token punctuation">.</span>improvement <span class="token operator">=</span> workerBuilding<span class="token punctuation">;</span>

          <span class="token comment">// Check if there is any metadata that should be added</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>Improvement<span class="token punctuation">.</span>FARM<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>workerBuilding<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Generate the number of strips and the angle for the farm</span>
            meta<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"strips"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>RANDOM<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            meta<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"angle"</span><span class="token punctuation">,</span> RANDOM<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Improvement<span class="token punctuation">.</span>MINE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>workerBuilding<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Generate the size/colour for each of the 3 rocks</span>
            List<span class="token generics function"><span class="token punctuation">&lt;</span>Double<span class="token punctuation">></span></span> sizes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            List<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">></span></span> colours <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              sizes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>RANDOM<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3.0</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              colours<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>RANDOM<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            meta<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"sizes"</span><span class="token punctuation">,</span> sizes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            meta<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"colours"</span><span class="token punctuation">,</span> colours<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Improvement<span class="token punctuation">.</span>ROAD<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>workerBuilding<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Again if we're building a road, all tiles need to be updated to</span>
            <span class="token comment">// recalculate road adjacencies</span>
            allTilesNeedReRendering <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        tile<span class="token punctuation">.</span>improvementMetadata <span class="token operator">=</span> meta<span class="token punctuation">;</span>
        <span class="token comment">// Reset the worker's building state</span>
        workerBuilding <span class="token operator">=</span> Improvement<span class="token punctuation">.</span>NONE<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Make sure the unit's tile is updated</span>
      tileUpdated <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Return an empty array if all tiles need to be updated</span>
    <span class="token keyword">return</span> allTilesNeedReRendering
      <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">Tile</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token operator">:</span> <span class="token punctuation">(</span>tileUpdated
      <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">Tile</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>tile<span class="token punctuation">}</span>
      <span class="token operator">:</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Handle another unit attacking this unit
   *
   * @param attacker the other unit attacking this unit
   * @param ranged   whether this was a ranged attack
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAttacked</span><span class="token punctuation">(</span>Unit attacker<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ranged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Damage the unit an amount based on the attacker's strength</span>
    <span class="token function">damage</span><span class="token punctuation">(</span>attacker<span class="token punctuation">.</span>unitType<span class="token punctuation">.</span><span class="token function">getAttackStrength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ranged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Only damage the attack if this wasn't a ranged attack</span>
      attacker<span class="token punctuation">.</span><span class="token function">damage</span><span class="token punctuation">(</span>unitType<span class="token punctuation">.</span><span class="token function">getBaseHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the owner of the unit
   *
   * @return owner of the unit
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> Player <span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> player<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the position of the unit from the tile the unit is occupying
   *
   * @return position of the unit
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> Point2D <span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> tile<span class="token punctuation">.</span><span class="token function">getHexagon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/logic/unit/UnitAbility.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">;</span>

<span class="token comment">/**
 * Class containing constants for unit abilities. Each of these is an integer
 * with one of the bits set to one. This allows for easy checking of a unit's
 * abilities.
 * &lt;p>
 * For example, if we take the worker's ability number (ABILITY_MOVEMENT +
 * ABILITY_IMPROVE) this will result in the binary number: 10001. If we AND
 * this with the ABILITY_IMPROVE constant and then check if the number is
 * greater than 0, we'll be able to tell if the unit has the improve ability.
 * &lt;p>
 * 10001
 * AND 10000
 * = 10000 (16) [16 is greater than 0, so the unit has the ability]
 * &lt;p>
 * If we perform the same check with settling:
 * &lt;p>
 * 10001
 * AND 00010
 * = 00000 (0) [0 is not greater than 0, so the unit doesn't have the ability]
 */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">UnitAbility</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> ABILITY_MOVEMENT <span class="token operator">=</span> <span class="token number">0b1</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> ABILITY_SETTLE <span class="token operator">=</span> <span class="token number">0b10</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> ABILITY_ATTACK <span class="token operator">=</span> <span class="token number">0b100</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> ABILITY_RANGED_ATTACK <span class="token operator">=</span> <span class="token number">0b1000</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> ABILITY_IMPROVE <span class="token operator">=</span> <span class="token number">0b10000</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> ABILITY_BLAST_OFF <span class="token operator">=</span> <span class="token number">0b100000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/logic/unit/UnitType.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>CityBuildable<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>Game<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>City<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Tile<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">.</span>PacketUnitCreate<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>game<span class="token punctuation">.</span>BadgeType<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>UnitAbility<span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token comment">/**
 * Class representing a type of unit that can be built within a city. The class
 * contains a variety of constants for the different types of units.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UnitType</span> <span class="token keyword">extends</span> <span class="token class-name">CityBuildable</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Base unlock ID for unit types. Used to identify unit types that can be
   * unlocked.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> BASE_UNLOCK_ID <span class="token operator">=</span> <span class="token number">0x20</span><span class="token punctuation">;</span>

  <span class="token comment">/*
   * START UNIT TYPE DEFINITIONS
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> UnitType SETTLER <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnitType</span><span class="token punctuation">(</span>
    <span class="token string">"Settler"</span><span class="token punctuation">,</span>
    <span class="token string">"Creates cities"</span><span class="token punctuation">,</span>
    <span class="token number">60</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    Color<span class="token punctuation">.</span>GOLD<span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">5</span><span class="token punctuation">,</span>
    ABILITY_MOVEMENT <span class="token operator">+</span> ABILITY_SETTLE
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> UnitType SCOUT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnitType</span><span class="token punctuation">(</span>
    <span class="token string">"Scout"</span><span class="token punctuation">,</span>
    <span class="token string">"Moves around"</span><span class="token punctuation">,</span>
    <span class="token number">40</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    Color<span class="token punctuation">.</span>GREEN<span class="token punctuation">,</span>
    <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token number">25</span><span class="token punctuation">,</span>
    ABILITY_MOVEMENT <span class="token operator">+</span> ABILITY_ATTACK
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> UnitType WARRIOR <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnitType</span><span class="token punctuation">(</span>
    <span class="token string">"Warrior"</span><span class="token punctuation">,</span>
    <span class="token string">"Can attack adjacent units"</span><span class="token punctuation">,</span>
    <span class="token number">50</span><span class="token punctuation">,</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    Color<span class="token punctuation">.</span>RED<span class="token punctuation">,</span>
    <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token number">50</span><span class="token punctuation">,</span>
    ABILITY_MOVEMENT <span class="token operator">+</span> ABILITY_ATTACK
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> UnitType SWORDSMAN <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnitType</span><span class="token punctuation">(</span>
    <span class="token string">"Swordsman"</span><span class="token punctuation">,</span>
    <span class="token string">"Can attack adjacent units"</span><span class="token punctuation">,</span>
    <span class="token number">70</span><span class="token punctuation">,</span>
    BASE_UNLOCK_ID<span class="token punctuation">,</span>
    Color<span class="token punctuation">.</span>BROWN<span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token number">15</span><span class="token punctuation">,</span>
    <span class="token number">60</span><span class="token punctuation">,</span>
    ABILITY_MOVEMENT <span class="token operator">+</span> ABILITY_ATTACK
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> UnitType KNIGHT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnitType</span><span class="token punctuation">(</span>
    <span class="token string">"Knight"</span><span class="token punctuation">,</span>
    <span class="token string">"Can attack adjacent units"</span><span class="token punctuation">,</span>
    <span class="token number">90</span><span class="token punctuation">,</span>
    BASE_UNLOCK_ID <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
    Color<span class="token punctuation">.</span>GREY<span class="token punctuation">,</span>
    <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token number">20</span><span class="token punctuation">,</span>
    <span class="token number">70</span><span class="token punctuation">,</span>
    ABILITY_MOVEMENT <span class="token operator">+</span> ABILITY_ATTACK
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> UnitType ARCHER <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnitType</span><span class="token punctuation">(</span>
    <span class="token string">"Archer"</span><span class="token punctuation">,</span>
    <span class="token string">"Can attack units up to 2 tiles away"</span><span class="token punctuation">,</span>
    <span class="token number">60</span><span class="token punctuation">,</span>
    BASE_UNLOCK_ID <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span>
    Color<span class="token punctuation">.</span>INDIANRED<span class="token punctuation">,</span>
    <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token number">30</span><span class="token punctuation">,</span>
    ABILITY_MOVEMENT <span class="token operator">+</span> ABILITY_RANGED_ATTACK
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> UnitType WORKER <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnitType</span><span class="token punctuation">(</span>
    <span class="token string">"Worker"</span><span class="token punctuation">,</span>
    <span class="token string">"Can improve a tile"</span><span class="token punctuation">,</span>
    <span class="token number">40</span><span class="token punctuation">,</span>
    BASE_UNLOCK_ID <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span>
    Color<span class="token punctuation">.</span>DODGERBLUE<span class="token punctuation">,</span>
    <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">15</span><span class="token punctuation">,</span>
    ABILITY_MOVEMENT <span class="token operator">+</span> ABILITY_IMPROVE
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> UnitType ROCKET <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnitType</span><span class="token punctuation">(</span>
    <span class="token string">"Rocket"</span><span class="token punctuation">,</span>
    <span class="token string">"Wins the game"</span><span class="token punctuation">,</span>
    <span class="token number">200</span><span class="token punctuation">,</span>
    BASE_UNLOCK_ID <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span>
    Color<span class="token punctuation">.</span>GREY<span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">100</span><span class="token punctuation">,</span>
    ABILITY_BLAST_OFF
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/*
   * END UNIT TYPE DEFINITIONS
   */</span>

  <span class="token comment">//Define unit upgrade paths</span>
  <span class="token keyword">static</span> <span class="token punctuation">{</span>
    WARRIOR<span class="token punctuation">.</span>canUpgradeTo <span class="token operator">=</span> SWORDSMAN<span class="token punctuation">;</span>
    SWORDSMAN<span class="token punctuation">.</span>canUpgradeTo <span class="token operator">=</span> KNIGHT<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Array containing all defined unit types.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> UnitType<span class="token punctuation">[</span><span class="token punctuation">]</span> VALUES <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnitType</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
    SETTLER<span class="token punctuation">,</span>
    SCOUT<span class="token punctuation">,</span>
    WARRIOR<span class="token punctuation">,</span>
    SWORDSMAN<span class="token punctuation">,</span>
    KNIGHT<span class="token punctuation">,</span>
    ARCHER<span class="token punctuation">,</span>
    WORKER<span class="token punctuation">,</span>
    ROCKET
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Function to get a unit type from just its name
   *
   * @param name name of unit type to get
   * @return the unit type with the specified name or null if the unit type
   * doesn't exist
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> UnitType <span class="token function">fromName</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Iterates through all the unit types...</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>UnitType value <span class="token operator">:</span> VALUES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Check if the names match</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Colour representing this unit (the torso colour, the other belt colour
   * represents the player)
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Color color<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Base number of movement points units of this type should start with
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> movementPoints<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Attack strength of this unit type (i.e. how much damage it will do to
   * other units or cities)
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> attackStrength<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Starting health for the unit
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> baseHealth<span class="token punctuation">;</span>
  <span class="token comment">/**
   * A number representing this unit's abilities (see {@link UnitAbility}) for
   * more information on how this works.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> abilities<span class="token punctuation">;</span>
  <span class="token comment">/**
   * A unit type that this unit can be upgraded to if it's been unlocked.
   */</span>
  <span class="token keyword">private</span> UnitType canUpgradeTo<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token function">UnitType</span><span class="token punctuation">(</span>
    String name<span class="token punctuation">,</span>
    String description<span class="token punctuation">,</span>
    <span class="token keyword">int</span> productionCost<span class="token punctuation">,</span>
    <span class="token keyword">int</span> unlockId<span class="token punctuation">,</span>
    Color color<span class="token punctuation">,</span>
    <span class="token keyword">int</span> movementPoints<span class="token punctuation">,</span>
    <span class="token keyword">int</span> attackStrength<span class="token punctuation">,</span>
    <span class="token keyword">int</span> baseHealth<span class="token punctuation">,</span>
    <span class="token keyword">int</span> abilities
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> description<span class="token punctuation">,</span> productionCost<span class="token punctuation">,</span> unlockId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>movementPoints <span class="token operator">=</span> movementPoints<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>attackStrength <span class="token operator">=</span> attackStrength<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>baseHealth <span class="token operator">=</span> baseHealth<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>abilities <span class="token operator">=</span> abilities<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the unit's colour
   *
   * @return unit's colour
   */</span>
  <span class="token keyword">public</span> Color <span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the unit's base movement points
   *
   * @return unit's base movement points
   */</span>
  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"WeakerAccess"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getMovementPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> movementPoints<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the unit's attack strength
   *
   * @return unit's attack strength
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAttackStrength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> attackStrength<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the unit's base health
   *
   * @return unit's base/starting health
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getBaseHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> baseHealth<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets a number representing the units abilities
   *
   * @return unit's abilities
   */</span>
  <span class="token keyword">int</span> <span class="token function">getAbilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> abilities<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the unit type that this unit type can update to
   *
   * @return upgraded unit type, or null if this unit type cannot be upgraded
   */</span>
  <span class="token keyword">public</span> UnitType <span class="token function">getUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> canUpgradeTo<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the details to be displayed in the city production list for this
   * unit type
   *
   * @return details to be displayed
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Detail<span class="token punctuation">></span></span> <span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Detail<span class="token punctuation">></span></span> details <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    details<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Detail</span><span class="token punctuation">(</span>BadgeType<span class="token punctuation">.</span>HEALTH<span class="token punctuation">,</span> baseHealth<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>movementPoints <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
      details<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Detail</span><span class="token punctuation">(</span>BadgeType<span class="token punctuation">.</span>MOVEMENT<span class="token punctuation">,</span> movementPoints<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>attackStrength <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
      details<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Detail</span><span class="token punctuation">(</span>BadgeType<span class="token punctuation">.</span>ATTACK<span class="token punctuation">,</span> attackStrength<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> details<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Builds an instance of this unit type in the specified city, creating a new
   * unit object
   *
   * @param city city to build in
   * @param game game the city is contained within
   * @return tile to update the render of (i.e. the tile the new unit was
   * created in)
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> Tile <span class="token function">build</span><span class="token punctuation">(</span>City city<span class="token punctuation">,</span> Game game<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    PacketUnitCreate packetUnitCreate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PacketUnitCreate</span><span class="token punctuation">(</span>
      city<span class="token punctuation">.</span>player<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      city<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> city<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> placedTiles <span class="token operator">=</span> game<span class="token punctuation">.</span><span class="token function">handlePacket</span><span class="token punctuation">(</span>packetUnitCreate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> placedTiles <span class="token operator">!=</span> null
      <span class="token operator">&amp;&amp;</span> placedTiles<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span>
      <span class="token operator">?</span> placedTiles<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      <span class="token operator">:</span> null<span class="token punctuation">;</span>
    <span class="token comment">// No need to broadcast packet as this method is called on the client and</span>
    <span class="token comment">// the server automatically on receiving a PacketReady</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/render/map/RenderGame.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>map<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>Civilisation<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Path<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>Player<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>Game<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>City<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Tile<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>Unit<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>UnitAbility<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">.</span>RenderData<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Point2D<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>Node<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>input<span class="token punctuation">.</span>MouseButton<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>input<span class="token punctuation">.</span>PickResult<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>PhongMaterial<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>shape<span class="token punctuation">.</span>Box<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>PriorityQueue<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span>Consumer<span class="token punctuation">;</span>

<span class="token comment">/**
 * Main render object for representing the game state. Handles rendering tiles
 * (terrain, improvements, units, cities).
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RenderGame</span> <span class="token keyword">extends</span> <span class="token class-name">RenderData</span><span class="token generics function"><span class="token punctuation">&lt;</span>Game<span class="token punctuation">></span></span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Function to be called when the player (de)selects a unit. Null should be
   * passed on deselection.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Consumer<span class="token generics function"><span class="token punctuation">&lt;</span>Unit<span class="token punctuation">></span></span> selectedUnitListener<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Function to be called when the player (de)selects a city. Null should be
   * passed on deselection.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Consumer<span class="token generics function"><span class="token punctuation">&lt;</span>City<span class="token punctuation">></span></span> selectedCityListener<span class="token punctuation">;</span>

  <span class="token comment">/**
   * The current player of the game for this client
   */</span>
  <span class="token keyword">public</span> Player currentPlayer<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The city that has been selected by the player. Null if no city is
   * selected.
   */</span>
  <span class="token keyword">private</span> City selectedCity<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Creates a new game render object
   *
   * @param data                 game to render
   * @param id                   id of the current player
   * @param selectedUnitListener function to be called when the selected unit
   *                             changes
   * @param selectedCityListener function to be called when the selected city
   *                             changes
   */</span>
  <span class="token keyword">public</span> <span class="token function">RenderGame</span><span class="token punctuation">(</span>
    Game data<span class="token punctuation">,</span>
    String id<span class="token punctuation">,</span>
    Consumer<span class="token generics function"><span class="token punctuation">&lt;</span>Unit<span class="token punctuation">></span></span> selectedUnitListener<span class="token punctuation">,</span>
    Consumer<span class="token generics function"><span class="token punctuation">&lt;</span>City<span class="token punctuation">></span></span> selectedCityListener
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>selectedUnitListener <span class="token operator">=</span> selectedUnitListener<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>selectedCityListener <span class="token operator">=</span> selectedCityListener<span class="token punctuation">;</span>

    <span class="token comment">// Find the current player</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Player player <span class="token operator">:</span> data<span class="token punctuation">.</span>players<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>player<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        currentPlayer <span class="token operator">=</span> player<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPlayer <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
        <span class="token string">"current player not found in player list"</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Priority queue that ensures translucent tiles are added to the render</span>
    <span class="token comment">// last. This is required for the translucency effect to work.</span>
    <span class="token keyword">final</span> PriorityQueue<span class="token generics function"><span class="token punctuation">&lt;</span>RenderTile<span class="token punctuation">></span></span> tilesToAdd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriorityQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>
      <span class="token comment">// Orders tiles with translucent tiles at the end of the queue</span>
      <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">isTranslucent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>b<span class="token punctuation">.</span><span class="token function">isTranslucent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">isTranslucent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>a<span class="token punctuation">.</span><span class="token function">isTranslucent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Iterates through every possible hex tile position</span>
    data<span class="token punctuation">.</span>hexagonGrid<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tile<span class="token punctuation">,</span> hex<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token comment">// Creates the render object for that tile</span>
      RenderTile renderTile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RenderTile</span><span class="token punctuation">(</span>
        tile<span class="token punctuation">,</span>
        data<span class="token punctuation">.</span>hexagonGrid<span class="token punctuation">.</span><span class="token function">getNeighbours</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      tile<span class="token punctuation">.</span>renderer <span class="token operator">=</span> renderTile<span class="token punctuation">;</span>

      <span class="token comment">// Registers click listener for this tile</span>
      renderTile<span class="token punctuation">.</span><span class="token function">setOnMouseClicked</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment">// Ignore the click if we're waiting for other players</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>waitingForPlayers<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> MouseButton<span class="token punctuation">.</span>PRIMARY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// If this was a left click, the user is trying to select this tile</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>tile<span class="token punctuation">.</span>city <span class="token operator">!=</span> null
            <span class="token operator">&amp;&amp;</span> tile<span class="token punctuation">.</span>city<span class="token punctuation">.</span><span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">samePositionAs</span><span class="token punctuation">(</span>tile<span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> tile<span class="token punctuation">.</span>city<span class="token punctuation">.</span>player<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>currentPlayer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Prioritise selecting a capital city is there is one</span>
            <span class="token function">setSelectedCity</span><span class="token punctuation">(</span>tile<span class="token punctuation">.</span>city<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setSelectedUnit</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// Otherwise select the unit on this tile</span>
          <span class="token function">setSelectedCity</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// tile.unit will be null if there isn't a unit, deselecting any</span>
          <span class="token comment">// previously selected units</span>
          <span class="token function">setSelectedUnit</span><span class="token punctuation">(</span>tile<span class="token punctuation">.</span>unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> MouseButton<span class="token punctuation">.</span>SECONDARY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// If this was a right click, the user is trying to purchase a tile</span>
          <span class="token comment">// or attack something</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedCity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// If there's a selected city, this must be a purchase request</span>
            PacketPurchaseTileRequest packetPurchaseTileRequest
              <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PacketPurchaseTileRequest</span><span class="token punctuation">(</span>
              selectedCity<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              selectedCity<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              tile<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
              tile<span class="token punctuation">.</span>y
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Try the purchase request, if null was received, then it didn't</span>
            <span class="token comment">// work so there's no need to broadcast it</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">handlePacket</span><span class="token punctuation">(</span>packetPurchaseTileRequest<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// If it did work, update the game state of other clients</span>
              Civilisation<span class="token punctuation">.</span>CLIENT<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>packetPurchaseTileRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>selectedUnit <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// If there's a selected unit, try and attack with it</span>
            PacketDamage packetDamage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PacketDamage</span><span class="token punctuation">(</span>
              data<span class="token punctuation">.</span>selectedUnit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
              data<span class="token punctuation">.</span>selectedUnit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
              tile<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
              tile<span class="token punctuation">.</span>y
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// If that returned null, the attack didn't work, so there's no</span>
            <span class="token comment">// need to broadcast it</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">handlePacket</span><span class="token punctuation">(</span>packetDamage<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// If it did work, update the game state of other clients</span>
              Civilisation<span class="token punctuation">.</span>CLIENT<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>packetDamage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Registers drag listener for this tile</span>
      renderTile<span class="token punctuation">.</span><span class="token function">setOnMouseDragged</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment">// Ignore the click if we're waiting for other players</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>waitingForPlayers<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

        <span class="token comment">// If this was a right click drag, the user is trying to path-find</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> MouseButton<span class="token punctuation">.</span>SECONDARY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// If there isn't a start to the path yet, mark this initial tile</span>
          <span class="token comment">// as it, providing it contains a unit that can be moved</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>pathStartTile <span class="token operator">==</span> null
            <span class="token operator">&amp;&amp;</span> renderTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>unit <span class="token operator">!=</span> null
            <span class="token operator">&amp;&amp;</span> renderTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>player<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>currentPlayer<span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> renderTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>unit<span class="token punctuation">.</span><span class="token function">hasAbility</span><span class="token punctuation">(</span>UnitAbility<span class="token punctuation">.</span>ABILITY_MOVEMENT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pathStartTile <span class="token operator">=</span> renderTile<span class="token punctuation">;</span>
            <span class="token comment">// Show the pathfinding overlay</span>
            pathStartTile<span class="token punctuation">.</span><span class="token function">setOverlayVisible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// If there's a starting tile</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>pathStartTile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Get the tile the user is dragging over and check it exists</span>
            RenderTile pickedTile <span class="token operator">=</span> <span class="token function">getTileFromPickResult</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getPickResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pickedTile <span class="token operator">==</span> null <span class="token operator">||</span> pickedTile <span class="token operator">!=</span> pathEndTile<span class="token punctuation">)</span>
              <span class="token operator">&amp;&amp;</span> pathEndTile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// If it's different to the last end, reset the pathfinding end</span>
              <span class="token function">resetPathfindingEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// If there was a tile</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pickedTile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// Check if a path can be made to the tile</span>
              RenderTile potentialEnd <span class="token operator">=</span> pickedTile<span class="token punctuation">;</span>

              List<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> path <span class="token operator">=</span> data<span class="token punctuation">.</span>hexagonGrid<span class="token punctuation">.</span><span class="token function">findPath</span><span class="token punctuation">(</span>
                pathStartTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
                pathStartTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
                potentialEnd<span class="token punctuation">.</span>data<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
                potentialEnd<span class="token punctuation">.</span>data<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
                pathStartTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>remainingMovementPointsThisTurn
              <span class="token punctuation">)</span><span class="token punctuation">.</span>path<span class="token punctuation">;</span>

              <span class="token comment">// Mark the path for the user</span>
              path<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> p<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">setOverlayVisible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token comment">// Set the end if there's a valid path</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                potentialEnd <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>renderer<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              pathEndTile <span class="token operator">=</span> potentialEnd<span class="token punctuation">;</span>
              pathEndTile<span class="token punctuation">.</span><span class="token function">setOverlayVisible</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Adds the tile to the render queue</span>
      tilesToAdd<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>renderTile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add a box underneath the tiles to represent a boardgame board that the</span>
    <span class="token comment">// game is being played on</span>
    Point2D topLeftCenter <span class="token operator">=</span>
      data<span class="token punctuation">.</span>hexagonGrid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHexagon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Box gameBoard <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Box</span><span class="token punctuation">(</span>
      Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>topLeftCenter<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4.5</span><span class="token punctuation">,</span>
      Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>topLeftCenter<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token number">1</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    gameBoard<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gameBoard<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>WHITESMOKE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span>gameBoard<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add all the renders of the tiles, adding translucent tiles last</span>
    RenderTile t<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">=</span> tilesToAdd<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the selected unit, notifying the listener of the change
   *
   * @param unit new selected unit, can be null if a unit has been deselected
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSelectedUnit</span><span class="token punctuation">(</span>Unit unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Check if the unit exists and belongs to the current player (you can't</span>
    <span class="token comment">// selected other player's units, that would be unfair)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>unit <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> unit<span class="token punctuation">.</span>player<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>currentPlayer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Check if there's already a selected unit and deselect it if there is</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>selectedUnit <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>selectedUnit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>selected <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// Rerender the containing tile</span>
        data<span class="token punctuation">.</span>selectedUnit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">updateRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Mark the new unit as selected and rerender the containing tile</span>
      unit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>selected <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      unit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">updateRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Update the game state and notify the unit listener</span>
      data<span class="token punctuation">.</span>selectedUnit <span class="token operator">=</span> unit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>unit<span class="token punctuation">;</span>
      selectedUnitListener<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>selectedUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Otherwise, if the unit doesn't exist or doesn't belong to the current</span>
      <span class="token comment">// player, deselect the current unit</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>selectedUnit <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>selectedUnit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>selected <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// Rerender the containing tile</span>
        data<span class="token punctuation">.</span>selectedUnit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">updateRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Update the game state and notify the unit listener</span>
        data<span class="token punctuation">.</span>selectedUnit <span class="token operator">=</span> null<span class="token punctuation">;</span>
        selectedUnitListener<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the selected city, notifying the listener of the change. There's no
   * need to check the owner here, as this is done in the click handler.
   *
   * @param city new selected city, can be null if a city has been deselected
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSelectedCity</span><span class="token punctuation">(</span>City city<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Update the game state and notify the city listener</span>
    selectedCity <span class="token operator">=</span> city<span class="token punctuation">;</span>
    selectedCityListener<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>city<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Deletes a unit from the game, updating the containing tile render
   *
   * @param unit      unit to delete
   * @param broadcast whether to broadcast this change to other clients
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteUnit</span><span class="token punctuation">(</span>Unit unit<span class="token punctuation">,</span> <span class="token keyword">boolean</span> broadcast<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>unit <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Deselect this unit if it was the selected unit</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>selectedUnit <span class="token operator">==</span> unit<span class="token punctuation">)</span> <span class="token function">setSelectedUnit</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Remove the unit from the tile and rerender the tile</span>
      unit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>unit <span class="token operator">=</span> null<span class="token punctuation">;</span>
      unit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">updateRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Remove the unit and broadcast the change if required</span>
      data<span class="token punctuation">.</span>units<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>broadcast<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Civilisation<span class="token punctuation">.</span>CLIENT<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PacketUnitDelete</span><span class="token punctuation">(</span>
          unit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
          unit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>y
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Requests that all tiles be rerendered following a big game state changed
   * (i.e. city growth)
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateTileRenders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">.</span>hexagonGrid<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>gridTile<span class="token punctuation">,</span> _hex<span class="token punctuation">,</span> _x<span class="token punctuation">,</span> _y<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> gridTile<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">updateRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Start tile of the selected path
   */</span>
  <span class="token keyword">private</span> RenderTile pathStartTile<span class="token punctuation">;</span>
  <span class="token comment">/**
   * End tile of the selected path
   */</span>
  <span class="token keyword">private</span> RenderTile pathEndTile<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Gets a tile render object from a raycast result
   *
   * @param result result of a raycast
   * @return render tile hit by the ray or null if no tile was hit
   */</span>
  <span class="token keyword">private</span> RenderTile <span class="token function">getTileFromPickResult</span><span class="token punctuation">(</span>PickResult result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Check if there even was a selected node</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    Node node <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getIntersectedNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span>

    <span class="token comment">// Traverse up the tree until a tile render object is found, returning it</span>
    <span class="token comment">// if it was</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token keyword">instanceof</span> <span class="token class-name">RenderTile</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>RenderTile<span class="token punctuation">)</span> node<span class="token punctuation">;</span>
      node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Otherwise return null if no tile render could be found</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Reset the path, so that a new path can be drawn in its place
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">resetPathfindingEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pathEndTile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Resets the path overlays for the path</span>
      pathEndTile<span class="token punctuation">.</span><span class="token function">setOverlayVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      data<span class="token punctuation">.</span>hexagonGrid<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>t<span class="token punctuation">,</span> _hex<span class="token punctuation">,</span> _x<span class="token punctuation">,</span> _y<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> t<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">setOverlayVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      pathEndTile <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Resets the pathfinding state, moving a unit if a path was found. Called
   * when the mouse is released.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">resetPathfinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Check if a path was found</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pathStartTile <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> pathEndTile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Path<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> path <span class="token operator">=</span> data<span class="token punctuation">.</span>hexagonGrid<span class="token punctuation">.</span><span class="token function">findPath</span><span class="token punctuation">(</span>
        pathStartTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
        pathStartTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
        pathEndTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
        pathEndTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
        pathStartTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>remainingMovementPointsThisTurn
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Check if the path was valid</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> usedMovementPoints <span class="token operator">=</span> path<span class="token punctuation">.</span>totalCost<span class="token punctuation">;</span>

        <span class="token comment">// Subtract the required movement points, checking the value didn't go</span>
        <span class="token comment">// below 0</span>
        pathStartTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>remainingMovementPointsThisTurn <span class="token operator">-=</span>
          usedMovementPoints<span class="token punctuation">;</span>
        <span class="token keyword">assert</span> pathStartTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>remainingMovementPointsThisTurn <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// Update the game state of this and other clients</span>
        Civilisation<span class="token punctuation">.</span>CLIENT<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PacketUnitMove</span><span class="token punctuation">(</span>
          pathStartTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
          pathStartTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
          pathEndTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
          pathEndTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
          usedMovementPoints
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Move the unit</span>
        pathStartTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>tile <span class="token operator">=</span> pathEndTile<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        pathEndTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>unit <span class="token operator">=</span> pathStartTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>unit<span class="token punctuation">;</span>
        pathStartTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>unit <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token comment">// Move the unit selection if the unit was selected</span>
        pathEndTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>selected <span class="token operator">=</span> pathStartTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>selected<span class="token punctuation">;</span>
        pathStartTile<span class="token punctuation">.</span>data<span class="token punctuation">.</span>selected <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token comment">// Update the tile renders to reflect the departure/arrival of units</span>
        pathStartTile<span class="token punctuation">.</span><span class="token function">updateRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pathEndTile<span class="token punctuation">.</span><span class="token function">updateRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Notify the selected unit listener of the change too</span>
        selectedUnitListener<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>selectedUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Reset the pathfinding overlays</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pathStartTile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pathStartTile<span class="token punctuation">.</span><span class="token function">setOverlayVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      pathStartTile <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pathEndTile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resetPathfindingEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Handle an incoming packet that affects the game state. Updates the
   * updated tiles' renders too.
   *
   * @param packet packet to handle
   * @return a list of tiles that were updated, an empty array if all tiles
   * were updated, or null if no tiles were updated
   */</span>
  <span class="token keyword">public</span> Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handlePacket</span><span class="token punctuation">(</span>Packet packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Handle the packet</span>
    Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> tilesToUpdate <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">handlePacket</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Rerender the required tiles</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tilesToUpdate <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tilesToUpdate<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">updateTileRenders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>Tile tile <span class="token operator">:</span> tilesToUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Check if any units died, removing them if they did</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tile<span class="token punctuation">.</span>unit <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> tile<span class="token punctuation">.</span>unit<span class="token punctuation">.</span><span class="token function">isDead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">deleteUnit</span><span class="token punctuation">(</span>tile<span class="token punctuation">.</span>unit<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          tile<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">updateRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> tilesToUpdate<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/render/map/RenderHealthBar.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>map<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>Living<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">.</span>RenderData<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>PhongMaterial<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>shape<span class="token punctuation">.</span>Cylinder<span class="token punctuation">;</span>

<span class="token comment">/**
 * Render object for a health bar. Used by units and cities.
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RenderHealthBar</span> <span class="token keyword">extends</span> <span class="token class-name">RenderData</span><span class="token generics function"><span class="token punctuation">&lt;</span>Living<span class="token punctuation">></span></span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Whether an extended health bar should be used. Primarily for cities.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> extended<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Cylinder representing the healthy part of the health bar
   */</span>
  <span class="token keyword">private</span> Cylinder healthPart<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Cylinder representing the damaged part of the health bar
   */</span>
  <span class="token keyword">private</span> Cylinder remainingPart<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Constructor for health bar render object
   *
   * @param data     living object to render health for
   * @param extended whether an extended health bar should be used
   */</span>
  <span class="token keyword">public</span> <span class="token function">RenderHealthBar</span><span class="token punctuation">(</span>Living data<span class="token punctuation">,</span> <span class="token keyword">boolean</span> extended<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>extended <span class="token operator">=</span> extended<span class="token punctuation">;</span>

    <span class="token comment">// Translate the health bar up</span>
    <span class="token function">translateTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> extended <span class="token operator">?</span> <span class="token number">1.6</span> <span class="token operator">:</span> <span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rotateTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the cylinders</span>
    healthPart <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cylinder</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> extended <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    remainingPart <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cylinder</span><span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    remainingPart<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>SLATEGREY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">add</span><span class="token punctuation">(</span>healthPart<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span>remainingPart<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Update the state of the health bar render</span>
    <span class="token function">updateRender</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Calculate the colour for the healthy part of the bar
   *
   * @param healthPercent percentage health of the living object
   * @return colour to be used for rendering the health bar
   */</span>
  <span class="token keyword">private</span> Color <span class="token function">colorForHealthPercent</span><span class="token punctuation">(</span><span class="token keyword">double</span> healthPercent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Use a different colour depending on the interval the health percent is</span>
    <span class="token comment">// in</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>healthPercent <span class="token operator">></span> <span class="token number">0.6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Color<span class="token punctuation">.</span>LIMEGREEN<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>healthPercent <span class="token operator">></span> <span class="token number">0.4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Color<span class="token punctuation">.</span>YELLOW<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>healthPercent <span class="token operator">></span> <span class="token number">0.2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Color<span class="token punctuation">.</span>ORANGERED<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Color<span class="token punctuation">.</span>RED<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Updates the render's state based on the health of the living object it
   * represents
   *
   * @param living living object containing health data
   */</span>
  <span class="token keyword">void</span> <span class="token function">updateRender</span><span class="token punctuation">(</span>Living living<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If the living doesn't exist, or it's at max health, hide the bar</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>living <span class="token operator">==</span> null <span class="token operator">||</span> living<span class="token punctuation">.</span><span class="token function">getHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> living<span class="token punctuation">.</span><span class="token function">getBaseHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">double</span> length <span class="token operator">=</span> extended <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>

      <span class="token keyword">double</span> healthPercent <span class="token operator">=</span> living<span class="token punctuation">.</span><span class="token function">getHealthPercent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">double</span> remainingPercent <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> healthPercent<span class="token punctuation">;</span>

      <span class="token comment">// Otherwise set the colour based on the health percent</span>
      healthPart<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span><span class="token function">colorForHealthPercent</span><span class="token punctuation">(</span>healthPercent<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Set the size and position of the bar based on the health percent</span>
      healthPart<span class="token punctuation">.</span><span class="token function">setHeight</span><span class="token punctuation">(</span>healthPercent <span class="token operator">*</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      remainingPart<span class="token punctuation">.</span><span class="token function">setHeight</span><span class="token punctuation">(</span>remainingPercent <span class="token operator">*</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

      healthPart<span class="token punctuation">.</span><span class="token function">setTranslateY</span><span class="token punctuation">(</span>remainingPercent <span class="token operator">*</span> length <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      remainingPart<span class="token punctuation">.</span><span class="token function">setTranslateY</span><span class="token punctuation">(</span><span class="token operator">-</span>healthPercent <span class="token operator">*</span> length <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Make the bar visible</span>
      <span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/render/map/RenderTile.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>map<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Tile<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>map<span class="token punctuation">.</span>improvement<span class="token punctuation">.</span>RenderImprovement<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">.</span>Render<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">.</span>RenderData<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Point2D<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>PhongMaterial<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>shape<span class="token punctuation">.</span>Shape3D<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>Translate<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span>

<span class="token comment">/**
 * Render object for a hexagonal tile in the hexagon grid. Handles rendering
 * terrain, improvements, units, selections and city walls.
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RenderTile</span> <span class="token keyword">extends</span> <span class="token class-name">RenderData</span><span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Colour to render the hexagonal prism for this tile
   */</span>
  <span class="token keyword">private</span> Color colour<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Render object translated so that z=0 is on the surface of the tile. Holds
   * improvements and units.
   */</span>
  <span class="token keyword">private</span> Render aboveGround<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Render object for the tile's improvement. May not contain any children
   * if the tile doesn't have an improvement.
   */</span>
  <span class="token keyword">private</span> RenderImprovement improvement<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Render object for the unit selection overlay. Also handles rendering of
   * city boundary walls, and pathfinding routes.
   */</span>
  <span class="token keyword">private</span> RenderTileOverlay overlay<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Render object for the unit occupying this tile. Hidden if the tile doesn't
   * currently contain a unit.
   */</span>
  <span class="token keyword">private</span> RenderUnit unit<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Render object for a capital cities health bar. Null by default and only
   * created if there's a capital city on the tile.
   */</span>
  <span class="token keyword">private</span> RenderHealthBar cityHealthBar<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Height of the hexagonal prism used to represent this tile.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">double</span> height<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Tiles that are adjacent to this tile on the map.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> adjacentTiles<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Constructor for a new render object. This will be used as long as the
   * game is open and isn't destroyed/recreated when a tile update occurs.
   *
   * @param data          tile this render represents
   * @param adjacentTiles tiles adjacent to the tile this render represents
   */</span>
  <span class="token function">RenderTile</span><span class="token punctuation">(</span>Tile data<span class="token punctuation">,</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> adjacentTiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>adjacentTiles <span class="token operator">=</span> adjacentTiles<span class="token punctuation">;</span>

    <span class="token comment">// Translate this render to the appropriate position on the hex grid</span>
    Point2D center <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getHexagon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">translateTo</span><span class="token punctuation">(</span>center<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> center<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Calculate the colour for the terrain</span>
    colour <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getTerrain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getColour</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add a hexagonal prism representing the terrain</span>
    height <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Shape3D ground <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getHexagon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPrism</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ground<span class="token punctuation">.</span><span class="token function">getTransforms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Translate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ground<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>colour<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span>ground<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the render object linked to the top of the terrain</span>
    aboveGround <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    aboveGround<span class="token punctuation">.</span><span class="token function">translateTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span>aboveGround<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the improvement render object</span>
    improvement <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RenderImprovement</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> adjacentTiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    aboveGround<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>improvement<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the overlay render object for unit selection/city walls/</span>
    <span class="token comment">// pathfinding</span>
    overlay <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RenderTileOverlay</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the unit render object</span>
    unit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RenderUnit</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    unit<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>unit <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    aboveGround<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>overlay<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Update the details of all the render objects so they reflect the tile</span>
    <span class="token comment">// data</span>
    <span class="token function">updateRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">updateRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Set the overlay colour depending on whether this tile is selected and</span>
    <span class="token comment">// traversable by units</span>
    overlay<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>
      data<span class="token punctuation">.</span>selected
        <span class="token operator">?</span> Color<span class="token punctuation">.</span>LIGHTBLUE
        <span class="token operator">:</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">canTraverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> Color<span class="token punctuation">.</span>WHITE <span class="token operator">:</span> Color<span class="token punctuation">.</span>INDIANRED<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Check if there's a city on this tile</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>city <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Update the city walls</span>
      overlay<span class="token punctuation">.</span><span class="token function">setCityWalls</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>city<span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">getCityWalls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// If this is a capital city, and the health bar hasn't been added yet,</span>
      <span class="token comment">// add it</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>city<span class="token punctuation">.</span><span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">samePositionAs</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cityHealthBar <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          aboveGround<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
            cityHealthBar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RenderHealthBar</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>city<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Update the health bar render regardless of whether is was created</span>
        <span class="token comment">// now</span>
        cityHealthBar<span class="token punctuation">.</span><span class="token function">updateRender</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>city<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Mark the overlay as selected if it is</span>
    overlay<span class="token punctuation">.</span><span class="token function">setSelected</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>selected<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Update the unit render object hiding it if there isn't a unit present</span>
    <span class="token comment">// or changing its colours if there is one</span>
    unit<span class="token punctuation">.</span><span class="token function">updateRender</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    unit<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>unit <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Update the improvement render object</span>
    improvement<span class="token punctuation">.</span><span class="token function">setImprovement</span><span class="token punctuation">(</span>
      data<span class="token punctuation">.</span>improvement<span class="token punctuation">,</span>
      data<span class="token punctuation">.</span>improvementMetadata<span class="token punctuation">,</span>
      adjacentTiles
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Marks an overlay as visible. Used when a path dragged out by the user
   * covers this tile.
   *
   * @param visible whether the overlay should always be visible regardless of
   *                its selection state
   */</span>
  <span class="token keyword">void</span> <span class="token function">setOverlayVisible</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> visible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    overlay<span class="token punctuation">.</span><span class="token function">setOverlayVisible</span><span class="token punctuation">(</span>visible<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Checks if the colour of this tile is translucent. Translucent objects must
   * be added to the render tree last for the translucency effects to work
   *
   * @return whether the tiles terrain is translucent
   */</span>
  <span class="token keyword">boolean</span> <span class="token function">isTranslucent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> colour<span class="token punctuation">.</span><span class="token function">getOpacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/render/map/RenderTileOverlay.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>map<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>City<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">.</span>Render<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>

<span class="token comment">/**
 * Render object representing a tile overlay. Used for highlighting the
 * selected path, and a city's boundaries.
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">class</span> <span class="token class-name">RenderTileOverlay</span> <span class="token keyword">extends</span> <span class="token class-name">Render</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Array of the 6 different parts of the overlay (one for each hexagonal
   * edge)
   */</span>
  <span class="token keyword">private</span> RenderTileOverlayPart<span class="token punctuation">[</span><span class="token punctuation">]</span> parts<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The city this overlay covers (may be null)
   */</span>
  <span class="token keyword">private</span> City city<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Array containing information about whether adjacent tiles are part of the
   * same city.
   * &lt;p>
   * [top left, left, bottom left, bottom right, right, top right]
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cityWalls<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Color to render the overlay (depends on unit selection and traversability)
   */</span>
  <span class="token keyword">private</span> Color color<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Whether the overlay should be visible. City walls are always visible.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> visible<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Whether the tile this overlay represents has been selected
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> selected<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Constructor for a new tile overlay
   *
   * @param color starting colour for the overlay
   */</span>
  <span class="token function">RenderTileOverlay</span><span class="token punctuation">(</span>Color color<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">;</span>
    <span class="token comment">// Create an array to hold to parts</span>
    parts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RenderTileOverlayPart</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Set default values</span>
    city <span class="token operator">=</span> null<span class="token punctuation">;</span>
    cityWalls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    selected <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the part for each hexagonal edge</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">double</span> angle <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>

      RenderTileOverlayPart part <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RenderTileOverlayPart</span><span class="token punctuation">(</span>angle<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
      parts<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> part<span class="token punctuation">;</span>
      <span class="token function">add</span><span class="token punctuation">(</span>part<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Recalculates the visibility of each part from whether or not the overlay's
   * been marked as visible, it's selected, or there are city walls.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateVisibilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> parts<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      parts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">setWallVisible</span><span class="token punctuation">(</span>visible <span class="token operator">||</span> selected <span class="token operator">||</span> cityWalls<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Joins should only be visible for city walls</span>
      parts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">setJoinVisible</span><span class="token punctuation">(</span>cityWalls<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the overlay's visibility for pathfinding
   *
   * @param visible whether all overlay parts should be visible
   */</span>
  <span class="token keyword">void</span> <span class="token function">setOverlayVisible</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> visible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>visible <span class="token operator">=</span> visible<span class="token punctuation">;</span>
    <span class="token comment">// Recalculate visibilities</span>
    <span class="token function">updateVisibilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the overlay's visibility for unit selection
   *
   * @param selected whether all overlay parts should be visible
   */</span>
  <span class="token keyword">void</span> <span class="token function">setSelected</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> selected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>selected <span class="token operator">=</span> selected<span class="token punctuation">;</span>
    <span class="token comment">// Recalculate visibilities</span>
    <span class="token function">updateVisibilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the colour of the overlay if it's been selected or it's part of the
   * path
   *
   * @param color colour of the overlay
   */</span>
  <span class="token keyword">void</span> <span class="token function">setColor</span><span class="token punctuation">(</span>Color color<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">;</span>
    Color wallColour <span class="token operator">=</span> city <span class="token operator">==</span> null <span class="token operator">?</span> color <span class="token operator">:</span> city<span class="token punctuation">.</span>wallColour<span class="token punctuation">;</span>
    Color joinColour <span class="token operator">=</span> city <span class="token operator">==</span> null <span class="token operator">?</span> color <span class="token operator">:</span> city<span class="token punctuation">.</span>joinColour<span class="token punctuation">;</span>

    <span class="token comment">// Set the colour for each of the overlay parts</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> parts<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">boolean</span> walled <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cityWalls<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      RenderTileOverlayPart part <span class="token operator">=</span> parts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      part<span class="token punctuation">.</span><span class="token function">setWallColour</span><span class="token punctuation">(</span>walled <span class="token operator">?</span> wallColour <span class="token operator">:</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
      part<span class="token punctuation">.</span><span class="token function">setJoinColour</span><span class="token punctuation">(</span>walled <span class="token operator">?</span> joinColour <span class="token operator">:</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets this overlay's city walls containing information about whether
   * adjacent tiles are part of the same city.
   *
   * @param city       city the overlay is part of
   * @param walls      array containing wall information.
   *                   [top left, left, bottom left,
   *                   bottom right, right, top right]
   * @param tileHeight height of the tile this overlay covers
   */</span>
  <span class="token keyword">void</span> <span class="token function">setCityWalls</span><span class="token punctuation">(</span>City city<span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> walls<span class="token punctuation">,</span> <span class="token keyword">double</span> tileHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>city <span class="token operator">=</span> city<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> parts<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">boolean</span> walled <span class="token operator">=</span> walls<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">double</span> wallHeight <span class="token operator">=</span> city<span class="token punctuation">.</span>greatestTileHeight <span class="token operator">+</span> <span class="token number">0.2</span> <span class="token operator">-</span> tileHeight<span class="token punctuation">;</span>
      RenderTileOverlayPart part <span class="token operator">=</span> parts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">// Update wall state for each part</span>
      part<span class="token punctuation">.</span><span class="token function">setWallColour</span><span class="token punctuation">(</span>walled <span class="token operator">?</span> city<span class="token punctuation">.</span>wallColour <span class="token operator">:</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
      part<span class="token punctuation">.</span><span class="token function">setJoinColour</span><span class="token punctuation">(</span>walled <span class="token operator">?</span> city<span class="token punctuation">.</span>joinColour <span class="token operator">:</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>

      part<span class="token punctuation">.</span><span class="token function">setWallVisible</span><span class="token punctuation">(</span>walled<span class="token punctuation">)</span><span class="token punctuation">;</span>
      part<span class="token punctuation">.</span><span class="token function">setJoinVisible</span><span class="token punctuation">(</span>walled<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Set the height of the part to be different depending on whether this</span>
      <span class="token comment">// is just a selection/path route</span>
      <span class="token keyword">double</span> targetHeight <span class="token operator">=</span> walled <span class="token operator">?</span> wallHeight <span class="token operator">:</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
      part<span class="token punctuation">.</span><span class="token function">setWallHeight</span><span class="token punctuation">(</span>targetHeight<span class="token punctuation">,</span> tileHeight<span class="token punctuation">,</span> city<span class="token punctuation">.</span>greatestTileHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cityWalls <span class="token operator">=</span> walls<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/render/map/RenderUnit.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>map<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>Unit<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>UnitType<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">.</span>Render<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">.</span>RenderData<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>PhongMaterial<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>shape<span class="token punctuation">.</span>Cylinder<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>shape<span class="token punctuation">.</span>Sphere<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>Rotate<span class="token punctuation">;</span>

<span class="token comment">/**
 * Render object for a unit. Containing within a {@link RenderTile}. Always
 * added to the tile, but only visible if a unit exists on the tile.
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">class</span> <span class="token class-name">RenderUnit</span> <span class="token keyword">extends</span> <span class="token class-name">RenderData</span><span class="token generics function"><span class="token punctuation">&lt;</span>Unit<span class="token punctuation">></span></span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Constant for the height of a rocket body
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> ROCKET_HEIGHT <span class="token operator">=</span> <span class="token number">1.2</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Constant for the height of a rocket engine
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> ROCKET_ENGINE_HEIGHT <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Array containing the torsos of all the people. Stored so that the colours
   * can be changed when the unit changes. The torso colour is based on the
   * unit type.
   */</span>
  <span class="token keyword">private</span> Cylinder<span class="token punctuation">[</span><span class="token punctuation">]</span> torsos<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Array containing the belts of all the people. Stored so that the colours
   * can be changed when the unit changes. The belt colour is based on the
   * colour of the owning player.
   */</span>
  <span class="token keyword">private</span> Cylinder<span class="token punctuation">[</span><span class="token punctuation">]</span> belts<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Array containing the render objects that wrap all the components of a
   * person. There are 7 people representing each unit. The amount that are
   * shown depends on the health of the unit.
   */</span>
  <span class="token keyword">private</span> Render<span class="token punctuation">[</span><span class="token punctuation">]</span> people<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Render object representing a rocket. Only shown when the unit's type is
   * {@link UnitType#ROCKET}.
   */</span>
  <span class="token keyword">private</span> Render rocket<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Render object for showing a unit's health.
   */</span>
  <span class="token keyword">private</span> RenderHealthBar healthBar<span class="token punctuation">;</span>

  <span class="token function">RenderUnit</span><span class="token punctuation">(</span>Unit data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create arrays for render components</span>
    torsos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cylinder</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    belts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cylinder</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    people <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Render</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the render objects for the people and rocket</span>
    <span class="token function">add</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">buildPerson</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span>rocket <span class="token operator">=</span> <span class="token function">buildRocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Render rotor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      rotor<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">buildPerson</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Pivot the person around the center</span>
      rotor<span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">setX</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      rotor<span class="token punctuation">.</span>rotateZ<span class="token punctuation">.</span><span class="token function">setAngle</span><span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">add</span><span class="token punctuation">(</span>rotor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Create and add the health bar</span>
    <span class="token function">add</span><span class="token punctuation">(</span>healthBar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RenderHealthBar</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Creates a render object representing a person facing forward
   *
   * @param i index of this person (0 for center, 1 - 6 anticlockwise from
   *          right)
   * @return render object containing components representing a person
   */</span>
  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"Duplicates"</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> Render <span class="token function">buildPerson</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Render person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Build legs</span>
    Cylinder leg1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cylinder</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    leg1<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>LIGHTGOLDENRODYELLOW<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    leg1<span class="token punctuation">.</span><span class="token function">setTranslateX</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    leg1<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    leg1<span class="token punctuation">.</span><span class="token function">setRotationAxis</span><span class="token punctuation">(</span>Rotate<span class="token punctuation">.</span>X_AXIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    leg1<span class="token punctuation">.</span><span class="token function">setRotate</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    person<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>leg1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Cylinder leg2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cylinder</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    leg2<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>LIGHTGOLDENRODYELLOW<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    leg2<span class="token punctuation">.</span><span class="token function">setTranslateX</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    leg2<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    leg2<span class="token punctuation">.</span><span class="token function">setRotationAxis</span><span class="token punctuation">(</span>Rotate<span class="token punctuation">.</span>X_AXIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    leg2<span class="token punctuation">.</span><span class="token function">setRotate</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    person<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>leg2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Build torso</span>
    Cylinder torso <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cylinder</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    torso<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>WHITE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    torso<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span><span class="token number">0.2</span> <span class="token operator">+</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    torso<span class="token punctuation">.</span><span class="token function">setRotationAxis</span><span class="token punctuation">(</span>Rotate<span class="token punctuation">.</span>X_AXIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    torso<span class="token punctuation">.</span><span class="token function">setRotate</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    person<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>torso<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Store torso so the colour can be changed later</span>
    torsos<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torso<span class="token punctuation">;</span>

    <span class="token comment">// Build belt</span>
    Cylinder belt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cylinder</span><span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    belt<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>WHITE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    belt<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span><span class="token number">0.2</span> <span class="token operator">+</span> <span class="token number">0.15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    belt<span class="token punctuation">.</span><span class="token function">setRotationAxis</span><span class="token punctuation">(</span>Rotate<span class="token punctuation">.</span>X_AXIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    belt<span class="token punctuation">.</span><span class="token function">setRotate</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    person<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>belt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Store belt so the colour can be changed later</span>
    belts<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> belt<span class="token punctuation">;</span>

    <span class="token comment">// Build head</span>
    Sphere head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sphere</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>LIGHTGOLDENRODYELLOW<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span><span class="token number">0.2</span> <span class="token operator">+</span> <span class="token number">0.4</span> <span class="token operator">+</span> <span class="token number">0.27</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    person<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Build eyes</span>
    Sphere eye <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sphere</span><span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    eye<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>BLACK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    eye<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span><span class="token number">0.2</span> <span class="token operator">+</span> <span class="token number">0.4</span> <span class="token operator">+</span> <span class="token number">0.27</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    eye<span class="token punctuation">.</span><span class="token function">setTranslateX</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    eye<span class="token punctuation">.</span><span class="token function">setTranslateY</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    person<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Sphere eye2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sphere</span><span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    eye2<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>BLACK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    eye2<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span><span class="token number">0.2</span> <span class="token operator">+</span> <span class="token number">0.4</span> <span class="token operator">+</span> <span class="token number">0.27</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    eye2<span class="token punctuation">.</span><span class="token function">setTranslateX</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    eye2<span class="token punctuation">.</span><span class="token function">setTranslateY</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    person<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>eye2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Make the person a bit smaller than it otherwise would be</span>
    person<span class="token punctuation">.</span><span class="token function">scaleTo</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Rotate the person that when it is pivoted, it will still be facing</span>
    <span class="token comment">// forward</span>
    <span class="token keyword">double</span> angle <span class="token operator">=</span> <span class="token number">180</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> angle <span class="token operator">-=</span> <span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">;</span>
    person<span class="token punctuation">.</span>rotateZ<span class="token punctuation">.</span><span class="token function">setAngle</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> person<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Creates a render object representing a rocket
   *
   * @return render object containing components representing a rocket
   */</span>
  <span class="token keyword">private</span> Render <span class="token function">buildRocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Render rocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Build rocket engine (bottom bit underneath body)</span>
    Cylinder engine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cylinder</span><span class="token punctuation">(</span><span class="token number">0.11</span><span class="token punctuation">,</span> ROCKET_ENGINE_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    engine<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span>ROCKET_ENGINE_HEIGHT <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    engine<span class="token punctuation">.</span><span class="token function">setRotationAxis</span><span class="token punctuation">(</span>Rotate<span class="token punctuation">.</span>X_AXIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    engine<span class="token punctuation">.</span><span class="token function">setRotate</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    engine<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>UnitType<span class="token punctuation">.</span>ROCKET<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">brighter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    rocket<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Build rocket body</span>
    Cylinder body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cylinder</span><span class="token punctuation">(</span><span class="token number">0.22</span><span class="token punctuation">,</span> ROCKET_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    body<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span>ROCKET_HEIGHT <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> ROCKET_ENGINE_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    body<span class="token punctuation">.</span><span class="token function">setRotationAxis</span><span class="token punctuation">(</span>Rotate<span class="token punctuation">.</span>X_AXIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    body<span class="token punctuation">.</span><span class="token function">setRotate</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    body<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>UnitType<span class="token punctuation">.</span>ROCKET<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rocket<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Build nose cone</span>
    Sphere cone <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sphere</span><span class="token punctuation">(</span><span class="token number">0.22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cone<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span>ROCKET_HEIGHT <span class="token operator">+</span> ROCKET_ENGINE_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cone<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>UnitType<span class="token punctuation">.</span>ROCKET<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rocket<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cone<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Hide the rocket by default</span>
    rocket<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> rocket<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Update the render for the unit now placed on the tile. Sets the colour and
   * visibility of various components
   *
   * @param unit unit to take data for the update from
   */</span>
  <span class="token keyword">void</span> <span class="token function">updateRender</span><span class="token punctuation">(</span>Unit unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>unit <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Show the rocket if this is the rocket type</span>
      rocket<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span>unit<span class="token punctuation">.</span>unitType <span class="token operator">==</span> UnitType<span class="token punctuation">.</span>ROCKET<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Build materials for the unit colours</span>
      PhongMaterial torsoMaterial <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>unit<span class="token punctuation">.</span>unitType<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      PhongMaterial beltMaterial <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>unit<span class="token punctuation">.</span>player<span class="token punctuation">.</span><span class="token function">getColour</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Show a proportionate amount of people for the health</span>
      <span class="token keyword">double</span> healthPercent <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">getHealthPercent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">double</span> onePersonProportion <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> people<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> people<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Update the colours</span>
        torsos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span>torsoMaterial<span class="token punctuation">)</span><span class="token punctuation">;</span>
        belts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span>beltMaterial<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Update the visibility for the health</span>
        people<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span>healthPercent <span class="token operator">>=</span> i <span class="token operator">*</span> onePersonProportion<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Update the health bar render with new information</span>
    healthBar<span class="token punctuation">.</span><span class="token function">updateRender</span><span class="token punctuation">(</span>unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/render/map/RenderTileOverlayPart.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>map<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Hexagon<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">.</span>Render<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>PointLight<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>PhongMaterial<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>shape<span class="token punctuation">.</span>Box<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>shape<span class="token punctuation">.</span>Cylinder<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>Rotate<span class="token punctuation">;</span>

<span class="token comment">/**
 * Render object for one part of the tile overlay. One part represents one edge
 * of a hexagon.
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">class</span> <span class="token class-name">RenderTileOverlayPart</span> <span class="token keyword">extends</span> <span class="token class-name">Render</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * The wall part. Used for selections/path highlighting and city walls.
   */</span>
  <span class="token keyword">private</span> Box wall<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The join between segments of walls in a city.
   */</span>
  <span class="token keyword">private</span> Cylinder join<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Creates a new tile part
   *
   * @param angle  pivot angle for the part
   * @param colour initial colour of the part
   */</span>
  <span class="token function">RenderTileOverlayPart</span><span class="token punctuation">(</span><span class="token keyword">double</span> angle<span class="token punctuation">,</span> Color colour<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create and pivot the wall</span>
    Render wallHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wallHolder<span class="token punctuation">.</span>rotateZ<span class="token punctuation">.</span><span class="token function">setAngle</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    wallHolder<span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">setY</span><span class="token punctuation">(</span>Hexagon<span class="token punctuation">.</span>SQRT_3 <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wall <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Box</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wall<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>colour<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wall<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wall<span class="token punctuation">.</span><span class="token function">setTranslateY</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wall<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wallHolder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wall<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create and pivot the join</span>
    Render joinHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    joinHolder<span class="token punctuation">.</span>rotateZ<span class="token punctuation">.</span><span class="token function">setAngle</span><span class="token punctuation">(</span>angle <span class="token operator">+</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    joinHolder<span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">setY</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    join <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cylinder</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    join<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>colour<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    join<span class="token punctuation">.</span><span class="token function">setRotationAxis</span><span class="token punctuation">(</span>Rotate<span class="token punctuation">.</span>X_AXIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    join<span class="token punctuation">.</span><span class="token function">setRotate</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    join<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    join<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    joinHolder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>join<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">add</span><span class="token punctuation">(</span>wallHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span>joinHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the visibility of the wall component of this part
   *
   * @param visible whether the wall should be visible
   */</span>
  <span class="token keyword">void</span> <span class="token function">setWallVisible</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> visible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    wall<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span>visible<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the visibility of the join component of this part
   *
   * @param visible whether the join should be visible
   */</span>
  <span class="token keyword">void</span> <span class="token function">setJoinVisible</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> visible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    join<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span>visible<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the colour of the wall component of this part
   *
   * @param colour new colour for the wall component
   */</span>
  <span class="token keyword">void</span> <span class="token function">setWallColour</span><span class="token punctuation">(</span>Color colour<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    wall<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>colour<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the colour of the join component of this part
   *
   * @param colour new colour for the join component
   */</span>
  <span class="token keyword">void</span> <span class="token function">setJoinColour</span><span class="token punctuation">(</span>Color colour<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    join<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>colour<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets height of the wall/join components
   *
   * @param height             new height of the wall
   * @param tileHeight         height of the tile this overlay represents
   * @param greatestTileHeight greatest tile height of all tiles in the
   *                           containing city
   */</span>
  <span class="token keyword">void</span> <span class="token function">setWallHeight</span><span class="token punctuation">(</span>
    <span class="token keyword">double</span> height<span class="token punctuation">,</span>
    <span class="token keyword">double</span> tileHeight<span class="token punctuation">,</span>
    <span class="token keyword">double</span> greatestTileHeight
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    wall<span class="token punctuation">.</span><span class="token function">setDepth</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    wall<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span>height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Update the join height</span>
    <span class="token function">updateJoinHeight</span><span class="token punctuation">(</span>tileHeight<span class="token punctuation">,</span> greatestTileHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Updates the join height so that it reaches the bottom of the ground
   *
   * @param tileHeight         height of the tile this overlay represents
   * @param greatestTileHeight greatest tile height of all tiles in the
   *                           containing city
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateJoinHeight</span><span class="token punctuation">(</span><span class="token keyword">double</span> tileHeight<span class="token punctuation">,</span> <span class="token keyword">double</span> greatestTileHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Height of this join</span>
    <span class="token keyword">double</span> joinHeight <span class="token operator">=</span> greatestTileHeight <span class="token operator">+</span> <span class="token number">0.4</span><span class="token punctuation">;</span>

    join<span class="token punctuation">.</span><span class="token function">setHeight</span><span class="token punctuation">(</span>joinHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Translate the join so that it has the same height and vertical position</span>
    <span class="token comment">// for each tile in the containing city</span>
    join<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span><span class="token operator">-</span>tileHeight <span class="token operator">+</span> <span class="token punctuation">(</span>joinHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/ui/connect/ClientCreator.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>connect<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>

<span class="token comment">/**
 * Function called when the user requests a connection be made to the server
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ClientCreator</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Create client callback
   *
   * @param host server host IP/URL
   * @param port server port number
   * @param id   desired id of the player
   * @throws IOException if a connection cannot be established
   */</span>
  <span class="token keyword">void</span> <span class="token function">createClient</span><span class="token punctuation">(</span>String host<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> String id<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/ui/connect/ScreenConnect.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>connect<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>MapSize<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>CivilisationServer<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>Screen<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>UIHelpers<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>application<span class="token punctuation">.</span>Platform<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>value<span class="token punctuation">.</span>ChangeListener<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>FXCollections<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>ObservableList<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Pos<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>Node<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>Scene<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>control<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>GridPane<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>HBox<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>StackPane<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>stage<span class="token punctuation">.</span>Stage<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>File<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileReader<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span>Files<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span>Path<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span>Paths<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>Collectors<span class="token punctuation">;</span>

<span class="token comment">/**
 * Screen for letting a user join a game, create a new game, or load an
 * existing game. The first screen the user lands on when the game starts.
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScreenConnect</span> <span class="token keyword">extends</span> <span class="token class-name">Screen</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Enum representing the choices the user has on this screen. These are
   * translated to radio buttons to allow the user to select each one. When
   * clicked they en/disable various UI components that are(n't) needed.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">enum</span> Choice <span class="token punctuation">{</span>
    <span class="token function">JOIN</span><span class="token punctuation">(</span><span class="token string">"Join a Game"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">HOST</span><span class="token punctuation">(</span><span class="token string">"Create and Host a New Game"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">LOAD</span><span class="token punctuation">(</span><span class="token string">"Load and Host a Saved Game"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Description of this choice. To be displayed on the radio button for this
     * choice.
     */</span>
    <span class="token keyword">private</span> String description<span class="token punctuation">;</span>

    <span class="token function">Choice</span><span class="token punctuation">(</span>String description<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>description <span class="token operator">=</span> description<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Class representing a game save file to be shown in the save list
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">GameSave</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * Path to the game save file, should end with .yml.
     */</span>
    <span class="token keyword">private</span> String filePath<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Name of the game, loaded from the file
     */</span>
    <span class="token keyword">private</span> String gameName<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token function">GameSave</span><span class="token punctuation">(</span>String filePath<span class="token punctuation">,</span> String gameName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>filePath <span class="token operator">=</span> filePath<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>gameName <span class="token operator">=</span> gameName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Function to be called when the user requests a connection to a server
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> ClientCreator clientCreator<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Function to be called when the user requests a server be created
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> ServerCreator serverCreator<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Array containing all the game saves in the "saves" directory
   */</span>
  <span class="token keyword">private</span> GameSave<span class="token punctuation">[</span><span class="token punctuation">]</span> saves<span class="token punctuation">;</span>

  <span class="token comment">/**
   * User's selected choice. Determines what UI elements to enable and how to
   * handle the Join/Host button click.
   */</span>
  <span class="token keyword">private</span> Choice choice <span class="token operator">=</span> Choice<span class="token punctuation">.</span>JOIN<span class="token punctuation">;</span>
  <span class="token comment">/**
   * User's selected map size. Used when creating a new game.
   */</span>
  <span class="token keyword">private</span> MapSize selectedMapSize <span class="token operator">=</span> MapSize<span class="token punctuation">.</span>STANDARD<span class="token punctuation">;</span>
  <span class="token comment">/**
   * List containing names of game saves. Observable so changes made to it can
   * be reflected in the combo box for names.
   */</span>
  <span class="token keyword">private</span> ObservableList<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> nameList<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Combo box for name that lists all the values in nameList.
   */</span>
  <span class="token keyword">private</span> ComboBox<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> nameBox<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Array containing all radio buttons for controlling map size. Stored so
   * they can be en/disabled when the user's choice changes.
   */</span>
  <span class="token keyword">private</span> RadioButton<span class="token punctuation">[</span><span class="token punctuation">]</span> sizeRadioButtons<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Text field for the host name of the server to connect too.
   */</span>
  <span class="token keyword">private</span> TextField hostField<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Text field for the port number of the server to connect too. Should only
   * accept numeric values.
   */</span>
  <span class="token keyword">private</span> TextField portField<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Text field for the user's player ID when joining a server. Controls unit/
   * cities owners, panel border colours, etc.
   */</span>
  <span class="token keyword">private</span> TextField idField<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Button that joins/hosts a game depending on the user's choice. Should
   * only be enabled if all the required UI components have sensible data.
   */</span>
  <span class="token keyword">private</span> Button joinButton<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Pane containing UI elements for choices, host, sizes, id, port, and other
   * connection details. Should be hidden when the user clicks the join button.
   */</span>
  <span class="token keyword">private</span> GridPane pane<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Loading indicator shown when the user clicks the join button to indicate
   * that something is happening.
   */</span>
  <span class="token keyword">private</span> ProgressIndicator progressIndicator<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Constructor for a new connection screen
   *
   * @param clientCreator callback function for creating a client
   * @param serverCreator callback function for creating a server
   */</span>
  <span class="token keyword">public</span> <span class="token function">ScreenConnect</span><span class="token punctuation">(</span>
    ClientCreator clientCreator<span class="token punctuation">,</span>
    ServerCreator serverCreator
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>clientCreator <span class="token operator">=</span> clientCreator<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>serverCreator <span class="token operator">=</span> serverCreator<span class="token punctuation">;</span>

    <span class="token comment">// Load all available game saves</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// Get a reference to the saves directory</span>
      <span class="token comment">// ("current working directory/saves")</span>
      String savesDirectoryPath <span class="token operator">=</span>
        System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"user.dir"</span><span class="token punctuation">)</span> <span class="token operator">+</span> File<span class="token punctuation">.</span>separator <span class="token operator">+</span> <span class="token string">"saves"</span><span class="token punctuation">;</span>
      File savesDirectory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>savesDirectoryPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Check if the folder exists, otherwise make it</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>savesDirectory<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> made <span class="token operator">=</span> savesDirectory<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>made<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"unable to create saves directory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Load the list of GameSave objects</span>
      saves <span class="token operator">=</span> Files<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>Paths<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>savesDirectoryPath<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// Convert path objects to their absolute file path</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Path<span class="token operator">:</span><span class="token operator">:</span>toString<span class="token punctuation">)</span>
        <span class="token comment">// We only want files ending with .yml</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>path <span class="token operator">-</span><span class="token operator">></span> path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">".yml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>path <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token comment">// Load the game save as we normally would to extract the name</span>
          String name <span class="token operator">=</span> <span class="token string">"Unknown"</span><span class="token punctuation">;</span>
          <span class="token keyword">try</span> <span class="token punctuation">(</span>FileReader reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//noinspection unchecked</span>
            Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> map <span class="token operator">=</span>
              CivilisationServer<span class="token punctuation">.</span>YAML<span class="token punctuation">.</span><span class="token function">loadAs</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> Map<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            name <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// Return a new game save object with the required data</span>
          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GameSave</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// Convert the stream to an array</span>
        <span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>GameSave<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Set the loading state. Shows/hides the details pane/loading indicator.
   *
   * @param loading whether to show the loading indicator
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> loading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Hide the pane if we're loading. Do this with setOpacity not setVisible</span>
    <span class="token comment">// so the pane is still used in layout calculations (so the wrapping title</span>
    <span class="token comment">// pane doesn't change size).</span>
    pane<span class="token punctuation">.</span><span class="token function">setOpacity</span><span class="token punctuation">(</span>loading <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// We can just use setVisible for the loading indicator. It's smaller than</span>
    <span class="token comment">// the pane.</span>
    progressIndicator<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span>loading<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Set all the size radio buttons disabled state
   *
   * @param disable whether all the buttons should be disabled
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setSizeRadioButtonsDisable</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> disable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>RadioButton sizeRadioButton <span class="token operator">:</span> sizeRadioButtons<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sizeRadioButton<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span>disable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Calculates whether the join button should be enabled from the state of the
   * other UI components. Which UI components to check depends on the user's
   * choice.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkJoinButtonEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> enabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>choice<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> JOIN<span class="token operator">:</span>
        <span class="token comment">// If we're joining a game, we need a host name, port number, and</span>
        <span class="token comment">// player ID</span>
        enabled <span class="token operator">=</span> <span class="token operator">!</span>hostField<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>portField<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>idField<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> HOST<span class="token operator">:</span>
        <span class="token comment">// If we're hosting a game, we need a new game name, port number, and</span>
        <span class="token comment">// player ID. We also need a map size, but this will always be set.</span>
        enabled <span class="token operator">=</span> <span class="token operator">!</span>nameBox<span class="token punctuation">.</span><span class="token function">getEditor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>portField<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>idField<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> LOAD<span class="token operator">:</span>
        <span class="token comment">// If we're loading an existing game, we need an existing game name, a</span>
        <span class="token comment">// port number, and player ID.</span>
        enabled <span class="token operator">=</span> nameBox<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null
          <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>nameBox<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>portField<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>idField<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Set the enabled state</span>
    joinButton<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span><span class="token operator">!</span>enabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * En/disables the required UI components for the user's new choice
   * selection.
   *
   * @param choice new selected choice
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">resetForChoice</span><span class="token punctuation">(</span>Choice choice<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Store the choice selection</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>choice <span class="token operator">=</span> choice<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>choice<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> JOIN<span class="token operator">:</span>
        <span class="token comment">// If we're joining a game, we need a host name, port number, and</span>
        <span class="token comment">// player ID</span>
        nameList<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nameBox<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nameBox<span class="token punctuation">.</span><span class="token function">setEditable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Disable map size selection buttons</span>
        <span class="token function">setSizeRadioButtonsDisable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hostField<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        joinButton<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"Join"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> HOST<span class="token operator">:</span>
        <span class="token comment">// If we're hosting a game, we need a new game name, map size, port</span>
        <span class="token comment">// number, and player ID.</span>
        nameList<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nameBox<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nameBox<span class="token punctuation">.</span><span class="token function">setEditable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Enable map size selection buttons</span>
        <span class="token function">setSizeRadioButtonsDisable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hostField<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        joinButton<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"Host and Join"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> LOAD<span class="token operator">:</span>
        <span class="token comment">// If we're loading an existing game, we need an existing game name, a</span>
        <span class="token comment">// port number, and player ID.</span>
        nameList<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Get existing game names</span>
        nameList<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>
          Arrays<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>saves<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>save <span class="token operator">-</span><span class="token operator">></span> save<span class="token punctuation">.</span>gameName<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        nameBox<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nameBox<span class="token punctuation">.</span><span class="token function">setEditable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nameList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> nameBox<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>nameList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Disable map size selection buttons</span>
        <span class="token function">setSizeRadioButtonsDisable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hostField<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        joinButton<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"Host and Join"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">checkJoinButtonEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Called on click of the join button.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Show the loading indicator</span>
    <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Start a new thread for launching the client/server. This should be</span>
    <span class="token comment">// done in a separate thread so the UI thread isn't blocked. This would</span>
    <span class="token comment">// cause the loading spinner animation not to work.</span>
    Thread bootstrapThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Get the port number and player ID as these are required for all</span>
        <span class="token comment">// choices</span>
        <span class="token keyword">int</span> port <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>portField<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String id <span class="token operator">=</span> idField<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>choice<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">case</span> JOIN<span class="token operator">:</span>
            <span class="token comment">// If we're joining a game, get the host name and connect to it</span>
            String host <span class="token operator">=</span> hostField<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            clientCreator<span class="token punctuation">.</span><span class="token function">createClient</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> HOST<span class="token operator">:</span>
            <span class="token comment">// If we're hosting a game, get the new game name</span>
            String newGameName <span class="token operator">=</span> nameBox<span class="token punctuation">.</span><span class="token function">getEditor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Make a file name for this game name. (lower case,</span>
            <span class="token comment">// spaces -> underscores, + .yml)</span>
            String newGameFileName <span class="token operator">=</span> <span class="token string">"saves"</span> <span class="token operator">+</span> File<span class="token punctuation">.</span>separator <span class="token operator">+</span> newGameName
              <span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">)</span>
              <span class="token operator">+</span> <span class="token string">".yml"</span><span class="token punctuation">;</span>
            <span class="token comment">// Create the server and then immediately connect to it as if it</span>
            <span class="token comment">// was over the network. Even though we running these in the same</span>
            <span class="token comment">// program instance and could exchange data more efficiently, this</span>
            <span class="token comment">// reduces the need to write duplicate code for exchanging data</span>
            <span class="token comment">// between the client and server.</span>
            serverCreator<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>
              newGameFileName<span class="token punctuation">,</span>
              newGameName<span class="token punctuation">,</span>
              selectedMapSize<span class="token punctuation">,</span>
              port
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Use the local loopback address as the host name (this computer)</span>
            clientCreator<span class="token punctuation">.</span><span class="token function">createClient</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> port<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> LOAD<span class="token operator">:</span>
            <span class="token comment">// Get the existing game name</span>
            String loadGameName <span class="token operator">=</span> nameBox<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Try and find the game save with that name, we should be able to</span>
            <span class="token comment">// because these names come from the list of game saves</span>
            GameSave loadGameSave <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>GameSave gameSave <span class="token operator">:</span> saves<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>gameSave<span class="token punctuation">.</span>gameName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>loadGameName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                loadGameSave <span class="token operator">=</span> gameSave<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Check we did find a save</span>
            <span class="token keyword">assert</span> loadGameSave <span class="token operator">!=</span> null<span class="token punctuation">;</span>
            <span class="token comment">// Create the server and then immediately connect to it as if it</span>
            <span class="token comment">// was over the network. See above comment for more details. We</span>
            <span class="token comment">// pass null as the game name here to signify that we want to load</span>
            <span class="token comment">// the game save. This makes the passed map size irrelevant.</span>
            serverCreator<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>
              loadGameSave<span class="token punctuation">.</span>filePath<span class="token punctuation">,</span>
              null<span class="token punctuation">,</span>
              MapSize<span class="token punctuation">.</span>STANDARD<span class="token punctuation">,</span>
              port
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Use the local loopback address as the host name (this computer)</span>
            clientCreator<span class="token punctuation">.</span><span class="token function">createClient</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> port<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If there was an error, show a dialog on the UI thread stating such</span>
        Platform<span class="token punctuation">.</span><span class="token function">runLater</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          UIHelpers<span class="token punctuation">.</span><span class="token function">showDialog</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bootstrapThread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Bootstrap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bootstrapThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Function to check whether text only contains digits
   *
   * @param text text to check against
   * @return whether the text only contains digits
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isDigits</span><span class="token punctuation">(</span>String text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">char</span> c <span class="token operator">:</span> text<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">int</span> code <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> c<span class="token punctuation">;</span>
      <span class="token comment">// Check every ASCII code is between 0 and 9.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">&lt;</span> <span class="token number">48</span> <span class="token operator">||</span> code <span class="token operator">></span> <span class="token number">57</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Wraps a node with a titled border
   *
   * @param title title for the border
   * @param child node to wrap
   * @return titled pane containing the child
   */</span>
  <span class="token keyword">private</span> TitledPane <span class="token function">makeTitledPane</span><span class="token punctuation">(</span>String title<span class="token punctuation">,</span> Node child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TitledPane titledPane <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TitledPane</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Specify a desired size for the child (it would fill the screen</span>
    <span class="token comment">// otherwise)</span>
    titledPane<span class="token punctuation">.</span><span class="token function">setMaxSize</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Titled panes are collapsible by default which is something we don't</span>
    <span class="token comment">// really want</span>
    titledPane<span class="token punctuation">.</span><span class="token function">setCollapsible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> titledPane<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Creates a scene representing this screen
   *
   * @param stage  stage the scene would be placed in
   * @param width  width of the screen
   * @param height height of the screen
   * @return scene representing this screen
   */</span>
  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"Duplicates"</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> Scene <span class="token function">makeScene</span><span class="token punctuation">(</span>Stage stage<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create a change listener that will be used in all UI components to</span>
    <span class="token comment">// check whether the join button should be enabled when data changes.</span>
    ChangeListener<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> changeListener <span class="token operator">=</span>
      <span class="token punctuation">(</span>observable<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">checkJoinButtonEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    pane <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GridPane</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pane<span class="token punctuation">.</span><span class="token function">setHgap</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pane<span class="token punctuation">.</span><span class="token function">setVgap</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create choice radio buttons, adding them to a toggle group so only one</span>
    <span class="token comment">// choice can be selected at once.</span>
    ToggleGroup choiceToggleGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToggleGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Choice<span class="token punctuation">[</span><span class="token punctuation">]</span> choices <span class="token operator">=</span> Choice<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> choices<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> Choice choice <span class="token operator">=</span> choices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      RadioButton choiceRadioButton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RadioButton</span><span class="token punctuation">(</span>choice<span class="token punctuation">.</span>description<span class="token punctuation">)</span><span class="token punctuation">;</span>
      choiceRadioButton<span class="token punctuation">.</span><span class="token function">setToggleGroup</span><span class="token punctuation">(</span>choiceToggleGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Reset other UI components on button selection change</span>
      choiceRadioButton<span class="token punctuation">.</span><span class="token function">setOnAction</span><span class="token punctuation">(</span>e <span class="token operator">-</span><span class="token operator">></span> <span class="token function">resetForChoice</span><span class="token punctuation">(</span>choice<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Add the button to the pane filling all available width</span>
      pane<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>choiceRadioButton<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Set a default selection</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>choice <span class="token operator">==</span> Choice<span class="token punctuation">.</span>JOIN<span class="token punctuation">)</span> choiceRadioButton<span class="token punctuation">.</span><span class="token function">setSelected</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Create labels</span>
    Label nameLabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span><span class="token string">"Name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Label hostLabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span><span class="token string">"Host"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Label portLabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span><span class="token string">"Port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Label idLabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span><span class="token string">"ID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nameLabel<span class="token punctuation">.</span><span class="token function">setPrefWidth</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hostLabel<span class="token punctuation">.</span><span class="token function">setPrefWidth</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    portLabel<span class="token punctuation">.</span><span class="token function">setPrefWidth</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    idLabel<span class="token punctuation">.</span><span class="token function">setPrefWidth</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the game name box, this will act like a text field when creating</span>
    <span class="token comment">// a new game, and a combo box when selecting a game to load</span>
    nameList <span class="token operator">=</span> FXCollections<span class="token punctuation">.</span><span class="token function">observableArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nameBox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComboBox</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>nameList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nameBox<span class="token punctuation">.</span><span class="token function">setPrefWidth</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nameBox<span class="token punctuation">.</span><span class="token function">setEditable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nameBox<span class="token punctuation">.</span><span class="token function">valueProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>changeListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Watch for changes</span>
    nameBox<span class="token punctuation">.</span><span class="token function">getEditor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">textProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>changeListener<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the size radio buttons row</span>
    HBox sizeBox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HBox</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ToggleGroup sizeToggleGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToggleGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MapSize<span class="token punctuation">[</span><span class="token punctuation">]</span> mapSizes <span class="token operator">=</span> MapSize<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sizeRadioButtons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RadioButton</span><span class="token punctuation">[</span>mapSizes<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mapSizes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> MapSize mapSize <span class="token operator">=</span> mapSizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      RadioButton sizeRadioButton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RadioButton</span><span class="token punctuation">(</span>mapSize<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      sizeRadioButton<span class="token punctuation">.</span><span class="token function">setToggleGroup</span><span class="token punctuation">(</span>sizeToggleGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Store the new selected state</span>
      sizeRadioButton<span class="token punctuation">.</span><span class="token function">setOnAction</span><span class="token punctuation">(</span>e <span class="token operator">-</span><span class="token operator">></span> selectedMapSize <span class="token operator">=</span> mapSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Set a default selection</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mapSize <span class="token operator">==</span> MapSize<span class="token punctuation">.</span>STANDARD<span class="token punctuation">)</span> sizeRadioButton<span class="token punctuation">.</span><span class="token function">setSelected</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      sizeRadioButtons<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> sizeRadioButton<span class="token punctuation">;</span>
      sizeBox<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sizeRadioButton<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Create text fields</span>
    hostField <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextField</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    portField <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextField</span><span class="token punctuation">(</span><span class="token string">"1234"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    idField <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Make sure that the port field only allows digits to be inputted</span>
    portField<span class="token punctuation">.</span><span class="token function">setTextFormatter</span><span class="token punctuation">(</span>
      <span class="token comment">// Returning null discards the change</span>
      <span class="token keyword">new</span> <span class="token class-name">TextFormatter</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>change <span class="token operator">-</span><span class="token operator">></span> <span class="token function">isDigits</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> change <span class="token operator">:</span> null<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Register text change listeners</span>
    hostField<span class="token punctuation">.</span><span class="token function">textProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>changeListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    portField<span class="token punctuation">.</span><span class="token function">textProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>changeListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    idField<span class="token punctuation">.</span><span class="token function">textProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>changeListener<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the join button that launches the game when clicked</span>
    joinButton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Button</span><span class="token punctuation">(</span><span class="token string">"Join"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    joinButton<span class="token punctuation">.</span><span class="token function">setPrefWidth</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    joinButton<span class="token punctuation">.</span><span class="token function">setOnAction</span><span class="token punctuation">(</span>e <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add UI components to the pane (argument order: node, column index, row</span>
    <span class="token comment">// index, [column span, row span]) [spans are optional]</span>
    pane<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
      nameLabel<span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> choices<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    pane<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
      nameBox<span class="token punctuation">,</span>
      <span class="token number">1</span><span class="token punctuation">,</span> choices<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    pane<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
      sizeBox<span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> choices<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    pane<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>hostLabel<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> choices<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pane<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>hostField<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> choices<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pane<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>portLabel<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> choices<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pane<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>portField<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> choices<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    pane<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>idLabel<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> choices<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pane<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
      idField<span class="token punctuation">,</span>
      <span class="token number">1</span><span class="token punctuation">,</span> choices<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    pane<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
      joinButton<span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span> choices<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">,</span>
      <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// En/disable UI components for the default choice</span>
    <span class="token function">resetForChoice</span><span class="token punctuation">(</span>Choice<span class="token punctuation">.</span>JOIN<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the size loading indicator and hide it by default</span>
    progressIndicator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProgressIndicator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    progressIndicator<span class="token punctuation">.</span><span class="token function">setMaxSize</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the layered layout</span>
    StackPane layers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StackPane</span><span class="token punctuation">(</span>pane<span class="token punctuation">,</span> progressIndicator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    layers<span class="token punctuation">.</span><span class="token function">setAlignment</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>CENTER<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Title the pane</span>
    StackPane root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StackPane</span><span class="token punctuation">(</span><span class="token function">makeTitledPane</span><span class="token punctuation">(</span><span class="token string">"Game"</span><span class="token punctuation">,</span> layers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    root<span class="token punctuation">.</span><span class="token function">setAlignment</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>CENTER<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the scene</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/ui/connect/ServerCreator.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>connect<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>MapSize<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>

<span class="token comment">/**
 * Function called when the user requests that a server be started
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ServerCreator</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Create server callback
   *
   * @param gameFilePath file path of the game save file (may or may not exist)
   * @param gameName     name of the game (if this is null, we're loading an
   *                     existing game from a file)
   * @param mapSize      desired map size of the new game (ignored if loading
   *                     from a file)
   * @param port         port number to run the server on
   * @throws IOException if the server cannot be created (e.g. port already
   *                     bound)
   */</span>
  <span class="token keyword">void</span> <span class="token function">createServer</span><span class="token punctuation">(</span>
    String gameFilePath<span class="token punctuation">,</span>
    String gameName<span class="token punctuation">,</span>
    MapSize mapSize<span class="token punctuation">,</span>
    <span class="token keyword">int</span> port
  <span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/ui/game/Badge.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>game<span class="token punctuation">;</span>

<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Pos<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>Canvas<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>GraphicsContext<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>control<span class="token punctuation">.</span>Label<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>StackPane<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>text<span class="token punctuation">.</span>Font<span class="token punctuation">;</span>

<span class="token comment">/**
 * Pane showing a "badge", a coloured circle with text on top.
 */</span>
<span class="token keyword">class</span> <span class="token class-name">Badge</span> <span class="token keyword">extends</span> <span class="token class-name">StackPane</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Size of the badge's coloured circle
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> BADGE_SIZE <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Creates a new badge
   *
   * @param badgeType type of the badge containing information on the colour
   *                  and text
   */</span>
  <span class="token function">Badge</span><span class="token punctuation">(</span>BadgeType badgeType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setAlignment</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>CENTER<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the coloured circle</span>
    Canvas canvas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Canvas</span><span class="token punctuation">(</span>BADGE_SIZE<span class="token punctuation">,</span> BADGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    GraphicsContext g <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getGraphicsContext2D</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    g<span class="token punctuation">.</span><span class="token function">setFill</span><span class="token punctuation">(</span>badgeType<span class="token punctuation">.</span>color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    g<span class="token punctuation">.</span><span class="token function">fillOval</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> BADGE_SIZE<span class="token punctuation">,</span> BADGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    g<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the text label</span>
    Label label <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span>badgeType<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    label<span class="token punctuation">.</span><span class="token function">setTextFill</span><span class="token punctuation">(</span>badgeType<span class="token punctuation">.</span>textColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    label<span class="token punctuation">.</span><span class="token function">setFont</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Font</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Stack them on top of each other</span>
    <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/ui/game/BadgeType.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>game<span class="token punctuation">;</span>

<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>

<span class="token comment">/**
 * Enum representing the different types of badges. Badges are just a coloured
 * circle with some text on top.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> BadgeType <span class="token punctuation">{</span>
  <span class="token function">SCIENCE</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>DEEPSKYBLUE<span class="token punctuation">,</span> <span class="token string">"S"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">GOLD</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>GOLD<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">PRODUCTION</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>ORANGE<span class="token punctuation">,</span> <span class="token string">"P"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">FOOD</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>GREEN<span class="token punctuation">,</span> <span class="token string">"@"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">HEALTH</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>PINK<span class="token punctuation">,</span> <span class="token string">"H"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">MOVEMENT</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>LIMEGREEN<span class="token punctuation">,</span> <span class="token string">"M"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">ATTACK</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>CRIMSON<span class="token punctuation">,</span> <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Colour of the circle
   */</span>
  Color color<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Colour of the text on the circle
   */</span>
  Color textColor<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Text to be displayed on the circle
   */</span>
  String text<span class="token punctuation">;</span>

  <span class="token function">BadgeType</span><span class="token punctuation">(</span>Color color<span class="token punctuation">,</span> String text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>textColor <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>text <span class="token operator">=</span> text<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/ui/game/ScreenGame.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>game<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>Game<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">.</span>PacketChat<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">.</span>PacketReady<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>RenderCivilisation<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>map<span class="token punctuation">.</span>RenderGame<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>Screen<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>UIHelpers<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Pos<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>Scene<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>input<span class="token punctuation">.</span>KeyCode<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>StackPane<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>stage<span class="token punctuation">.</span>Stage<span class="token punctuation">;</span>

<span class="token comment">/**
 * Main screen for the game. Contains the game render and UI overlays.
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScreenGame</span> <span class="token keyword">extends</span> <span class="token class-name">Screen</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Game that should be rendered in this screen
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Game game<span class="token punctuation">;</span>
  <span class="token comment">/**
   * ID of the current game player
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> String id<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Root render object
   */</span>
  <span class="token keyword">public</span> RenderCivilisation renderCivilisation<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Panel containing UI overlays for player stats, research progress, unit
   * selection details, city production list, etc
   */</span>
  <span class="token keyword">private</span> UIGame ui<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Creates a new game screen
   *
   * @param game game that should be rendered by the screen
   * @param id   ID of the player who's currently playing the game
   */</span>
  <span class="token keyword">public</span> <span class="token function">ScreenGame</span><span class="token punctuation">(</span>Game game<span class="token punctuation">,</span> String id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Store the values so they can be used later</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>game <span class="token operator">=</span> game<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Creates a scene representing this screen
   *
   * @param stage  stage the scene would be placed in
   * @param width  width of the screen
   * @param height height of the screen
   * @return scene representing this screen
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> Scene <span class="token function">makeScene</span><span class="token punctuation">(</span>Stage stage<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    StackPane pane <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StackPane</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pane<span class="token punctuation">.</span><span class="token function">setAlignment</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>CENTER<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create a render object for the game</span>
    RenderGame renderGame <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RenderGame</span><span class="token punctuation">(</span>
      game<span class="token punctuation">,</span>
      id<span class="token punctuation">,</span>
      <span class="token comment">// Register unit and city selection listeners</span>
      <span class="token punctuation">(</span>unit<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> ui<span class="token punctuation">.</span><span class="token function">onSelectedUnitChanged</span><span class="token punctuation">(</span>game<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span>city<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> ui<span class="token punctuation">.</span><span class="token function">onSelectedCityChanged</span><span class="token punctuation">(</span>
        game<span class="token punctuation">,</span>
        city<span class="token punctuation">,</span>
        game<span class="token punctuation">.</span><span class="token function">getPlayersCitiesById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Create the root render object allowing for zooming, panning, and</span>
    <span class="token comment">// lighting</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>renderCivilisation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RenderCivilisation</span><span class="token punctuation">(</span>
      renderGame<span class="token punctuation">,</span>
      width<span class="token punctuation">,</span>
      height
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the game UI</span>
    ui <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UIGame</span><span class="token punctuation">(</span>renderGame<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ui<span class="token punctuation">.</span><span class="token function">setPrefSize</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Register game state listeners so changes can be reflected in the UI</span>
    game<span class="token punctuation">.</span><span class="token function">setCurrentPlayer</span><span class="token punctuation">(</span>
      id<span class="token punctuation">,</span>
      <span class="token punctuation">(</span>stats<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> ui<span class="token punctuation">.</span><span class="token function">onPlayerStatsChanged</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    game<span class="token punctuation">.</span><span class="token function">setTechDetailsListener</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>details<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> ui<span class="token punctuation">.</span><span class="token function">onTechDetailsChanged</span><span class="token punctuation">(</span>game<span class="token punctuation">,</span> details<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Show a dialog on new messages (research unlocks, errors, etc)</span>
    game<span class="token punctuation">.</span><span class="token function">setMessageListener</span><span class="token punctuation">(</span>UIHelpers<span class="token operator">:</span><span class="token operator">:</span>showDialog<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add the 3D render's sub-scene to the pane</span>
    pane<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>renderCivilisation<span class="token punctuation">.</span>subScene<span class="token punctuation">,</span> ui<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create a new scene</span>
    Scene scene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scene</span><span class="token punctuation">(</span>pane<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Register a CSS stylesheet for styling some of the UI panels (mostly</span>
    <span class="token comment">// the city production list)</span>
    scene<span class="token punctuation">.</span><span class="token function">getStylesheets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/com/mrbbot/civilisation/ui/game/styles.css"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Set the scene of the render, registering keyboard shortcuts</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>renderCivilisation<span class="token punctuation">.</span><span class="token function">setScene</span><span class="token punctuation">(</span>scene<span class="token punctuation">,</span> e <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> KeyCode<span class="token punctuation">.</span>F11<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stage<span class="token punctuation">.</span><span class="token function">setFullScreen</span><span class="token punctuation">(</span><span class="token operator">!</span>stage<span class="token punctuation">.</span><span class="token function">isFullScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> scene<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Forwards a chat packet to the UI, so it can be displayed
   *
   * @param packet packet to forward
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlePacketChat</span><span class="token punctuation">(</span>PacketChat packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ui<span class="token punctuation">.</span><span class="token function">handlePacketChat</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Forwards a ready packet to the UI, so the next turn button can be
   * re-enabled
   *
   * @param packet packet to forward
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlePacketReady</span><span class="token punctuation">(</span>PacketReady packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ui<span class="token punctuation">.</span><span class="token function">handlePacketReady</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/ui/game/UIGame.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>game<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>Civilisation<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>Player<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>PlayerStats<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>Game<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>City<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Improvement<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>techs<span class="token punctuation">.</span>PlayerTechDetails<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>Unit<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>UnitAbility<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>map<span class="token punctuation">.</span>RenderGame<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Insets<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Pos<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>control<span class="token punctuation">.</span>Button<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span>

<span class="token comment">/**
 * UI panel containing all other UI panels for the game (stats, techs, etc).
 * Extends anchor pane allowing items to be positioned relative to the edges of
 * the screen.
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UIGame</span> <span class="token keyword">extends</span> <span class="token class-name">AnchorPane</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Default amount of padding for UI panels
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Insets PANEL_PADDING <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Insets</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Game render object reference for performing actions on the game state.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> RenderGame renderGame<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Colour of the current player. Used for panel borders.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Color playerColor<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Panel for technology stats (current research and progress)
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> UIPanelTech panelTech<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Panel for chat messages and for sending new ones
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> UIPanelChat panelChat<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Panel for performing actions with units and displaying information on the
   * current selection
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> UIPanelActions panelActions<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Panel for current player statistics (gold/science per turn)
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> UIPanelStats panelStats<span class="token punctuation">;</span>
  <span class="token comment">/**
   * UI of the technology tree showing techs available for research and
   * previously researched items.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> UITechTree techTree<span class="token punctuation">;</span>
  <span class="token comment">/**
   * UI panel for showing city details and for choosing what to build in a
   * city.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> UIPanelCityDetails panelCityDetails<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Button that when clicked closes the tech tree. The open button is in
   * {@link UIPanelTech}.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Button closeTechTreeButton<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Creates a new game UI instance
   *
   * @param renderGame reference to the current game render object
   * @param height     height of the screen this is displayed in
   */</span>
  <span class="token keyword">public</span> <span class="token function">UIGame</span><span class="token punctuation">(</span>RenderGame renderGame<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>renderGame <span class="token operator">=</span> renderGame<span class="token punctuation">;</span>
    <span class="token comment">// Stop preventing the mouse from reaching the 3D render object that would</span>
    <span class="token comment">// prevent panning, zooming, and unit selection.</span>
    <span class="token function">setPickOnBounds</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Player player <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderGame<span class="token punctuation">.</span>currentPlayer<span class="token punctuation">;</span>
    playerColor <span class="token operator">=</span> player<span class="token punctuation">.</span><span class="token function">getColour</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the tech panel</span>
    panelTech <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UIPanelTech</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    panelTech<span class="token punctuation">.</span><span class="token function">setBorder</span><span class="token punctuation">(</span><span class="token function">makePanelBorder</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>BOTTOM_RIGHT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    panelTech<span class="token punctuation">.</span><span class="token function">setBackground</span><span class="token punctuation">(</span><span class="token function">makePanelBackground</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>BOTTOM_RIGHT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    panelTech<span class="token punctuation">.</span><span class="token function">setPadding</span><span class="token punctuation">(</span>PANEL_PADDING<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Open the tech tree on clicking the open button</span>
    panelTech<span class="token punctuation">.</span><span class="token function">setOnOpenTechTree</span><span class="token punctuation">(</span>e <span class="token operator">-</span><span class="token operator">></span> <span class="token function">setTechTreeVisible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Position it in the top left of the screen</span>
    AnchorPane<span class="token punctuation">.</span><span class="token function">setTopAnchor</span><span class="token punctuation">(</span>panelTech<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    AnchorPane<span class="token punctuation">.</span><span class="token function">setLeftAnchor</span><span class="token punctuation">(</span>panelTech<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the chat panel</span>
    panelChat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UIPanelChat</span><span class="token punctuation">(</span>renderGame<span class="token punctuation">.</span>currentPlayer<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    panelChat<span class="token punctuation">.</span><span class="token function">setBorder</span><span class="token punctuation">(</span><span class="token function">makePanelBorder</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>BOTTOM_LEFT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    panelChat<span class="token punctuation">.</span><span class="token function">setBackground</span><span class="token punctuation">(</span><span class="token function">makePanelBackground</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>BOTTOM_LEFT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    panelChat<span class="token punctuation">.</span><span class="token function">setPadding</span><span class="token punctuation">(</span>PANEL_PADDING<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Position it in the top right of the screen</span>
    AnchorPane<span class="token punctuation">.</span><span class="token function">setTopAnchor</span><span class="token punctuation">(</span>panelChat<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    AnchorPane<span class="token punctuation">.</span><span class="token function">setRightAnchor</span><span class="token punctuation">(</span>panelChat<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the unit actions panel</span>
    panelActions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UIPanelActions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    panelActions<span class="token punctuation">.</span><span class="token function">setBorder</span><span class="token punctuation">(</span><span class="token function">makePanelBorder</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>TOP_LEFT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    panelActions<span class="token punctuation">.</span><span class="token function">setBackground</span><span class="token punctuation">(</span><span class="token function">makePanelBackground</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>TOP_LEFT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    panelActions<span class="token punctuation">.</span><span class="token function">setPadding</span><span class="token punctuation">(</span>PANEL_PADDING<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Register the listener for when the user requests a unit take an action</span>
    <span class="token comment">// or clicks on the next turn button</span>
    panelActions<span class="token punctuation">.</span><span class="token function">setUnitActionListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span><span class="token operator">:</span>onUnitAction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Position it in the bottom right of the screen</span>
    AnchorPane<span class="token punctuation">.</span><span class="token function">setBottomAnchor</span><span class="token punctuation">(</span>panelActions<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    AnchorPane<span class="token punctuation">.</span><span class="token function">setRightAnchor</span><span class="token punctuation">(</span>panelActions<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the player stats panel</span>
    panelStats <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UIPanelStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    panelStats<span class="token punctuation">.</span><span class="token function">setBorder</span><span class="token punctuation">(</span><span class="token function">makePanelBorder</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>TOP_RIGHT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    panelStats<span class="token punctuation">.</span><span class="token function">setBackground</span><span class="token punctuation">(</span><span class="token function">makePanelBackground</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>TOP_RIGHT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    panelStats<span class="token punctuation">.</span><span class="token function">setPadding</span><span class="token punctuation">(</span>PANEL_PADDING<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Position it in the bottom left of the screen</span>
    AnchorPane<span class="token punctuation">.</span><span class="token function">setBottomAnchor</span><span class="token punctuation">(</span>panelStats<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    AnchorPane<span class="token punctuation">.</span><span class="token function">setLeftAnchor</span><span class="token punctuation">(</span>panelStats<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the city details panel</span>
    panelCityDetails <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UIPanelCityDetails</span><span class="token punctuation">(</span>renderGame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    panelCityDetails<span class="token punctuation">.</span><span class="token function">setBorder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Border</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BorderStroke</span><span class="token punctuation">(</span>
      playerColor<span class="token punctuation">,</span>
      BorderStrokeStyle<span class="token punctuation">.</span>SOLID<span class="token punctuation">,</span>
      CornerRadii<span class="token punctuation">.</span>EMPTY<span class="token punctuation">,</span>
      <span class="token comment">// Left border only</span>
      <span class="token keyword">new</span> <span class="token class-name">BorderWidths</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    panelCityDetails<span class="token punctuation">.</span><span class="token function">setBackground</span><span class="token punctuation">(</span><span class="token function">makePanelBackground</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>CENTER<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    panelCityDetails<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Position it to the right of the screen taking up the full screen height</span>
    AnchorPane<span class="token punctuation">.</span><span class="token function">setTopAnchor</span><span class="token punctuation">(</span>panelCityDetails<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    AnchorPane<span class="token punctuation">.</span><span class="token function">setRightAnchor</span><span class="token punctuation">(</span>panelCityDetails<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    AnchorPane<span class="token punctuation">.</span><span class="token function">setBottomAnchor</span><span class="token punctuation">(</span>panelCityDetails<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create initial player technology details for initialising the tech tree</span>
    PlayerTechDetails techDetails <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PlayerTechDetails</span><span class="token punctuation">(</span>
      renderGame<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">getPlayerUnlockedTechs</span><span class="token punctuation">(</span>player<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
      renderGame<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">getPlayerUnlockingTech</span><span class="token punctuation">(</span>player<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
      renderGame<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">getPlayerUnlockingProgress</span><span class="token punctuation">(</span>player<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Create the tech tree UI</span>
    techTree <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UITechTree</span><span class="token punctuation">(</span>
      renderGame<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
      player<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      techDetails<span class="token punctuation">,</span>
      height
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    techTree<span class="token punctuation">.</span><span class="token function">setBorder</span><span class="token punctuation">(</span><span class="token function">makePanelBorder</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>CENTER<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Fill the screen with the tech tree when it's visible</span>
    AnchorPane<span class="token punctuation">.</span><span class="token function">setTopAnchor</span><span class="token punctuation">(</span>techTree<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    AnchorPane<span class="token punctuation">.</span><span class="token function">setLeftAnchor</span><span class="token punctuation">(</span>techTree<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    AnchorPane<span class="token punctuation">.</span><span class="token function">setBottomAnchor</span><span class="token punctuation">(</span>techTree<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    AnchorPane<span class="token punctuation">.</span><span class="token function">setRightAnchor</span><span class="token punctuation">(</span>techTree<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Set the initial tech details</span>
    panelTech<span class="token punctuation">.</span><span class="token function">setTechDetails</span><span class="token punctuation">(</span>techDetails<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the close button</span>
    closeTechTreeButton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Button</span><span class="token punctuation">(</span><span class="token string">"Close Tech Tree"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    closeTechTreeButton<span class="token punctuation">.</span><span class="token function">setOnAction</span><span class="token punctuation">(</span>e <span class="token operator">-</span><span class="token operator">></span> <span class="token function">setTechTreeVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Position it in the top left of the screen</span>
    AnchorPane<span class="token punctuation">.</span><span class="token function">setTopAnchor</span><span class="token punctuation">(</span>closeTechTreeButton<span class="token punctuation">,</span> <span class="token number">20.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    AnchorPane<span class="token punctuation">.</span><span class="token function">setLeftAnchor</span><span class="token punctuation">(</span>closeTechTreeButton<span class="token punctuation">,</span> <span class="token number">20.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Hide the tech tree initially</span>
    <span class="token function">setTechTreeVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add all the panels to the screen</span>
    <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>
      panelTech<span class="token punctuation">,</span>
      panelChat<span class="token punctuation">,</span>
      panelActions<span class="token punctuation">,</span>
      panelStats<span class="token punctuation">,</span>
      panelCityDetails<span class="token punctuation">,</span>
      techTree<span class="token punctuation">,</span>
      closeTechTreeButton
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Create a corner radii object with the radius in the corner specified
   *
   * @param cutout corner for the cutout
   * @param size   size of the cutout
   * @return corner radii object with details on the corner cutout
   */</span>
  <span class="token keyword">private</span> CornerRadii <span class="token function">makeCornerRadiiForCutout</span><span class="token punctuation">(</span>Pos cutout<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CornerRadii</span><span class="token punctuation">(</span>
      cutout <span class="token operator">==</span> Pos<span class="token punctuation">.</span>TOP_LEFT <span class="token operator">?</span> size <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      cutout <span class="token operator">==</span> Pos<span class="token punctuation">.</span>TOP_RIGHT <span class="token operator">?</span> size <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      cutout <span class="token operator">==</span> Pos<span class="token punctuation">.</span>BOTTOM_RIGHT <span class="token operator">?</span> size <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      cutout <span class="token operator">==</span> Pos<span class="token punctuation">.</span>BOTTOM_LEFT <span class="token operator">?</span> size <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token boolean">false</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Makes a border object with a cutout in the specified corner
   *
   * @param cutout corner for the cutout
   * @return border object with a cutout
   */</span>
  <span class="token keyword">private</span> Border <span class="token function">makePanelBorder</span><span class="token punctuation">(</span>Pos cutout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Border</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BorderStroke</span><span class="token punctuation">(</span>
      playerColor<span class="token punctuation">,</span>
      BorderStrokeStyle<span class="token punctuation">.</span>SOLID<span class="token punctuation">,</span>
      <span class="token function">makeCornerRadiiForCutout</span><span class="token punctuation">(</span>cutout<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">BorderWidths</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Makes a solid white background with a cutout in the specified corner
   *
   * @param cutout corner for the cutout
   * @return background object with a cutout
   */</span>
  <span class="token keyword">private</span> Background <span class="token function">makePanelBackground</span><span class="token punctuation">(</span>Pos cutout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Background</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BackgroundFill</span><span class="token punctuation">(</span>
      Color<span class="token punctuation">.</span>WHITE<span class="token punctuation">,</span>
      <span class="token function">makeCornerRadiiForCutout</span><span class="token punctuation">(</span>cutout<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      null
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Callback function called when the selected unit changes in the game
   *
   * @param game game containing the unit
   * @param unit selected unit, may be null if no unit is selected
   */</span>
  <span class="token keyword">void</span> <span class="token function">onSelectedUnitChanged</span><span class="token punctuation">(</span>Game game<span class="token punctuation">,</span> Unit unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    panelActions<span class="token punctuation">.</span><span class="token function">setSelectedUnit</span><span class="token punctuation">(</span>game<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Callback function called when the selected city changes in the game
   *
   * @param game          game containing the city
   * @param city          selected city, may be null if no unit is selected
   * @param playersCities all of the players cities in the game
   */</span>
  <span class="token keyword">void</span> <span class="token function">onSelectedCityChanged</span><span class="token punctuation">(</span>
    Game game<span class="token punctuation">,</span>
    City city<span class="token punctuation">,</span>
    ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>City<span class="token punctuation">></span></span> playersCities
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Update the city details panel to reflect the change if required</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>city <span class="token operator">!=</span> null<span class="token punctuation">)</span>
      panelCityDetails<span class="token punctuation">.</span><span class="token function">setSelectedCity</span><span class="token punctuation">(</span>game<span class="token punctuation">,</span> city<span class="token punctuation">,</span> playersCities<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Show/hide the panel depending on if a city has been selected or not</span>
    panelCityDetails<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span>city <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Callback function called when the player requests a unit perform an action
   * or clicks the the next turn button.
   *
   * @param unit          unit the action should be performed on or null if the
   *                      next turn button was pressed
   * @param actionDetails string containing additional details about the action
   *                      (i.e. what improvement a worker should construct)
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onUnitAction</span><span class="token punctuation">(</span>Unit unit<span class="token punctuation">,</span> String actionDetails<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Check if this was the next turn button</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>unit <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Next turn..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Mark the client as waiting for other players, so it can't perform any</span>
      <span class="token comment">// more actions</span>
      renderGame<span class="token punctuation">.</span>data<span class="token punctuation">.</span>waitingForPlayers <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment">// Deselect any units/cities</span>
      renderGame<span class="token punctuation">.</span><span class="token function">setSelectedUnit</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
      renderGame<span class="token punctuation">.</span><span class="token function">setSelectedCity</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Otherwise, an action is to be performed</span>
      System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span>
        <span class="token string">"%s performed an action (details \"%s\")\n"</span><span class="token punctuation">,</span>
        unit<span class="token punctuation">.</span>unitType<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        actionDetails
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>unit<span class="token punctuation">.</span><span class="token function">hasAbility</span><span class="token punctuation">(</span>UnitAbility<span class="token punctuation">.</span>ABILITY_SETTLE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If this unit was a settler, try and create a city on the unit's tile</span>

        <span class="token comment">// Broadcast a packet...</span>
        Civilisation<span class="token punctuation">.</span>CLIENT<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PacketCityCreate</span><span class="token punctuation">(</span>
          renderGame<span class="token punctuation">.</span>currentPlayer<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
          unit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
          unit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>y
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ...and create the city for this client</span>
        renderGame<span class="token punctuation">.</span>data<span class="token punctuation">.</span>cities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">City</span><span class="token punctuation">(</span>
          renderGame<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hexagonGrid<span class="token punctuation">,</span>
          unit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
          unit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
          renderGame<span class="token punctuation">.</span>currentPlayer
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Rerender every tile</span>
        renderGame<span class="token punctuation">.</span><span class="token function">updateTileRenders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        renderGame<span class="token punctuation">.</span><span class="token function">setSelectedUnit</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Settlers can only be used once, so delete this unit</span>
        renderGame<span class="token punctuation">.</span><span class="token function">deleteUnit</span><span class="token punctuation">(</span>unit<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>unit<span class="token punctuation">.</span><span class="token function">hasAbility</span><span class="token punctuation">(</span>UnitAbility<span class="token punctuation">.</span>ABILITY_IMPROVE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If this unit was a worker, try and improve the unit's tile</span>

        <span class="token comment">// Get the improvement from the action's details</span>
        Improvement improvement <span class="token operator">=</span> Improvement<span class="token punctuation">.</span><span class="token function">fromName</span><span class="token punctuation">(</span>actionDetails<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> improvement <span class="token operator">!=</span> null<span class="token punctuation">;</span>

        <span class="token comment">// Create a packet detailing the request</span>
        PacketWorkerImproveRequest packetWorkerImproveRequest <span class="token operator">=</span>
          <span class="token keyword">new</span> <span class="token class-name">PacketWorkerImproveRequest</span><span class="token punctuation">(</span>
            unit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
            unit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
            improvement
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Handle it locally and broadcast it so other clients stay in sync</span>
        renderGame<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">handlePacket</span><span class="token punctuation">(</span>packetWorkerImproveRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Civilisation<span class="token punctuation">.</span>CLIENT<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>packetWorkerImproveRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        renderGame<span class="token punctuation">.</span><span class="token function">setSelectedUnit</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>unit<span class="token punctuation">.</span>unitType<span class="token punctuation">.</span><span class="token function">getUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If this unit could be upgraded, upgrade the unit</span>

        <span class="token comment">// Create a packet detailing the request</span>
        PacketUnitUpgrade packetUnitUpgrade <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PacketUnitUpgrade</span><span class="token punctuation">(</span>
          unit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
          unit<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>y
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Handle it locally and broadcast it so other clients stay in sync</span>
        renderGame<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">handlePacket</span><span class="token punctuation">(</span>packetUnitUpgrade<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Civilisation<span class="token punctuation">.</span>CLIENT<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>packetUnitUpgrade<span class="token punctuation">)</span><span class="token punctuation">;</span>
        renderGame<span class="token punctuation">.</span><span class="token function">setSelectedUnit</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>unit<span class="token punctuation">.</span><span class="token function">hasAbility</span><span class="token punctuation">(</span>UnitAbility<span class="token punctuation">.</span>ABILITY_BLAST_OFF<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If this is a rocket, blast off and win the game</span>

        <span class="token comment">// Create a packet detailing the request</span>
        PacketBlastOff packetBlastOff <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PacketBlastOff</span><span class="token punctuation">(</span>
          renderGame<span class="token punctuation">.</span>currentPlayer<span class="token punctuation">.</span>id
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Handle it locally and broadcast it so other clients stay in sync</span>
        renderGame<span class="token punctuation">.</span><span class="token function">handlePacket</span><span class="token punctuation">(</span>packetBlastOff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Civilisation<span class="token punctuation">.</span>CLIENT<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>packetBlastOff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        renderGame<span class="token punctuation">.</span><span class="token function">setSelectedUnit</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Rockets can only be used once, so delete this unit</span>
        renderGame<span class="token punctuation">.</span><span class="token function">deleteUnit</span><span class="token punctuation">(</span>unit<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the tech tree's visibility
   *
   * @param visible whether the tech tree should be visible
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setTechTreeVisible</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> visible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    techTree<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span>visible<span class="token punctuation">)</span><span class="token punctuation">;</span>
    closeTechTreeButton<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span>visible<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Callback function for a new chat packet. Adds the new chat message to the
   * chat log.
   *
   * @param packet packet containing the chat message
   */</span>
  <span class="token keyword">void</span> <span class="token function">handlePacketChat</span><span class="token punctuation">(</span>PacketChat packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    panelChat<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Callback function for a ready packet. Resets the action panel's next turn
   * button allowing it to be clicked again.
   *
   * @param data packet containing turn ready information
   */</span>
  <span class="token keyword">void</span> <span class="token function">handlePacketReady</span><span class="token punctuation">(</span>PacketReady data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    panelActions<span class="token punctuation">.</span><span class="token function">setNextTurnWaiting</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>ready<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Callback function called when a player's stats change (usually once per
   * turn)
   *
   * @param stats new stats for the current player
   */</span>
  <span class="token keyword">void</span> <span class="token function">onPlayerStatsChanged</span><span class="token punctuation">(</span>PlayerStats stats<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    panelStats<span class="token punctuation">.</span><span class="token function">setPlayerStats</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Callback function called when a player's tech details changed (usually
   * once per turn)
   *
   * @param game    game containing the player
   * @param details new tech details for the current player
   */</span>
  <span class="token keyword">void</span> <span class="token function">onTechDetailsChanged</span><span class="token punctuation">(</span>Game game<span class="token punctuation">,</span> PlayerTechDetails details<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    panelTech<span class="token punctuation">.</span><span class="token function">setTechDetails</span><span class="token punctuation">(</span>details<span class="token punctuation">)</span><span class="token punctuation">;</span>
    techTree<span class="token punctuation">.</span><span class="token function">setTechDetails</span><span class="token punctuation">(</span>game<span class="token punctuation">,</span> details<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/ui/game/UIPanelActions.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>game<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>Civilisation<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>Game<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Improvement<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Tile<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>Unit<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>UnitAbility<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>UnitType<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">.</span>PacketReady<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>FXCollections<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>ObservableList<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>event<span class="token punctuation">.</span>ActionEvent<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>event<span class="token punctuation">.</span>EventHandler<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Insets<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>control<span class="token punctuation">.</span>Button<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>control<span class="token punctuation">.</span>ComboBox<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>control<span class="token punctuation">.</span>Label<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>VBox<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>text<span class="token punctuation">.</span>Font<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span>BiConsumer<span class="token punctuation">;</span>

<span class="token comment">/**
 * UI panel for controlling the selected unit's actions and for declaring the
 * current player ready for the next turn. Extends {@link VBox} so that items
 * are arranged in a column.
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UIPanelActions</span> <span class="token keyword">extends</span> <span class="token class-name">VBox</span> <span class="token keyword">implements</span> <span class="token class-name">EventHandler</span><span class="token generics function"><span class="token punctuation">&lt;</span>ActionEvent<span class="token punctuation">></span></span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Constant for the preferred width of items in the action list
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> ITEM_WIDTH <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Currently selected unit by the player
   */</span>
  <span class="token keyword">private</span> Unit selectedUnit<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Unit for describing the type of the selected unit
   */</span>
  <span class="token keyword">private</span> Label selectedUnitLabel<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Combo box for the different types of actions that can be performed (only
   * used for worker improvement types at the moment)
   */</span>
  <span class="token keyword">private</span> ComboBox<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> actionsComboBox<span class="token punctuation">;</span>
  <span class="token comment">/**
   * List of the available actions for the actions box
   */</span>
  <span class="token keyword">private</span> ObservableList<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> actionsList<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Button to perform the selected action with the selected unit
   */</span>
  <span class="token keyword">private</span> Button actionButton<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Button to mark the current player as ready and wait for other players to
   * complete their turn
   */</span>
  <span class="token keyword">private</span> Button nextTurnButton<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Callback function for any actions to be performed. The first parameter is
   * the selected unit or null if the next turn button is pressed. The second
   * parameter contains information of the details of the action (i.e type of
   * improvement)
   */</span>
  <span class="token keyword">private</span> BiConsumer<span class="token generics function"><span class="token punctuation">&lt;</span>Unit<span class="token punctuation">,</span> String<span class="token punctuation">></span></span> unitActionListener<span class="token punctuation">;</span>

  <span class="token function">UIPanelActions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Set vertical height</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Make this panel occupy the minimum height</span>
    <span class="token function">setPrefHeight</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the selected unit label and heading</span>
    Label selectedUnitHeading <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span><span class="token string">"Selected unit:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    selectedUnitLabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span><span class="token string">"None"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    selectedUnitLabel<span class="token punctuation">.</span><span class="token function">setFont</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Font</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    selectedUnitLabel<span class="token punctuation">.</span><span class="token function">setPadding</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">Insets</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the actions combo box and button</span>
    actionsList <span class="token operator">=</span> FXCollections<span class="token punctuation">.</span><span class="token function">observableArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    actionsComboBox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComboBox</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>actionsList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    actionsComboBox<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    actionButton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Button</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Register this as the click handler</span>
    actionButton<span class="token punctuation">.</span><span class="token function">setOnAction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Disable it by default</span>
    actionButton<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the next turn button</span>
    nextTurnButton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Button</span><span class="token punctuation">(</span><span class="token string">"Next Turn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Register this as the click handler</span>
    nextTurnButton<span class="token punctuation">.</span><span class="token function">setOnAction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Make the text a bit bigger than usual</span>
    nextTurnButton<span class="token punctuation">.</span><span class="token function">setFont</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Font</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    actionsComboBox<span class="token punctuation">.</span><span class="token function">setPrefWidth</span><span class="token punctuation">(</span>ITEM_WIDTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    actionButton<span class="token punctuation">.</span><span class="token function">setPrefWidth</span><span class="token punctuation">(</span>ITEM_WIDTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nextTurnButton<span class="token punctuation">.</span><span class="token function">setPrefWidth</span><span class="token punctuation">(</span>ITEM_WIDTH<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add all the components to the vertical stack</span>
    <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>
      selectedUnitHeading<span class="token punctuation">,</span>
      selectedUnitLabel<span class="token punctuation">,</span>
      actionsComboBox<span class="token punctuation">,</span>
      actionButton<span class="token punctuation">,</span>
      nextTurnButton
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the action listener for performing unit actions and requesting the
   * next turn.
   *
   * @param unitActionListener new unit action listener
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUnitActionListener</span><span class="token punctuation">(</span>
    BiConsumer<span class="token generics function"><span class="token punctuation">&lt;</span>Unit<span class="token punctuation">,</span> String<span class="token punctuation">></span></span> unitActionListener
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>unitActionListener <span class="token operator">=</span> unitActionListener<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the current selected unit. Called when the player selects a new unit.
   *
   * @param game game containing the unit
   * @param unit new selected unit or null if no unit is selected
   */</span>
  <span class="token keyword">void</span> <span class="token function">setSelectedUnit</span><span class="token punctuation">(</span>Game game<span class="token punctuation">,</span> Unit unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>selectedUnit <span class="token operator">=</span> unit<span class="token punctuation">;</span>

    <span class="token comment">// Reset the UI</span>
    actionsList<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    actionsComboBox<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    actionsComboBox<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    actionButton<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    actionButton<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>unit <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If there's no unit selected, use none as the type</span>
      selectedUnitLabel<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"None"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      Tile tile <span class="token operator">=</span> unit<span class="token punctuation">.</span>tile<span class="token punctuation">;</span>

      <span class="token comment">// Set the unit label's text to be the type of the unit</span>
      selectedUnitLabel<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>unit<span class="token punctuation">.</span>unitType<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Depending on the units abilities enable different UI components</span>

      <span class="token comment">// If the unit can settle...</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>unit<span class="token punctuation">.</span><span class="token function">hasAbility</span><span class="token punctuation">(</span>UnitAbility<span class="token punctuation">.</span>ABILITY_SETTLE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Set the action</span>
        actionButton<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"Settle"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Enable the button if there isn't already a city on the tile</span>
        actionButton<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span>tile<span class="token punctuation">.</span>city <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// If the unit can improve...</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>unit<span class="token punctuation">.</span><span class="token function">hasAbility</span><span class="token punctuation">(</span>UnitAbility<span class="token punctuation">.</span>ABILITY_IMPROVE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Add all the improvements that a worker can always do</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Improvement improvement <span class="token operator">:</span> Improvement<span class="token punctuation">.</span>VALUES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Check the player has unlocked the improvement</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>improvement<span class="token punctuation">.</span>workerCanDo
            <span class="token operator">&amp;&amp;</span> game<span class="token punctuation">.</span><span class="token function">playerHasUnlocked</span><span class="token punctuation">(</span>unit<span class="token punctuation">.</span>player<span class="token punctuation">.</span>id<span class="token punctuation">,</span> improvement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            actionsList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>improvement<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Add chop forest if there's a tree and the player has unlocked it</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tile<span class="token punctuation">.</span>improvement <span class="token operator">==</span> Improvement<span class="token punctuation">.</span>TREE
          <span class="token operator">&amp;&amp;</span> game<span class="token punctuation">.</span><span class="token function">playerHasUnlocked</span><span class="token punctuation">(</span>unit<span class="token punctuation">.</span>player<span class="token punctuation">.</span>id<span class="token punctuation">,</span> Improvement<span class="token punctuation">.</span>CHOP_FOREST<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          actionsList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>Improvement<span class="token punctuation">.</span>CHOP_FOREST<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Set the action</span>
        actionButton<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"Improve"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Set the default improvement</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>actionsList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          actionsComboBox<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>actionsList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">boolean</span> canImprove <span class="token operator">=</span> tile<span class="token punctuation">.</span>city <span class="token operator">==</span> null
            <span class="token operator">||</span> <span class="token operator">!</span>tile<span class="token punctuation">.</span>city<span class="token punctuation">.</span>player<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>unit<span class="token punctuation">.</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span>
          actionsComboBox<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span>canImprove<span class="token punctuation">)</span><span class="token punctuation">;</span>
          actionButton<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span>canImprove<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// If the unit is already building something disable the button and</span>
        <span class="token comment">// show the progress of the build</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>unit<span class="token punctuation">.</span>workerBuilding <span class="token operator">!=</span> Improvement<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          actionButton<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>
            String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
              <span class="token string">"Improving... (%d turns remaining)"</span><span class="token punctuation">,</span>
              unit<span class="token punctuation">.</span>workerBuildTurnsRemaining
            <span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          actionsComboBox<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>unit<span class="token punctuation">.</span>workerBuilding<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
          actionsComboBox<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          actionButton<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// If the unit can be upgraded and the player has unlocked the upgraded</span>
      <span class="token comment">// type...</span>
      UnitType upgradedType <span class="token operator">=</span> unit<span class="token punctuation">.</span>unitType<span class="token punctuation">.</span><span class="token function">getUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>upgradedType <span class="token operator">!=</span> null
        <span class="token operator">&amp;&amp;</span> game<span class="token punctuation">.</span><span class="token function">playerHasUnlocked</span><span class="token punctuation">(</span>unit<span class="token punctuation">.</span>player<span class="token punctuation">.</span>id<span class="token punctuation">,</span> upgradedType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Set the action</span>
        actionButton<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"Upgrade to "</span> <span class="token operator">+</span> upgradedType<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        actionButton<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// If the unit can blast off, set the action</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>unit<span class="token punctuation">.</span><span class="token function">hasAbility</span><span class="token punctuation">(</span>UnitAbility<span class="token punctuation">.</span>ABILITY_BLAST_OFF<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        actionButton<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"Blast off!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        actionButton<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets whether or not the game is waiting for players
   *
   * @param waiting whether the game is waiting for other players
   */</span>
  <span class="token keyword">void</span> <span class="token function">setNextTurnWaiting</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> waiting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Disable the button if we're waiting</span>
    nextTurnButton<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span>waiting<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Set the button text according to the current state</span>
    nextTurnButton<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>waiting <span class="token operator">?</span> <span class="token string">"Waiting..."</span> <span class="token operator">:</span> <span class="token string">"Next Turn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Handle the next turn/action button events
   *
   * @param event JavaFX event for the button click containing information on
   *              the source of the event
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span>ActionEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>unitActionListener <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> actionButton<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If this was the action button, send the action's event with details</span>
        unitActionListener<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>selectedUnit<span class="token punctuation">,</span> actionsComboBox<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> nextTurnButton<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Otherwise, it was the next turn button, so declare the player ready</span>
        <span class="token comment">// and broadcast this</span>
        <span class="token function">setNextTurnWaiting</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Civilisation<span class="token punctuation">.</span>CLIENT<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PacketReady</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        unitActionListener<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/ui/game/UIPanelChat.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>game<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>Civilisation<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">.</span>PacketChat<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Insets<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>control<span class="token punctuation">.</span>Button<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>control<span class="token punctuation">.</span>TextArea<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>control<span class="token punctuation">.</span>TextField<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>BorderPane<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>StackPane<span class="token punctuation">;</span>

<span class="token comment">/**
 * UI panel for sending/receiving chat messages.
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">class</span> <span class="token class-name">UIPanelChat</span> <span class="token keyword">extends</span> <span class="token class-name">BorderPane</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Log of previous chat messages
   */</span>
  <span class="token keyword">private</span> TextArea log<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Text field containing text to send in next message
   */</span>
  <span class="token keyword">private</span> TextField messageField<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Button that when clicked will send the message
   */</span>
  <span class="token keyword">private</span> Button sendButton<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Creates a new chat panel
   *
   * @param id id of the current player
   */</span>
  <span class="token function">UIPanelChat</span><span class="token punctuation">(</span>String id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setPrefSize</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the chat log</span>
    log <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextArea</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">setEditable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Keep the scroll bar at the bottom of the log when new messages arrive</span>
    log<span class="token punctuation">.</span><span class="token function">textProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>observable<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> log<span class="token punctuation">.</span><span class="token function">setScrollTop</span><span class="token punctuation">(</span>Double<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    BorderPane bottomPane <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BorderPane</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bottomPane<span class="token punctuation">.</span><span class="token function">setPadding</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Insets</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the message field</span>
    messageField <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bottomPane<span class="token punctuation">.</span><span class="token function">setCenter</span><span class="token punctuation">(</span>messageField<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Watch the message and enable the send button when any text has been</span>
    <span class="token comment">// typed in</span>
    messageField<span class="token punctuation">.</span><span class="token function">textProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>observable<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> sendButton<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span>
        newValue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the send button</span>
    sendButton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Button</span><span class="token punctuation">(</span><span class="token string">"Send"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sendButton<span class="token punctuation">.</span><span class="token function">setOnAction</span><span class="token punctuation">(</span>e <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token comment">// Build the message</span>
      String message <span class="token operator">=</span> id <span class="token operator">+</span> <span class="token string">"> "</span> <span class="token operator">+</span> messageField<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Add the message locally, and send it to other clients</span>
      <span class="token function">addMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
      Civilisation<span class="token punctuation">.</span>CLIENT<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PacketChat</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Clear the message text</span>
      messageField<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sendButton<span class="token punctuation">.</span><span class="token function">setDisable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    StackPane sendButtonPane <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StackPane</span><span class="token punctuation">(</span>sendButton<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sendButtonPane<span class="token punctuation">.</span><span class="token function">setPadding</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Insets</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bottomPane<span class="token punctuation">.</span><span class="token function">setRight</span><span class="token punctuation">(</span>sendButtonPane<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setCenter</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setBottom</span><span class="token punctuation">(</span>bottomPane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Adds a chat message to this panel's chat log
   *
   * @param message new message to add with the player id of the sender
   */</span>
  <span class="token keyword">void</span> <span class="token function">addMessage</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    String currentText <span class="token operator">=</span> log<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    String toAdd <span class="token operator">=</span> message<span class="token punctuation">;</span>
    <span class="token comment">// Add a new line to the message if there's already text there</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentText<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> toAdd <span class="token operator">=</span> <span class="token string">"\n"</span> <span class="token operator">+</span> toAdd<span class="token punctuation">;</span>
    <span class="token comment">// Append the text to the chat log</span>
    log<span class="token punctuation">.</span><span class="token function">appendText</span><span class="token punctuation">(</span>toAdd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/ui/game/UIPanelStats.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>game<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>PlayerStats<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>control<span class="token punctuation">.</span>Label<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>HBox<span class="token punctuation">;</span>

<span class="token comment">/**
 * UI panel for displaying the current player's statistics (gold total, gold
 * per turn, science per turn)
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UIPanelStats</span> <span class="token keyword">extends</span> <span class="token class-name">HBox</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Label for displaying player's science per turn
   */</span>
  <span class="token keyword">private</span> Label scienceLabel<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Label for displaying player's current gold total and their gold per turn
   */</span>
  <span class="token keyword">private</span> Label goldLabel<span class="token punctuation">;</span>

  <span class="token function">UIPanelStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Initialise horizontal box with 10px of horizontal spacing between</span>
    <span class="token comment">// components</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Initialise and add the labels and badges to the panel</span>
    scienceLabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    goldLabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">Badge</span><span class="token punctuation">(</span>BadgeType<span class="token punctuation">.</span>SCIENCE<span class="token punctuation">)</span><span class="token punctuation">,</span>
      scienceLabel<span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Badge</span><span class="token punctuation">(</span>BadgeType<span class="token punctuation">.</span>GOLD<span class="token punctuation">)</span><span class="token punctuation">,</span>
      goldLabel
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Update the labels' text to reflect the player's new stats
   * @param playerStats object containing the new statistics for the player
   */</span>
  <span class="token keyword">void</span> <span class="token function">setPlayerStats</span><span class="token punctuation">(</span>PlayerStats playerStats<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    scienceLabel<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>playerStats<span class="token punctuation">.</span>sciencePerTurn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    goldLabel<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
      <span class="token string">"%d (+%d)"</span><span class="token punctuation">,</span>
      playerStats<span class="token punctuation">.</span>gold<span class="token punctuation">,</span>
      playerStats<span class="token punctuation">.</span>goldPerTurn
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/ui/game/UIPanelCityDetails.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>game<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>Civilisation<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>CityBuildable<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>Game<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Building<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>City<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>UnitType<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">.</span>PacketCityBuildRequest<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">.</span>PacketCityRename<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>map<span class="token punctuation">.</span>RenderGame<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>UIHelpers<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Insets<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>control<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>text<span class="token punctuation">.</span>Font<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token comment">/**
 * UI panel for showing a cities details and the production list where new
 * units and buildings can be built in the city.
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UIPanelCityDetails</span> <span class="token keyword">extends</span> <span class="token class-name">ScrollPane</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Game the selected city will be contained in
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> RenderGame renderGame<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Text field for the name of the city
   */</span>
  <span class="token keyword">private</span> TextField cityNameField<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Button that when clicked will update the name of the city to reflect the
   * name field.
   */</span>
  <span class="token keyword">private</span> Button renameButton<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Label for the city's current production
   */</span>
  <span class="token keyword">private</span> Label cityProductionLabel<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Label for the city's current science
   */</span>
  <span class="token keyword">private</span> Label cityScienceLabel<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Label for the city's current gold
   */</span>
  <span class="token keyword">private</span> Label cityGoldLabel<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Label for the city's current food
   */</span>
  <span class="token keyword">private</span> Label cityFoodLabel<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Panes that contain details on the mapped city buildables in the production
   * list
   */</span>
  <span class="token keyword">private</span> HashMap<span class="token generics function"><span class="token punctuation">&lt;</span>CityBuildable<span class="token punctuation">,</span> Pane<span class="token punctuation">></span></span> buildablePanes<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Tooltips for the mapped city buildables in the production list
   */</span>
  <span class="token keyword">private</span> HashMap<span class="token generics function"><span class="token punctuation">&lt;</span>CityBuildable<span class="token punctuation">,</span> Tooltip<span class="token punctuation">></span></span> buildableTooltips<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Progress indicators for the mapped city buildables in the production list
   */</span>
  <span class="token keyword">private</span> HashMap<span class="token generics function"><span class="token punctuation">&lt;</span>CityBuildable<span class="token punctuation">,</span> ProgressIndicator<span class="token punctuation">></span></span> buildableProgresses<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Array containing the 2 toggle groups for the gold/production buttons.
   * These should be kept in sync with each other.
   */</span>
  <span class="token keyword">private</span> ToggleGroup<span class="token punctuation">[</span><span class="token punctuation">]</span> productionGoldToggleGroups<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Array containing the 2 "build with production" radio buttons. These should
   * have their selected state kept in sync with each other.
   */</span>
  <span class="token keyword">private</span> RadioButton<span class="token punctuation">[</span><span class="token punctuation">]</span> productionRadioButtons<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Array containing the 2 "build with gold" radio buttons. These should have
   * their selected state kept in sync with each other.
   */</span>
  <span class="token keyword">private</span> RadioButton<span class="token punctuation">[</span><span class="token punctuation">]</span> goldRadioButtons<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Whether or not new buildings should be built with production or gold.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> buildWithProduction<span class="token punctuation">;</span>

  <span class="token comment">/**
   * The game containing the last selected city
   */</span>
  <span class="token keyword">private</span> Game lastSelectedGame<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The city that was last selected by the player
   */</span>
  <span class="token keyword">private</span> City lastSelectedCity<span class="token punctuation">;</span>
  <span class="token comment">/**
   * All the cities that belonged to the owner of the last selected city
   */</span>
  <span class="token keyword">private</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>City<span class="token punctuation">></span></span> lastSelectedPlayersCities<span class="token punctuation">;</span>

  <span class="token function">UIPanelCityDetails</span><span class="token punctuation">(</span>RenderGame renderGame<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>renderGame <span class="token operator">=</span> renderGame<span class="token punctuation">;</span>
    <span class="token function">setPrefWidth</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create empty maps for buildable UI components</span>
    buildablePanes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buildableTooltips <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buildableProgresses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    VBox list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the details pane for showing information (production, gold, etc)</span>
    <span class="token comment">// on a city</span>
    BorderPane detailsTitle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BorderPane</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    detailsTitle<span class="token punctuation">.</span><span class="token function">getStyleClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"production-list-title"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the rename field and button</span>
    detailsTitle<span class="token punctuation">.</span><span class="token function">setCenter</span><span class="token punctuation">(</span>cityNameField <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    StackPane renamePane <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">StackPane</span><span class="token punctuation">(</span>renameButton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Button</span><span class="token punctuation">(</span><span class="token string">"Rename"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    renamePane<span class="token punctuation">.</span><span class="token function">setPadding</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Insets</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    detailsTitle<span class="token punctuation">.</span><span class="token function">setRight</span><span class="token punctuation">(</span>renamePane<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the details row</span>
    HBox details <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HBox</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    details<span class="token punctuation">.</span><span class="token function">setPadding</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Insets</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    details<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">Badge</span><span class="token punctuation">(</span>BadgeType<span class="token punctuation">.</span>PRODUCTION<span class="token punctuation">)</span><span class="token punctuation">,</span>
      cityProductionLabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Badge</span><span class="token punctuation">(</span>BadgeType<span class="token punctuation">.</span>SCIENCE<span class="token punctuation">)</span><span class="token punctuation">,</span>
      cityScienceLabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Badge</span><span class="token punctuation">(</span>BadgeType<span class="token punctuation">.</span>GOLD<span class="token punctuation">)</span><span class="token punctuation">,</span>
      cityGoldLabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Badge</span><span class="token punctuation">(</span>BadgeType<span class="token punctuation">.</span>FOOD<span class="token punctuation">)</span><span class="token punctuation">,</span>
      cityFoodLabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span><span class="token string">"0 (0 citizens)"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>detailsTitle<span class="token punctuation">,</span> details<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create arrays for production/gold buttons</span>
    productionGoldToggleGroups <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToggleGroup</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    productionRadioButtons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RadioButton</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    goldRadioButtons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RadioButton</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// By default, build buildables with production</span>
    buildWithProduction <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// Add the units header</span>
    list<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">buildListTitle</span><span class="token punctuation">(</span><span class="token string">"Units"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>UnitType unit <span class="token operator">:</span> UnitType<span class="token punctuation">.</span>VALUES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Add all buildable unit types</span>
      list<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">buildListItem</span><span class="token punctuation">(</span>unit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Add the buildings header</span>
    list<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">buildListTitle</span><span class="token punctuation">(</span><span class="token string">"Buildings"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Building building <span class="token operator">:</span> Building<span class="token punctuation">.</span>VALUES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Add all buildable buildings</span>
      list<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">buildListItem</span><span class="token punctuation">(</span>building<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Always show the vertical scrollbar</span>
    <span class="token function">setHbarPolicy</span><span class="token punctuation">(</span>ScrollBarPolicy<span class="token punctuation">.</span>NEVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setVbarPolicy</span><span class="token punctuation">(</span>ScrollBarPolicy<span class="token punctuation">.</span>ALWAYS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setContent</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Creates a heading for a buildable list section (units/buildings) with
   * radio buttons for choosing between building with gold and production
   *
   * @param title title for the heading text
   * @param i     index of the section
   * @return pane containing the title
   */</span>
  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"Duplicates"</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> Pane <span class="token function">buildListTitle</span><span class="token punctuation">(</span>String title<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    BorderPane pane <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BorderPane</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Add a CSS class for styling</span>
    pane<span class="token punctuation">.</span><span class="token function">getStyleClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"production-list-title"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add the title</span>
    pane<span class="token punctuation">.</span><span class="token function">setLeft</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//Create a toggle group for this set of buttons</span>
    <span class="token keyword">final</span> ToggleGroup toggleGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToggleGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    productionGoldToggleGroups<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> toggleGroup<span class="token punctuation">;</span>

    HBox prodGoldBox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Label buildWithLabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span><span class="token string">"Build with"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create build with production and gold buttons</span>
    <span class="token keyword">final</span> RadioButton productionButton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RadioButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    productionRadioButtons<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> productionButton<span class="token punctuation">;</span>
    productionButton<span class="token punctuation">.</span><span class="token function">setToggleGroup</span><span class="token punctuation">(</span>toggleGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
    productionButton<span class="token punctuation">.</span><span class="token function">setSelected</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    StackPane productionButtonPane <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StackPane</span><span class="token punctuation">(</span>productionButton<span class="token punctuation">)</span><span class="token punctuation">;</span>
    productionButtonPane<span class="token punctuation">.</span><span class="token function">setPadding</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">Insets</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> RadioButton goldButton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RadioButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    goldRadioButtons<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> goldButton<span class="token punctuation">;</span>
    goldButton<span class="token punctuation">.</span><span class="token function">setToggleGroup</span><span class="token punctuation">(</span>toggleGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
    StackPane goldButtonPane <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StackPane</span><span class="token punctuation">(</span>goldButton<span class="token punctuation">)</span><span class="token punctuation">;</span>
    goldButtonPane<span class="token punctuation">.</span><span class="token function">setPadding</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Insets</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Keep the buttons in this header in sync with the other header by</span>
    <span class="token comment">// watching for changes</span>
    toggleGroup<span class="token punctuation">.</span><span class="token function">selectedToggleProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>observable<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment">// Whether we're now building with production</span>
        <span class="token keyword">boolean</span> newBuildWithProduction <span class="token operator">=</span> newValue <span class="token operator">==</span> productionButton<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buildWithProduction <span class="token operator">!=</span> newBuildWithProduction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// If they're different, update the other button</span>
          buildWithProduction <span class="token operator">=</span> newBuildWithProduction<span class="token punctuation">;</span>
          <span class="token keyword">int</span> otherIndex <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">;</span>
          productionGoldToggleGroups<span class="token punctuation">[</span>otherIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">selectToggle</span><span class="token punctuation">(</span>
            buildWithProduction
              <span class="token operator">?</span> productionRadioButtons<span class="token punctuation">[</span>otherIndex<span class="token punctuation">]</span>
              <span class="token operator">:</span> goldRadioButtons<span class="token punctuation">[</span>otherIndex<span class="token punctuation">]</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// Recalculate whether or not each item can be built/purchased</span>
          <span class="token function">setSelectedCity</span><span class="token punctuation">(</span>
            lastSelectedGame<span class="token punctuation">,</span>
            lastSelectedCity<span class="token punctuation">,</span>
            lastSelectedPlayersCities
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add build with UI components</span>
    prodGoldBox<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>
      buildWithLabel<span class="token punctuation">,</span>
      productionButtonPane<span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Badge</span><span class="token punctuation">(</span>BadgeType<span class="token punctuation">.</span>PRODUCTION<span class="token punctuation">)</span><span class="token punctuation">,</span>
      goldButtonPane<span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Badge</span><span class="token punctuation">(</span>BadgeType<span class="token punctuation">.</span>GOLD<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    pane<span class="token punctuation">.</span><span class="token function">setRight</span><span class="token punctuation">(</span>prodGoldBox<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> pane<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Build a list item for a {@link CityBuildable}. Clicking on this will build
   * it in the selected city.
   *
   * @param buildable buildable to constructor a list item for
   * @return list item for that buildable
   */</span>
  <span class="token keyword">private</span> Pane <span class="token function">buildListItem</span><span class="token punctuation">(</span>CityBuildable buildable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    BorderPane listItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BorderPane</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Add CSS class form styling</span>
    listItem<span class="token punctuation">.</span><span class="token function">getStyleClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"production-list-item"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Make it fill as little height as possible</span>
    listItem<span class="token punctuation">.</span><span class="token function">setMaxHeight</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create a tooltip that shows up on hover</span>
    Tooltip tooltip <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tooltip</span><span class="token punctuation">(</span><span class="token string">"Click to build this in the city"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buildableTooltips<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>buildable<span class="token punctuation">,</span> tooltip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Tooltip<span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span>listItem<span class="token punctuation">,</span> tooltip<span class="token punctuation">)</span><span class="token punctuation">;</span>

    VBox list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add the title and description of the buildable</span>
    Label titleLabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span>buildable<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    titleLabel<span class="token punctuation">.</span><span class="token function">setFont</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Font</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Label descriptionLabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span>buildable<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add the details of the buildable in a row with the relevant badges</span>
    HBox detailsBox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HBox</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    detailsBox<span class="token punctuation">.</span><span class="token function">setPadding</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Insets</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>CityBuildable<span class="token punctuation">.</span>Detail detail <span class="token operator">:</span> buildable<span class="token punctuation">.</span><span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      detailsBox<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Badge</span><span class="token punctuation">(</span>detail<span class="token punctuation">.</span>badge<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>detail<span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        detailsBox<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span>detail<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    list<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>titleLabel<span class="token punctuation">,</span> descriptionLabel<span class="token punctuation">,</span> detailsBox<span class="token punctuation">)</span><span class="token punctuation">;</span>

    listItem<span class="token punctuation">.</span><span class="token function">setCenter</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add a progress indicator for the build progress</span>
    ProgressIndicator progressIndicator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProgressIndicator</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    progressIndicator<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buildableProgresses<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>buildable<span class="token punctuation">,</span> progressIndicator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    listItem<span class="token punctuation">.</span><span class="token function">setRight</span><span class="token punctuation">(</span>progressIndicator<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store the pane later so it can be made translucent/invisible</span>
    buildablePanes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>buildable<span class="token punctuation">,</span> listItem<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> listItem<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the currently selected city and updates the UI to reflect what can be
   * built there.
   *
   * @param game          game the city is contained in
   * @param city          newly selected city
   * @param playersCities all the cities that belonged to the owner of the
   *                      newly selected city
   */</span>
  <span class="token keyword">void</span> <span class="token function">setSelectedCity</span><span class="token punctuation">(</span>Game game<span class="token punctuation">,</span> City city<span class="token punctuation">,</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>City<span class="token punctuation">></span></span> playersCities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Store these last selections so this function can be called again later</span>
    lastSelectedGame <span class="token operator">=</span> game<span class="token punctuation">;</span>
    lastSelectedCity <span class="token operator">=</span> city<span class="token punctuation">;</span>
    lastSelectedPlayersCities <span class="token operator">=</span> playersCities<span class="token punctuation">;</span>

    <span class="token comment">// Update the city details in the labels</span>
    cityProductionLabel<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>city<span class="token punctuation">.</span><span class="token function">getProductionPerTurn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cityScienceLabel<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>city<span class="token punctuation">.</span><span class="token function">getSciencePerTurn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cityGoldLabel<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>city<span class="token punctuation">.</span><span class="token function">getGoldPerTurn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cityFoodLabel<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
      <span class="token string">"%d (%d citizen%s)"</span><span class="token punctuation">,</span>
      city<span class="token punctuation">.</span><span class="token function">getFoodPerTurn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      city<span class="token punctuation">.</span>citizens<span class="token punctuation">,</span>
      city<span class="token punctuation">.</span>citizens <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> <span class="token string">"s"</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cityNameField<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>city<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Set the rename handler</span>
    renameButton<span class="token punctuation">.</span><span class="token function">setOnAction</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
      String newName <span class="token operator">=</span> cityNameField<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Update the name locally and broadcast a pakcet for the change</span>
      city<span class="token punctuation">.</span>name <span class="token operator">=</span> newName<span class="token punctuation">;</span>
      Civilisation<span class="token punctuation">.</span>CLIENT<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PacketCityRename</span><span class="token punctuation">(</span>
        city<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        city<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        newName
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Iterate through every buildables' pane</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token generics function"><span class="token punctuation">&lt;</span>CityBuildable<span class="token punctuation">,</span> Pane<span class="token punctuation">></span></span> e <span class="token operator">:</span> buildablePanes<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Get UI components representing the buildable</span>
      CityBuildable buildable <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Pane buildablePane <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Tooltip buildableTooltip <span class="token operator">=</span> buildableTooltips<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>buildable<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ProgressIndicator progressIndicator <span class="token operator">=</span> buildableProgresses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>buildable<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Toggle CSS class for opacity</span>
      UIHelpers<span class="token punctuation">.</span><span class="token function">toggleClass</span><span class="token punctuation">(</span>
        buildablePane<span class="token punctuation">,</span>
        <span class="token string">"not-unlocked"</span><span class="token punctuation">,</span>
        <span class="token operator">!</span>game<span class="token punctuation">.</span><span class="token function">playerHasUnlocked</span><span class="token punctuation">(</span>city<span class="token punctuation">.</span>player<span class="token punctuation">.</span>id<span class="token punctuation">,</span> buildable<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Toggle visibility</span>
      buildablePane<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span>
        game<span class="token punctuation">.</span><span class="token function">playerHasUnlocked</span><span class="token punctuation">(</span>city<span class="token punctuation">.</span>player<span class="token punctuation">.</span>id<span class="token punctuation">,</span> buildable<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Prevents the pane from taking up space in the column if it's hidden</span>
      buildablePane<span class="token punctuation">.</span><span class="token function">setManaged</span><span class="token punctuation">(</span>
        game<span class="token punctuation">.</span><span class="token function">playerHasUnlocked</span><span class="token punctuation">(</span>city<span class="token punctuation">.</span>player<span class="token punctuation">.</span>id<span class="token punctuation">,</span> buildable<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Whether this is the currently building item</span>
      <span class="token keyword">boolean</span> currentlyBuildingThis <span class="token operator">=</span> buildable<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>city<span class="token punctuation">.</span>currentlyBuilding<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Get the reason (if any) why this can't be built in the city</span>
      String cantBuildReason <span class="token operator">=</span> buildable<span class="token punctuation">.</span><span class="token function">canBuildGivenCities</span><span class="token punctuation">(</span>
        city<span class="token punctuation">,</span>
        playersCities
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Calculate the tooltip text</span>
      String tooltipText <span class="token operator">=</span> <span class="token string">"Click to build this in the city"</span><span class="token punctuation">;</span>
      <span class="token keyword">boolean</span> canBuild <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentlyBuildingThis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tooltipText <span class="token operator">=</span> <span class="token string">"You are currently building this"</span><span class="token punctuation">;</span>
        canBuild <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>city<span class="token punctuation">.</span>currentlyBuilding <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tooltipText <span class="token operator">=</span> <span class="token string">"You are currently building something else"</span><span class="token punctuation">;</span>
        canBuild <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buildWithProduction
        <span class="token operator">&amp;&amp;</span> game<span class="token punctuation">.</span><span class="token function">getPlayerGoldTotal</span><span class="token punctuation">(</span>city<span class="token punctuation">.</span>player<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token operator">&lt;</span> buildable<span class="token punctuation">.</span><span class="token function">getGoldCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tooltipText <span class="token operator">=</span> <span class="token string">"You don't have enough gold to build this"</span><span class="token punctuation">;</span>
        canBuild <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cantBuildReason <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> cantBuildReason<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tooltipText <span class="token operator">=</span> cantBuildReason<span class="token punctuation">;</span>
        canBuild <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Set the tooltip text to the calculate value</span>
      buildableTooltip<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>tooltipText<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Update classes for opacity</span>
      UIHelpers<span class="token punctuation">.</span><span class="token function">toggleClass</span><span class="token punctuation">(</span>
        buildablePane<span class="token punctuation">,</span>
        <span class="token string">"can-build"</span><span class="token punctuation">,</span>
        canBuild
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      UIHelpers<span class="token punctuation">.</span><span class="token function">toggleClass</span><span class="token punctuation">(</span>
        buildablePane<span class="token punctuation">,</span>
        <span class="token string">"building"</span><span class="token punctuation">,</span>
        currentlyBuildingThis
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Set the progress of the current build</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentlyBuildingThis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        progressIndicator<span class="token punctuation">.</span><span class="token function">setProgress</span><span class="token punctuation">(</span>
          Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> city<span class="token punctuation">.</span>productionTotal
              <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> buildable<span class="token punctuation">.</span><span class="token function">getProductionCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token number">1.0</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      progressIndicator<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span>currentlyBuildingThis<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Add a click listener if this can be built</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>canBuild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buildablePane<span class="token punctuation">.</span><span class="token function">setOnMouseClicked</span><span class="token punctuation">(</span>event <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token comment">// Create a packet detailing the build request</span>
          PacketCityBuildRequest packetCityBuildRequest <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">PacketCityBuildRequest</span><span class="token punctuation">(</span>
              city<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              city<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              buildable<span class="token punctuation">,</span>
              buildWithProduction
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// Handle it locally and broadcast it to sync the state</span>
          renderGame<span class="token punctuation">.</span><span class="token function">handlePacket</span><span class="token punctuation">(</span>packetCityBuildRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// Update the display of items now that something is being built</span>
          <span class="token function">setSelectedCity</span><span class="token punctuation">(</span>game<span class="token punctuation">,</span> city<span class="token punctuation">,</span> playersCities<span class="token punctuation">)</span><span class="token punctuation">;</span>
          Civilisation<span class="token punctuation">.</span>CLIENT<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>packetCityBuildRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
          System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Clicked on "</span> <span class="token operator">+</span> buildable<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Remove it if it can't</span>
        buildablePane<span class="token punctuation">.</span><span class="token function">setOnMouseClicked</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/ui/game/styles.css</h1><pre class="language-css"><code class="language-css"><span class="token comment">/* Removes default light grey backgrounds on scroll panes */</span>
<span class="token selector">.scroll-pane > .viewport</span> <span class="token punctuation">{</span>
  <span class="token property">-fx-background-color</span><span class="token punctuation">:</span> transparent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Styles the production list headers (the "Units" and "Buildings") above the
 * list of available buildables.
 */</span>
<span class="token selector">.production-list-title</span> <span class="token punctuation">{</span>
  <span class="token property">-fx-pref-width</span><span class="token punctuation">:</span> 275px<span class="token punctuation">;</span>
  <span class="token property">-fx-background-color</span><span class="token punctuation">:</span> #CCCCCC<span class="token punctuation">;</span>
  <span class="token property">-fx-padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Styles a production list item representing a city buildable. */</span>
<span class="token selector">.production-list-item</span> <span class="token punctuation">{</span>
  <span class="token property">-fx-pref-width</span><span class="token punctuation">:</span> 275px<span class="token punctuation">;</span>
  <span class="token property">-fx-background-color</span><span class="token punctuation">:</span> #FFFFFF<span class="token punctuation">;</span>
  <span class="token property">-fx-padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
  <span class="token comment">/* Make items slightly translucent by default. */</span>
  <span class="token property">-fx-opacity</span><span class="token punctuation">:</span> 0.5<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Removes padding from buildables that haven't been unlocked yet so they don't
 * take up any space in the production list.
 */</span>
<span class="token selector">.production-list-item.not-unlocked</span> <span class="token punctuation">{</span>
  <span class="token property">-fx-padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Make items opaque if they can be built or they are currently being built. */</span>
<span class="token selector">.production-list-item.can-build, .production-list-item.building</span> <span class="token punctuation">{</span>
  <span class="token property">-fx-opacity</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Change the background colour of an item when the user is hovering over it */</span>
<span class="token selector">.production-list-item.can-build:hover</span> <span class="token punctuation">{</span>
  <span class="token property">-fx-background-color</span><span class="token punctuation">:</span> #EEEEEE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Change the background colour of an item when the user is clicking on it */</span>
<span class="token selector">.production-list-item.can-build:pressed</span> <span class="token punctuation">{</span>
  <span class="token property">-fx-background-color</span><span class="token punctuation">:</span> #DDDDDD<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/ui/game/UIPanelTech.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>game<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>techs<span class="token punctuation">.</span>PlayerTechDetails<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>event<span class="token punctuation">.</span>ActionEvent<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>event<span class="token punctuation">.</span>EventHandler<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Insets<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>control<span class="token punctuation">.</span>Button<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>control<span class="token punctuation">.</span>Label<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>control<span class="token punctuation">.</span>ProgressIndicator<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>BorderPane<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>text<span class="token punctuation">.</span>Font<span class="token punctuation">;</span>

<span class="token comment">/**
 * UI panel for basic tech details (what the player is currently researching
 * and their progress towards unlocking it)
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UIPanelTech</span> <span class="token keyword">extends</span> <span class="token class-name">BorderPane</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Label containing the name of the player's current research or "Nothing" if
   * they aren't researching anything
   */</span>
  <span class="token keyword">private</span> Label currentlyResearching<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Progress towards unlocking the current technology
   */</span>
  <span class="token keyword">private</span> ProgressIndicator progress<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Button that when clicked should show the tech tree UI
   */</span>
  <span class="token keyword">private</span> Button openTechTree<span class="token punctuation">;</span>

  <span class="token function">UIPanelTech</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the current researching label</span>
    Label currentlyResearchingHeading <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span><span class="token string">"Currently researching:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentlyResearching <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span><span class="token string">"Nothing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentlyResearching<span class="token punctuation">.</span><span class="token function">setFont</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Font</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentlyResearching<span class="token punctuation">.</span><span class="token function">setPadding</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">Insets</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the unlock progress indicator</span>
    progress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProgressIndicator</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    progress<span class="token punctuation">.</span><span class="token function">setPadding</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Insets</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the open button</span>
    openTechTree <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Button</span><span class="token punctuation">(</span><span class="token string">"Open Tech Tree"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    openTechTree<span class="token punctuation">.</span><span class="token function">setPrefWidth</span><span class="token punctuation">(</span><span class="token number">230</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Position the elements in the border pane</span>
    <span class="token function">setTop</span><span class="token punctuation">(</span>currentlyResearchingHeading<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setLeft</span><span class="token punctuation">(</span>progress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCenter</span><span class="token punctuation">(</span>currentlyResearching<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setBottom</span><span class="token punctuation">(</span>openTechTree<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Update the UI to reflect new player tech details. Called when a player
   * chooses a new technology to research or the progress of the current
   * project is updated (on new turn)
   *
   * @param details new tech details object for the player
   */</span>
  <span class="token keyword">void</span> <span class="token function">setTechDetails</span><span class="token punctuation">(</span>PlayerTechDetails details<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Set the currently researching text to the name of the current tech or</span>
    <span class="token comment">// "Nothing" if no tech is being researched.</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentlyResearching<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>details<span class="token punctuation">.</span>currentlyUnlocking <span class="token operator">==</span> null
      <span class="token operator">?</span> <span class="token string">"Nothing"</span>
      <span class="token operator">:</span> details<span class="token punctuation">.</span>currentlyUnlocking<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Set the progress indicator to reflect the current percent unlocked</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>progress<span class="token punctuation">.</span><span class="token function">setProgress</span><span class="token punctuation">(</span>details<span class="token punctuation">.</span>percentUnlocked<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the listener to be called when the open tech tree button is pressed.
   * Should show the tech tree UI.
   *
   * @param value listener to be called when the button is pressed
   */</span>
  <span class="token keyword">void</span> <span class="token function">setOnOpenTechTree</span><span class="token punctuation">(</span>EventHandler<span class="token generics function"><span class="token punctuation">&lt;</span>ActionEvent<span class="token punctuation">></span></span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    openTechTree<span class="token punctuation">.</span><span class="token function">setOnAction</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/ui/game/UITechTree.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>game<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>Civilisation<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>techs<span class="token punctuation">.</span>Unlockable<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>Game<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>techs<span class="token punctuation">.</span>PlayerTechDetails<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>techs<span class="token punctuation">.</span>Tech<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">.</span>PacketPlayerResearchRequest<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Insets<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Pos<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>Canvas<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>GraphicsContext<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>control<span class="token punctuation">.</span>Label<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>control<span class="token punctuation">.</span>ScrollPane<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>LinearGradient<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Stop<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>text<span class="token punctuation">.</span>Font<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>text<span class="token punctuation">.</span>FontWeight<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>text<span class="token punctuation">.</span>TextAlignment<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>UIHelpers<span class="token punctuation">.</span>colouredBackground<span class="token punctuation">;</span>

<span class="token comment">/**
 * Tech tree UI. Overlaid on top of the entire game interface when shown
 * so that it takes up the full screen. Extends scroll pane to enable
 * horizontal scrolling.
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UITechTree</span> <span class="token keyword">extends</span> <span class="token class-name">ScrollPane</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Font to be used for rendering the name of technologies in the tree
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Font TECH_TITLE_FONT <span class="token operator">=</span> Font<span class="token punctuation">.</span><span class="token function">font</span><span class="token punctuation">(</span>
    Font<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFamily</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    FontWeight<span class="token punctuation">.</span>EXTRA_BOLD<span class="token punctuation">,</span>
    <span class="token number">15</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Default border for technologies in the tree
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Border TECH_BORDER <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Border</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">BorderStroke</span><span class="token punctuation">(</span>
      Color<span class="token punctuation">.</span>BLACK<span class="token punctuation">,</span>
      BorderStrokeStyle<span class="token punctuation">.</span>SOLID<span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">CornerRadii</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">BorderWidths</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Border for technologies that can be unlocked in the tree. Only used when
   * the player is able to select a new technology (i.e. when one isn't being
   * researched).
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Border TECH_CAN_UNLOCK_BORDER <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Border</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">BorderStroke</span><span class="token punctuation">(</span>
      Color<span class="token punctuation">.</span>LIMEGREEN<span class="token punctuation">,</span>
      BorderStrokeStyle<span class="token punctuation">.</span>SOLID<span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">CornerRadii</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">BorderWidths</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Border for the technology that is currently being unlocked in the tree
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Border TECH_UNLOCKING_BORDER <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Border</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">BorderStroke</span><span class="token punctuation">(</span>
      Color<span class="token punctuation">.</span>DEEPSKYBLUE<span class="token punctuation">,</span>
      BorderStrokeStyle<span class="token punctuation">.</span>SOLID<span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">CornerRadii</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">BorderWidths</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Width of the rounded rectangle that represents a technology in the tree
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> TECH_WIDTH <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Horizontal spacing between horizontally adjacent techs (spacing between
   * each level of techs). See {@link Tech} for level information.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> TECH_HORIZONTAL_SPACING <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Vertical spacing between vertically adjacent techs (spacing between
   * techs on the same level). See {@link Tech} for level information.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> TECH_VERTICAL_SPACING <span class="token operator">=</span> <span class="token number">320</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * ID of the current player
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> String playerId<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Graphics context for rendering the connecting curves between technologies
   * in the tree.
   */</span>
  <span class="token keyword">private</span> GraphicsContext lineGraphics<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Pane containing the rounded rectangles for each of the techs in the tree.
   */</span>
  <span class="token keyword">private</span> StackPane techPane<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Map mapping techs to their rounded rectangles in the UI.
   */</span>
  <span class="token keyword">private</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>Tech<span class="token punctuation">,</span> Region<span class="token punctuation">></span></span> renderedTechs<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Middle of the screen. Screen y-coordinate to render techs with a
   * y-coordinate of 0. See {@link Tech#getY()}.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> lineOffset<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Create a new tech tree UI
   *
   * @param game     game containing the current player
   * @param playerId ID of the current player
   * @param details  the current player's tech details
   * @param height   the screen height
   */</span>
  <span class="token function">UITechTree</span><span class="token punctuation">(</span>
    Game game<span class="token punctuation">,</span>
    String playerId<span class="token punctuation">,</span>
    PlayerTechDetails details<span class="token punctuation">,</span>
    <span class="token keyword">int</span> height
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>playerId <span class="token operator">=</span> playerId<span class="token punctuation">;</span>

    <span class="token comment">// Always show the horizontal scroll bar</span>
    <span class="token function">setVbarPolicy</span><span class="token punctuation">(</span>ScrollBarPolicy<span class="token punctuation">.</span>NEVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setHbarPolicy</span><span class="token punctuation">(</span>ScrollBarPolicy<span class="token punctuation">.</span>ALWAYS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setFitToHeight</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Position techs with a y-coordinate of 0 in the middle of the screen</span>
    lineOffset <span class="token operator">=</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token comment">// Create the canvas and context for rendering connecting curves between</span>
    <span class="token comment">// the techs</span>
    Canvas lineCanvas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Canvas</span><span class="token punctuation">(</span>
      <span class="token comment">// Max it wide enough to contain all the lines</span>
      <span class="token punctuation">(</span>Tech<span class="token punctuation">.</span>MAX_X <span class="token operator">*</span> <span class="token punctuation">(</span>TECH_WIDTH <span class="token operator">+</span> TECH_HORIZONTAL_SPACING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">,</span>
      height
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    lineGraphics <span class="token operator">=</span> lineCanvas<span class="token punctuation">.</span><span class="token function">getGraphicsContext2D</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lineGraphics<span class="token punctuation">.</span><span class="token function">setLineWidth</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the pane/map that all tech rounded rectangles should be added to</span>
    techPane <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StackPane</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    techPane<span class="token punctuation">.</span><span class="token function">setAlignment</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>CENTER_LEFT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    renderedTechs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Traverse the tech tree, adding all techs to the UI along the way</span>
    <span class="token function">addTechs</span><span class="token punctuation">(</span>Tech<span class="token punctuation">.</span><span class="token function">getRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Stack the tech rectangles on top of the connecting lines</span>
    StackPane rootPane <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StackPane</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rootPane<span class="token punctuation">.</span><span class="token function">setAlignment</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>TOP_LEFT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rootPane<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>lineCanvas<span class="token punctuation">,</span> techPane<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setContent</span><span class="token punctuation">(</span>rootPane<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Set the initial player tech details, making certain techs clickable in</span>
    <span class="token comment">// the tree.</span>
    <span class="token function">setTechDetails</span><span class="token punctuation">(</span>game<span class="token punctuation">,</span> details<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Adds techs' rounded rectangles to the UI so they can be seen/selected by
   * the user.
   *
   * @param techToRender root of the tech tree containing children that will
   *                     be recursively passed back to this function to render
   *                     their children and so fourth
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addTechs</span><span class="token punctuation">(</span>Tech techToRender<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Calculate the position to render this tech in</span>
    <span class="token keyword">int</span> x <span class="token operator">=</span> techToRender<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> y <span class="token operator">=</span> techToRender<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">double</span> renderX <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token punctuation">(</span>TECH_WIDTH <span class="token operator">+</span> TECH_HORIZONTAL_SPACING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> renderY <span class="token operator">=</span> y <span class="token operator">*</span> TECH_VERTICAL_SPACING<span class="token punctuation">;</span>

    <span class="token comment">// Make sure each tech is only rendered once</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>renderedTechs<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>techToRender<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Create the rounded rectangle for this tech with some vertical spacing</span>
      <span class="token comment">// between its subcomponents</span>
      VBox tech <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VBox</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      tech<span class="token punctuation">.</span><span class="token function">setMinWidth</span><span class="token punctuation">(</span>TECH_WIDTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
      tech<span class="token punctuation">.</span><span class="token function">setAlignment</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>CENTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
      tech<span class="token punctuation">.</span><span class="token function">setPadding</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Insets</span><span class="token punctuation">(</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token comment">// Give the tech some padding if it unlocks things so the unlock list</span>
        <span class="token comment">// is centered (if it exists)</span>
        techToRender<span class="token punctuation">.</span><span class="token function">getUnlocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">10</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      tech<span class="token punctuation">.</span><span class="token function">setMaxSize</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      tech<span class="token punctuation">.</span><span class="token function">setBorder</span><span class="token punctuation">(</span>TECH_BORDER<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Store the render so the tech isn't rendered again and so it can be</span>
      <span class="token comment">// updated later</span>
      renderedTechs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>techToRender<span class="token punctuation">,</span> tech<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Create/add a label for the name of the tech</span>
      Label titleLabel <span class="token operator">=</span> <span class="token function">makeCenteredLabel</span><span class="token punctuation">(</span>techToRender<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      titleLabel<span class="token punctuation">.</span><span class="token function">setFont</span><span class="token punctuation">(</span>TECH_TITLE_FONT<span class="token punctuation">)</span><span class="token punctuation">;</span>
      titleLabel<span class="token punctuation">.</span><span class="token function">setPadding</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Insets</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      titleLabel<span class="token punctuation">.</span><span class="token function">setAlignment</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>CENTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
      titleLabel<span class="token punctuation">.</span><span class="token function">setPrefWidth</span><span class="token punctuation">(</span>Double<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      titleLabel<span class="token punctuation">.</span><span class="token function">setTextFill</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      titleLabel<span class="token punctuation">.</span><span class="token function">setBackground</span><span class="token punctuation">(</span><span class="token function">colouredBackground</span><span class="token punctuation">(</span>techToRender<span class="token punctuation">.</span><span class="token function">getColour</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      tech<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>titleLabel<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Create/add labels for each of the techs unlocks</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>Unlockable unlock <span class="token operator">:</span> techToRender<span class="token punctuation">.</span><span class="token function">getUnlocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tech<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeCenteredLabel</span><span class="token punctuation">(</span>unlock<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Position the tech on the screen</span>
      StackPane<span class="token punctuation">.</span><span class="token function">setMargin</span><span class="token punctuation">(</span>tech<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Insets</span><span class="token punctuation">(</span>
        renderY<span class="token punctuation">,</span>
        <span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        renderX
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Add it to the UI</span>
      techPane<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tech<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Update renderY for line coordinates</span>
    renderY <span class="token operator">=</span> <span class="token punctuation">(</span>renderY <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> lineOffset<span class="token punctuation">;</span>

    <span class="token comment">// Render the connections between this tech and any children. Then render</span>
    <span class="token comment">// those children if they haven't already been.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Tech child <span class="token operator">:</span> techToRender<span class="token punctuation">.</span><span class="token function">getRequiredBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Calculate the end coordinates of the connecting line</span>
      <span class="token keyword">int</span> endX <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> endY <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">double</span> endRenderX <span class="token operator">=</span>
        <span class="token punctuation">(</span>endX <span class="token operator">*</span> <span class="token punctuation">(</span>TECH_WIDTH <span class="token operator">+</span> TECH_HORIZONTAL_SPACING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
      <span class="token keyword">double</span> endRenderY <span class="token operator">=</span> <span class="token punctuation">(</span>endY <span class="token operator">*</span> TECH_VERTICAL_SPACING <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> lineOffset<span class="token punctuation">;</span>
      <span class="token keyword">double</span> startX <span class="token operator">=</span> renderX <span class="token operator">+</span> TECH_WIDTH<span class="token punctuation">;</span>
      <span class="token keyword">double</span> midRenderX <span class="token operator">=</span> <span class="token punctuation">(</span>startX <span class="token operator">+</span> endRenderX<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>

      <span class="token comment">// Set the stroke colour to a linear gradient of the different techs'</span>
      <span class="token comment">// colours</span>
      lineGraphics<span class="token punctuation">.</span><span class="token function">setStroke</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LinearGradient</span><span class="token punctuation">(</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">Stop</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> techToRender<span class="token punctuation">.</span><span class="token function">getColour</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">Stop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> child<span class="token punctuation">.</span><span class="token function">getColour</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Start drawing the connecting curve</span>
      lineGraphics<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Start Coordinates</span>
      lineGraphics<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>startX<span class="token punctuation">,</span> renderY<span class="token punctuation">)</span><span class="token punctuation">;</span>
      lineGraphics<span class="token punctuation">.</span><span class="token function">bezierCurveTo</span><span class="token punctuation">(</span>
        <span class="token comment">// Control Point 1</span>
        midRenderX<span class="token punctuation">,</span> renderY<span class="token punctuation">,</span>
        <span class="token comment">// Control Point 2</span>
        midRenderX<span class="token punctuation">,</span> endRenderY<span class="token punctuation">,</span>
        <span class="token comment">// End Coordinates</span>
        endRenderX<span class="token punctuation">,</span> endRenderY
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Actually draw the line to the canvas</span>
      lineGraphics<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      lineGraphics<span class="token punctuation">.</span><span class="token function">closePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Add the child to the UI along with any of its children (recursive call)</span>
      <span class="token function">addTechs</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Creates a label with centered text
   *
   * @param text text of the label
   * @return label containing the specified text in the center
   */</span>
  <span class="token keyword">private</span> Label <span class="token function">makeCenteredLabel</span><span class="token punctuation">(</span>String text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Label label <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    label<span class="token punctuation">.</span><span class="token function">setTextAlignment</span><span class="token punctuation">(</span>TextAlignment<span class="token punctuation">.</span>CENTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> label<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Update the rounded rectangles representing the different technologies.
   *
   * @param game    game the current player is contained within
   * @param details current player's technology details
   */</span>
  <span class="token keyword">void</span> <span class="token function">setTechDetails</span><span class="token punctuation">(</span>Game game<span class="token punctuation">,</span> PlayerTechDetails details<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Iterate through all of the tech renders</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token generics function"><span class="token punctuation">&lt;</span>Tech<span class="token punctuation">,</span> Region<span class="token punctuation">></span></span> entry <span class="token operator">:</span> renderedTechs<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> Tech tech <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> Region render <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Check if this tech is currently being unlocked</span>
      <span class="token keyword">boolean</span> current <span class="token operator">=</span> tech<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>details<span class="token punctuation">.</span>currentlyUnlocking<span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> details<span class="token punctuation">.</span>percentUnlocked <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token comment">// Check if this tech is already unlocked</span>
      <span class="token keyword">boolean</span> unlocked <span class="token operator">=</span> tech<span class="token punctuation">.</span><span class="token function">getScienceCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
        <span class="token operator">||</span> details<span class="token punctuation">.</span>unlockedTechs<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>tech<span class="token punctuation">)</span>
        <span class="token operator">||</span> <span class="token punctuation">(</span>tech<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>details<span class="token punctuation">.</span>currentlyUnlocking<span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> details<span class="token punctuation">.</span>percentUnlocked <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Check if the player can unlock this tech given its requirements</span>
      <span class="token keyword">boolean</span> canUnlock <span class="token operator">=</span> <span class="token operator">!</span>unlocked <span class="token operator">&amp;&amp;</span>
        details<span class="token punctuation">.</span>currentlyUnlocking <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span>
        tech<span class="token punctuation">.</span><span class="token function">canUnlockGivenUnlocked</span><span class="token punctuation">(</span>details<span class="token punctuation">.</span>unlockedTechs<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Make the tech opaque only if any of these conditions are true</span>
      render<span class="token punctuation">.</span><span class="token function">setOpacity</span><span class="token punctuation">(</span>
        unlocked <span class="token operator">||</span> current <span class="token operator">||</span> canUnlock
          <span class="token operator">?</span> <span class="token number">1</span>
          <span class="token operator">:</span> <span class="token number">0.2</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Set the tech's border depending on these conditions</span>
      render<span class="token punctuation">.</span><span class="token function">setBorder</span><span class="token punctuation">(</span>
        canUnlock
          <span class="token operator">?</span> TECH_CAN_UNLOCK_BORDER
          <span class="token operator">:</span> <span class="token punctuation">(</span>current <span class="token operator">?</span> TECH_UNLOCKING_BORDER <span class="token operator">:</span> TECH_BORDER<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Register a click listener if this tech can be unlocked</span>
      render<span class="token punctuation">.</span><span class="token function">setOnMouseClicked</span><span class="token punctuation">(</span>
        canUnlock
          <span class="token operator">?</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token comment">// Request the player start researching this technology</span>
          PacketPlayerResearchRequest packetPlayerResearchRequest <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">PacketPlayerResearchRequest</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> tech<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// Handle it locally and broadcast it to keep the game state in sync</span>
          game<span class="token punctuation">.</span><span class="token function">handlePacket</span><span class="token punctuation">(</span>packetPlayerResearchRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
          Civilisation<span class="token punctuation">.</span>CLIENT<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>packetPlayerResearchRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
          <span class="token operator">:</span> null
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/Packet.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable<span class="token punctuation">;</span>

<span class="token comment">/**
 * Base packet class. All packet types extend this. Packets are sent between
 * clients and the server to keep the game state synchronised.
 * &lt;p>
 * Implements serializable so
 * that any subclass can be sent over the network with
 * {@link java.io.ObjectInputStream} and {@link java.io.ObjectOutputStream}
 * both of which allow Java objects to be sent/received. Implementing
 * serializable means that all class fields must themselves be serializable.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Packet</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/PacketBlastOff.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token comment">/**
 * Packet emitted when a player activates the blast off action. On receiving
 * this packet, the specified player should win the game.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketBlastOff</span> <span class="token keyword">extends</span> <span class="token class-name">PacketUpdate</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * ID of the player who blasted off and is now the winner of the game
   */</span>
  <span class="token keyword">public</span> String playerId<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">PacketBlastOff</span><span class="token punctuation">(</span>String playerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>playerId <span class="token operator">=</span> playerId<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/PacketChat.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token comment">/**
 * Packet emitted when a player sends a chat message from the UI. On receiving
 * this packet, the UI of this game should update to include the new message.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketChat</span> <span class="token keyword">extends</span> <span class="token class-name">PacketUpdate</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Chat message sent by the player along with their player ID. An example
   * would be "Player: Hello?".
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> String message<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">PacketChat</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> message<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/PacketCityBuildRequest.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>CityBuildable<span class="token punctuation">;</span>

<span class="token comment">/**
 * Packet emitted when a player clicks on a buildable in the city production
 * list. On receiving this packet, the game should start the build of this in
 * the selected city, or purchase the item with gold if that was requested.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketCityBuildRequest</span> <span class="token keyword">extends</span> <span class="token class-name">PacketUpdate</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * X-coordinate of the city to build in
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Y-coordinate of the city to build in
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> y<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Name of the buildable object to build in the city (buildables aren't
   * serializable so we must store the unique name instead)
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> String buildable<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Whether to build this with production or to just purchase it outright
   * with gold.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> withProduction<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">PacketCityBuildRequest</span><span class="token punctuation">(</span>
    <span class="token keyword">int</span> x<span class="token punctuation">,</span>
    <span class="token keyword">int</span> y<span class="token punctuation">,</span>
    CityBuildable buildable<span class="token punctuation">,</span>
    <span class="token keyword">boolean</span> withProduction
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>buildable <span class="token operator">=</span> buildable<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>withProduction <span class="token operator">=</span> withProduction<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the city buildable this packet contains. Buildables aren't
   * serializable so they must be recreated from their name.
   *
   * @return buildable this packet contains
   */</span>
  <span class="token keyword">public</span> CityBuildable <span class="token function">getBuildable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> CityBuildable<span class="token punctuation">.</span><span class="token function">fromName</span><span class="token punctuation">(</span>buildable<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/PacketCityCreate.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token comment">/**
 * Packet emitted when a player wants to create a city. On receiving this
 * packet, the game should create the city at the specified coordinates for the
 * player.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketCityCreate</span> <span class="token keyword">extends</span> <span class="token class-name">PacketUpdate</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * ID of the player who's creating this city
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> String id<span class="token punctuation">;</span>
  <span class="token comment">/**
   * X-coordinate of the city
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Y-coordinate of the city
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> y<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">PacketCityCreate</span><span class="token punctuation">(</span>String id<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/PacketCityGrow.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Point2D<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span>

<span class="token comment">/**
 * Packet emitted when a city grows to a new set of tiles. On receiving this
 * packet, the game should add the specified tiles to the cities territory.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketCityGrow</span> <span class="token keyword">extends</span> <span class="token class-name">PacketUpdate</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * ID of the owner of the city to grow
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> String id<span class="token punctuation">;</span>
  <span class="token comment">/**
   * X-coordinate of the city to grow
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Y-coordinate of the city to grow
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> y<span class="token punctuation">;</span>
  <span class="token comment">/**
   * X-coordinates of the new set of tiles to grow to ({@link Point2D} isn't
   * serializable)
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> grownToXs<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Y-coordinates of the new set of tiles to grow to ({@link Point2D} isn't
   * serializable)
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> grownToYs<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">PacketCityGrow</span><span class="token punctuation">(</span>String id<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Point2D<span class="token punctuation">></span></span> grownTo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>

    <span class="token comment">// Split the grown to coordinates into their x and y components so they</span>
    <span class="token comment">// can be serialized</span>
    <span class="token keyword">int</span> grownToSize <span class="token operator">=</span> grownTo<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    grownToXs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>grownToSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
    grownToYs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>grownToSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> grownToSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      grownToXs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> grownTo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      grownToYs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> grownTo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Reconstructs the grown to coordinates from their x and y components
   * @return coordinates of tiles the city should grow to
   */</span>
  <span class="token keyword">public</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Point2D<span class="token punctuation">></span></span> <span class="token function">getGrownTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> grownToSize <span class="token operator">=</span> grownToXs<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Point2D<span class="token punctuation">></span></span> grownTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>grownToSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> grownToSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      grownTo<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Point2D</span><span class="token punctuation">(</span>grownToXs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> grownToYs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> grownTo<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/PacketCityRename.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token comment">/**
 * Packet emitted when a user requests the specified city should have a
 * different name. On receiving this packet, the name of the city should be
 * updated.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketCityRename</span> <span class="token keyword">extends</span> <span class="token class-name">PacketUpdate</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * X-coordinate of the city to rename
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Y-coordinate of the city to rename
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> y<span class="token punctuation">;</span>
  <span class="token comment">/**
   * New name the user has chosen for the city
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> String newName<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">PacketCityRename</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> String newName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>newName <span class="token operator">=</span> newName<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/PacketDamage.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token comment">/**
 * Packet emitted when a unit attacks another living thing (city or other unit).
 * On receiving this packet, the game should check if the attack is valid, and
 * then perform the attack.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketDamage</span> <span class="token keyword">extends</span> <span class="token class-name">PacketUpdate</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * X-coordinate of the attacking unit
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> attackerX<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Y-coordinate of the attacking unit
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> attackerY<span class="token punctuation">;</span>
  <span class="token comment">/**
   * X-coordinate of the target living thing (city or another unit)
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> targetX<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Y-coordinate of the target living thing (city or another unit)
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> targetY<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">PacketDamage</span><span class="token punctuation">(</span><span class="token keyword">int</span> attackerX<span class="token punctuation">,</span> <span class="token keyword">int</span> attackerY<span class="token punctuation">,</span> <span class="token keyword">int</span> targetX<span class="token punctuation">,</span> <span class="token keyword">int</span> targetY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>attackerX <span class="token operator">=</span> attackerX<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>attackerY <span class="token operator">=</span> attackerY<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>targetX <span class="token operator">=</span> targetX<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>targetY <span class="token operator">=</span> targetY<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/PacketGame.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>Game<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token comment">/**
 * Packet emitted a new user joins the game containing the current game state.
 * On receiving this packet, the game should load the state and initialise and
 * display the 3D game render.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketGame</span> <span class="token keyword">extends</span> <span class="token class-name">Packet</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Map containing the game state. See {@link Game#toMap()}.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> map<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">PacketGame</span><span class="token punctuation">(</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>map <span class="token operator">=</span> map<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/PacketInit.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token comment">/**
 * Packet emitted by the client requesting the game state. On receiving this
 * packet, the server should send a {@link PacketGame} containing the game
 * state.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketInit</span> <span class="token keyword">extends</span> <span class="token class-name">Packet</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/PacketPlayerChange.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token comment">/**
 * Packet emitted by the server when a new player joins the game. On receiving
 * this packet, the game should add this player to the list of players.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketPlayerChange</span> <span class="token keyword">extends</span> <span class="token class-name">Packet</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> String id<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">PacketPlayerChange</span><span class="token punctuation">(</span>String id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/PacketPlayerResearchRequest.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>techs<span class="token punctuation">.</span>Tech<span class="token punctuation">;</span>

<span class="token comment">/**
 * Packet emitted when a player starts to research a new tech. On receiving
 * this packet, the game should change the currently researching tech for the
 * player.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketPlayerResearchRequest</span> <span class="token keyword">extends</span> <span class="token class-name">PacketUpdate</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * ID of the player requesting the research change
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> String playerId<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Name of the tech to be researched (techs aren't serializable themselves so
   * they must be remade on receiving the packet)
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> String techName<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">PacketPlayerResearchRequest</span><span class="token punctuation">(</span>String playerId<span class="token punctuation">,</span> Tech tech<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>playerId <span class="token operator">=</span> playerId<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>techName <span class="token operator">=</span> tech<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the unserializable tech from the tech name
   *
   * @return tech specified by this packet
   */</span>
  <span class="token keyword">public</span> Tech <span class="token function">getTech</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Tech<span class="token punctuation">.</span><span class="token function">fromName</span><span class="token punctuation">(</span>techName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/PacketReady.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>Game<span class="token punctuation">;</span>

<span class="token comment">/**
 * Packet emitted by a client when a player marks themselves as ready or by the
 * server when all players have marked themselves as ready. On receiving this
 * packet on the server, the server should mark the player as ready and check
 * if all other players have done the same thing, moving the game onto the next
 * turn. On receiving this packet on the client, the turn should be handled.
 * See {@link Game#handleTurn(Game)}.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketReady</span> <span class="token keyword">extends</span> <span class="token class-name">Packet</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Whether the player is ready. Should always be true when sending from the
   * client, and false when sending from the server.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> ready<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">PacketReady</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> ready<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/PacketPurchaseTileRequest.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token comment">/**
 * Packet emitted when a player attempts to buy a tile. On receiving this
 * packet, the game should check if the player can purchase that tile and if
 * they can, bring the tile into the city's territory.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketPurchaseTileRequest</span> <span class="token keyword">extends</span> <span class="token class-name">PacketUpdate</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * X-coordinate of the city the player is trying to expand
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> cityX<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Y-coordinate of the city the player is trying to expand
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> cityY<span class="token punctuation">;</span>
  <span class="token comment">/**
   * X-coordinate of the tile the player is trying to purchase
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> purchaseX<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Y-coordinate of the tile the player is trying to purchase
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> purchaseY<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">PacketPurchaseTileRequest</span><span class="token punctuation">(</span>
    <span class="token keyword">int</span> cityX<span class="token punctuation">,</span>
    <span class="token keyword">int</span> cityY<span class="token punctuation">,</span>
    <span class="token keyword">int</span> purchaseX<span class="token punctuation">,</span>
    <span class="token keyword">int</span> purchaseY
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cityX <span class="token operator">=</span> cityX<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cityY <span class="token operator">=</span> cityY<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>purchaseX <span class="token operator">=</span> purchaseX<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>purchaseY <span class="token operator">=</span> purchaseY<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/PacketUnitCreate.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>UnitType<span class="token punctuation">;</span>

<span class="token comment">/**
 * Packet emitted when a player creates a unit (by building one in a city, or
 * by starting the game with some). On receiving this packet, the game should
 * create a unit belonging to the specified player with the specified type and
 * try to place it as close as possible to the target location.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketUnitCreate</span> <span class="token keyword">extends</span> <span class="token class-name">PacketUpdate</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * ID of the player to create the unit for
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> String id<span class="token punctuation">;</span>
  <span class="token comment">/**
   * X-coordinate of the tile to place the unit close to
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Y-coordinate of the tile to place the unit close to
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> y<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Type of unit to create (unit type's aren't serializable so only the name
   * is stored)
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> String unitType<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">PacketUnitCreate</span><span class="token punctuation">(</span>String id<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> UnitType unitType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>unitType <span class="token operator">=</span> unitType<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Finds the unit type specified by the name is this packet
   *
   * @return the unit type specified by this packet
   */</span>
  <span class="token keyword">public</span> UnitType <span class="token function">getUnitType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> UnitType<span class="token punctuation">.</span><span class="token function">fromName</span><span class="token punctuation">(</span>unitType<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/PacketUnitMove.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token comment">/**
 * Packet emitted when a selected unit is moved across the map. On receiving
 * this packet, the unit should be moved and the used movement points should be
 * deducted from the units remaining count.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketUnitMove</span> <span class="token keyword">extends</span> <span class="token class-name">PacketUpdate</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * X-coordinate of the unit's current tile
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> startX<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Y-coordinate of the unit's current tile
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> startY<span class="token punctuation">;</span>
  <span class="token comment">/**
   * X-coordinate of the target tile
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> endX<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Y-coordinate of the target tile
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> endY<span class="token punctuation">;</span>
  <span class="token comment">/**
   * How many movement points should be consumed by moving. Depends on the path
   * taken.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> usedMovementPoints<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">PacketUnitMove</span><span class="token punctuation">(</span>
    <span class="token keyword">int</span> startX<span class="token punctuation">,</span>
    <span class="token keyword">int</span> startY<span class="token punctuation">,</span>
    <span class="token keyword">int</span> endX<span class="token punctuation">,</span>
    <span class="token keyword">int</span> endY<span class="token punctuation">,</span>
    <span class="token keyword">int</span> usedMovementPoints
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>startX <span class="token operator">=</span> startX<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>startY <span class="token operator">=</span> startY<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>endX <span class="token operator">=</span> endX<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>endY <span class="token operator">=</span> endY<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>usedMovementPoints <span class="token operator">=</span> usedMovementPoints<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/PacketUnitDelete.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token comment">/**
 * Packet emitted when a unit should be removed from the game for some reason
 * (settler settling, unit death, etc). On receiving this packet, the unit at
 * the specified coordinate should be removed from the game.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketUnitDelete</span> <span class="token keyword">extends</span> <span class="token class-name">PacketUpdate</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * X-coordinate of the tile containing the unit to be removed
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Y-coordinate of the tile containing the unit to be removed
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> y<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">PacketUnitDelete</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/PacketUnitUpgrade.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token comment">/**
 * Packet emitted when a user requests that a unit be upgraded to an improved
 * type. On receiving this packet, the game should upgrade the unit type, and
 * proportionally set the health of the unit (see
 * {@link com.mrbbot.civilisation.logic.Living#setBaseHealth(int)}).
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketUnitUpgrade</span> <span class="token keyword">extends</span> <span class="token class-name">PacketUpdate</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * X-coordinate of tile containing unit to upgrade
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Y-coordinate of tile containing unit to upgrade
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> y<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">PacketUnitUpgrade</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/PacketUpdate.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token comment">/**
 * Abstract class extending Packet that describes a packet containing
 * information relating to game state. On receiving these types of packets, the
 * server should send them to all connected clients but the sender as they will
 * be handled locally there.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">PacketUpdate</span> <span class="token keyword">extends</span> <span class="token class-name">Packet</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/net/packet/PacketWorkerImproveRequest.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>net<span class="token punctuation">.</span>packet<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Improvement<span class="token punctuation">;</span>

<span class="token comment">/**
 * Packet emitted when a player requests that a worker improve a tile. On
 * receiving this packet, the game should set the workers current build project
 * to the specified one.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketWorkerImproveRequest</span> <span class="token keyword">extends</span> <span class="token class-name">PacketUpdate</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * X-coordinate of the tile containing the worker where the improvement
   * should built
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Y-coordinate of the tile containing the worker where the improvement
   * should built
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> y<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Name of the improvement to be built (improvements aren't serializable so
   * only the name is stored)
   */</span>
  <span class="token keyword">private</span> String improvementName<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">PacketWorkerImproveRequest</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> Improvement improvement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>improvementName <span class="token operator">=</span> improvement<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Finds the improvement from the name contained in the packet
   *
   * @return improvement specified by this packet
   */</span>
  <span class="token keyword">public</span> Improvement <span class="token function">getImprovement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Improvement<span class="token punctuation">.</span><span class="token function">fromName</span><span class="token punctuation">(</span>improvementName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/logic/map/tile/Building.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>CityBuildable<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>Game<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>game<span class="token punctuation">.</span>BadgeType<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span>

<span class="token comment">/**
 * Class representing a building that can be built within a city. Declared
 * abstract as buildings must implement {@link Building#setDetails()} to
 * register the abilities each building has.
 */</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"WeakerAccess"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Building</span> <span class="token keyword">extends</span> <span class="token class-name">CityBuildable</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Base unlock ID for buildings. Used to identify buildings that can be
   * unlocked.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> BASE_UNLOCK_ID <span class="token operator">=</span> <span class="token number">0x30</span><span class="token punctuation">;</span>

  <span class="token comment">/*
   * START BUILDING DEFINITIONS
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Building WALL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Building</span><span class="token punctuation">(</span>
    <span class="token string">"Walls"</span><span class="token punctuation">,</span>
    <span class="token string">"Protect a city"</span><span class="token punctuation">,</span>
    <span class="token number">100</span><span class="token punctuation">,</span>
    BASE_UNLOCK_ID
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      baseHealthIncrease <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Building MONUMENT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Building</span><span class="token punctuation">(</span>
    <span class="token string">"Monument"</span><span class="token punctuation">,</span>
    <span class="token string">"Reduces cost of expansion"</span><span class="token punctuation">,</span>
    <span class="token number">100</span><span class="token punctuation">,</span>
    BASE_UNLOCK_ID <span class="token operator">+</span> <span class="token number">1</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      goldPerTurnIncrease <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
      expansionCostMultiplier <span class="token operator">=</span> <span class="token number">0.75</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Building BANK <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Building</span><span class="token punctuation">(</span>
    <span class="token string">"Bank"</span><span class="token punctuation">,</span>
    <span class="token string">"Doubles a city's gold per turn"</span><span class="token punctuation">,</span>
    <span class="token number">150</span><span class="token punctuation">,</span>
    BASE_UNLOCK_ID <span class="token operator">+</span> <span class="token number">2</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      goldPerTurnMultiplier <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Building AMPHITHEATRE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Building</span><span class="token punctuation">(</span>
    <span class="token string">"Amphitheatre"</span><span class="token punctuation">,</span>
    <span class="token string">"Gives citizens a place to spend money"</span><span class="token punctuation">,</span>
    <span class="token number">150</span><span class="token punctuation">,</span>
    BASE_UNLOCK_ID <span class="token operator">+</span> <span class="token number">3</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      goldPerTurnIncrease <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Building SCHOOL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Building</span><span class="token punctuation">(</span>
    <span class="token string">"School"</span><span class="token punctuation">,</span>
    <span class="token string">"Educates citizens"</span><span class="token punctuation">,</span>
    <span class="token number">100</span><span class="token punctuation">,</span>
    BASE_UNLOCK_ID <span class="token operator">+</span> <span class="token number">4</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sciencePerTurnIncrease <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Building UNIVERSITY <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Building</span><span class="token punctuation">(</span>
    <span class="token string">"University"</span><span class="token punctuation">,</span>
    <span class="token string">"Must have a school in every city."</span><span class="token punctuation">,</span>
    <span class="token number">200</span><span class="token punctuation">,</span>
    BASE_UNLOCK_ID <span class="token operator">+</span> <span class="token number">5</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sciencePerTurnMultiplier <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">canBuildGivenCities</span><span class="token punctuation">(</span>City city<span class="token punctuation">,</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>City<span class="token punctuation">></span></span> cities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Check if there is a reason why this can't be built already and return</span>
      <span class="token comment">// it if there is</span>
      String superReason <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">canBuildGivenCities</span><span class="token punctuation">(</span>city<span class="token punctuation">,</span> cities<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>superReason<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> superReason<span class="token punctuation">;</span>

      <span class="token comment">// Otherwise check all other cities contain a school</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>City otherCity <span class="token operator">:</span> cities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>otherCity<span class="token punctuation">.</span>buildings<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>SCHOOL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token string">"You must have a school in all of your cities!"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// If they do, return an empty string indicating this building can be</span>
      <span class="token comment">// built</span>
      <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Building FACTORY <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Building</span><span class="token punctuation">(</span>
    <span class="token string">"Factory"</span><span class="token punctuation">,</span>
    <span class="token string">"Increases cities production"</span><span class="token punctuation">,</span>
    <span class="token number">200</span><span class="token punctuation">,</span>
    BASE_UNLOCK_ID <span class="token operator">+</span> <span class="token number">6</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      productionPerTurnMultiplier <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Building POWER_STATION <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Building</span><span class="token punctuation">(</span>
    <span class="token string">"Power Station"</span><span class="token punctuation">,</span>
    <span class="token string">"Increases cities production"</span><span class="token punctuation">,</span>
    <span class="token number">400</span><span class="token punctuation">,</span>
    BASE_UNLOCK_ID <span class="token operator">+</span> <span class="token number">7</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      productionPerTurnMultiplier <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Building SUPERMARKET <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Building</span><span class="token punctuation">(</span>
    <span class="token string">"Supermarket"</span><span class="token punctuation">,</span>
    <span class="token string">"Gives citizens a place to get food"</span><span class="token punctuation">,</span>
    <span class="token number">300</span><span class="token punctuation">,</span>
    BASE_UNLOCK_ID <span class="token operator">+</span> <span class="token number">8</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      goldPerTurnIncrease <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
      foodPerTurnMultiplier <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">/*
   * END BUILDING DEFINITIONS
   */</span>

  <span class="token comment">/**
   * Array containing all defined buildings.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Building<span class="token punctuation">[</span><span class="token punctuation">]</span> VALUES <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Building</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
    WALL<span class="token punctuation">,</span>
    MONUMENT<span class="token punctuation">,</span>
    BANK<span class="token punctuation">,</span>
    AMPHITHEATRE<span class="token punctuation">,</span>
    SCHOOL<span class="token punctuation">,</span>
    UNIVERSITY<span class="token punctuation">,</span>
    FACTORY<span class="token punctuation">,</span>
    POWER_STATION<span class="token punctuation">,</span>
    SUPERMARKET
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Function to get a building from just its name
   *
   * @param name name of building to get
   * @return the building with the specified name or null if the building
   * doesn't exist
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Building <span class="token function">fromName</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Iterates through all the buildings...</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Building value <span class="token operator">:</span> VALUES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Checking if the names match</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Increase in gold per turn for a city containing this building
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> goldPerTurnIncrease <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Increase in science per turn for a city containing this building
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> sciencePerTurnIncrease <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Increase in base health for a city containing this building
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> baseHealthIncrease <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Gold per turn multiplier for a city containing the building
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">double</span> goldPerTurnMultiplier <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Expansion cost multiplier for a city containing the building
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">double</span> expansionCostMultiplier <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Science per turn multiplier for a city containing the building
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">double</span> sciencePerTurnMultiplier <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Production per turn multiplier for a city containing the building
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">double</span> productionPerTurnMultiplier <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Food per turn multiplier for a city containing the building
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">double</span> foodPerTurnMultiplier <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token function">Building</span><span class="token punctuation">(</span>
    String name<span class="token punctuation">,</span>
    String description<span class="token punctuation">,</span>
    <span class="token keyword">int</span> productionCost<span class="token punctuation">,</span>
    <span class="token keyword">int</span> unlockId
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Pass required values to CityBuildable constructor</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> description<span class="token punctuation">,</span> productionCost<span class="token punctuation">,</span> unlockId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Called by the constructor to set the increases/multipliers this building
   * provides for the city it's built in
   */</span>
  <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Get the text to be displayed in the city production list for a resource
   * that may have an increase and/or a multiplier
   *
   * @param increase   increase in resource this building provides
   * @param multiplier multiplier in resource this building provides
   * @return text to be displayed in the city production list, example "7 (x3)"
   */</span>
  <span class="token keyword">private</span> String <span class="token function">getDetailTextForIncreaseWithMultiplier</span><span class="token punctuation">(</span>
    <span class="token keyword">int</span> increase<span class="token punctuation">,</span>
    <span class="token keyword">double</span> multiplier
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    StringBuilder text <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// If there is an increase, add it to the text</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>increase <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> text<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>increase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// If there is a multiplier...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>multiplier <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Determine whether there was an increase</span>
      <span class="token keyword">boolean</span> increased <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token comment">// If there was, add a space and a bracket</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>increased<span class="token punctuation">)</span> text<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" ("</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Even if there wasn't add the multiplier</span>
      text<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> multiplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Add the closing bracket if required</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>increased<span class="token punctuation">)</span> text<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the details to be displayed in the city production list for this
   * building
   *
   * @return details to be displayed
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Detail<span class="token punctuation">></span></span> <span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get the details required for all CityBuildables (production/gold cost)</span>
    ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Detail<span class="token punctuation">></span></span> details <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add the gold increase/multiplier (if there is one)</span>
    String goldText <span class="token operator">=</span> <span class="token function">getDetailTextForIncreaseWithMultiplier</span><span class="token punctuation">(</span>
      goldPerTurnIncrease<span class="token punctuation">,</span> goldPerTurnMultiplier
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>goldText<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
      details<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Detail</span><span class="token punctuation">(</span>BadgeType<span class="token punctuation">.</span>GOLD<span class="token punctuation">,</span> goldText<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add the science increase/multiplier (if there is one)</span>
    String scienceText <span class="token operator">=</span> <span class="token function">getDetailTextForIncreaseWithMultiplier</span><span class="token punctuation">(</span>
      sciencePerTurnIncrease<span class="token punctuation">,</span> sciencePerTurnMultiplier
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>scienceText<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
      details<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Detail</span><span class="token punctuation">(</span>BadgeType<span class="token punctuation">.</span>SCIENCE<span class="token punctuation">,</span> scienceText<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add the production multiplier (if there is one)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>productionPerTurnMultiplier <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      details<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Detail</span><span class="token punctuation">(</span>
        BadgeType<span class="token punctuation">.</span>PRODUCTION<span class="token punctuation">,</span>
        String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"x%d"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> productionPerTurnMultiplier<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Add the science base health increase (if there is one)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>baseHealthIncrease <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      details<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Detail</span><span class="token punctuation">(</span>BadgeType<span class="token punctuation">.</span>HEALTH<span class="token punctuation">,</span> baseHealthIncrease<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> details<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Determine if a building can be built in a city given the player's other
   * cities
   *
   * @param city   target city to build in
   * @param cities player's other cities
   * @return reason why the building cannot be built, or an empty string if it
   * can
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> String <span class="token function">canBuildGivenCities</span><span class="token punctuation">(</span>City city<span class="token punctuation">,</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>City<span class="token punctuation">></span></span> cities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> city<span class="token punctuation">.</span>buildings<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token operator">?</span> <span class="token string">"You can only have one of these buildings per city"</span>
      <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Build the building in the specified city
   *
   * @param city city to build in
   * @param game game the city is contained within
   * @return tile to update the render of
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> Tile <span class="token function">build</span><span class="token punctuation">(</span>City city<span class="token punctuation">,</span> Game game<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Add this building to the city</span>
    city<span class="token punctuation">.</span>buildings<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Return the city center for re-rendering</span>
    <span class="token keyword">return</span> city<span class="token punctuation">.</span><span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/logic/map/tile/City.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>HexagonGrid<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>CityBuildable<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>Living<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>Player<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>Game<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>Unit<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Point2D<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>Collectors<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">City</span> <span class="token keyword">extends</span> <span class="token class-name">Living</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Hexagon grid the city is contained within
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> HexagonGrid<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> grid<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Player the city is owned by
   */</span>
  <span class="token keyword">public</span> Player player<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Colour of the walls of the city
   */</span>
  <span class="token keyword">public</span> Color wallColour<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Colour of the wall joins of the city
   */</span>
  <span class="token keyword">public</span> Color joinColour<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Tiles that the city owns
   */</span>
  <span class="token keyword">public</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> tiles<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Height of the tile with the greatest height
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">double</span> greatestTileHeight<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Buildings the city has
   */</span>
  <span class="token keyword">public</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Building<span class="token punctuation">></span></span> buildings<span class="token punctuation">;</span>
  <span class="token comment">/**
   * What the city is currently building
   */</span>
  <span class="token keyword">public</span> CityBuildable currentlyBuilding<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The current production total in the city. When this value reaches the
   * currentlyBuilding's cost it will be built.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> productionTotal<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The number of citizens within the city. Used to calculated gold/science
   * per turn.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> citizens<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The amount of excess food the city has. Controls when the city
   * grows/starves.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> excessFoodCounter<span class="token punctuation">;</span>

  <span class="token comment">/**
   * The last unit that attacked this city. Used to control who to give the
   * city to if its health reaches 0.
   */</span>
  <span class="token keyword">public</span> Unit lastAttacker<span class="token punctuation">;</span>

  <span class="token comment">/**
   * The name of the city. Can be edited by the player.
   */</span>
  <span class="token keyword">public</span> String name<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Constructor for a new city
   *
   * @param grid    hexagon grid for the game
   * @param centerX the center x-coordinate of the city
   * @param centerY the center y-coordinate of the city
   * @param player  the player who owns this city
   */</span>
  <span class="token keyword">public</span> <span class="token function">City</span><span class="token punctuation">(</span>HexagonGrid<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> grid<span class="token punctuation">,</span> <span class="token keyword">int</span> centerX<span class="token punctuation">,</span> <span class="token keyword">int</span> centerY<span class="token punctuation">,</span> Player player<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Pass required parameters to base living class</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Store passed values</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>grid <span class="token operator">=</span> grid<span class="token punctuation">;</span>
    <span class="token function">setOwner</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"City"</span><span class="token punctuation">;</span>

    <span class="token comment">// Create empty list for tiles</span>
    tiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get center and check it doesn't already have a city</span>
    Tile center <span class="token operator">=</span> grid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>centerX<span class="token punctuation">,</span> centerY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>center<span class="token punctuation">.</span>city <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
        <span class="token string">"City created on tile with another city"</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    tiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>center<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Make the center of the city a capital</span>
    center<span class="token punctuation">.</span>improvement <span class="token operator">=</span> Improvement<span class="token punctuation">.</span>CAPITAL<span class="token punctuation">;</span>

    <span class="token comment">// Add all of the adjacent tiles that don't already have a city</span>
    ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> adjacentTiles <span class="token operator">=</span> grid<span class="token punctuation">.</span><span class="token function">getNeighbours</span><span class="token punctuation">(</span>
      centerX<span class="token punctuation">,</span> centerY<span class="token punctuation">,</span>
      <span class="token boolean">false</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    adjacentTiles<span class="token punctuation">.</span><span class="token function">removeIf</span><span class="token punctuation">(</span>tile <span class="token operator">-</span><span class="token operator">></span> tile<span class="token punctuation">.</span>city <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tiles<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>adjacentTiles<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Mark all of the cities tiles as belonging to this city</span>
    tiles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>tile <span class="token operator">-</span><span class="token operator">></span> tile<span class="token punctuation">.</span>city <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Calculate the greatest height of all the tiles</span>
    <span class="token function">updateGreatestHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create empty list for buildings</span>
    buildings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Reset totals</span>
    productionTotal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    citizens <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    excessFoodCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Constructor for a city loaded from a Map (could be from a file/server)
   *
   * @param grid hexagon grid for the game
   * @param map  map containing city data
   */</span>
  <span class="token keyword">public</span> <span class="token function">City</span><span class="token punctuation">(</span>HexagonGrid<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> grid<span class="token punctuation">,</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Pass required parameters to base living class</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"baseHealth"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"health"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Store passed values</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>grid <span class="token operator">=</span> grid<span class="token punctuation">;</span>

    <span class="token comment">// Load the city owner</span>
    <span class="token function">setOwner</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Player</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"owner"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Load the tiles belonging to the city</span>
    <span class="token comment">//noinspection unchecked</span>
    tiles <span class="token operator">=</span> <span class="token punctuation">(</span>ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span><span class="token operator">></span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"tiles"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>m <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment">// Get the tile with the specified coordinates</span>
        <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> m<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> m<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"y"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Tile center <span class="token operator">=</span> grid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Load the tile's improvement if there is one</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"improvement"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//noinspection unchecked</span>
          Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> improvement <span class="token operator">=</span>
            <span class="token punctuation">(</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span><span class="token punctuation">)</span> m<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"improvement"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          center<span class="token punctuation">.</span>improvement <span class="token operator">=</span>
            Improvement<span class="token punctuation">.</span><span class="token function">fromName</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span> improvement<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//noinspection unchecked</span>
          center<span class="token punctuation">.</span>improvementMetadata <span class="token operator">=</span>
            <span class="token punctuation">(</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span><span class="token punctuation">)</span> improvement<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"meta"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// Otherwise set the improvement to none</span>
          center<span class="token punctuation">.</span>improvement <span class="token operator">=</span> Improvement<span class="token punctuation">.</span>NONE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> center<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Mark the tiles as belonging to this city</span>
    tiles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>tile <span class="token operator">-</span><span class="token operator">></span> tile<span class="token punctuation">.</span>city <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Load the buildings the city has</span>
    <span class="token comment">//noinspection unchecked</span>
    buildings <span class="token operator">=</span> <span class="token punctuation">(</span>ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Building<span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>List<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"buildings"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Building<span class="token operator">:</span><span class="token operator">:</span>fromName<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Load the current build of the city if there is one</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"currentlyBuilding"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentlyBuilding <span class="token operator">=</span>
        CityBuildable<span class="token punctuation">.</span><span class="token function">fromName</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"currentlyBuilding"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Load totals from the map</span>
    productionTotal <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"productionTotal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    citizens <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"citizens"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    excessFoodCounter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"excessFood"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Load the city name</span>
    name <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Calculate the greatest height of all the tiles belonging to the city</span>
    <span class="token function">updateGreatestHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Grow the city by the specified number of nearby tiles
   *
   * @param newTiles number of tiles to grow
   * @return the points of the tiles the city grew too
   */</span>
  <span class="token keyword">public</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Point2D<span class="token punctuation">></span></span> <span class="token function">grow</span><span class="token punctuation">(</span><span class="token keyword">int</span> newTiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Point2D<span class="token punctuation">></span></span> grownTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get the center coordinate of the city</span>
    <span class="token keyword">final</span> Point2D center <span class="token operator">=</span> <span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHexagon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create a new queue to pull potential tiles from that sorts tiles by</span>
    <span class="token comment">// their distance from the center</span>
    PriorityQueue<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> potentialTiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriorityQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">double</span> aDist <span class="token operator">=</span> center<span class="token punctuation">.</span><span class="token function">distance</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getHexagon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">double</span> bDist <span class="token operator">=</span> center<span class="token punctuation">.</span><span class="token function">distance</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">getHexagon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Double<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>aDist<span class="token punctuation">,</span> bDist<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add all adjacent tiles that don't have a city to the potential tile list</span>
    tiles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>tile <span class="token operator">-</span><span class="token operator">></span> potentialTiles<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>
      grid<span class="token punctuation">.</span><span class="token function">getNeighbours</span><span class="token punctuation">(</span>tile<span class="token punctuation">.</span>x<span class="token punctuation">,</span> tile<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>adjTile <span class="token operator">-</span><span class="token operator">></span> adjTile<span class="token punctuation">.</span>city <span class="token operator">==</span> null<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Keep picking tiles from the queue until the specified number of tiles</span>
    <span class="token comment">// have been picked</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>newTiles <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> potentialTiles<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> newTiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Get the next tile</span>
      Tile tile <span class="token operator">=</span> potentialTiles<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Mark it as belonging to this city and add it</span>
      tile<span class="token punctuation">.</span>city <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      tiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tile<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Add the grown coordinate to the list of tiles</span>
      grownTo<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Point2D</span><span class="token punctuation">(</span>tile<span class="token punctuation">.</span>x<span class="token punctuation">,</span> tile<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      newTiles<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Calculate the new greatest height</span>
    <span class="token function">updateGreatestHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Return the list of grown to coordinates</span>
    <span class="token keyword">return</span> grownTo<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Grow the city to the tiles pointed to by the points list
   *
   * @param points list of coordinates of tiles to grow to
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">growTo</span><span class="token punctuation">(</span>ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Point2D<span class="token punctuation">></span></span> points<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Point2D point <span class="token operator">:</span> points<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Get the tile represented by the point</span>
      Tile tile <span class="token operator">=</span> grid<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> point<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> point<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Mark it as belonging to this city and add it</span>
      tile<span class="token punctuation">.</span>city <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      tiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Calculate the new greatest height</span>
    <span class="token function">updateGreatestHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Get the directions from the center that should have walls (that is,
   * adjacent directions that don't belong to the
   * city)
   *
   * @param tile tile to get walls from
   * @return boolean array of whether the tile should have walls in that
   * direction
   */</span>
  <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getWalls</span><span class="token punctuation">(</span>Tile tile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If this tile isn't part of the city, return an "empty" array</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tiles<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>tile<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// Alias the x and y coordinates</span>
    <span class="token keyword">int</span> x <span class="token operator">=</span> tile<span class="token punctuation">.</span>x<span class="token punctuation">,</span> y <span class="token operator">=</span> tile<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token comment">// Return the array for all of the directions, checking if the tile in each</span>
    <span class="token comment">// direction belongs to this city.</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
      <span class="token operator">!</span>tiles<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>grid<span class="token punctuation">.</span><span class="token function">getTopLeft</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token operator">!</span>tiles<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>grid<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token operator">!</span>tiles<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>grid<span class="token punctuation">.</span><span class="token function">getBottomLeft</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token operator">!</span>tiles<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>grid<span class="token punctuation">.</span><span class="token function">getBottomRight</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token operator">!</span>tiles<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>grid<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token operator">!</span>tiles<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>grid<span class="token punctuation">.</span><span class="token function">getTopRight</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Calculates the greatest height of a tile in the city, used for rendering
   * walls
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateGreatestHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    greatestTileHeight <span class="token operator">=</span> tiles<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Tile<span class="token operator">:</span><span class="token operator">:</span>getHeight<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>Double<span class="token operator">:</span><span class="token operator">:</span>compareTo<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Get the center/capital of this city
   *
   * @return Tile representing the center
   */</span>
  <span class="token keyword">public</span> Tile <span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The tile is always the first element added to the tile list</span>
    <span class="token keyword">return</span> tiles<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the x-coordinate of the center
   *
   * @return x-coordinate of the center
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the y-coordinate of the center
   *
   * @return y-coordinate of the center
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Builds a Map containing all required information to rebuild the city
   *
   * @return Map containing city information
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> <span class="token function">toMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get details on the health of the city (from Living)</span>
    Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store tile information in the map</span>
    ArrayList<span class="token operator">&lt;</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span><span class="token operator">></span> tileMaps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Tile tile <span class="token operator">:</span> tiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> tileMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Store the coordinate</span>
      tileMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">,</span> tile<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
      tileMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"y"</span><span class="token punctuation">,</span> tile<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Store the improvement if there is one</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tile<span class="token punctuation">.</span>improvement <span class="token operator">!=</span> Improvement<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> improvementMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        improvementMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> tile<span class="token punctuation">.</span>improvement<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        improvementMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"meta"</span><span class="token punctuation">,</span> tile<span class="token punctuation">.</span>improvementMetadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tileMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"improvement"</span><span class="token punctuation">,</span> improvementMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      tileMaps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tileMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"tiles"</span><span class="token punctuation">,</span> tileMaps<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store the city owner</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"owner"</span><span class="token punctuation">,</span> player<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store the city's buildings</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"buildings"</span><span class="token punctuation">,</span> buildings<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>CityBuildable<span class="token operator">:</span><span class="token operator">:</span>getName<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store the current building project if there is one</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentlyBuilding <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"currentlyBuilding"</span><span class="token punctuation">,</span> currentlyBuilding<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Store the totals</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"productionTotal"</span><span class="token punctuation">,</span> productionTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"citizens"</span><span class="token punctuation">,</span> citizens<span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"excessFood"</span><span class="token punctuation">,</span> excessFoodCounter<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store the city name</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> map<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the production per turn produced by this city. Calculated from the
   * number of citizens, buildings with production bonuses, and tile
   * improvements owned by the city.
   *
   * @return city's production per turn
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getProductionPerTurn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Calculate the base production per turn from the citizen count</span>
    <span class="token keyword">int</span> productionPerTurn <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> citizens<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Add all tile improvements to the production counter</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Tile tile <span class="token operator">:</span> tiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tile<span class="token punctuation">.</span>improvement <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        productionPerTurn <span class="token operator">+=</span> tile<span class="token punctuation">.</span>improvement<span class="token punctuation">.</span>productionPerTurn<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Multiply the counter by all buildings with production multipliers</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Building building <span class="token operator">:</span> buildings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      productionPerTurn <span class="token operator">*=</span> building<span class="token punctuation">.</span>productionPerTurnMultiplier<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> productionPerTurn<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the science per turn produced by this city. Calculated from the
   * number of citizens and buildings with science bonuses.
   *
   * @return city's science per turn
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSciencePerTurn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Calculate the base science per turn from the citizen count</span>
    <span class="token keyword">int</span> sciencePerTurn <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> citizens<span class="token punctuation">;</span>
    <span class="token comment">// Initialise the multiplier</span>
    <span class="token keyword">double</span> multiplier <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Building building <span class="token operator">:</span> buildings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Add to the total science per turn</span>
      sciencePerTurn <span class="token operator">+=</span> building<span class="token punctuation">.</span>sciencePerTurnIncrease<span class="token punctuation">;</span>
      multiplier <span class="token operator">*=</span> building<span class="token punctuation">.</span>sciencePerTurnMultiplier<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Apply the multiplier after all increases have been added</span>
    sciencePerTurn <span class="token operator">*=</span> multiplier<span class="token punctuation">;</span>
    <span class="token keyword">return</span> sciencePerTurn<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the gold per turn provided by this city. Calculated from the number
   * of citizens and buildings with gold bonuses.
   *
   * @return city's gold per turn
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getGoldPerTurn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Calculate the base gold per turn from the citizen count</span>
    <span class="token keyword">int</span> goldPerTurn <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> citizens<span class="token punctuation">;</span>
    <span class="token comment">// Initialise the multiplier</span>
    <span class="token keyword">double</span> multiplier <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Building building <span class="token operator">:</span> buildings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Add to the total gold per turn</span>
      goldPerTurn <span class="token operator">+=</span> building<span class="token punctuation">.</span>goldPerTurnIncrease<span class="token punctuation">;</span>
      multiplier <span class="token operator">*=</span> building<span class="token punctuation">.</span>goldPerTurnMultiplier<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Apply the multiplier after all increases have been added</span>
    goldPerTurn <span class="token operator">*=</span> multiplier<span class="token punctuation">;</span>
    <span class="token keyword">return</span> goldPerTurn<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the food per turn for this city. Calculated from the number of
   * citizens and buildings and tiles with food bonuses.
   *
   * @return city's food per turn
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getFoodPerTurn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Start with 5 base food per turn and subtract the number of citizens from</span>
    <span class="token comment">// this</span>
    <span class="token keyword">int</span> foodPerTurn <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">-</span> citizens<span class="token punctuation">;</span>
    <span class="token comment">// Apply tile bonuses</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Tile tile <span class="token operator">:</span> tiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tile<span class="token punctuation">.</span>improvement <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        foodPerTurn <span class="token operator">+=</span> tile<span class="token punctuation">.</span>improvement<span class="token punctuation">.</span>foodPerTurn<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Apply building multipliers</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Building building <span class="token operator">:</span> buildings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      foodPerTurn <span class="token operator">*=</span> building<span class="token punctuation">.</span>foodPerTurnMultiplier<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> foodPerTurn<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Handle a city's per turn operations
   *
   * @param game game object containing this city
   * @return tiles that have been updated this turn
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> Tile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handleTurn</span><span class="token punctuation">(</span>Game game<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> updatedTiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get totals for resources</span>
    <span class="token keyword">int</span> productionPerTurn <span class="token operator">=</span> <span class="token function">getProductionPerTurn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> sciencePerTurn <span class="token operator">=</span> <span class="token function">getSciencePerTurn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> goldPerTurn <span class="token operator">=</span> <span class="token function">getGoldPerTurn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> foodPerTurn <span class="token operator">=</span> <span class="token function">getFoodPerTurn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add the production total and check if the currently building thing can</span>
    <span class="token comment">// now be built</span>
    productionTotal <span class="token operator">+=</span> productionPerTurn<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      currentlyBuilding <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span>
        currentlyBuilding<span class="token punctuation">.</span><span class="token function">canBuildWithProduction</span><span class="token punctuation">(</span>productionTotal<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If it can build it</span>
      updatedTiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>currentlyBuilding<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> game<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Remove the cost from the total</span>
      productionTotal <span class="token operator">-=</span> currentlyBuilding<span class="token punctuation">.</span><span class="token function">getProductionCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Reset the currently building item</span>
      currentlyBuilding <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Add/subtract food to the counter</span>
    excessFoodCounter <span class="token operator">+=</span> foodPerTurn<span class="token punctuation">;</span>
    <span class="token comment">// Calculate growth/starvation values</span>
    <span class="token keyword">double</span> starvationValue <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">1.25</span><span class="token punctuation">,</span> citizens <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> growthValue <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">1.25</span><span class="token punctuation">,</span> citizens<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Check if the city should grow/starve</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>citizens <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> excessFoodCounter <span class="token operator">&lt;</span> starvationValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      citizens<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>excessFoodCounter <span class="token operator">></span> growthValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      citizens<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token comment">// If growing, grow the city by an extra tile and mark the grown tiles</span>
      <span class="token comment">// for updating</span>
      <span class="token function">grow</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      updatedTiles<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>tiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Increase global player science/gold counts by the counts for this city</span>
    game<span class="token punctuation">.</span><span class="token function">increasePlayerScienceBy</span><span class="token punctuation">(</span>player<span class="token punctuation">.</span>id<span class="token punctuation">,</span> sciencePerTurn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    game<span class="token punctuation">.</span><span class="token function">increasePlayerGoldBy</span><span class="token punctuation">(</span>player<span class="token punctuation">.</span>id<span class="token punctuation">,</span> goldPerTurn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Return all the tiles updated this turn</span>
    <span class="token keyword">return</span> updatedTiles<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Tile</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Handle when a unit attacks this city
   *
   * @param attacker unit that is attacking
   * @param ranged   whether the unit performed a ranged attack
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAttacked</span><span class="token punctuation">(</span>Unit attacker<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ranged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Mark the attack as the last attacker to this city</span>
    lastAttacker <span class="token operator">=</span> attacker<span class="token punctuation">;</span>
    <span class="token comment">// Damage the city the correct amount</span>
    <span class="token function">damage</span><span class="token punctuation">(</span>attacker<span class="token punctuation">.</span>unitType<span class="token punctuation">.</span><span class="token function">getAttackStrength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// If this wasn't a ranged attack, damage the attacker too</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ranged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      attacker<span class="token punctuation">.</span><span class="token function">damage</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>attacker<span class="token punctuation">.</span><span class="token function">getHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the owner of this city
   *
   * @return owner of this city
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> Player <span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> player<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the owner of this city, updating the wall and join colours
   *
   * @param player new owner of this city
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOwner</span><span class="token punctuation">(</span>Player player<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>player <span class="token operator">=</span> player<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>wallColour <span class="token operator">=</span> player<span class="token punctuation">.</span><span class="token function">getColour</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>joinColour <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wallColour<span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the position of the city center relative to the origin
   *
   * @return position of the city center
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> Point2D <span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHexagon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Determines if two cities are in the same position
   *
   * @param c other city to check
   * @return if the city centers are equal
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">sameCenterAs</span><span class="token punctuation">(</span>City c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">samePositionAs</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/logic/map/tile/Level.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">;</span>

<span class="token comment">/**
 * Enum for level types for tiles. Used to determine which colour to use to
 * render a tile.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> Level <span class="token punctuation">{</span>
  <span class="token function">MOUNTAIN</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">PLAIN</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">BEACH</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">OCEAN</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Movement cost of traversing this type of tile.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> cost<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The minimum height for this type of tile
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">double</span> minHeight<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The maximum height for this type of tile
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">double</span> maxHeight<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Whether this type of tile should always have the maximum height (only used
   * to maintain constant water height)
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> fixToMax<span class="token punctuation">;</span>

  <span class="token function">Level</span><span class="token punctuation">(</span><span class="token keyword">int</span> cost<span class="token punctuation">,</span> <span class="token keyword">double</span> minHeight<span class="token punctuation">,</span> <span class="token keyword">double</span> maxHeight<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fixToMax<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cost <span class="token operator">=</span> cost<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>minHeight <span class="token operator">=</span> minHeight<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>maxHeight <span class="token operator">=</span> maxHeight<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fixToMax <span class="token operator">=</span> fixToMax<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the height associated with the specified height
   *
   * @param height height to check
   * @return level associated with the specified height
   */</span>
  <span class="token keyword">static</span> Level <span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">double</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get all possible levels</span>
    Level<span class="token punctuation">[</span><span class="token punctuation">]</span> levels <span class="token operator">=</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Check if the height exceeds the minimum and if it does, return that</span>
    <span class="token comment">// level</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Level level <span class="token operator">:</span> levels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>height <span class="token operator">></span> level<span class="token punctuation">.</span>minHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> level<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> levels<span class="token punctuation">[</span>levels<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/logic/map/tile/Improvement.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>techs<span class="token punctuation">.</span>Unlockable<span class="token punctuation">;</span>

<span class="token comment">/**
 * Class representing an improvement that can be built within a cities bounds.
 * Most of these are built by workers.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Improvement</span> <span class="token keyword">implements</span> <span class="token class-name">Unlockable</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Base unlock ID for improvements. Used to identify improvements that can be
   * unlocked.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> BASE_UNLOCK_ID <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>

  <span class="token comment">/*
   * START IMPROVEMENT DEFINITIONS
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Improvement NONE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Improvement</span><span class="token punctuation">(</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token string">"None"</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Improvement CAPITAL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Improvement</span><span class="token punctuation">(</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token string">"Capital"</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Improvement TREE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Improvement</span><span class="token punctuation">(</span>
    <span class="token number">0x00</span><span class="token punctuation">,</span>
    <span class="token string">"Tree"</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Improvement FARM <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Improvement</span><span class="token punctuation">(</span>
    BASE_UNLOCK_ID<span class="token punctuation">,</span>
    <span class="token string">"Farm"</span><span class="token punctuation">,</span>
    <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token boolean">true</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Improvement CHOP_FOREST <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Improvement</span><span class="token punctuation">(</span>
    BASE_UNLOCK_ID <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string">"Chop Forest"</span><span class="token punctuation">,</span>
    <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Improvement MINE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Improvement</span><span class="token punctuation">(</span>
    BASE_UNLOCK_ID <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token string">"Mine"</span><span class="token punctuation">,</span>
    <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">15</span><span class="token punctuation">,</span>
    <span class="token boolean">true</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Improvement PASTURE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Improvement</span><span class="token punctuation">(</span>
    BASE_UNLOCK_ID <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token string">"Pasture"</span><span class="token punctuation">,</span>
    <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token boolean">true</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Improvement ROAD <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Improvement</span><span class="token punctuation">(</span>
    BASE_UNLOCK_ID <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token string">"Road"</span><span class="token punctuation">,</span>
    <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token boolean">true</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/*
   * END IMPROVEMENT DEFINITIONS
   */</span>

  <span class="token comment">/**
   * Array containing all defined improvements
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Improvement<span class="token punctuation">[</span><span class="token punctuation">]</span> VALUES <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Improvement</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
    NONE<span class="token punctuation">,</span>
    CAPITAL<span class="token punctuation">,</span>
    TREE<span class="token punctuation">,</span>
    FARM<span class="token punctuation">,</span>
    CHOP_FOREST<span class="token punctuation">,</span>
    MINE<span class="token punctuation">,</span>
    PASTURE<span class="token punctuation">,</span>
    ROAD
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Function to get an improvement from just its name
   *
   * @param name name of improvement to get
   * @return the improvement with the specified name or null if the improvement
   * doesn't exist
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Improvement <span class="token function">fromName</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Iterates through all the improvements...</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Improvement value <span class="token operator">:</span> VALUES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Check if the names match</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Unlock ID used to identify an unlockable improvement
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> unlockId<span class="token punctuation">;</span>
  <span class="token comment">/**
   * User friendly name of this improvement
   */</span>
  <span class="token keyword">public</span> String name<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Number of turns a worker unit takes to build this improvement
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> turnCost<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Food per turn increase for a city containing the improvement
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> foodPerTurn<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Production per turn increase for a city containing the improvement
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> productionPerTurn<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Whether a worker can build this improvement
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> workerCanDo<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token function">Improvement</span><span class="token punctuation">(</span>
    <span class="token keyword">int</span> unlockId<span class="token punctuation">,</span>
    String name<span class="token punctuation">,</span>
    <span class="token keyword">int</span> turnCost<span class="token punctuation">,</span>
    <span class="token keyword">int</span> foodPerTurn<span class="token punctuation">,</span>
    <span class="token keyword">int</span> productionPerTurn<span class="token punctuation">,</span>
    <span class="token keyword">boolean</span> workerCanDo
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>unlockId <span class="token operator">=</span> unlockId<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>turnCost <span class="token operator">=</span> turnCost<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>foodPerTurn <span class="token operator">=</span> foodPerTurn<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>productionPerTurn <span class="token operator">=</span> productionPerTurn<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>workerCanDo <span class="token operator">=</span> workerCanDo<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Improvement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Only check the names are equal, as these should be unique</span>
      <span class="token keyword">return</span> name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Improvement<span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the user friendly name of this improvement
   *
   * @return user friendly name of this improvement
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the unlock ID of this improvement
   *
   * @return unlock ID of this improvement
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getUnlockId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> unlockId<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/logic/map/tile/Tile.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Hexagon<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Traversable<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>unit<span class="token punctuation">.</span>Unit<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>map<span class="token punctuation">.</span>RenderTile<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token comment">/**
 * Class for a tile of the map. Stored in the game's hexagon grid.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Tile</span> <span class="token keyword">implements</span> <span class="token class-name">Traversable</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Hexagon this tile represents
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Hexagon hexagon<span class="token punctuation">;</span>
  <span class="token comment">/**
   * X-coordinate of this tile within the hexagon grid
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Y-coordinate of this tile within the hexagon grid
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> y<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Terrain object for this tile
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Terrain terrain<span class="token punctuation">;</span>
  <span class="token comment">/**
   * The city this tile is part of. May be null.
   */</span>
  <span class="token keyword">public</span> City city<span class="token punctuation">;</span>
  <span class="token comment">/**
   * This tiles improvement. Defaults to {@link Improvement#NONE}.
   */</span>
  <span class="token keyword">public</span> Improvement improvement<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Metadata associated with the improvement (angle, strip count, width).
   */</span>
  <span class="token keyword">public</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> improvementMetadata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Unit currently on the tile. May be null.
   */</span>
  <span class="token keyword">public</span> Unit unit<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Whether this tile is the currently selected tile.
   */</span>
  <span class="token annotation punctuation">@ClientOnly</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> selected <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Renderer for this tile. Only used by the client.
   */</span>
  <span class="token annotation punctuation">@ClientOnly</span>
  <span class="token keyword">public</span> RenderTile renderer<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Creates a new tile object for the specified coordinate
   *
   * @param hexagon hexagon the tile is part of
   * @param x       x-coordinate of the tile
   * @param y       y-coordinate of the tile
   */</span>
  <span class="token keyword">public</span> <span class="token function">Tile</span><span class="token punctuation">(</span>Hexagon hexagon<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hexagon <span class="token operator">=</span> hexagon<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>terrain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Terrain</span><span class="token punctuation">(</span>hexagon<span class="token punctuation">.</span><span class="token function">getCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Set the improvement to a tree if there is one</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>improvement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>terrain<span class="token punctuation">.</span>hasTree
      <span class="token operator">?</span> Improvement<span class="token punctuation">.</span>TREE
      <span class="token operator">:</span> Improvement<span class="token punctuation">.</span>NONE<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Creates a new tile object for the specified coordinates with a pre-set
   * height and tree state
   *
   * @param hexagon hexagon the tile is part of
   * @param x       x-coordinate of the tile
   * @param y       y-coordinate of the tile
   * @param height  height of the tile's terrain
   * @param hasTree whether the tile naturally has a tree
   */</span>
  <span class="token keyword">public</span> <span class="token function">Tile</span><span class="token punctuation">(</span>Hexagon hexagon<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">double</span> height<span class="token punctuation">,</span> <span class="token keyword">boolean</span> hasTree<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hexagon <span class="token operator">=</span> hexagon<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>terrain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Terrain</span><span class="token punctuation">(</span>height<span class="token punctuation">,</span> hasTree<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Set the improvement to a tree if there is one</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>improvement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>terrain<span class="token punctuation">.</span>hasTree
      <span class="token operator">?</span> Improvement<span class="token punctuation">.</span>TREE
      <span class="token operator">:</span> Improvement<span class="token punctuation">.</span>NONE<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the tiles hexagon
   *
   * @return hexagon attached to the tile
   */</span>
  <span class="token keyword">public</span> Hexagon <span class="token function">getHexagon</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> hexagon<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the city walls for this tile
   *
   * @return boolean array containing details on whether adjacent edges belong
   * to the same city
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getCityWalls</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span> city <span class="token operator">!=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">return</span> city<span class="token punctuation">.</span><span class="token function">getWalls</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the actual height of this tile
   *
   * @return terrain height mapped onto range [1, 3]
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>terrain<span class="token punctuation">.</span>height <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 1 &lt;= height &lt;= 3</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the x-coordinate of this tile
   *
   * @return x-coordinate of this tile
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> x<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the y-coordinate of this tile
   *
   * @return y-coordinate of this tile
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> y<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the terrain object associated with this tile
   *
   * @return terrain object associated with this tile
   */</span>
  <span class="token keyword">public</span> Terrain <span class="token function">getTerrain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> terrain<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Gets the cost of travelling over this tile. Returns the tile cost or 0 if
   * the tile has a road.
   *
   * @return cost of travelling over this tile
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">hasRoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> terrain<span class="token punctuation">.</span>level<span class="token punctuation">.</span>cost<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Checks whether a unit could actually traverse this tile
   *
   * @return traversability of this tile
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canTraverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Traversable if the level isn't an ocean or mountain, and if there isn't</span>
    <span class="token comment">// already a unit on the tile</span>
    <span class="token keyword">return</span> terrain<span class="token punctuation">.</span>level <span class="token operator">!=</span> Level<span class="token punctuation">.</span>OCEAN
      <span class="token operator">&amp;&amp;</span> terrain<span class="token punctuation">.</span>level <span class="token operator">!=</span> Level<span class="token punctuation">.</span>MOUNTAIN
      <span class="token operator">&amp;&amp;</span> unit <span class="token operator">==</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Checks whether another tile has the same position as this tile
   *
   * @param t other tile to check
   * @return whether the 2 tiles have the same position
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">samePositionAs</span><span class="token punctuation">(</span>Tile t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> x <span class="token operator">==</span> t<span class="token punctuation">.</span>x <span class="token operator">&amp;&amp;</span> y <span class="token operator">==</span> t<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Checks whether this tile has a road. Capitals have a road by default.
   *
   * @return whether this tile has a road
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasRoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Check if the improvement is a capital or an actual road</span>
    <span class="token keyword">return</span> improvement <span class="token operator">==</span> Improvement<span class="token punctuation">.</span>CAPITAL
      <span class="token operator">||</span> improvement <span class="token operator">==</span> Improvement<span class="token punctuation">.</span>ROAD<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Tile[x=%d, y=%d]"</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/render/map/improvement/RenderImprovement.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>map<span class="token punctuation">.</span>improvement<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Improvement<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Tile<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">.</span>RenderData<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>PhongMaterial<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>shape<span class="token punctuation">.</span>Box<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token comment">/**
 * Render object for a tile's improvement. All tiles have this object, but it
 * only contains other renders if the improvement isn't equal to
 * {@link Improvement#NONE}.
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RenderImprovement</span> <span class="token keyword">extends</span> <span class="token class-name">RenderData</span><span class="token generics function"><span class="token punctuation">&lt;</span>Improvement<span class="token punctuation">></span></span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Tile the improvement is situated on
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Tile tile<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Creates a new render object for the specified tile's improvement
   *
   * @param tile          tile the improvement is situated on
   * @param adjacentTiles adjacent tiles to this tile
   */</span>
  <span class="token keyword">public</span> <span class="token function">RenderImprovement</span><span class="token punctuation">(</span>Tile tile<span class="token punctuation">,</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> adjacentTiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>tile<span class="token punctuation">.</span>improvement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tile <span class="token operator">=</span> tile<span class="token punctuation">;</span>
    <span class="token comment">// Set the render's initial state</span>
    <span class="token function">setImprovement</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> tile<span class="token punctuation">.</span>improvementMetadata<span class="token punctuation">,</span> adjacentTiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Sets the improvement details for this render, updating what it's showing
   *
   * @param data          new improvement of the tile
   * @param metadata      metadata of the improvement, angle, size, etc
   * @param adjacentTiles adjacent tiles to the improvement's tile
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setImprovement</span><span class="token punctuation">(</span>
    Improvement data<span class="token punctuation">,</span>
    Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> metadata<span class="token punctuation">,</span>
    ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> adjacentTiles
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token comment">// Remove all the previous children renders for the old improvement</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Reset transformations to their default values</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add the correct render objects for the new improvement</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Improvement<span class="token punctuation">.</span>CAPITAL<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Capitals automatically have a road, so add it underneath the capital</span>
      <span class="token comment">// render</span>
      <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RenderImprovementRoad</span><span class="token punctuation">(</span>tile<span class="token punctuation">,</span> adjacentTiles<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RenderImprovementHouse</span><span class="token punctuation">(</span>tile<span class="token punctuation">.</span>city<span class="token punctuation">.</span>wallColour<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Improvement<span class="token punctuation">.</span>FARM<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RenderImprovementFarm</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Improvement<span class="token punctuation">.</span>TREE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RenderImprovementTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Improvement<span class="token punctuation">.</span>MINE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RenderImprovementMine</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Improvement<span class="token punctuation">.</span>PASTURE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RenderImprovementPasture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Improvement<span class="token punctuation">.</span>ROAD<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RenderImprovementRoad</span><span class="token punctuation">(</span>tile<span class="token punctuation">,</span> adjacentTiles<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/logic/map/tile/Terrain.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>NoiseGenerator<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>Point2D<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Random<span class="token punctuation">;</span>

<span class="token comment">/**
 * Class for the terrain of a tile. Stores information on the height, level,
 * and whether the tile has a tree.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Terrain</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Random number generator for trees
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Random RANDOM <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Height of the tile. This is a number in the range [0, 1];
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">double</span> height<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Level associated with the height of the tile. Contains information on the
   * colour of the tile.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> Level level<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Whether the tile has a tree in its natural state (regardless of tile
   * improvements that would remove it)
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> hasTree<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Creates a new terrain object for a specified point
   *
   * @param p point to generate terrain for
   */</span>
  <span class="token function">Terrain</span><span class="token punctuation">(</span>Point2D p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>
      <span class="token comment">// Height of the terrain (rounded to 3 d.p. to reduce file saves)</span>
      Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>NoiseGenerator<span class="token punctuation">.</span><span class="token function">getInterpolatedNoise</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
          <span class="token operator">*</span> <span class="token number">1000.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000.0</span><span class="token punctuation">,</span>
      <span class="token comment">// Whether the tile has a tree (completely random and not dependent on</span>
      <span class="token comment">// the position, this is ok as this will only be called once per point</span>
      <span class="token comment">// during the generation stage)</span>
      RANDOM<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Cretaes a new terrain object with a specified height and tree
   *
   * @param height  height of the terrain
   * @param hasTree whether the terrain has a tree
   */</span>
  <span class="token function">Terrain</span><span class="token punctuation">(</span><span class="token keyword">double</span> height<span class="token punctuation">,</span> <span class="token keyword">boolean</span> hasTree<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Store the height</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>

    <span class="token comment">// Get the level for the height</span>
    level <span class="token operator">=</span> Level<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Set the height to the maximum value if required</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>level<span class="token punctuation">.</span>fixToMax<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> level<span class="token punctuation">.</span>maxHeight<span class="token punctuation">;</span>

    <span class="token comment">// Only keep the tree if this is on the plains level (we don't want trees</span>
    <span class="token comment">// in the ocean)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hasTree <span class="token operator">=</span> hasTree <span class="token operator">&amp;&amp;</span> level <span class="token operator">==</span> Level<span class="token punctuation">.</span>PLAIN<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Calculates the colour that should be used when rendering this terrain
   * @return colour to be used for rendering
   */</span>
  <span class="token keyword">public</span> Color <span class="token function">getColour</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Color min <span class="token operator">=</span> Color<span class="token punctuation">.</span>BLACK<span class="token punctuation">;</span>
    Color max <span class="token operator">=</span> Color<span class="token punctuation">.</span>BLACK<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>level<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> MOUNTAIN<span class="token operator">:</span>
        min <span class="token operator">=</span> Color<span class="token punctuation">.</span>GRAY<span class="token punctuation">;</span>
        max <span class="token operator">=</span> Color<span class="token punctuation">.</span>WHITE<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> PLAIN<span class="token operator">:</span>
        min <span class="token operator">=</span> Color<span class="token punctuation">.</span>GREEN<span class="token punctuation">;</span>
        max <span class="token operator">=</span> Color<span class="token punctuation">.</span>LIGHTGREEN<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> BEACH<span class="token operator">:</span>
        min <span class="token operator">=</span> Color<span class="token punctuation">.</span>GOLDENROD<span class="token punctuation">;</span>
        max <span class="token operator">=</span> Color<span class="token punctuation">.</span>LIGHTGOLDENRODYELLOW<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> OCEAN<span class="token operator">:</span>
        max <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Color</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.66</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Calculate the percentage through the terrains level</span>
    <span class="token keyword">double</span> t <span class="token operator">=</span> <span class="token punctuation">(</span>height <span class="token operator">-</span> level<span class="token punctuation">.</span>minHeight<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>level<span class="token punctuation">.</span>maxHeight <span class="token operator">-</span> level<span class="token punctuation">.</span>minHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Linear interpolate between the min and max colour</span>
    <span class="token keyword">return</span> min<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span>max<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/render/map/improvement/RenderImprovementFarm.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>map<span class="token punctuation">.</span>improvement<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">.</span>Render<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>PhongMaterial<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>shape<span class="token punctuation">.</span>Box<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Random<span class="token punctuation">;</span>

<span class="token comment">/**
 * Render object for a farm improvement. Added to a {@link RenderImprovement}.
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RenderImprovementFarm</span> <span class="token keyword">extends</span> <span class="token class-name">Render</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Width/length of the farm
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> SIZE <span class="token operator">=</span> <span class="token number">0.7</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Colour of the fence around the farm
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Color FENCE_COLOUR <span class="token operator">=</span> Color<span class="token punctuation">.</span>BROWN<span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Colour of the grass strips in the farm
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Color GRASS_COLOUR <span class="token operator">=</span> Color<span class="token punctuation">.</span>GREEN<span class="token punctuation">;</span>
  <span class="token comment">/**
   * Colour of the soil strips in the farm
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Color SOIL_COLOUR <span class="token operator">=</span> Color<span class="token punctuation">.</span>BROWN<span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">RenderImprovementFarm</span><span class="token punctuation">(</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> metadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get the number of alternating strips this farm has</span>
    <span class="token keyword">double</span> numStrips <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> metadata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"strips"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Calculate the strips' size and position</span>
    <span class="token keyword">double</span> stripSize <span class="token operator">=</span> SIZE <span class="token operator">/</span> numStrips<span class="token punctuation">;</span>
    <span class="token keyword">double</span> startTranslate <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>numStrips <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span> <span class="token operator">*</span> stripSize<span class="token punctuation">;</span>

    <span class="token comment">// Add the strips</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numStrips<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Box strip <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Box</span><span class="token punctuation">(</span>stripSize<span class="token punctuation">,</span> SIZE<span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      strip<span class="token punctuation">.</span><span class="token function">setTranslateX</span><span class="token punctuation">(</span>startTranslate <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">*</span> stripSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      strip<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> GRASS_COLOUR <span class="token operator">:</span> SOIL_COLOUR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">add</span><span class="token punctuation">(</span>strip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Add the fences around the farm</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeWall</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeWall</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeWall</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeWall</span><span class="token punctuation">(</span><span class="token number">270</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Shift the farm up and rotate it by the set angle</span>
    translate<span class="token punctuation">.</span><span class="token function">setZ</span><span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rotateZ<span class="token punctuation">.</span><span class="token function">setAngle</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> metadata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"angle"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Makes a segment of the wall
   * @param angle angle to pivot the wall by in degrees
   * @return render object containing the wall
   */</span>
  <span class="token keyword">private</span> Render <span class="token function">makeWall</span><span class="token punctuation">(</span><span class="token keyword">double</span> angle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create a render object used to pivot the wall around</span>
    Render wallHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wallHolder<span class="token punctuation">.</span>rotateZ<span class="token punctuation">.</span><span class="token function">setAngle</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add the wall</span>
    Box box <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Box</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> SIZE <span class="token operator">+</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    box<span class="token punctuation">.</span><span class="token function">setTranslateX</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SIZE <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    box<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    box<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>FENCE_COLOUR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wallHolder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> wallHolder<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/render/map/improvement/RenderImprovementMine.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>map<span class="token punctuation">.</span>improvement<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">.</span>Render<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>PhongMaterial<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>shape<span class="token punctuation">.</span>Box<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token comment">/**
 * Render object for a mine improvement. Added to a {@link RenderImprovement}.
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RenderImprovementMine</span> <span class="token keyword">extends</span> <span class="token class-name">Render</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Various colours the rocks can be
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Color<span class="token punctuation">[</span><span class="token punctuation">]</span> ROCK_COLOURS <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Color</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
    Color<span class="token punctuation">.</span>WHITESMOKE<span class="token punctuation">,</span>
    Color<span class="token punctuation">.</span>ORANGERED<span class="token punctuation">,</span>
    Color<span class="token punctuation">.</span>DIMGREY<span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
  <span class="token function">RenderImprovementMine</span><span class="token punctuation">(</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> metadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get the rock sizes and colours</span>
    List<span class="token generics function"><span class="token punctuation">&lt;</span>Double<span class="token punctuation">></span></span> sizes <span class="token operator">=</span> <span class="token punctuation">(</span>List<span class="token generics function"><span class="token punctuation">&lt;</span>Double<span class="token punctuation">></span></span><span class="token punctuation">)</span> metadata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"sizes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    List<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">></span></span> colours <span class="token operator">=</span> <span class="token punctuation">(</span>List<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">></span></span><span class="token punctuation">)</span> metadata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"colours"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the 3 rocks</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">double</span> size <span class="token operator">=</span> sizes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> colour <span class="token operator">=</span> colours<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> angle <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">120</span><span class="token punctuation">;</span>
      <span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeRock</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> colour<span class="token punctuation">,</span> angle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Makes a rock for the mine render
   *
   * @param size  relative size of the rock
   * @param color colour index of the rock
   * @param angle angle the rock should be pivoted by
   * @return render object containing the rock
   */</span>
  <span class="token keyword">private</span> Render <span class="token function">makeRock</span><span class="token punctuation">(</span><span class="token keyword">double</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> color<span class="token punctuation">,</span> <span class="token keyword">int</span> angle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create the rock</span>
    Box rock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Box</span><span class="token punctuation">(</span>
      size <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">,</span>
      size <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">,</span>
      size <span class="token operator">/</span> <span class="token number">2.0</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    rock<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>ROCK_COLOURS<span class="token punctuation">[</span>color<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rock<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span>size <span class="token operator">/</span> <span class="token number">4.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add it to a render object and pivot it the specified number of degrees</span>
    Render rockHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rockHolder<span class="token punctuation">.</span>rotateZ<span class="token punctuation">.</span><span class="token function">setAngle</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rockHolder<span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">setX</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rockHolder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rockHolder<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/render/map/improvement/RenderImprovementHouse.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>map<span class="token punctuation">.</span>improvement<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">.</span>Render<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>PhongMaterial<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>shape<span class="token punctuation">.</span>Box<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>shape<span class="token punctuation">.</span>Cylinder<span class="token punctuation">;</span>

<span class="token comment">/**
 * Render object for a capital improvement. Added to a
 * {@link RenderImprovement}.
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RenderImprovementHouse</span> <span class="token keyword">extends</span> <span class="token class-name">Render</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Roof colour of a default house
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Color ROOF_COLOUR <span class="token operator">=</span> Color<span class="token punctuation">.</span>BROWN<span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Wall colour of a default house
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Color WALL_COLOUR <span class="token operator">=</span> Color<span class="token punctuation">.</span>GOLDENROD<span class="token punctuation">;</span>

  <span class="token function">RenderImprovementHouse</span><span class="token punctuation">(</span>Color colour<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create and add the walls</span>
    Box box <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Box</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    box<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    box<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>colour <span class="token operator">==</span> null <span class="token operator">?</span> WALL_COLOUR <span class="token operator">:</span> colour<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create and add the roof (triangular prism, cylinder with 3 divisions)</span>
    Cylinder roof <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cylinder</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    roof<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span><span class="token number">0.25</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    roof<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>
      colour <span class="token operator">==</span> null
        <span class="token operator">?</span> ROOF_COLOUR
        <span class="token operator">:</span> colour<span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span>roof<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/render/map/improvement/RenderImprovementPasture.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>map<span class="token punctuation">.</span>improvement<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ClientOnly<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">.</span>Render<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>PhongMaterial<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>shape<span class="token punctuation">.</span>Box<span class="token punctuation">;</span>

<span class="token comment">/**
 * Render object for a pasture improvement. Added to a {@link RenderImprovement}.
 */</span>
<span class="token annotation punctuation">@ClientOnly</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RenderImprovementPasture</span> <span class="token keyword">extends</span> <span class="token class-name">Render</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Width/length of the pasture
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> SIZE <span class="token operator">=</span> <span class="token number">0.4</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Colours of the pasture fences
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Color FENCE_COLOUR <span class="token operator">=</span> Color<span class="token punctuation">.</span>BROWN<span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">RenderImprovementPasture</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Add the pasture fences</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeFence</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeFence</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeFence</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeFence</span><span class="token punctuation">(</span><span class="token number">270</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Creates a fence render object and pivots it the specified number of
   * degrees
   *
   * @param angle angle to pivot the fence by in degrees
   * @return render object containing this fence segment and a fence corner
   * post
   */</span>
  <span class="token keyword">private</span> Render <span class="token function">makeFence</span><span class="token punctuation">(</span><span class="token keyword">double</span> angle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create the holder render object and pivot it</span>
    Render fenceHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fenceHolder<span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">setX</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fenceHolder<span class="token punctuation">.</span>rotateZ<span class="token punctuation">.</span><span class="token function">setAngle</span><span class="token punctuation">(</span>angle <span class="token operator">+</span> <span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the bottom fence</span>
    Box fence <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Box</span><span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">,</span> SIZE <span class="token operator">+</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fence<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>FENCE_COLOUR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fence<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Create the top fence</span>
    Box fence2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Box</span><span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">,</span> SIZE <span class="token operator">+</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fence2<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>FENCE_COLOUR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fence2<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Create the corner fence post</span>
    Box fencePost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Box</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.35</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fencePost<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>FENCE_COLOUR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fencePost<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span><span class="token number">0.35</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fencePost<span class="token punctuation">.</span><span class="token function">setTranslateY</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SIZE <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add the fence components</span>
    fenceHolder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fence<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fenceHolder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fence2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fenceHolder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fencePost<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> fenceHolder<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/render/map/improvement/RenderImprovementRoad.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>map<span class="token punctuation">.</span>improvement<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>logic<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tile<span class="token punctuation">.</span>Tile<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">.</span>Render<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>PhongMaterial<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>shape<span class="token punctuation">.</span>Box<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>shape<span class="token punctuation">.</span>Cylinder<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>Rotate<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span>

<span class="token comment">/**
 * Render object for a road improvement. Added to a {@link RenderImprovement}.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RenderImprovementRoad</span> <span class="token keyword">extends</span> <span class="token class-name">Render</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Colour of road segments
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Color ROAD_COLOUR <span class="token operator">=</span> Color<span class="token punctuation">.</span>DIMGREY<span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Height of the road off the ground
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> ROAD_HEIGHT <span class="token operator">=</span> <span class="token number">0.075</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Width of road segments
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> ROAD_WIDTH <span class="token operator">=</span> <span class="token number">0.3</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Length of road segments, from the center of tiles to the edges
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> ROAD_LENGTH <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">0.75</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">RenderImprovementRoad</span><span class="token punctuation">(</span>Tile thisTile<span class="token punctuation">,</span> ArrayList<span class="token generics function"><span class="token punctuation">&lt;</span>Tile<span class="token punctuation">></span></span> adjacentTiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Adds the center join which connects road road segments together or just</span>
    <span class="token comment">// indicates the tile has a road if there are not adjacent connections</span>
    Cylinder join <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cylinder</span><span class="token punctuation">(</span>
      ROAD_WIDTH <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
      ROAD_HEIGHT<span class="token punctuation">,</span>
      <span class="token number">6</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    join<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>ROAD_COLOUR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    join<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span>ROAD_HEIGHT <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    join<span class="token punctuation">.</span><span class="token function">setRotationAxis</span><span class="token punctuation">(</span>Rotate<span class="token punctuation">.</span>X_AXIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    join<span class="token punctuation">.</span><span class="token function">setRotate</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span>join<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// For every adjacent tile, checks if there is a connecting road</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Tile adjacentTile <span class="token operator">:</span> adjacentTiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>adjacentTile<span class="token punctuation">.</span><span class="token function">hasRoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> dx <span class="token operator">=</span> adjacentTile<span class="token punctuation">.</span>x <span class="token operator">-</span> thisTile<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        <span class="token keyword">int</span> dy <span class="token operator">=</span> adjacentTile<span class="token punctuation">.</span>y <span class="token operator">-</span> thisTile<span class="token punctuation">.</span>y<span class="token punctuation">;</span>

        <span class="token comment">// Calculates the pivot angle of the road segment</span>
        <span class="token keyword">int</span> angle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> xOffset <span class="token operator">=</span> thisTile<span class="token punctuation">.</span>y <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dy <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          angle <span class="token operator">=</span> dx <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dy <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          angle <span class="token operator">=</span> dx <span class="token operator">==</span> <span class="token operator">-</span>xOffset <span class="token operator">?</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dy <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          angle <span class="token operator">=</span> dx <span class="token operator">==</span> <span class="token operator">-</span>xOffset <span class="token operator">?</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">60</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Calculates the height difference for the road connector</span>
        <span class="token keyword">double</span> heightDifference <span class="token operator">=</span>
          adjacentTile<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> thisTile<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Adds the road segment for this connection</span>
        <span class="token function">add</span><span class="token punctuation">(</span><span class="token function">buildRoadSegment</span><span class="token punctuation">(</span>angle<span class="token punctuation">,</span> heightDifference<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Creates a segment of road to be added to this improvement
   *
   * @param angle            pivot angle of this segment
   * @param heightDifference difference in height between this and the
   *                         connecting road
   * @return render object containing the road segment
   */</span>
  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"Duplicates"</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> Render <span class="token function">buildRoadSegment</span><span class="token punctuation">(</span><span class="token keyword">double</span> angle<span class="token punctuation">,</span> <span class="token keyword">double</span> heightDifference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Build the render object and pivot it</span>
    Render rotor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rotor<span class="token punctuation">.</span>rotateZ<span class="token punctuation">.</span><span class="token function">setAngle</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">//      #-----</span>
    <span class="token comment">//      #</span>
    <span class="token comment">// =====#</span>
    <span class="token comment">//</span>

    <span class="token comment">// Build the actual segment of road (the ='s in the above diagram)</span>
    Box road <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Box</span><span class="token punctuation">(</span>ROAD_WIDTH<span class="token punctuation">,</span> ROAD_LENGTH<span class="token punctuation">,</span> ROAD_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    road<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>ROAD_COLOUR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    road<span class="token punctuation">.</span><span class="token function">setTranslateX</span><span class="token punctuation">(</span>ROAD_LENGTH <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    road<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span>ROAD_HEIGHT <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    road<span class="token punctuation">.</span><span class="token function">setRotationAxis</span><span class="token punctuation">(</span>Rotate<span class="token punctuation">.</span>Z_AXIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    road<span class="token punctuation">.</span><span class="token function">setRotate</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rotor<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>road<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Only render joins that go up in height</span>
    <span class="token keyword">double</span> roadJoinHeight <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>heightDifference<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> ROAD_HEIGHT<span class="token punctuation">;</span>
    <span class="token comment">// Add the box that joins the road segment on this tile and the road</span>
    <span class="token comment">// segment on the adjacent tile (the #'s in the above diagram)</span>
    Box roadJoin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Box</span><span class="token punctuation">(</span>ROAD_WIDTH<span class="token punctuation">,</span> ROAD_HEIGHT<span class="token punctuation">,</span> roadJoinHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    roadJoin<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>ROAD_COLOUR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    roadJoin<span class="token punctuation">.</span><span class="token function">setTranslateX</span><span class="token punctuation">(</span>ROAD_LENGTH <span class="token operator">-</span> <span class="token punctuation">(</span>ROAD_HEIGHT <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    roadJoin<span class="token punctuation">.</span><span class="token function">setTranslateZ</span><span class="token punctuation">(</span>roadJoinHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    roadJoin<span class="token punctuation">.</span><span class="token function">setRotationAxis</span><span class="token punctuation">(</span>Rotate<span class="token punctuation">.</span>Z_AXIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    roadJoin<span class="token punctuation">.</span><span class="token function">setRotate</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rotor<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>roadJoin<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> rotor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre><h1>com/mrbbot/civilisation/render/map/improvement/RenderImprovementTree.java</h1><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>civilisation<span class="token punctuation">.</span>render<span class="token punctuation">.</span>map<span class="token punctuation">.</span>improvement<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mrbbot<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>render<span class="token punctuation">.</span>Render<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Color<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>Material<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>paint<span class="token punctuation">.</span>PhongMaterial<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>shape<span class="token punctuation">.</span>Cylinder<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>shape<span class="token punctuation">.</span>Sphere<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>Rotate<span class="token punctuation">;</span>
<span class="token keyword">import</span> javafx<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>Translate<span class="token punctuation">;</span>

<span class="token comment">/**
 * Render object for a tree on the map. Added to a {@link RenderImprovement}.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RenderImprovementTree</span> <span class="token keyword">extends</span> <span class="token class-name">Render</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Material used for rendering a tree's logs
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Material LOG_MATERIAL <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>BROWN<span class="token punctuation">.</span><span class="token function">darker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Material used for rendering a tree's bushes
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Material BUSH_MATERIAL <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">PhongMaterial</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>FORESTGREEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Height of a trees trunk
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> TREE_HEIGHT <span class="token operator">=</span> <span class="token number">0.6</span><span class="token punctuation">;</span>

  <span class="token function">RenderImprovementTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create the tree trunk</span>
    Cylinder log <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cylinder</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> TREE_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">getTransforms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">Rotate</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">,</span> Rotate<span class="token punctuation">.</span>X_AXIS<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Translate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> TREE_HEIGHT <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span>LOG_MATERIAL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the tree's leaves</span>
    Sphere bush <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sphere</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bush<span class="token punctuation">.</span><span class="token function">getTransforms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">Translate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> TREE_HEIGHT <span class="token operator">+</span> <span class="token number">0.2</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    bush<span class="token punctuation">.</span><span class="token function">setMaterial</span><span class="token punctuation">(</span>BUSH_MATERIAL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>log<span class="token punctuation">,</span> bush<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
</body>
</html>